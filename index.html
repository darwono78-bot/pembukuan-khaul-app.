<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pencatatan Donatur Khaul - Saldo Berjalan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .container-app {
            max-width: 900px; 
        }
        .input-field {
            @apply w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-150;
        }
        .header-title {
            @apply text-3xl font-bold text-center text-white mb-6 p-4 rounded-lg shadow-inner;
        }
        .section-title {
            @apply text-xl font-semibold text-gray-700 border-b pb-2 mb-4 mt-8;
        }
        .btn-action {
            @apply font-bold py-3 px-6 rounded-lg transition duration-150 shadow-md hover:shadow-lg w-full;
        }
        /* Style input sesuai web Yapin (seperti yang terlihat dari layout sebelumnya) */
        #form-catat-donasi {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        #tanggal-input, #nama-donatur-input, #alamat-input, #nilai-jariyah-input, #jumlah-jariyah-input, #btn-catat-donasi {
            grid-column: span 1;
        }
        /* Biar tombol memanjang ke samping */
        #btn-catat-donasi {
            grid-column: span 2;
        }
        /* Perbaikan untuk tampilan mobile */
        @media (max-width: 640px) {
             #form-catat-donasi {
                grid-template-columns: 1fr;
            }
            #tanggal-input, #nama-donatur-input, #alamat-input, #nilai-jariyah-input, #jumlah-jariyah-input, #btn-catat-donasi {
                grid-column: span 1;
            }
        }
    </style>

    <script type="module">
        
        // --- VARIABEL GLOBAL & UTILITY ---
        const STORAGE_KEY = 'khaul_donations_running_balance';
        let allDonations = []; 
        
        const formatRupiah = (angka) => {
            if (angka === undefined || angka === null) return 'Rp 0';
            const num = Math.round(angka); 
            return 'Rp ' + num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        };

        // --- DATA HANDLING (localStorage) ---

        const loadDonations = () => {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                allDonations = data ? JSON.parse(data) : [];
                
                // --- Memastikan nilai uang adalah Number saat dimuat ---
                allDonations = allDonations.map(d => ({
                    ...d,
                    totalJariyah: Number(d.totalJariyah),
                    timestamp: Number(d.timestamp)
                }));

            } catch (error) {
                console.error("Gagal memuat data dari localStorage:", error);
                allDonations = [];
            }
            renderTable(allDonations);
        };

        const saveDonations = () => {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(allDonations));
        };
        
        // --- INPUT & FORM FUNCTIONS ---

        const handleCatatDonasi = () => {
            const tanggal = document.getElementById('tanggal-input').value;
            const namaDonatur = document.getElementById('nama-donatur-input').value;
            const alamat = document.getElementById('alamat-input').value;
            const nilaiJariyah = document.getElementById('nilai-jariyah-input').value || 'Jariyah Umum';
            const jumlahJariyah = Number(document.getElementById('jumlah-jariyah-input').value); // Ini adalah nilai per baris

            if (!tanggal || !
