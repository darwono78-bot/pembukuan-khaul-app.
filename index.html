<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Pelacak Keuangan Sederhana</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Heroicons untuk ikon -->
    <script src="https://unpkg.com/heroicons@2.1.1/24/outline/index.js"></script>
    <style>
        /* Menggunakan font Inter secara default */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Animasi masuk modal */
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-down {
            animation: fadeInDown 0.3s ease-out forwards;
        }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen bg-gray-100 font-sans p-4 sm:p-6 lg:p-8">
        <!-- Konten aplikasi akan dirender di sini oleh JavaScript -->
        <div class="text-center p-10">
            <svg class="animate-spin h-8 w-8 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-sm text-gray-600">Memuat Aplikasi...</p>
        </div>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, addDoc, onSnapshot, doc, updateDoc, deleteDoc, Timestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Mengatur level log Firebase ke Debug untuk diagnosa
        // setLogLevel('debug'); 

        // --- Konfigurasi dan Global Variables ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let transactions = [];
        let isLoading = true;
        let error = null;
        let isModalOpen = false;
        let editingTransaction = null;
        let isConfirmModalOpen = false;
        let transactionToDelete = null;
        let formData = {
            tanggal: new Date().toISOString().substring(0, 10),
            deskripsi: '',
            nominal: '',
            jenis: 'pemasukan',
        };

        // --- Fungsi Utilitas ---

        // Fungsi untuk memformat nominal ke Rupiah
        const formatRupiah = (number) => {
            if (number === null || number === undefined || isNaN(number)) return 'Rp 0';
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0,
            }).format(Number(number));
        };

        // Fungsi untuk memformat tanggal ke format lokal
        const formatDate = (timestamp) => {
            if (!timestamp) return '-';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('id-ID', {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
            });
        };

        // Path Collection Firestore
        const getCollectionPath = (currentUserId) => {
            if (!currentUserId) return null;
            return `artifacts/${appId}/users/${currentUserId}/transactions`;
        };
        
        // --- State Management dan Render Ulang UI ---
        const renderApp = () => {
            const appDiv = document.getElementById('app');
            if (!appDiv) return;

            // Perhitungan Saldo & Ringkasan (diulang di setiap render)
            let totalPemasukan = 0;
            let totalPengeluaran = 0;
            transactions.forEach(t => {
                if (t.jenis === 'pemasukan') {
                    totalPemasukan += t.nominal;
                } else if (t.jenis === 'pengeluaran') {
                    totalPengeluaran += t.nominal;
                }
            });
            const saldoAkhir = totalPemasukan - totalPengeluaran;

            // Template UI menggunakan string literal
            appDiv.innerHTML = `
                <header class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl sm:text-3xl font-extrabold text-indigo-700">
                        <span class="block text-sm font-medium text-indigo-500">Aplikasi Pelacak</span>
                        Laporan Keuangan
                    </h1>
                    <div class="flex space-x-2">
                        <button id="add-transaction-btn" 
                            class="flex items-center px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 transform hover:scale-[1.02]">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 mr-1">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                            </svg>
                            <span class="hidden sm:inline">Tambah Transaksi</span>
                            <span class="sm:hidden">Tambah</span>
                        </button>
                        <button id="sign-out-btn" title="Keluar / Sign Out"
                            class="p-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5.636 5.636a9 9 0 1 0 12.728 0M12 2v10" />
                            </svg>
                        </button>
                    </div>
                </header>
                
                <!-- Tampilkan UID -->
                <p class="text-xs text-gray-500 mb-4">
                    ID Pengguna (UID): <span class="font-mono text-indigo-500">${userId || 'Menunggu Autentikasi...'}</span>
                </p>

                <!-- Ringkasan Keuangan -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    ${SummaryCard('SALDO AKHIR', saldoAkhir, saldoAkhir >= 0 ? 'text-indigo-600' : 'text-red-600', 'bg-white', '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"> <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818L6.477 14.28a3.001 3.001 0 0 0 1.296 4.707M9 12h.008v.008H9V12Zm2.5-6H15.63a4.5 4.5 0 1 1 0 9H12m2.818 2.818L17.523 9.72a3 3 0 0 0-1.296-4.707M15 12h.008v.008H15V12Z" /> </svg>')}
                    ${SummaryCard('TOTAL PEMASUKAN', totalPemasukan, 'text-green-600', 'bg-green-50', '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18 9 11.25l4.306 4.305a11.233 11.233 0 0 1 6.323-2.145H17.25m-4.686-2.522 1.57-2.739 1.754-.007a11.272 11.272 0 0 0 5.418 2.39M15.75 6.75a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0Z" /></svg>')}
                    ${SummaryCard('TOTAL PENGELUARAN', totalPengeluaran, 'text-red-600', 'bg-red-50', '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l5.485 5.485m-5.485-5.485h17.565m-2.25 0l-5.485 5.485m5.485-5.485h-17.565m17.565 0l-5.485-5.485m5.485 5.485H6.435" /></svg>')}
                </div>

                <!-- Pesan Error Global -->
                ${error ? `<div class="p-3 mb-4 text-sm text-red-700 bg-red-100 rounded-lg" role="alert">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline mr-1">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.021 3.375 1.77 3.375h14.714c1.749 0 2.635-1.875 1.77-3.375l-7.385-12.285a1.875 1.875 0 0 0-3.232 0l-7.385 12.285Z" />
                    </svg>
                    ${error}
                </div>` : ''}

                <!-- Tabel Data Transaksi -->
                <h2 class="text-xl font-bold text-gray-800 mb-4">Daftar Transaksi (${transactions.length} Data)</h2>
                ${TransactionTable(transactions)}

                <!-- Modals -->
                ${isModalOpen ? InputModal() : ''}
                ${isConfirmModalOpen ? ConfirmDeleteModal() : ''}
            `;

            // Pasang Event Listeners setelah HTML dirender
            setupEventListeners();
        };

        const setupEventListeners = () => {
            const addBtn = document.getElementById('add-transaction-btn');
            if (addBtn) {
                addBtn.onclick = () => {
                    // Reset form state dan buka modal
                    formData = {
                        tanggal: new Date().toISOString().substring(0, 10),
                        deskripsi: '',
                        nominal: '',
                        jenis: 'pemasukan',
                    };
                    editingTransaction = null;
                    error = null;
                    isModalOpen = true;
                    renderApp();
                };
            }

            const signOutBtn = document.getElementById('sign-out-btn');
            if (signOutBtn) {
                signOutBtn.onclick = async () => {
                    if (auth && auth.currentUser) {
                        try {
                            await signOut(auth);
                            console.log("Sign Out Berhasil.");
                        } catch (e) {
                            console.error("Sign Out Gagal:", e);
                        }
                    }
                };
            }

            // Event Listeners Modal
            const modalForm = document.getElementById('modal-form');
            if (modalForm) {
                modalForm.onsubmit = handleSubmit;
            }

            const modalCloseBtn = document.getElementById('modal-close-btn');
            if (modalCloseBtn) {
                modalCloseBtn.onclick = handleModalClose;
            }

            const nominalInput = document.getElementById('nominal');
            if (nominalInput) {
                nominalInput.oninput = handleNominalChange;
            }
            
            // Event Listeners Aksi Tabel (Edit/Delete)
            transactions.forEach(t => {
                const editBtn = document.getElementById(`edit-btn-${t.id}`);
                const deleteBtn = document.getElementById(`delete-btn-${t.id}`);
                if (editBtn) {
                    editBtn.onclick = () => handleEdit(t);
                }
                if (deleteBtn) {
                    deleteBtn.onclick = () => handleDelete(t);
                }
            });
            
            // Event Listeners Confirm Delete Modal
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            if (confirmDeleteBtn) {
                confirmDeleteBtn.onclick = confirmDelete;
            }
            if (cancelDeleteBtn) {
                cancelDeleteBtn.onclick = () => {
                    isConfirmModalOpen = false;
                    transactionToDelete = null;
                    renderApp();
                };
            }
        };

        // --- Komponen UI Pembantu (sebagai fungsi yang mengembalikan string HTML) ---
        
        const SummaryCard = (title, value, valueColor, bgColor, iconSvg) => `
            <div class="p-5 rounded-xl shadow-lg flex items-center justify-between ${bgColor} transform transition duration-200 hover:scale-[1.02] border-b-4 border-opacity-50">
                <div class="flex items-center">
                    <div class="w-6 h-6 mr-3 ${valueColor}">
                        ${iconSvg}
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-700">${title}</p>
                        <h2 class="text-xl font-bold ${valueColor} mt-1">
                            ${formatRupiah(value)}
                        </h2>
                    </div>
                </div>
            </div>
        `;

        const TransactionTable = (data) => `
            <div class="bg-white rounded-xl shadow-lg overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider w-1/6">Tanggal</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider w-3/6">Deskripsi</th>
                            <th class="px-4 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider w-1/6">Nominal</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider w-1/12">Jenis</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider w-1/12">Aksi</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${data.length === 0 ? `
                            <tr>
                                <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">
                                    ${isLoading ? 'Memuat data...' : 'Belum ada data transaksi. Silakan input transaksi baru.'}
                                </td>
                            </tr>
                        ` : data.map((item) => {
                            const isIncome = item.jenis === 'pemasukan';
                            const nominalColor = isIncome ? 'text-green-600' : 'text-red-600';
                            const iconSvg = isIncome 
                                ? '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 10.5 12 3m0 0 7.5 7.5M12 3v18" /></svg>'
                                : '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 13.5 12 21m0 0-7.5-7.5M12 21V3" /></svg>';

                            return `
                                <tr class="hover:bg-gray-50 transition duration-100">
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${formatDate(item.tanggal)}</td>
                                    <td class="px-4 py-3 text-sm font-medium text-gray-900">${item.deskripsi}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm font-mono text-right ${nominalColor}">
                                        ${formatRupiah(item.nominal)}
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap text-xs font-semibold text-center">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full ${isIncome ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                            ${iconSvg}
                                            <span class="ml-1 hidden sm:inline">${isIncome ? 'Pemasukan' : 'Pengeluaran'}</span>
                                        </span>
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                                        <div class="flex justify-center space-x-2">
                                            <button id="edit-btn-${item.id}"
                                                class="text-indigo-600 hover:text-indigo-900 p-1 rounded-full hover:bg-indigo-100 transition"
                                                title="Edit Transaksi">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 17.159a2.25 2.25 0 0 1-1.006.58l-1.677.368a2.25 2.25 0 0 1-2.07-.48l-.001-.001-.002-.002-.002-.002.002.002a2.25 2.25 0 0 1 .48-.823l.368-1.677a2.25 2.25 0 0 1 .58-1.006l6.657-6.657Z" /></svg>
                                            </button>
                                            <button id="delete-btn-${item.id}"
                                                class="text-red-600 hover:text-red-900 p-1 rounded-full hover:bg-red-100 transition"
                                                title="Hapus Transaksi">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.764-1.99a2.25 2.25 0 0 0-2.25-2.25H15m0 0V4.75A.75.75 0 0 0 14.25 4h-4.5A.75.75 0 0 0 9 4.75V7H5.25A2.25 2.25 0 0 0 3 9.25v2.5A.75.75 0 0 0 3.75 12h16.5A.75.75 0 0 0 21 11.75v-2.5A2.25 2.25 0 0 0 18.75 7z" /></svg>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
                ${isLoading ? `
                    <div class="p-4 text-center text-indigo-500 flex items-center justify-center">
                        <svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0 0 13.84 2.805l.3-.2" />
                        </svg>
                        Memuat data...
                    </div>
                ` : ''}
            </div>
        `;

        const InputModal = () => `
            <div class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4">
                <div class="relative p-6 border w-full max-w-lg shadow-lg rounded-xl bg-white animate-fade-in-down">
                    <h3 class="text-xl font-bold text-gray-900 mb-4 border-b pb-2">
                        ${editingTransaction ? 'Edit Transaksi' : 'Input Transaksi Baru'}
                    </h3>
                    ${error ? `<div class="p-3 mb-4 text-sm text-red-700 bg-red-100 rounded-lg" role="alert">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline mr-1"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.021 3.375 1.77 3.375h14.714c1.749 0 2.635-1.875 1.77-3.375l-7.385-12.285a1.875 1.875 0 0 0-3.232 0l-7.385 12.285Z" /></svg>
                        ${error}
                    </div>` : ''}
                    <form id="modal-form" class="space-y-4">
                        <!-- Bidang Jenis Transaksi -->
                        <div>
                            <label for="jenis" class="block text-sm font-medium text-gray-700">Jenis Transaksi *</label>
                            <select name="jenis" id="jenis" required onchange="handleInputChange(event)"
                                class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                                <option value="pemasukan" ${formData.jenis === 'pemasukan' ? 'selected' : ''}>Pemasukan (Income)</option>
                                <option value="pengeluaran" ${formData.jenis === 'pengeluaran' ? 'selected' : ''}>Pengeluaran (Expense)</option>
                            </select>
                        </div>
                        <!-- Bidang Tanggal -->
                        <div>
                            <label for="tanggal" class="block text-sm font-medium text-gray-700">Tanggal *</label>
                            <input type="date" name="tanggal" id="tanggal" required value="${formData.tanggal}" onchange="handleInputChange(event)"
                                class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"/>
                        </div>
                        <!-- Bidang Deskripsi -->
                        <div>
                            <label for="deskripsi" class="block text-sm font-medium text-gray-700">Deskripsi *</label>
                            <input type="text" name="deskripsi" id="deskripsi" required placeholder="Contoh: Gaji Bulanan, Beli Bahan Makanan" value="${formData.deskripsi}" onchange="handleInputChange(event)"
                                class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"/>
                        </div>
                        <!-- Bidang Nominal -->
                        <div>
                            <label for="nominal" class="block text-sm font-medium text-gray-700">Nominal (Rp) *</label>
                            <div class="mt-1 relative rounded-lg shadow-sm">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span class="text-gray-500 sm:text-sm">Rp</span>
                                </div>
                                <input type="text" name="nominal" id="nominal" required placeholder="Masukkan angka saja" value="${formData.nominal}"
                                    class="block w-full rounded-lg pl-10 pr-3 border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 p-2 border text-right font-mono text-lg"/>
                            </div>
                        </div>

                        <div class="flex justify-end space-x-4 pt-4">
                            <button type="button" id="modal-close-btn"
                                class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">
                                Batal
                            </button>
                            <button type="submit"
                                class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition">
                                ${editingTransaction ? 'Simpan Perubahan' : 'Tambah Transaksi'}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        
        const ConfirmDeleteModal = () => `
            <div class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4">
                <div class="relative p-6 border w-full max-w-sm shadow-xl rounded-xl bg-white transform transition-all animate-fade-in-down">
                    <h3 class="text-lg font-bold text-red-700 mb-3">Konfirmasi Penghapusan</h3>
                    <p class="text-sm text-gray-600 mb-4">
                        Apakah Anda yakin ingin menghapus transaksi <strong>${transactionToDelete?.deskripsi || ''}</strong> sebesar <span class="font-semibold">${formatRupiah(transactionToDelete?.nominal)}</span>? Aksi ini tidak dapat dibatalkan.
                    </p>
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancel-delete-btn"
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">
                            Batal
                        </button>
                        <button type="button" id="confirm-delete-btn"
                            class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition">
                            Ya, Hapus
                        </button>
                    </div>
                </div>
            </div>
        `;


        // --- Penanganan Form (Global Functions) ---
        window.handleInputChange = (e) => {
            const { name, value } = e.target;
            formData = { ...formData, [name]: value };
        };

        const handleNominalChange = (e) => {
            const rawValue = e.target.value.replace(/\D/g, '');
            formData = { ...formData, nominal: rawValue };
            renderApp(); // Render ulang untuk menampilkan nilai yang sudah dibersihkan di input
        };

        const handleModalClose = () => {
            isModalOpen = false;
            editingTransaction = null;
            error = null;
            renderApp();
        };

        // --- Operasi CRUD Firebase ---
        
        const handleSubmit = async (e) => {
            e.preventDefault();

            if (!db || !userId) {
                error = "Autentikasi belum selesai. Mohon tunggu sebentar.";
                renderApp();
                return;
            }

            const nominalValue = parseInt(formData.nominal || '0', 10);
            if (nominalValue <= 0) {
                error = "Nominal transaksi harus lebih dari 0.";
                renderApp();
                return;
            }
            
            const dateObject = new Date(formData.tanggal);
            if (isNaN(dateObject.getTime())) {
                error = "Format tanggal tidak valid.";
                renderApp();
                return;
            }
            
            const dataToSave = {
                tanggal: Timestamp.fromDate(dateObject), 
                deskripsi: formData.deskripsi.trim() || 'Tanpa Deskripsi',
                nominal: nominalValue,
                jenis: formData.jenis, 
                userId: userId, 
            };

            try {
                const path = getCollectionPath(userId);
                if (!path) return;
                
                if (editingTransaction) {
                    // Mode Edit
                    const docRef = doc(db, path, editingTransaction.id); 
                    await updateDoc(docRef, dataToSave);
                } else {
                    // Mode Tambah Baru
                    await addDoc(collection(db, path), dataToSave); 
                }
                
                // Reset state
                formData = {
                    tanggal: new Date().toISOString().substring(0, 10),
                    deskripsi: '',
                    nominal: '',
                    jenis: 'pemasukan',
                };
                isModalOpen = false;
                editingTransaction = null;
                error = null;
                renderApp();
            } catch (e) {
                console.error("Kesalahan saat menyimpan data:", e);
                error = `Kesalahan saat menyimpan data: ${e.message}`;
                renderApp();
            }
        };

        const handleEdit = (transaction) => {
            editingTransaction = transaction;
            
            let dateStr;
            if (transaction.tanggal.toDate) {
                dateStr = transaction.tanggal.toDate().toISOString().substring(0, 10);
            } else {
                dateStr = new Date(transaction.tanggal).toISOString().substring(0, 10);
            }

            formData = {
                tanggal: dateStr,
                deskripsi: transaction.deskripsi,
                nominal: String(transaction.nominal),
                jenis: transaction.jenis,
            };
            error = null;
            isModalOpen = true;
            renderApp();
        };

        const handleDelete = (transaction) => {
            transactionToDelete = transaction;
            isConfirmModalOpen = true;
            renderApp();
        };

        const confirmDelete = async () => {
            if (!transactionToDelete || !db || !userId) return;

            try {
                const path = getCollectionPath(userId);
                if (!path) return;
                
                const docRef = doc(db, path, transactionToDelete.id); 
                await deleteDoc(docRef);
                
                isConfirmModalOpen = false;
                transactionToDelete = null;
                renderApp();
            } catch (e) {
                console.error("Kesalahan saat menghapus data:", e);
                error = `Kesalahan saat menghapus data: ${e.message}`;
                isConfirmModalOpen = false;
                transactionToDelete = null;
                renderApp();
            }
        };


        // --- Inisialisasi Firebase dan Autentikasi ---
        const initFirebase = () => {
            if (!firebaseConfig.projectId) {
                error = "Error: Konfigurasi Firebase tidak lengkap.";
                isLoading = false;
                renderApp();
                return;
            }

            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            
            // 1. Siapkan listener untuk memantau perubahan status autentikasi
            onAuthStateChanged(auth, (user) => {
                const currentUserId = user ? user.uid : null;
                const wasAuthReady = isAuthReady;

                userId = currentUserId;
                isAuthReady = true;

                if (!wasAuthReady) {
                    console.log('DEBUG: Auth State Ready. UserID:', userId);
                    // Setelah autentikasi siap, panggil listener data
                    setupDataListener();
                }
                
                renderApp(); // Render ulang setelah status auth berubah
            });

            // 2. Lakukan sign-in awal
            const performInitialSignIn = async () => {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (e) {
                    console.error("Kesalahan saat sign-in:", e);
                    error = `Kesalahan saat sign-in: ${e.message}`;
                    isLoading = false;
                    renderApp();
                }
            };

            performInitialSignIn();
        };
        
        // --- Listener Data Transaksi (Real-time) ---
        let unsubscribeSnapshot = null;
        const setupDataListener = () => {
            // Hentikan listener lama jika ada
            if (unsubscribeSnapshot) {
                unsubscribeSnapshot();
                unsubscribeSnapshot = null;
            }
            
            if (!isAuthReady || !db || !userId) {
                console.log('DEBUG: Gagal melampirkan listener, Auth/DB belum siap.');
                return;
            }

            const path = getCollectionPath(userId);
            if (!path) return;
            
            console.log('DEBUG: Melampirkan onSnapshot ke jalur:', path); 

            const colRef = collection(db, path);
            const q = query(colRef); 

            isLoading = true;
            renderApp();

            unsubscribeSnapshot = onSnapshot(q, (snapshot) => {
                const newTransactions = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    newTransactions.push({
                        id: doc.id,
                        ...data,
                        nominal: Number(data.nominal || 0),
                    });
                });

                // Urutkan berdasarkan tanggal (descending, terbaru di atas)
                newTransactions.sort((a, b) => {
                    const dateA = a.tanggal?.toMillis ? a.tanggal.toMillis() : new Date(a.tanggal).getTime();
                    const dateB = b.tanggal?.toMillis ? b.tanggal.toMillis() : new Date(b.tanggal).getTime();
                    return dateB - dateA; 
                });

                transactions = newTransactions;
                isLoading = false;
                error = null;
                renderApp(); // Render ulang dengan data baru
            }, (e) => {
                console.error("Kesalahan saat mengambil data:", e);
                console.error("DEBUG Diagnostik Error: UserID:", userId, "Path:", path); 
                if (isAuthReady) {
                    error = `Kesalahan saat mengambil data: ${e.message}. Pastikan Aturan Keamanan Firestore sudah dipublikasikan.`;
                }
                isLoading = false;
                renderApp(); // Render ulang dengan pesan error
            });
        };

        // Inisialisasi saat window dimuat
        window.onload = initFirebase;

    </script>
</body>
</html>
