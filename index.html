<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Aplikasi Pembukuan Dana Khaul Online</title>
    
    <style>
        body { font-family: 'Arial', sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; }
        hr { border: 0; border-top: 1px solid #eee; margin: 20px 0; }
        form label { display: block; margin-top: 10px; font-weight: bold; }
        form input, form select, form textarea, form button { width: 100%; padding: 10px; margin-top: 5px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        form button { background-color: #007bff; color: white; border: none; cursor: pointer; margin-top: 15px; }
        form button:hover { background-color: #0056b3; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #e9ecef; }
        .admin-only { background-color: #fff3cd; } 
        #finalSaldo { font-weight: bold; background-color: #d4edda; color: #155724; text-align: right; }
        .dana-masuk { color: green; font-weight: bold; text-align: right; }
        .dana-keluar { color: red; text-align: right; }
        .aksi-btn { padding: 4px 8px; margin: 2px; cursor: pointer; border-radius: 3px; }
        .aksi-btn.edit { background-color: #ffc107; }
        .aksi-btn.delete { background-color: #dc3545; color: white; }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
<div class="container">
    <h1>üìù Aplikasi Pembukuan Dana Khaul</h1>
    
    <h2>1. Masukkan Donasi (Dana Masuk)</h2>
    <form id="formDonasi">
        <label for="donasiTanggal">Tanggal Donasi (K-2):</label>
        <input type="date" id="donasiTanggal" required>
        <label for="namaDonatur">Nama Donatur (K-3):</label>
        <input type="text" id="namaDonatur" required>
        <label for="alamatDonatur">Alamat (K-4):</label>
        <input type="text" id="alamatDonatur">
        <label for="jumlahJariyah">Jumlah Jariyah/Donasi (Rp) (K-5/6):</label>
        <input type="number" id="jumlahJariyah" min="1" required>
        <button type="submit">Catat Donasi</button>
    </form>
    
    <hr>

    <h2>2. Masukkan Pengeluaran</h2>
    <form id="formPengeluaran">
        <label for="pengeluaranTanggal">Tanggal Transaksi (K-9):</label>
        <input type="date" id="pengeluaranTanggal" required>
        
        <label for="kategori">Kategori Biaya (LPJ) (K-11):</label>
        <select id="kategori" required>
            <option value="">-- Pilih Kategori --</option>
        </select>
        
        <label for="uraian">Uraian / Deskripsi Pengeluaran (K-10):</label>
        <textarea id="uraian" rows="3" required></textarea>
        
        <label for="jumlah">Jumlah Dana Keluar (Rp) (K-12):</label>
        <input type="number" id="jumlah" min="1" required>
        
        <button type="submit">Catat Pengeluaran</button>
    </form>

    <hr>
    
    <h2>3. üìä Dashboard Laporan Kas Berjalan</h2>
    <table id="tabelJurnalKas">
        <thead>
            <tr>
                <th>No (K-8)</th> 
                <th>Tanggal (K-9)</th>
                <th>Uraian (K-10)</th>
                <th class="admin-only">Kategori (K-11)</th> 
                <th>Dana Masuk</th>
                <th>Dana Keluar (K-12)</th>
                <th>Saldo Berjalan (K-13)</th>
                <th class="admin-only">Aksi (K-14)</th>
            </tr>
        </thead>
        <tbody id="jurnalBody">
            </tbody>
        <tfoot>
            <tr>
                <td colspan="6" style="text-align: right; font-weight: bold;">TOTAL SALDO AKHIR:</td>
                <td colspan="2" id="finalSaldo" style="text-align: right;"></td>
            </tr>
        </tfoot>
    </table>
    
    <button id="downloadLaporanLPJ" style="background-color: green;">Unduh Laporan Pertanggung Jawaban (LPJ) PDF (K-18)</button>
    <button id="downloadListDonatur">Unduh List Donatur PDF (K-16)</button>
    <button id="downloadPengeluaranDetail">Unduh Pengeluaran Detail PDF (K-17)</button>
    
    <button onclick="alert('Fungsi Reset Data (K-15) memerlukan otorisasi Cloud Function. Hati-hati menggunakan ini!')" style="background-color: red;">Reset Semua Data</button>

</div>

<script type="module">
    // Import semua fungsi yang diperlukan
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, runTransaction, query, orderBy, getDocs, updateDoc, deleteDoc, Timestamp, where } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    // Your web app's Firebase configuration (WAJIB GANTI DENGAN KUNCI ASLI ANDA)
    const firebaseConfig = {
        apiKey: "AIzaSyCLFgGblfLTDvploV-tZGYqAajIzT7t0bc",
        authDomain: "laporan-keuangan-yayasan.firebaseapp.com",
        projectId: "laporan-keuangan-yayasan",
        storageBucket: "laporan-keuangan-yayasan.firebasestorage.app",
        messagingSenderId: "616927572689",
        appId: "1:616927572689:web:3961f22c7a7899e71d8bf0"
    };

    // Inisialisasi Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // =================================================================
    // UTILITY FUNCTIONS & NOMOR URUT AMAN
    // =================================================================
    
    const formatRupiah = (angka) => {
        return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka);
    };
    
    const formatDate = (timestamp) => {
        return (timestamp instanceof Timestamp ? timestamp.toDate() : new Date(timestamp)).toLocaleDateString('id-ID');
    };

    const cleanRupiah = (str) => {
        if (!str) return 0;
        // Hapus semua non-digit kecuali tanda koma/titik untuk desimal
        let cleaned = str.replace(/[^\d,\.]/g, ''); 
        // Konversi koma ke titik (jika format desimal Indonesia)
        cleaned = cleaned.replace(/\./g, '').replace(/,/g, ''); 
        return parseInt(cleaned) || 0;
    };


    const getNextNoTransaksi = async () => {
        const counterRef = doc(db, "metadata", "global_counter");
        let newNo = 0;
        
        try {
            await runTransaction(db, async (transaction) => {
                const counterDoc = await transaction.get(counterRef);
                newNo = (counterDoc.exists() && typeof counterDoc.data().last_no === 'number') ? counterDoc.data().last_no + 1 : 1;
                transaction.set(counterRef, { last_no: newNo });
            });
            return newNo; 
        } catch (e) {
            console.error("Gagal mendapatkan nomor urut: ", e);
            throw new Error("Gagal mengamankan nomor urut transaksi. Cek Firestore Rules.");
        }
    };

    // =================================================================
    // CRUD ACTIONS (Edit & Delete)
    // =================================================================
    window.editTransaksi = async (docId) => {
        alert(`[K-14] Fungsi Edit untuk ID: ${docId} Belum diaktifkan. Anda harus membuat Form Pop-up untuk mengisi ulang data!`);
    };

    window.deleteTransaksi = async (docId, noTransaksi, isDonasi = false) => {
        if (!confirm("Apakah Anda yakin ingin menghapus transaksi ini?")) return;
        
        try {
            await deleteDoc(doc(db, "jurnal_kas", docId));
            
            if (isDonasi) {
                // Hapus entri yang sesuai di donatur_khaul
                const q = query(collection(db, 'donatur_khaul'), where('no', '==', noTransaksi));
                const snapshot = await getDocs(q);
                snapshot.forEach(async (doc) => {
                    await deleteDoc(doc(db, "donatur_khaul", doc.id));
                });
            }
            
            alert("Transaksi berhasil dihapus!");
            displayJurnalKas(); 
        } catch (e) {
            alert("Gagal menghapus transaksi. Cek Konsol/Rules Firebase.");
        }
    };

    // =================================================================
    // DATA EXCEL LAMA ANDA (UNTUK IMPORT SATU KALI)
    // =================================================================
    const dataToImport = [
        {
            "No": 1, "Tanggal": "21-11-2025", "Nama donatur": "Sarpin", "Alamat": "Gowangkong 1/10 Ngablak", 
            "Jariyah": "2,000,000", "Total Jariyah": "2,000,000", 
            "No__1": 1, "Tanggal__1": "21-11-2025", "Uraian": "ongkos kiai ceramah", 
            "Kategori": "bayar kiai", "Dana masuk": "10,000,000", "Dana Keluar": "1,000,000"
        },
        {
            "No": 2, "Tanggal": "21-11-2025", "Nama donatur": "ngadiyo", "Alamat": "Gowangkong 1/10 Ngablak", 
            "Jariyah": "2,000,000", "Total Jariyah": "4,000,000", 
            "No__1": 2, "Tanggal__1": "21-11-2025", "Uraian": "ongkos kataman", 
            "Kategori": "bayar kataman", "Dana masuk": "", "Dana Keluar": "600,000"
        },
        {
            "No": 3, "Tanggal": "21-11-2025", "Nama donatur": "ngarpani", "Alamat": "Gowangkong 1/10 Ngablak", 
            "Jariyah": "2,000,000", "Total Jariyah": "6,000,000", 
            "No__1": 3, "Tanggal__1": "21-11-2025", "Uraian": "ongkos konsumsi", 
            "Kategori": "bayar konsumsi", "Dana masuk": "", "Dana Keluar": "1,500,000"
        },
        {
            "No": 4, "Tanggal": "21-11-2025", "Nama donatur": "sular", "Alamat": "Gowangkong 1/10 Ngablak", 
            "Jariyah": "2,000,000", "Total Jariyah": "8,000,000", 
            "No__1": 4, "Tanggal__1": "21-11-2025", "Uraian": "sewa tratak", 
            "Kategori": "bayar persewaan", "Dana masuk": "", "Dana Keluar": "700,000"
        },
        {
            "No": 5, "Tanggal": "21-11-2025", "Nama donatur": "sutris", "Alamat": "Gowangkong 1/10 Ngablak", 
            "Jariyah": "2,000,000", "Total Jariyah": "10,000,000", 
            "No__1": 5, "Tanggal__1": "21-11-2025", "Uraian": "bayar panitia", 
            "Kategori": "bayar pekerja", "Dana masuk": "", "Dana Keluar": "500,000"
        },
        {
            "No__1": 6, "Tanggal__1": "21-11-2025", "Uraian": "Bayar kiai kataman", 
            "Kategori": "bayar kiai", "Dana masuk": "", "Dana Keluar": "500,000",
        }
    ];

    async function importOldData() {
        console.log("Memulai proses impor data lama...");
        
        let currentNo = 0; 
        const totalDonasi = cleanRupiah(dataToImport[4]["Total Jariyah"]); 
        
        // 1. IMPOR DONASI TOTAL (SATU TRANSAKSI JURNAL)
        if (totalDonasi > 0) {
            currentNo = await getNextNoTransaksi(); 
            await addDoc(collection(db, "jurnal_kas"), {
                no: currentNo,
                tanggal: new Date("2025-11-21"), 
                uraian: "Transfer Saldo Awal/Total Donasi Massal",
                kategori: "Dana Masuk (Donasi)",
                jenis_transaksi: "MASUK",
                jumlah: totalDonasi
            });
            console.log(`[IMPOR JURNAL] Berhasil mencatat Saldo Awal No: ${currentNo}`);
        }


        // 2. IMPOR PENGELUARAN (ENAM TRANSAKSI JURNAL)
        for (let i = 0; i < dataToImport.length; i++) {
            const item = dataToImport[i];
            
            const danaKeluar = cleanRupiah(item["Dana Keluar"]);
            if (danaKeluar > 0) {
                currentNo = await getNextNoTransaksi(); 
                
                await addDoc(collection(db, "jurnal_kas"), {
                    no: currentNo,
                    tanggal: new Date(`2025-11-21`), 
                    uraian: item["Uraian"],
                    kategori: item["Kategori"],
                    jenis_transaksi: "KELUAR",
                    jumlah: danaKeluar
                });
                console.log(`[IMPOR JURNAL] Berhasil mencatat Pengeluaran No: ${currentNo} (${item["Uraian"]})`);
            }
        }
        
        // 3. IMPOR DETAIL DONATUR (LIMA TRANSAKSI DONATUR_KHAUL)
        for (let i = 0; i < 5; i++) {
            const item = dataToImport[i];
            
            await addDoc(collection(db, "donatur_khaul"), {
                no: item["No"], 
                tanggal: new Date(`2025-11-21`),
                nama_donatur: item["Nama donatur"],
                alamat: item["Alamat"],
                jariyah: cleanRupiah(item["Jariyah"]),
                total_jariyah: cleanRupiah(item["Jariyah"]),
            });
            console.log(`[IMPOR DONATUR] Berhasil mencatat Donatur: ${item["Nama donatur"]}`);
        }

        console.log("Proses impor data lama selesai!");
        alert("SEMUA DATA LAMA BERHASIL DIIMPOR KE FIREBASE! Silakan cek Dashboard.");
    }
    
    // =================================================================
    // 1. INPUT DONASI (PEMASUKAN) - Kode sama seperti sebelumnya
    // =================================================================
    document.getElementById('formDonasi').addEventListener('submit', async (e) => { /* ... kode donasi ... */ });

    // =================================================================
    // 2. INPUT PENGELUARAN - Kode sama seperti sebelumnya
    // =================================================================
    function loadKategori() { /* ... kode load kategori ... */ }
    document.getElementById('formPengeluaran').addEventListener('submit', async (e) => { /* ... kode pengeluaran ... */ });

    // =================================================================
    // 3. TAMPILAN SALDO BERJALAN & PDF - Kode sama seperti sebelumnya
    // =================================================================
    async function displayJurnalKas() { /* ... kode display jurnal kas ... */ }
    document.getElementById('downloadLaporanLPJ').addEventListener('click', async () => { /* ... kode PDF LPJ ... */ });
    document.getElementById('downloadListDonatur').addEventListener('click', async () => { /* ... kode PDF Donatur ... */ });
    document.getElementById('downloadPengeluaranDetail').addEventListener('click', async () => { /* ... kode PDF Detail ... */ });

    // =================================================================
    // INITIATION CALLS
    // =================================================================
    window.onload = () => {
         loadKategori();
         displayJurnalKas();
         
         // PENTING: Panggil importOldData() HANYA SEKALI!
         // Hapus tanda '//' untuk menjalankan impor saat file dibuka pertama kali.
         // importOldData();
    };
</script>
</body>

</html>
