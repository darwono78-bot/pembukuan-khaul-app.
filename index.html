<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catatan Pembukuan Donatur Haul (Final)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        // Konfigurasi Tailwind CSS
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Warna diambil dari contoh gambar Anda
                        'dark-green': '#1a472a', 
                        'medium-green': '#2b6e49', 
                        'yellow-accent': '#ffeb3b', // Nilai ini adalah #ffeb3b
                        'red-danger': '#ef5350', 
                        'text-light': '#e0e0e0', 
                    }
                }
            }
        }
    </script>
    
    <style>
        /* --- STYLE GLOBAL & GLOW FINAL --- */
        
        /* 1. Body Background: HIJAU PALING GELAP (#052600) */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #052600; 
            color: #e0e0e0;
        }
        
        /* 2. STYLE UTAMA: Bingkai Konten */
        .max-w-6xl {
            position: relative; 
            z-index: 10;
            background-color: #1a472a; 
            border-radius: 0.75rem;

            /* A. Border Kuning: Tipis */
            border: 2px solid #fff352; 

            /* B. Box-Shadow untuk Glow Menengah (Inti Sinar) - KEMBALI DITAMBAHKAN */
            box-shadow: 
                0 0 10px rgba(255, 235, 59, 1), 
                0 0 25px rgba(255, 235, 59, 0.7); 

            /* C. Filter Drop-Shadow untuk Glow Terluar (Sinar Menyebar) - KEMBALI DITAMBAHKAN */
            filter: 
                drop-shadow(0 0 15px rgba(255, 235, 59, 0.5)) 
                drop-shadow(0 0 30px rgba(255, 235, 59, 0.3)); 
        }
        
        /* 3. Warna Inner Content: Lebih Gelap (#1D4F31) */
        .bg-medium-green {
            background-color: #1D4F31; 
        }

        /* --- UTILITY CSS --- */
        
        /* Menghilangkan panah pada input number */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none;
          margin: 0;
        }
        ::placeholder {
            color: #a0a0a0;
            opacity: 1;
        }
        /* Mengubah warna ikon kalender pada input date menjadi putih */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
        
        /* Style untuk Tabel Header */
        #donatur-table th {
            font-size: 0.75rem; /* text-xs */
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
            text-align: center; 
        }
        
        /* Style untuk Konten Tabel (Baris Data) */
        #donatur-table td {
            padding: 0.75rem 1rem; 
            vertical-align: top;
            font-weight: normal; 
            font-size: 0.875rem; /* Ukuran default untuk teks data lain */
            text-align: right; /* Default rata kanan untuk semua kolom data */
        }
        
        /* Ukuran & Warna Angka Rupiah di BARIS DATA (PUTIH) */
        #donatur-table .kolom-nilai-alokasi { 
            font-size: 1rem; 
            color: #e0e0e0; /* PUTIH (text-light) */
            font-weight: normal; 
        }
        
        /* Ukuran & Warna Teks Nama Donatur & Alamat (PUTIH) */
        #donatur-table .kolom-nama-alamat { 
            font-size: 1rem; 
            color: #e0e0e0; /* PUTIH (text-light) */
        }


        /* Override untuk kolom teks agar rata kiri/tengah */
        #donatur-table .kolom-no {
            text-align: center;
        }
        #donatur-table .kolom-tanggal {
            text-align: left;
        }
        #donatur-table .kolom-nama {
            text-align: left;
        }
        #donatur-table .kolom-alamat {
            text-align: left;
        }
        
        /* Wrapper Tabel */
        .table-wrapper {
            box-shadow: 0 0 15px rgba(255, 235, 59, 0.2); 
            border: 1px solid #ffeb3b; 
        }
        
        /* Penyesuaian lebar kolom agar rapi */
        #donatur-table .nilai-kolom, .alokasi-kolom {
            width: 120px; 
            min-width: 120px;
        }
        #donatur-table .kolom-no {
            width: 40px; 
        }
        #donatur-table .kolom-tanggal {
            width: 100px; 
            min-width: 100px;
        }
        
        /* --- STYLE KHUSUS UNTUK FOOTER TOTAL --- */
        
        /* Style untuk Label "TOTAL KESELURUHAN:" (KUNING) */
        #donatur-table tfoot td {
            font-weight: bold;
            font-size: 2.00rem; 
            color: #ffeb3b; /* KUNING (yellow-accent) */
        }

        /* Angka Rupiah di Baris Total (Footer) KUNING */
        #donatur-table tfoot .total-angka-rupiah { 
            font-size: 1.25rem; 
            color: #ffeb3b; /* KUNING (yellow-accent) */
            font-weight: normal; 
        }
    </style>
</head>
<body class="p-4 sm:p-10">

    <div class="max-w-6xl mx-auto rounded-xl shadow-2xl">
        
        <div class="bg-dark-green text-text-light py-4 px-6 flex justify-center items-center">
            <h1 class="text-3xl font-bold text-center text-yellow-accent">
                Catatan Pembukuan Donatur Haul
            </h1>
        </div>

        
        <div class="bg-medium-green p-8 text-text-light">

            <h2 class="text-2xl font-bold mb-4 text-yellow-accent border-b border-yellow-accent/50 pb-3">
                Ringkasan Data Transaksi
            </h2>
            <div class="table-wrapper overflow-x-auto shadow-lg rounded-xl mb-10">
                <table id="donatur-table" class="min-w-full divide-y divide-text-light/20">
                    <thead class="bg-dark-green/80 text-text-light">
                        <tr>
                            <th class="px-4 py-3 text-left font-bold uppercase tracking-wider rounded-tl-xl kolom-no">NO</th>
                            <th class="px-4 py-3 text-left font-bold uppercase tracking-wider kolom-tanggal">TANGGAL</th>
                            <th class="px-4 py-3 text-left font-bold uppercase tracking-wider kolom-nama">NAMA DONATUR</th>
                            <th class="px-4 py-3 text-left font-bold uppercase tracking-wider kolom-alamat">ALAMAT</th>
                            <th class="px-4 py-3 font-bold uppercase tracking-wider nilai-kolom">NILAI (RP)</th> 
                            <th class="px-4 py-3 font-bold uppercase tracking-wider alokasi-kolom">PERAWATAN MAKAM (15%)</th>
                            <th class="px-4 py-3 font-bold uppercase tracking-wider alokasi-kolom">BISYAROH PANITIA (15%)</th>
                            <th class="px-4 py-3 font-bold uppercase tracking-wider rounded-tr-xl alokasi-kolom">BIAYA HAUL (70%)</th>
                        </tr>
                    </thead>
                    <tbody id="donatur-table-body" class="bg-medium-green/50 divide-y divide-text-light/10">
                        <tr><td colspan="8" class="py-6 text-center text-text-light/70">Memuat data...</td></tr>
                    </tbody>
                    <tfoot>
                        <tr class="bg-dark-green/80 font-extrabold border-t-2 border-yellow-accent">
                            <td colspan="4" class="px-4 py-3 text-right">TOTAL KESELURUHAN:</td> 
                            
                            <td id="total-donasi-input" class="px-4 py-3 text-right total-angka-rupiah">0</td> 
                            <td id="total-perawatan-makam" class="px-4 py-3 text-right total-angka-rupiah">0</td> 
                            <td id="total-bisyaroh-panitia" class="px-4 py-3 text-right total-angka-rupiah">0</td> 
                            <td id="total-biaya-haul" class="px-4 py-3 text-right total-angka-rupiah">0</td> 
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div id="donasi-input-container" class="p-6 rounded-xl bg-dark-green/50 shadow-lg mb-10 hidden">
                <h2 class="text-2xl font-bold mb-6 text-yellow-accent border-b border-yellow-accent/50 pb-3">
                    Input Data Donatur Baru
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="date" id="donatur-date-input" class="p-3 border border-text-light/30 rounded-lg w-full bg-medium-green/50 text-text-light focus:ring-yellow-accent focus:border-yellow-accent" required>
                    
                    <input type="text" id="donatur-name-input" class="p-3 border border-text-light/30 rounded-lg w-full bg-medium-green/50 text-text-light placeholder:text-text-light/60 focus:ring-yellow-accent focus:border-yellow-accent" placeholder="Nama Donatur (Contoh: Saripin)" required>
                    
                    <input type="text" id="donatur-alamat-input" class="p-3 border border-text-light/30 rounded-lg w-full bg-medium-green/50 text-text-light placeholder:text-text-light/60 focus:ring-yellow-accent focus:border-yellow-accent" placeholder="Alamat (Contoh: Ngablak)" required>
                    
                    <input type="number" id="donasi-nilai-input" class="p-3 border border-text-light/30 rounded-lg w-full bg-medium-green/50 text-text-light placeholder:text-text-light/60 focus:ring-yellow-accent focus:border-yellow-accent text-right" placeholder="Nilai Donasi (Rp)" required>
                </div>
                
                <button onclick="addDonatur()" class="bg-yellow-accent text-dark-green py-3 px-6 rounded-lg hover:bg-yellow-accent/90 w-full font-bold transition duration-150 shadow-md mt-6">
                    Simpan Donasi & Alokasikan Dana
                </button>
            </div>
            
            <div class="p-4 rounded-xl bg-dark-green/50 shadow-inner">
                
                <div id="login-form-container" class="flex flex-grow justify-end items-center gap-4">
                    <input type="email" id="admin-email-input" class="p-2 border border-text-light/30 rounded bg-medium-green/50 text-text-light placeholder:text-text-light/60 focus:ring-yellow-accent focus:border-yellow-accent" placeholder="Email Admin" value="darwono78@gmail.com" required>
                    <input type="password" id="admin-password-input" class="p-2 border border-text-light/30 rounded bg-medium-green/50 text-text-light placeholder:text-text-light/60 focus:ring-yellow-accent focus:border-yellow-accent" placeholder="Password Admin" value="haul2025" required>
                    <button onclick="adminLogin()" class="bg-yellow-accent text-dark-green py-2 px-4 rounded hover:bg-yellow-accent/90 font-semibold transition duration-150 shadow-md">
                        Login Admin
                    </button>
                </div>
                
                <div id="admin-actions-container" class="hidden mt-4">
                    <div class="flex justify-between items-center gap-4">
                        <button onclick="confirmResetData()" class="bg-red-danger text-white py-2 px-4 rounded hover:bg-red-danger/90 text-sm transition duration-150 shadow-md">
                            Reset Data (Hapus Permanen)
                        </button>
                        
                        <button onclick="adminLogout()" class="bg-red-danger text-white py-2 px-4 rounded hover:bg-red-danger/90 text-sm transition duration-150 shadow-md">
                            Logout
                        </button>
                    </div>
                    <p class="text-sm font-semibold mt-3 text-yellow-accent/80 text-right">Mode Admin Aktif.</p>
                </div>
            </div>
            
        </div>
        
    </div>

    <script type="module">
        
        // --------------------------------------------------------------------------------
        // 1. FIREBASE SETUP DAN KONFIGURASI
        // --------------------------------------------------------------------------------
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp, writeBatch, doc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        
        // Konfigurasi Firebase Anda
        const firebaseConfig = {
            apiKey: "AIzaSyAHIO0RZgoq6eyjeERTpjOugzJLzqG2S-w",
            authDomain: "catatan-keuangan-haul.firebaseapp.com",
            projectId: "catatan-keuangan-haul",
            storageBucket: "catatan-keuangan-haul.appspot.com", 
            messagingSenderId: "955355049778", 
            appId: "1:955355049778:web:0b844b27b82a88cc0cf12b" 
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const donaturCol = collection(db, "transaksi_haul"); 

        let allDonatur = []; 
        let isAdminLoggedIn = false; 
        
        // Konstanta Prosentase Alokasi
        const PERSENTASE = {
            PERAWATAN_MAKAM: 0.15, // 15%
            BISYAROH_PANITIA: 0.15, // 15%
            BIAYA_HAUL: 0.70     // 70%
        };

        // --------------------------------------------------------------------------------
        // 2. HELPER FUNCTIONS
        // --------------------------------------------------------------------------------

        const formatRupiah = (angka) => {
            if (typeof angka !== 'number' || isNaN(angka)) return '0'; 
            const sign = angka < 0 ? '-' : '';
            const absoluteAngka = Math.abs(Math.floor(angka));
            const numberString = absoluteAngka.toString();
            const rupiah = numberString.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            return sign + rupiah;
        };
        
        // Fungsi untuk menghitung alokasi dana dari nilai donasi
        const calculateAlokasi = (nilai) => {
            const nilaiDonasi = parseFloat(nilai) || 0;
            if (nilaiDonasi <= 0) {
                 return { perawatan_makam: 0, bisyaroh_panitia: 0, biaya_haul: 0 };
            }
            
            const perawatan_makam = Math.round(nilaiDonasi * PERSENTASE.PERAWATAN_MAKAM);
            const bisyaroh_panitia = Math.round(nilaiDonasi * PERSENTASE.BISYAROH_PANITIA);
            const biaya_haul = nilaiDonasi - perawatan_makam - bisyaroh_panitia;
            
            return { perawatan_makam, bisyaroh_panitia, biaya_haul };
        }

        const updateFooter = (id, value) => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = formatRupiah(value); 
            }
        };
        
        const updateAdminView = () => {
            const isLogged = isAdminLoggedIn;
            
            document.getElementById('login-form-container')?.classList.toggle('hidden', isLogged);
            document.getElementById('admin-actions-container')?.classList.toggle('hidden', !isLogged);
            document.getElementById('donasi-input-container')?.classList.toggle('hidden', !isLogged);
        };

        // --------------------------------------------------------------------------------
        // 3. FIREBASE AUTH & ADMIN ACTIONS
        // --------------------------------------------------------------------------------

        onAuthStateChanged(auth, (user) => {
            if (user) {
                isAdminLoggedIn = true;
            } else {
                isAdminLoggedIn = false;
            }
            updateAdminView();
            loadAndRenderDonatur(); 
        });


        window.adminLogin = async () => {
            const email = document.getElementById('admin-email-input').value;
            const password = document.getElementById('admin-password-input').value;
            
            if (!email || !password) {
                alert('Mohon masukkan Email dan Password Admin.');
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
                
            } catch (error) {
                console.error("Login Error:", error.code);
                let errorMessage = 'Login Gagal. ';
                if (error.code === 'auth/wrong-password') {
                    errorMessage += 'Password salah.';
                } else if (error.code === 'auth/user-not-found') {
                    errorMessage += 'Akun Admin tidak ditemukan.';
                } else {
                    errorMessage += 'Terjadi kesalahan sistem.';
                }
                alert(errorMessage);
            }
        };

        window.adminLogout = async () => {
            if (confirm('Anda yakin ingin keluar dari mode Bendahara?')) {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error("Logout Error:", error);
                    alert(`Logout Gagal: ${error.message}`);
                }
            }
        };
        
        window.confirmResetData = async () => {
             if (!isAdminLoggedIn) return alert('Hanya Bendahara yang dapat mereset data.');
             
             if (!confirm('PERINGATAN! Anda yakin ingin MENGHAPUS SEMUA data Donasi? Tindakan ini tidak bisa dibatalkan.')) return;
             
             if (!confirm('KONFIRMASI TERAKHIR: Ini akan menghapus PERMANEN semua donasi di Firebase. LANJUTKAN?')) return;
             
             try {
                const donaturSnapshot = await getDocs(donaturCol);
                const batch = writeBatch(db); 
                
                donaturSnapshot.docs.forEach((d) => {
                    batch.delete(doc(db, "transaksi_haul", d.id));
                });
                
                await batch.commit();

                alert('SEMUA DATA DONASI BERHASIL DIHAPUS PERMANEN DARI FIREBASE.');
                await loadAndRenderDonatur();
             } catch (error) {
                 console.error("Gagal mereset data:", error);
                 alert('Gagal menghapus data di Firestore. Cek console log.');
             }
        };


        // --------------------------------------------------------------------------------
        // 4. FIRESTORE CRUD (CREATE & READ)
        // --------------------------------------------------------------------------------

        const loadAndRenderDonatur = async () => {
            allDonatur = [];
            const tableBody = document.getElementById('donatur-table-body');
            tableBody.innerHTML = `<tr><td colspan="8" class="py-6 text-center text-text-light/70">Memuat data dari Firebase...</td></tr>`;

            try {
                const donaturQuery = query(donaturCol, orderBy("timestamp", "asc")); 
                const donaturSnapshot = await getDocs(donaturQuery);

                donaturSnapshot.forEach(doc => {
                    const data = doc.data();
                    const nilaiDonasi = parseFloat(data.nilai || data.danaMasuk || 0);

                    let alokasiData = data.alokasi;
                    
                    if (!alokasiData || 
                        alokasiData.perawatan_makam === undefined || 
                        alokasiData.bisyaroh_panitia === undefined ||
                        alokasiData.biaya_haul === undefined) 
                    {
                        alokasiData = calculateAlokasi(nilaiDonasi);
                    }

                    allDonatur.push({
                        id: doc.id, 
                        date: data.date,
                        nama: data.nama || data.uraian || 'Tanpa Nama',
                        alamat: data.alamat || '-',
                        nilai: nilaiDonasi, 
                        alokasi: alokasiData,
                        timestamp: data.timestamp ? data.timestamp.toMillis() : new Date(data.date).getTime(), 
                    });
                });
                
                renderDonaturTable();
                
            } catch (error) {
                console.error("Gagal memuat data dari Firestore:", error);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="py-6 text-center text-red-danger">
                            ðŸ”´ GAGAL MEMUAT DATA. Cek Koneksi Internet atau Konfigurasi Firebase.
                        </td>
                    </tr>`;
            }
        };
        
        window.addDonatur = async () => {
            if (!isAdminLoggedIn) return alert('Hanya Bendahara yang dapat menginput data. Mohon Login terlebih dahulu.');

            const date = document.getElementById('donatur-date-input').value;
            const nama = document.getElementById('donatur-name-input').value; 
            const alamat = document.getElementById('donatur-alamat-input').value;
            let nilai = parseInt(document.getElementById('donasi-nilai-input').value) || 0;
            
            if (!date || !nama || !nilai || nilai <= 0) {
                alert('Mohon isi Tanggal, Nama Donatur, dan Nilai Donasi yang valid.');
                return;
            }
            
            const alokasiHitungan = calculateAlokasi(nilai);
            
            const newDonasi = {
                date: date,
                nama: nama,
                alamat: alamat,
                nilai: nilai, 
                alokasi: alokasiHitungan,
                timestamp: serverTimestamp() 
            };

            try {
                await addDoc(donaturCol, newDonasi);
                
                document.getElementById('donatur-name-input').value = '';
                document.getElementById('donatur-alamat-input').value = '';
                document.getElementById('donasi-nilai-input').value = '';
                
                alert('Donasi berhasil ditambahkan & dana dialokasikan!');
                await loadAndRenderDonatur(); 
            } catch (error) {
                console.error("Gagal menambahkan Donasi:", error);
                alert("Gagal menyimpan donasi. Cek console log.");
            }
        };


        // --------------------------------------------------------------------------------
        // 5. RENDER DATA (LOGIC TOTAL & PROSENTASE)
        // --------------------------------------------------------------------------------

        const renderDonaturTable = () => {
            const tableBody = document.getElementById('donatur-table-body');
            tableBody.innerHTML = '';
            
            let totalDonasiInput = 0;
            let totalPerawatanMakam = 0;
            let totalBisyarohPanitia = 0;
            let totalBiayaHaul = 0;
            
            if (allDonatur.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="8" class="py-6 text-center text-text-light/70">Belum ada data donasi yang dicatat.</td></tr>`;
                updateFooter('total-donasi-input', 0); 
                updateFooter('total-perawatan-makam', 0); 
                updateFooter('total-bisyaroh-panitia', 0); 
                updateFooter('total-biaya-haul', 0); 
                return;
            }

            allDonatur.forEach((d, index) => {
                const nilaiDonasi = parseFloat(d.nilai) || 0;
                const pm = parseFloat(d.alokasi.perawatan_makam) || 0;
                const bp = parseFloat(d.alokasi.bisyaroh_panitia) || 0;
                const bh = parseFloat(d.alokasi.biaya_haul) || 0;
                
                totalDonasiInput += nilaiDonasi;
                totalPerawatanMakam += pm;
                totalBisyarohPanitia += bp;
                totalBiayaHaul += bh;

                const row = tableBody.insertRow();
                
                const dateObj = new Date(d.date + 'T00:00:00');
                const formattedDate = dateObj.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' });
                
                row.innerHTML = `
                    <td class="px-4 py-3 kolom-no">${index + 1}</td>
                    <td class="px-4 py-3 kolom-tanggal">${formattedDate}</td>
                    <td class="px-4 py-3 kolom-nama kolom-nama-alamat">${d.nama}</td> 
                    <td class="px-4 py-3 kolom-alamat kolom-nama-alamat">${d.alamat}</td> 
                    <td class="px-4 py-3 text-right kolom-nilai-alokasi">${formatRupiah(nilaiDonasi)}</td> 
                    <td class="px-4 py-3 text-right kolom-nilai-alokasi">${formatRupiah(pm)}</td> 
                    <td class="px-4 py-3 text-right kolom-nilai-alokasi">${formatRupiah(bp)}</td> 
                    <td class="px-4 py-3 text-right kolom-nilai-alokasi">${formatRupiah(bh)}</td> 
                `;
            });

            // Update Footer Total
            updateFooter('total-donasi-input', totalDonasiInput);
            updateFooter('total-perawatan-makam', totalPerawatanMakam); 
            updateFooter('total-bisyaroh-panitia', totalBisyarohPanitia); 
            updateFooter('total-biaya-haul', totalBiayaHaul); 
            
            // Pengecekan konsistensi
            const totalAkumulasiAlokasi = totalPerawatanMakam + totalBisyarohPanitia + totalBiayaHaul;
            if (Math.round(totalDonasiInput) !== Math.round(totalAkumulasiAlokasi)) {
                console.error(`ERROR KONSISTENSI TOTAL: Total Input (${totalDonasiInput}) tidak sama dengan Total Alokasi (${totalAkumulasiAlokasi}). Selisih Pembulatan: ${totalDonasiInput - totalAkumulasiAlokasi}`);
                if (isAdminLoggedIn) {
                     alert(`Peringatan: Total Donasi (${formatRupiah(totalDonasiInput)}) tidak sama dengan Total Alokasi (${formatRupiah(totalAkumulasiAlokasi)}). Selisih Pembulatan: ${formatRupiah(totalDonasiInput - totalAkumulasiAlokasi)}`);
                }
            }
        };

        // --------------------------------------------------------------------------------
        // 6. INISIALISASI
        // --------------------------------------------------------------------------------

        window.onload = () => {
            const today = new Date().toLocaleDateString('en-CA');
            const dateInput = document.getElementById('donatur-date-input');
            if (dateInput) {
                dateInput.value = today;
            }
        };
    </script>
</body>
</html>


