<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pembukuan Khaul - Kas Umum (Donatur & Pengeluaran)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .container-app {
            max-width: 1200px; /* Lebar maksimum diperbesar */
        }
        .input-field {
            @apply w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-150;
        }
        .header-title {
            @apply text-3xl font-bold text-center text-white mb-6 p-4 rounded-lg shadow-inner;
        }
        .section-title {
            @apply text-xl font-semibold text-gray-700 border-b pb-2 mb-4 mt-8;
        }
        .btn-action {
            @apply font-bold py-3 px-6 rounded-lg transition duration-150 shadow-md hover:shadow-lg w-full;
        }
        .grid-form {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        .grid-form button {
            grid-column: span 2;
        }
        @media (max-width: 640px) {
             .grid-form {
                grid-template-columns: 1fr;
            }
            .grid-form button {
                grid-column: span 1;
            }
        }
    </style>

    <script type="module">
        
        // --- VARIABEL GLOBAL & UTILITY ---
        // Ganti Storage Key agar data lama tidak bentrok dengan struktur baru
        const STORAGE_KEY_JURNAL = 'khaul_jurnal_umum_transaksi'; 
        let allTransactions = []; 
        
        // Konstanta Persentase Donatur
        const PERAWATAN_MAKAM = 0.15; // 15%
        const ONGKOS_PANITIA = 0.15; // 15%
        const BIAYA_KHAUL = 0.70; // 70%
        
        // Kategori LPJ (Digunakan untuk Pengeluaran)
        const KATEGORI_PENGELUARAN = [
            "Ongkos Kiai", "Bayar Kataman", "Bayar Konsumsi", "Bayar Persewaan", "Bayar Pekerja", "Lain-lain"
        ];

        const formatRupiah = (angka) => {
            if (angka === undefined || angka === null) return 'Rp 0';
            const num = Math.round(angka); 
            return 'Rp ' + num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        };

        // --- DATA HANDLING (localStorage) ---

        const loadTransactions = () => {
            try {
                const data = localStorage.getItem(STORAGE_KEY_JURNAL);
                allTransactions = data ? JSON.parse(data) : [];
                
                // Pastikan nilai uang adalah Number
                allTransactions = allTransactions.map(t => ({
                    ...t,
                    nilai: Number(t.nilai) || 0,
                    timestamp: Number(t.timestamp) || 0
                }));

            } catch (error) {
                console.error("Gagal memuat data dari localStorage:", error);
                allTransactions = [];
            }
            renderTables(allTransactions);
        };

        const saveTransactions = () => {
            localStorage.setItem(STORAGE_KEY_JURNAL, JSON.stringify(allTransactions));
        };
        
        // --- INPUT & FORM FUNCTIONS ---

        const handleCatatDonasi = () => {
            const tanggal = document.getElementById('tanggal-donasi-input').value;
            const namaDonatur = document.getElementById('nama-donatur-input').value;
            const alamat = document.getElementById('alamat-input').value;
            const jumlahJariyah = Number(document.getElementById('jumlah-jariyah-input').value);

            if (!tanggal || !namaDonatur || !alamat || jumlahJariyah <= 0) {
                alert("Semua kolom Donatur wajib diisi.");
                return;
            }
            
            const newTransaction = {
                id: Date.now(),
                type: 'masuk', // Tipe Transaksi
                tanggal: tanggal,
                timestamp: new Date(tanggal).getTime(),
                nama: namaDonatur,
                alamat: alamat,
                uraian: 'Donasi Jariyah',
                kategori: 'Donatur', // Kategori LPJ Dana Masuk
                nilai: jumlahJariyah, 
            };

            allTransactions.push(newTransaction);
            saveTransactions();
            renderTables(allTransactions);
            alert(`Donasi dari ${namaDonatur} sejumlah ${formatRupiah(jumlahJariyah)} berhasil dicatat!`);

            document.getElementById('form-catat-donasi').reset();
        };

        const handleCatatPengeluaran = () => {
            const tanggal = document.getElementById('tanggal-keluar-input').value;
            const uraian = document.getElementById('uraian-input').value;
            const kategori = document.getElementById('kategori-input').value;
            const jumlahKeluar = Number(document.getElementById('jumlah-keluar-input').value);

            if (!tanggal || !uraian || !kategori || jumlahKeluar <= 0) {
                alert("Semua kolom Pengeluaran wajib diisi.");
                return;
            }

            const newTransaction = {
                id: Date.now() + 1, // Pastikan ID berbeda dari donasi
                type: 'keluar', // Tipe Transaksi
                tanggal: tanggal,
                timestamp: new Date(tanggal).getTime(),
                nama: '-',
                alamat: '-',
                uraian: uraian,
                kategori: kategori, 
                nilai: jumlahKeluar, 
            };

            allTransactions.push(newTransaction);
            saveTransactions();
            renderTables(allTransactions);
            alert(`Pengeluaran untuk ${uraian} sejumlah ${formatRupiah(jumlahKeluar)} berhasil dicatat.`);
            
            document.getElementById('form-catat-pengeluaran').reset();
        };
        
        const handleDeleteTransaction = (id) => {
            if (confirm("Apakah Anda yakin ingin menghapus transaksi ini?")) {
                allTransactions = allTransactions.filter(t => t.id !== id);
                saveTransactions();
                renderTables(allTransactions);
                alert("Transaksi berhasil dihapus.");
            }
        };
        window.handleDeleteTransaction = handleDeleteTransaction; 

        // --- RENDER MAIN FUNCTION ---

        const renderTables = (data) => {
            // Urutkan semua transaksi berdasarkan waktu (ASCENDING) untuk perhitungan Saldo
            const sortedAscending = [...data].sort((a, b) => a.timestamp - b.timestamp);
            
            let runningBalance = 0;
            let totalDanaMasuk = 0;
            let totalDanaKeluar = 0;
            
            // Hitung Saldo Berjalan dan total akumulasi
            const processedTransactions = sortedAscending.map((t, index) => {
                const danaMasuk = t.type === 'masuk' ? t.nilai : 0;
                const danaKeluar = t.type === 'keluar' ? t.nilai : 0;

                runningBalance += danaMasuk;
                runningBalance -= danaKeluar;
                
                totalDanaMasuk += danaMasuk;
                totalDanaKeluar += danaKeluar;

                return { 
                    ...t, 
                    noUrut: index + 1,
                    danaMasuk: danaMasuk,
                    danaKeluar: danaKeluar,
                    saldoBerjalan: runningBalance
                };
            });
            
            // Render 1: Tabel Donatur (Hanya menampilkan transaksi 'masuk' dan prosentase)
            renderDonaturTable(processedTransactions.filter(t => t.type === 'masuk'), totalDanaMasuk);

            // Render 2: Tabel Jurnal Kas Umum (Menampilkan semua transaksi)
            renderJurnalTable(processedTransactions, totalDanaMasuk, totalDanaKeluar, runningBalance);
        };
        
        // --- RENDER 1: TABEL DONATUR (DANA MASUK + PROSENTASE) ---

        const renderDonaturTable = (donations, totalDanaMasuk) => {
            const tableBody = document.getElementById('donatur-table-body');
            tableBody.innerHTML = '';
            
            if (donations.length === 0) {
                 // Update Footer jika kosong
                document.getElementById('total-semua-donasi').textContent = formatRupiah(0);
                document.getElementById('total-makam').textContent = formatRupiah(0);
                document.getElementById('total-panitia').textContent = formatRupiah(0);
                document.getElementById('total-khaul').textContent = formatRupiah(0);
                tableBody.innerHTML = `<tr><td colspan="10" class="py-4 text-center text-gray-500">Belum ada data donatur yang dicatat.</td></tr>`;
                return;
            }
            
            let totalMakam = 0;
            let totalPanitia = 0;
            let totalKhaul = 0;

            donations.forEach((d, index) => {
                
                // Hitung Prosentase per baris
                const makam = Math.round(d.nilai * PERAWATAN_MAKAM);
                const panitia = Math.round(d.nilai * ONGKOS_PANITIA);
                const khaul = Math.round(d.nilai * BIAYA_KHAUL);
                
                totalMakam += makam;
                totalPanitia += panitia;
                totalKhaul += khaul;

                const row = tableBody.insertRow();
                const date = new Date(d.tanggal);
                const formattedDate = date.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
                
                row.className = index % 2 === 0 ? 'hover:bg-gray-50' : 'bg-gray-50 hover:bg-gray-100';
                
                // Kolom Donatur
                row.insertCell().textContent = d.noUrut;
                row.insertCell().textContent = formattedDate;
                row.insertCell().textContent = d.nama;
                row.insertCell().textContent = d.alamat;
                
                const nilaiCell = row.insertCell();
                nilaiCell.textContent = formatRupiah(d.nilai);
                nilaiCell.className = 'py-3 px-3 text-right text-blue-600';
                
                const totalJariyahCell = row.insertCell();
                totalJariyahCell.textContent = formatRupiah(d.saldoBerjalan); 
                totalJariyahCell.className = 'py-3 px-3 text-right font-bold text-green-700 bg-green-50';
                
                // Kolom Prosentase
                row.insertCell().textContent = formatRupiah(makam);
                row.insertCell().className = 'py-3 px-3 text-right bg-yellow-50 text-yellow-800';
                row.insertCell().textContent = formatRupiah(panitia);
                row.insertCell().className = 'py-3 px-3 text-right bg-yellow-50 text-yellow-800';
                row.insertCell().textContent = formatRupiah(khaul);
                row.insertCell().className = 'py-3 px-3 text-right bg-yellow-50 text-yellow-800';

                // Aksi
                const actionCell = row.insertCell();
                actionCell.className = 'py-3 px-3 text-center';
                actionCell.innerHTML = `<button onclick="window.handleDeleteTransaction(${d.id})" class="text-red-500 hover:text-red-700 font-bold p-1 rounded-full hover:bg-red-50 transition duration-150 text-xs">Hapus</button>`;
            });

            // Update Total Footer Donatur
            document.getElementById('total-semua-donasi').textContent = formatRupiah(totalDanaMasuk);
            document.getElementById('total-makam').textContent = formatRupiah(totalMakam);
            document.getElementById('total-panitia').textContent = formatRupiah(totalPanitia);
            document.getElementById('total-khaul').textContent = formatRupiah(totalKhaul);
        };

        // --- RENDER 2: TABEL JURNAL KAS UMUM (DANA MASUK & KELUAR) ---
        
        const renderJurnalTable = (transactions, totalMasuk, totalKeluar, saldoAkhir) => {
            const tableBody = document.getElementById('jurnal-table-body');
            tableBody.innerHTML = '';

            if (transactions.length === 0) {
                document.getElementById('total-dana-masuk-jurnal').textContent = formatRupiah(0);
                document.getElementById('total-dana-keluar-jurnal').textContent = formatRupiah(0);
                document.getElementById('saldo-akhir-jurnal').textContent = formatRupiah(0);
                tableBody.innerHTML = `<tr><td colspan="7" class="py-4 text-center text-gray-500">Belum ada transaksi di Jurnal Kas.</td></tr>`;
                return;
            }

            // Data sudah diurutkan ASCENDING, kita tampilkan saja
            transactions.forEach((t, index) => {
                const row = tableBody.insertRow();
                const date = new Date(t.tanggal);
                const formattedDate = date.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
                
                row.className = t.type === 'masuk' ? 'bg-green-50 hover:bg-green-100' : 'bg-red-50 hover:bg-red-100';

                // 1. No
                row.insertCell().textContent = t.noUrut;
                // 2. Tanggal
                row.insertCell().textContent = formattedDate;
                // 3. Uraian
                row.insertCell().textContent = t.uraian;
                // 4. Kategori LPJ (Hanya terlihat Admin, tapi kita tampilkan untuk verifikasi)
                row.insertCell().textContent = t.kategori;
                // 5. Dana Masuk
                const masukCell = row.insertCell();
                masukCell.textContent = formatRupiah(t.danaMasuk);
                masukCell.className = 'py-3 px-3 text-right font-bold text-green-700';
                // 6. Dana Keluar
                const keluarCell = row.insertCell();
                keluarCell.textContent = formatRupiah(t.danaKeluar);
                keluarCell.className = 'py-3 px-3 text-right font-bold text-red-700';
                // 7. Saldo Berjalan
                const saldoCell = row.insertCell();
                saldoCell.textContent = formatRupiah(t.saldoBerjalan);
                saldoCell.className = 'py-3 px-3 text-right font-bold';
                // 8. Aksi
                const actionCell = row.insertCell();
                actionCell.className = 'py-3 px-3 text-center';
                actionCell.innerHTML = `<button onclick="window.handleDeleteTransaction(${t.id})" class="text-red-500 hover:text-red-700 font-bold p-1 rounded-full hover:bg-red-50 transition duration-150 text-xs">Hapus</button>`;
            });

            // Update Total Footer Jurnal
            document.getElementById('total-dana-masuk-jurnal').textContent = formatRupiah(totalMasuk);
            document.getElementById('total-dana-keluar-jurnal').textContent = formatRupiah(totalKeluar);
            document.getElementById('saldo-akhir-jurnal').textContent = formatRupiah(saldoAkhir);
        };

        // --- SETUP DAN INISIALISASI ---

        const populateKategoriDropdown = () => {
            const select = document.getElementById('kategori-input');
            KATEGORI_PENGELUARAN.forEach(kategori => {
                const option = document.createElement('option');
                option.value = kategori;
                option.textContent = kategori;
                select.appendChild(option);
            });
        };

        const setupEventListeners = () => {
            document.getElementById('btn-catat-donasi').addEventListener('click', handleCatatDonasi);
            document.getElementById('btn-catat-keluar').addEventListener('click', handleCatatPengeluaran);
        };

        window.onload = () => {
            populateKategoriDropdown();
            loadTransactions(); 
            setupEventListeners();
        };

    </script>
</head>
<body class="p-4 sm:p-8">
    <div class="container-app mx-auto bg-white p-6 sm:p-10 rounded-xl shadow-2xl">
        
        <h1 class="header-title bg-green-600">
            Aplikasi Pembukuan Khaul - Jurnal Umum
        </h1>

        <div class="section-title border-green-500">
            1. Catat Donasi Jariyah (Dana Masuk)
        </div>
        <form id="form-catat-donasi" class="grid-form">
            <input type="text" id="tanggal-donasi-input" placeholder="Tanggal Donasi" class="input-field" onfocus="this.type='date'" onblur="if(!this.value)this.type='text'">
            <input type="text" id="nama-donatur-input" placeholder="Nama Donatur" class="input-field">
            <input type="text" id="alamat-input" placeholder="Alamat Donatur" class="input-field">
            
            <div class="relative">
                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">Rp</span>
                <input type="number" id="jumlah-jariyah-input" placeholder="Jumlah Jariyah (Angka saja)" class="input-field pl-10">
            </div>
            
            <button type="button" id="btn-catat-donasi" class="btn-action bg-green-600 hover:bg-green-700 text-white">
                Catat Dana Masuk
            </button>
        </form>

        <div class="section-title border-red-500 mt-10">
            2. Catat Pengeluaran (Dana Keluar)
        </div>
        <form id="form-catat-pengeluaran" class="grid-form">
            <input type="text" id="tanggal-keluar-input" placeholder="Tanggal Pengeluaran" class="input-field" onfocus="this.type='date'" onblur="if(!this.value)this.type='text'">
            <input type="text" id="uraian-input" placeholder="Uraian Pengeluaran" class="input-field">
            
            <select id="kategori-input" class="input-field">
                <option value="">-- Pilih Kategori LPJ (Dana Keluar) --</option>
                </select>
            
            <div class="relative">
                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">Rp</span>
                <input type="number" id="jumlah-keluar-input" placeholder="Jumlah Dana Keluar (Angka saja)" class="input-field pl-10">
            </div>
            
            <button type="button" id="btn-catat-keluar" class="btn-action bg-red-600 hover:bg-red-700 text-white">
                Catat Dana Keluar
            </button>
        </form>


        <div class="section-title border-blue-500">
            3. Laporan List Donatur Jariyah & Pembagian Prosentase
        </div>
        
        <div class="overflow-x-auto rounded-lg shadow-lg mb-12">
            <table class="min-w-full bg-white border border-gray-200">
                <thead>
                    <tr class="bg-gray-100 text-gray-600 uppercase text-xs leading-normal">
                        <th rowspan="2" class="py-3 px-3 text-center align-middle w-[3%]">No</th>
                        <th rowspan="2" class="py-3 px-3 text-center align-middle w-[10%]">Tanggal</th>
                        <th rowspan="2" class="py-3 px-3 text-left align-middle w-[15%]">Nama Donatur</th>
                        <th rowspan="2" class="py-3 px-3 text-left align-middle w-[15%]">Alamat Donatur</th>
                        <th rowspan="2" class="py-3 px-3 text-right align-middle w-[10%]">Nilai Rupiah Jariyah</th>
                        <th rowspan="2" class="py-3 px-3 text-right align-middle w-[10%] bg-green-200">Total Jariyah</th>
                        <th colspan="3" class="py-1 px-3 text-center bg-yellow-200 border-b border-gray-200">PROSENTASE PEMBAGIAN</th>
                        <th rowspan="2" class="py-3 px-3 text-center align-middle w-[5%]">Aksi</th>
                    </tr>
                    <tr class="bg-yellow-100 text-gray-700 uppercase text-xs leading-normal">
                         <th class="py-2 px-3 text-right w-[8%]">Perawatan Makam (15%)</th>
                         <th class="py-2 px-3 text-right w-[8%]">Ongkos Panitia (15%)</th>
                         <th class="py-2 px-3 text-right w-[8%]">Biaya Khaul (70%)</th>
                    </tr>
                </thead>
                <tbody id="donatur-table-body" class="text-gray-600 text-sm font-light divide-y divide-gray-200">
                    </tbody>
                <tfoot>
                    <tr class="bg-green-50 font-bold text-gray-800">
                        <td colspan="5" class="py-3 px-6 text-right text-lg">TOTAL KESELURUHAN:</td>
                        <td id="total-semua-donasi" class="py-3 px-6 text-right text-lg text-green-700 bg-green-100">Rp 0</td>
                        <td id="total-makam" class="py-3 px-6 text-right text-lg bg-yellow-200 text-yellow-800">Rp 0</td>
                        <td id="total-panitia" class="py-3 px-6 text-right text-lg bg-yellow-200 text-yellow-800">Rp 0</td>
                        <td id="total-khaul" class="py-3 px-6 text-right text-lg bg-yellow-200 text-yellow-800">Rp 0</td>
                        <td class="py-3 px-6 text-center"></td>
                    </tr>
                </tfoot>
            </table>
        </div>


        <div class="section-title border-gray-500">
            4. Jurnal Kas Umum (Dana Masuk, Dana Keluar, Saldo)
        </div>
        
        <div class="overflow-x-auto rounded-lg shadow-lg">
            <table class="min-w-full bg-white border border-gray-200">
                <thead>
                    <tr class="bg-gray-100 text-gray-600 uppercase text-xs leading-normal">
                        <th class="py-3 px-3 text-center w-[5%]">No</th>
                        <th class="py-3 px-3 text-center w-[10%]">Tanggal</th>
                        <th class="py-3 px-3 text-left w-[25%]">Uraian</th>
                        <th class="py-3 px-3 text-left w-[15%]">Kategori LPJ</th>
                        <th class="py-3 px-3 text-right w-[15%]">Dana Masuk</th>
                        <th class="py-3 px-3 text-right w-[15%]">Dana Keluar</th>
                        <th class="py-3 px-3 text-right w-[10%] bg-gray-200">Saldo</th>
                        <th class="py-3 px-3 text-center w-[5%]">Aksi</th>
                    </tr>
                </thead>
                <tbody id="jurnal-table-body" class="text-gray-600 text-sm font-light divide-y divide-gray-200">
                    </tbody>
                <tfoot>
                    <tr class="bg-gray-200 font-bold text-gray-800">
                        <td colspan="4" class="py-3 px-6 text-right text-lg">TOTAL AKHIR:</td>
                        <td id="total-dana-masuk-jurnal" class="py-3 px-6 text-right text-lg text-green-700">Rp 0</td>
                        <td id="total-dana-keluar-jurnal" class="py-3 px-6 text-right text-lg text-red-700">Rp 0</td>
                        <td id="saldo-akhir-jurnal" class="py-3 px-6 text-right text-lg bg-gray-300 text-blue-800">Rp 0</td>
                        <td class="py-3 px-6 text-center"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        
    </div> 
</body>
</html>
