<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pembukuan Transaksi Keuangan Haul</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dark-green': '#1a472a', // Main background green
                        'medium-green': '#2b6e49', // Card background green
                        'yellow-accent': '#ffeb3b', // Yellow for buttons/highlights
                        'red-danger': '#ef5350', // Red for danger actions
                        'text-light': '#e0e0e0', // Light text color
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            font-family: 'Roboto', sans-serif; /* Menggunakan font yang umum dan bersih */
            background-color: #1a472a; /* Warna hijau gelap untuk background */
            color: #e0e0e0; /* Warna teks default */
        }
        /* Hilangkan panah pada input type=number */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none;
          margin: 0;
        }
        /* Style untuk placeholder */
        ::placeholder {
            color: #a0a0a0;
            opacity: 1; /* Override default opacity */
        }
        /* Style untuk input date */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1); /* Membuat ikon kalender putih */
        }
        /* Style untuk select (dropdown) */
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%23e0e0e0'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd' /%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.7rem center;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
    </style>
</head>
<body class="bg-dark-green p-4 sm:p-10">

    <div class="max-w-6xl mx-auto rounded-xl shadow-2xl overflow-hidden">
        
        <div class="bg-dark-green text-text-light py-3 px-6 flex justify-end items-center border-b border-text-light/20">
            <div id="login-form-container" class="flex flex-grow justify-end items-center gap-4">
                <input type="email" id="admin-email-input" class="p-2 border border-text-light/30 rounded bg-medium-green/50 text-text-light placeholder:text-text-light/60 focus:ring-yellow-accent focus:border-yellow-accent" placeholder="Email Admin" value="darwono78@gmail.com" required>
                <input type="password" id="admin-password-input" class="p-2 border border-text-light/30 rounded bg-medium-green/50 text-text-light placeholder:text-text-light/60 focus:ring-yellow-accent focus:border-yellow-accent" placeholder="Password Admin" value="haul2025" required>
                <button onclick="adminLogin()" class="bg-yellow-accent text-dark-green py-2 px-4 rounded hover:bg-yellow-accent/90 font-semibold transition duration-150 shadow-md">
                    Login Admin
                </button>
            </div>
            
            <div id="admin-status-container" class="hidden">
                 <span class="text-sm font-semibold text-text-light">Selamat datang, Bendahara!</span>
            </div>
        </div>

        
        <div class="bg-medium-green p-8 text-text-light">
            <h1 class="text-3xl font-bold mb-6 text-center text-yellow-accent">
                Catatan Pembukuan Donatur Haul
            </h1>

            <div id="donasi-input-container" class="p-6 rounded-xl bg-dark-green/50 shadow-lg mb-10 hidden">
                <h2 class="text-2xl font-bold mb-6 text-yellow-accent border-b border-yellow-accent/50 pb-3">
                    Input Transaksi Baru
                </h2>
                <div class="grid grid-cols-1 gap-6">
                    <div>
                        <input type="date" id="donatur-date-input" class="p-3 border border-text-light/30 rounded-lg w-full bg-medium-green/50 text-text-light focus:ring-yellow-accent focus:border-yellow-accent" required>
                    </div>
                    <div>
                        <input type="text" id="donatur-name-input" class="p-3 border border-text-light/30 rounded-lg w-full bg-medium-green/50 text-text-light placeholder:text-text-light/60 focus:ring-yellow-accent focus:border-yellow-accent" placeholder="Uraian Transaksi (Contoh: Saldo bulan lalu/Bayar Bisyaroh)" required>
                    </div>
                    <div>
                        <select id="kategori-transaksi-select" class="p-3 border border-text-light/30 rounded-lg w-full bg-medium-green/50 text-text-light focus:ring-yellow-accent focus:border-yellow-accent">
                            <option value="">--- Pilih Kategori ---</option>
                            <option value="Dana Masuk">Dana Masuk (Contoh: Donasi, Pemasukan)</option>
                            <option value="Dana Keluar">Dana Keluar (Contoh: Bisyaroh, Belanja)</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <input type="number" id="donasi-dana-masuk-input" class="p-3 border border-text-light/30 rounded-lg w-full bg-medium-green/50 text-text-light placeholder:text-text-light/60 focus:ring-yellow-accent focus:border-yellow-accent text-right" placeholder="Jumlah Dana Masuk">
                        </div>
                        <div>
                            <input type="number" id="donasi-dana-keluar-input" class="p-3 border border-text-light/30 rounded-lg w-full bg-medium-green/50 text-text-light placeholder:text-text-light/60 focus:ring-yellow-accent focus:border-yellow-accent text-right" placeholder="Jumlah Dana Keluar">
                        </div>
                    </div>
                    <button onclick="addDonatur()" class="bg-yellow-accent text-dark-green py-3 px-6 rounded-lg hover:bg-yellow-accent/90 w-full font-bold transition duration-150 shadow-md">
                        Simpan Transaksi
                    </button>
                </div>
            </div>

            <h2 class="text-2xl font-bold mb-4 text-yellow-accent border-b border-yellow-accent/50 pb-3">
                Ringkasan Data Transaksi
            </h2>
            <div class="table-wrapper overflow-x-auto shadow-lg rounded-xl border border-text-light/20">
                <table class="min-w-full divide-y divide-text-light/20">
                    <thead class="bg-dark-green/80 text-text-light">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider rounded-tl-xl">No</th>
                            <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">Tanggal</th>
                            <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">Uraian Transaksi</th>
                            <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">Kategori</th>
                            <th class="px-4 py-3 text-right text-xs font-bold uppercase tracking-wider">Dana Masuk (Rp)</th>
                            <th class="px-4 py-3 text-right text-xs font-bold uppercase tracking-wider">Dana Keluar (Rp)</th>
                            <th class="px-4 py-3 text-right text-xs font-bold uppercase tracking-wider rounded-tr-xl">Saldo Akhir</th>
                        </tr>
                    </thead>
                    <tbody id="donatur-table-body" class="bg-medium-green/50 divide-y divide-text-light/10">
                        <tr><td colspan="7" class="py-6 text-center text-text-light/70">Memuat data...</td></tr>
                    </tbody>
                    <tfoot>
                        <tr class="bg-dark-green/80 font-extrabold border-t-2 border-yellow-accent">
                            <td colspan="4" class="px-4 py-3 text-right text-yellow-accent">TOTAL SALDO AKHIR:</td>
                            <td id="total-dana-masuk" class="px-4 py-3 text-right text-yellow-accent">Rp 0</td>
                            <td id="total-dana-keluar" class="px-4 py-3 text-right text-yellow-accent">Rp 0</td>
                            <td id="total-donasi-jumlah" class="px-4 py-3 text-right text-yellow-accent text-lg">Rp 0</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        
        <div id="admin-actions-container" class="bg-dark-green/80 text-text-light p-4 flex justify-between items-center hidden">
            <button onclick="confirmResetData()" class="bg-red-danger text-white py-2 px-4 rounded hover:bg-red-danger/90 text-sm transition duration-150 shadow-md">
                Reset Data (Hapus Permanen)
            </button>
            
            <button onclick="adminLogout()" class="bg-red-danger text-white py-2 px-4 rounded hover:bg-red-danger/90 text-sm transition duration-150 shadow-md">
                Logout
            </button>
        </div>
        
    </div>

    <script type="module">
        
        // --------------------------------------------------------------------------------
        // 1. FIREBASE SETUP DAN KONFIGURASI
        // --------------------------------------------------------------------------------
        
        // Import fungsi-fungsi yang diperlukan dari Firebase SDK (Versi 9 modular)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, query, orderBy, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        
        // KONFIGURASI FIREBASE FINAL (Sesuai Konfirmasi Anda)
        const firebaseConfig = {
            apiKey: "AIzaSyAHIO0RZgoq6eyjeERTpjOugzJLzqG2S-w",
            authDomain: "catatan-keuangan-haul.firebaseapp.com",
            projectId: "catatan-keuangan-haul",
            storageBucket: "catatan-keuangan-haul.appspot.com",
            messagingSenderId: "955355049778",
            appId: "1:955355049778:web:0b844b27b82a88cc0cf12b"
        };
        
        // Initialize Firebase dan dapatkan referensi Auth & Firestore
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Definisikan Collection
        const donaturCol = collection(db, "transaksi_haul"); 

        // Global State
        let allDonatur = []; 
        let isAdminLoggedIn = false; 

        // --------------------------------------------------------------------------------
        // 2. HELPER FUNCTIONS
        // --------------------------------------------------------------------------------

        const formatRupiah = (angka) => {
            if (typeof angka !== 'number') return 'Rp 0';
            const sign = angka < 0 ? '-' : '';
            const absoluteAngka = Math.abs(Math.floor(angka));
            const numberString = absoluteAngka.toString();
            const rupiah = numberString.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            return sign + 'Rp ' + rupiah;
        };

        const updateFooter = (id, value) => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = formatRupiah(value);
            }
        };
        
        const updateAdminView = () => {
            const isLogged = isAdminLoggedIn;
            
            // Toggle login form in the top bar
            document.getElementById('login-form-container')?.classList.toggle('hidden', isLogged);
            document.getElementById('admin-status-container')?.classList.toggle('hidden', !isLogged);
            
            // Toggle Admin Actions (Reset/Logout) below the table
            document.getElementById('admin-actions-container')?.classList.toggle('hidden', !isLogged);
            
            // Toggle Input Transaksi Baru form
            document.getElementById('donasi-input-container')?.classList.toggle('hidden', !isLogged);
        };

        // --------------------------------------------------------------------------------
        // 3. FIREBASE AUTH LOGIC (LOGIN/LOGOUT)
        // --------------------------------------------------------------------------------

        // Mengelola perubahan status login: Ini akan dipanggil setiap kali status auth berubah
        onAuthStateChanged(auth, (user) => {
            if (user) {
                isAdminLoggedIn = true;
                console.log("Status Admin: LOGIN BERHASIL");
            } else {
                isAdminLoggedIn = false;
                console.log("Status Admin: LOGOUT");
            }
            updateAdminView();
            loadAndRenderDonatur(); 
        });


        window.adminLogin = async () => {
            const email = document.getElementById('admin-email-input').value;
            const password = document.getElementById('admin-password-input').value;
            
            if (!email || !password) {
                alert('Mohon masukkan Email dan Password Admin.');
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
                
            } catch (error) {
                console.error("Login Error:", error.code);
                let errorMessage = 'Login Gagal. ';
                if (error.code === 'auth/wrong-password') {
                    errorMessage += 'Password salah.';
                } else if (error.code === 'auth/user-not-found') {
                    errorMessage += 'Akun Admin tidak ditemukan.';
                } else {
                    errorMessage += 'Terjadi kesalahan sistem.';
                }
                alert(errorMessage);
            }
        };

        window.adminLogout = async () => {
            if (confirm('Anda yakin ingin keluar dari mode Bendahara?')) {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error("Logout Error:", error);
                    alert(`Logout Gagal: ${error.message}`);
                }
            }
        };
        
        window.confirmResetData = async () => {
             if (!isAdminLoggedIn) return alert('Hanya Bendahara yang dapat mereset data.');
             
             if (!confirm('PERINGATAN! Anda yakin ingin MENGHAPUS SEMUA data Transaksi? Tindakan ini tidak bisa dibatalkan.')) return;
             
             if (!confirm('KONFIRMASI TERAKHIR: Ini akan menghapus PERMANEN semua transaksi di Firebase. LANJUTKAN?')) return;
             
             try {
                const donaturSnapshot = await getDocs(donaturCol);
                const batch = writeBatch(db); 
                
                donaturSnapshot.docs.forEach((d) => {
                    batch.delete(doc(db, "transaksi_haul", d.id));
                });
                
                await batch.commit();

                alert('SEMUA DATA TRANSAKSI BERHASIL DIHAPUS PERMANEN DARI FIREBASE.');
                await loadAndRenderDonatur();
             } catch (error) {
                 console.error("Gagal mereset data:", error);
                 alert('Gagal menghapus data di Firestore. Cek console log.');
             }
        };


        // --------------------------------------------------------------------------------
        // 4. FIRESTORE CRUD (CREATE & READ)
        // --------------------------------------------------------------------------------

        const loadAndRenderDonatur = async () => {
            allDonatur = [];
            const tableBody = document.getElementById('donatur-table-body');
            tableBody.innerHTML = `<tr><td colspan="7" class="py-6 text-center text-text-light/70">Memuat data dari Firebase...</td></tr>`;

            try {
                const donaturQuery = query(donaturCol, orderBy("timestamp", "asc")); 
                const donaturSnapshot = await getDocs(donaturQuery);

                donaturSnapshot.forEach(doc => {
                    const data = doc.data();
                    allDonatur.push({
                        id: doc.id, 
                        date: data.date,
                        uraian: data.uraian,
                        kategori: data.kategori || '-',
                        danaMasuk: data.danaMasuk || 0,
                        danaKeluar: data.danaKeluar || 0,
                        timestamp: data.timestamp ? data.timestamp.toMillis() : new Date(data.date).getTime(), 
                    });
                });
                
                renderDonaturTable();
                
            } catch (error) {
                console.error("Gagal memuat data dari Firestore:", error);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="py-6 text-center text-red-danger">
                            ðŸ”´ GAGAL MEMUAT DATA. Cek Koneksi Internet atau Konfigurasi Firebase.
                        </td>
                    </tr>`;
            }
        };
        
        window.addDonatur = async () => {
            if (!isAdminLoggedIn) return alert('Hanya Bendahara yang dapat menginput data. Mohon Login terlebih dahulu.');

            const date = document.getElementById('donatur-date-input').value;
            const uraian = document.getElementById('donatur-name-input').value; 
            const kategori = document.getElementById('kategori-transaksi-select').value;
            let danaMasuk = parseInt(document.getElementById('donasi-dana-masuk-input').value) || 0;
            let danaKeluar = parseInt(document.getElementById('donasi-dana-keluar-input').value) || 0;
            
            if (!date || !uraian || !kategori) {
                alert('Mohon isi Tanggal, Uraian, dan Kategori Transaksi.');
                return;
            }

            if (danaMasuk === 0 && danaKeluar === 0) {
                alert('Mohon masukkan jumlah Dana Masuk atau Dana Keluar.');
                return;
            }
            if (danaMasuk > 0 && danaKeluar > 0) {
                 alert('Mohon hanya isi salah satu: Dana Masuk atau Dana Keluar.');
                 return;
            }


            const newTransaksi = {
                date: date,
                uraian: uraian,
                kategori: kategori,
                danaMasuk: danaMasuk,
                danaKeluar: danaKeluar,
                timestamp: serverTimestamp() 
            };

            try {
                await addDoc(donaturCol, newTransaksi);
                
                // Reset form setelah sukses
                document.getElementById('donatur-name-input').value = '';
                document.getElementById('kategori-transaksi-select').value = '';
                document.getElementById('donasi-dana-masuk-input').value = '';
                document.getElementById('donasi-dana-keluar-input').value = '';
                
                alert('Transaksi berhasil ditambahkan ke Firebase!');
                await loadAndRenderDonatur(); 
            } catch (error) {
                console.error("Gagal menambahkan Transaksi:", error);
                alert("Gagal menyimpan transaksi. Cek console log.");
            }
        };

        // --------------------------------------------------------------------------------
        // 5. RENDER DATA (LOGIC KUMULATIF)
        // --------------------------------------------------------------------------------

        const renderDonaturTable = () => {
            const tableBody = document.getElementById('donatur-table-body');
            tableBody.innerHTML = '';
            
            let totalDanaMasuk = 0;
            let totalDanaKeluar = 0;
            let saldoAkhirKumulatif = 0;
            
            if (allDonatur.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="7" class="py-6 text-center text-text-light/70">Belum ada data transaksi yang dicatat.</td></tr>`;
                updateFooter('total-dana-masuk', 0);
                updateFooter('total-dana-keluar', 0);
                updateFooter('total-donasi-jumlah', 0); 
                return;
            }

            allDonatur.forEach((t, index) => {
                totalDanaMasuk += t.danaMasuk;
                totalDanaKeluar += t.danaKeluar;
                saldoAkhirKumulatif += (t.danaMasuk - t.danaKeluar); 

                const row = tableBody.insertRow();
                const formattedDate = new Date(t.date + 'T00:00:00').toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
                
                // Menentukan warna teks berdasarkan jenis dana
                const danaMasukText = t.danaMasuk > 0 ? 'text-yellow-accent' : 'text-text-light/50';
                const danaKeluarText = t.danaKeluar > 0 ? 'text-red-danger' : 'text-text-light/50';

                row.innerHTML = `
                    <td class="px-4 py-3 text-center">${index + 1}</td>
                    <td class="px-4 py-3">${formattedDate}</td>
                    <td class="px-4 py-3 font-medium">${t.uraian}</td>
                    <td class="px-4 py-3 text-sm">${t.kategori}</td>
                    <td class="px-4 py-3 text-right font-mono ${danaMasukText}">${formatRupiah(t.danaMasuk)}</td>
                    <td class="px-4 py-3 text-right font-mono ${danaKeluarText}">${formatRupiah(t.danaKeluar)}</td>
                    <td class="px-4 py-3 text-right font-bold text-lg text-yellow-accent">${formatRupiah(saldoAkhirKumulatif)}</td>
                `;
            });

            // Update Footer Total
            updateFooter('total-dana-masuk', totalDanaMasuk);
            updateFooter('total-dana-keluar', totalDanaKeluar);
            updateFooter('total-donasi-jumlah', saldoAkhirKumulatif); 
        };

        // --------------------------------------------------------------------------------
        // 6. INISIALISASI
        // --------------------------------------------------------------------------------

        window.onload = () => {
            // Set tanggal hari ini di input
            const today = new Date().toLocaleDateString('en-CA');
            const dateInput = document.getElementById('donatur-date-input');
            if (dateInput) {
                dateInput.value = today;
            }
        };
    </script>
</body>
</html>
