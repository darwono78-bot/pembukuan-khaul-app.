<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catatan Pembukuan Haul - Bendahara</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        // Konfigurasi Tailwind CSS
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Warna diambil dari contoh gambar Anda
                        'dark-green': '#1a472a', 
                        'medium-green': '#2b6e49', 
                        'yellow-accent': '#ffeb3b', // Nilai ini adalah #ffeb3b
                        'red-danger': '#ef5350', 
                        'text-light': '#e0e0e0', 
                    }
                }
            }
        }
    </script>
    
    <style>
        /* --- STYLE GLOBAL & GLOW FINAL --- */
        
        /* 1. Body Background: HIJAU PALING GELAP (#052600) */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #052600; 
            color: #e0e0e0;
        }
        
        /* 2. STYLE UTAMA: Bingkai Konten */
        .max-w-6xl {
            position: relative; 
            z-index: 10;
            background-color: #1a472a; 
            border-radius: 0.75rem;

            /* A. Border Kuning: Tipis */
            border: 2px solid #fff352; 

            /* B. Box-Shadow untuk Glow Menengah (Inti Sinar) */
            box-shadow: 
                0 0 10px rgba(255, 235, 59, 1), 
                0 0 25px rgba(255, 235, 59, 0.7); 

            /* C. Filter Drop-Shadow untuk Glow Terluar (Sinar Menyebar) */
            filter: 
                drop-shadow(0 0 15px rgba(255, 235, 59, 0.5)) 
                drop-shadow(0 0 30px rgba(255, 235, 59, 0.3)); 
        }
        
        /* 3. Warna Inner Content: Lebih Gelap (#1D4F31) */
        .bg-medium-green {
            background-color: #1D4F31; 
        }

        /* --- UTILITY CSS --- */
        
        /* Menghilangkan panah pada input number */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none;
          margin: 0;
        }
        ::placeholder {
            color: #a0a0a0;
            opacity: 1;
        }
        /* Mengubah warna ikon kalender pada input date menjadi putih */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
        
        /* Style untuk Tabel Header */
        #donatur-table th, #jurnal-kas-table th {
            font-size: 0.75rem; /* text-xs */
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
            text-align: center; 
        }
        
        /* Style untuk Konten Tabel (Baris Data) */
        #donatur-table td, #jurnal-kas-table td {
            padding: 0.75rem 1rem; 
            vertical-align: top;
            font-weight: normal; 
            font-size: 0.875rem; /* Ukuran default untuk teks data lain */
            text-align: right; /* Default rata kanan untuk semua kolom data */
        }
        
        /* Ukuran & Warna Angka Rupiah di BARIS DATA (PUTIH) */
        #donatur-table .kolom-nilai-alokasi { 
            font-size: 1rem; 
            color: #e0e0e0; /* PUTIH (text-light) */
            font-weight: normal; 
        }
        
        /* Ukuran & Warna Teks Nama Donatur & Alamat (PUTIH) */
        #donatur-table .kolom-nama-alamat { 
            font-size: 1rem; 
            color: #e0e0e0; /* PUTIH (text-light) */
        }


        /* Override untuk kolom teks agar rata kiri/tengah */
        #donatur-table .kolom-no, #jurnal-kas-table .kolom-no {
            text-align: center;
        }
        #donatur-table .kolom-tanggal, #jurnal-kas-table .kolom-tanggal {
            text-align: left;
        }
        #donatur-table .kolom-nama {
            text-align: left;
        }
        #donatur-table .kolom-alamat {
            text-align: left;
        }
        
        /* Wrapper Tabel */
        .table-wrapper {
            box-shadow: 0 0 15px rgba(255, 235, 59, 0.2); 
            border: 1px solid #ffeb3b; 
        }
        
        /* Penyesuaian lebar kolom agar rapi */
        #donatur-table .nilai-kolom, .alokasi-kolom {
            width: 120px; 
            min-width: 120px;
        }
        #donatur-table .kolom-no {
            width: 40px; 
        }
        #donatur-table .kolom-tanggal {
            width: 100px; 
            min-width: 100px;
        }
        
        /* --- STYLE KHUSUS UNTUK FOOTER TOTAL (KUNING) --- */
        
        /* Style untuk Label "TOTAL KESELURUHAN:" (KUNING) */
        #donatur-table tfoot td {
            font-weight: bold;
            font-size: 1.125rem; 
            color: #ffeb3b; /* KUNING (yellow-accent) */
        }

        /* Angka Rupiah di Baris Total (Footer Donasi) KUNING */
        #donatur-table tfoot .total-angka-rupiah { 
            font-size: 1.25rem; 
            color: #ffeb3b; /* KUNING (yellow-accent) */
            font-weight: normal; 
        }

        /* Style untuk Footer Jurnal Kas (KUNING) */
        #jurnal-kas-table tfoot td {
            font-weight: bold;
            font-size: 1.125rem; 
            color: #ffeb3b; /* KUNING (yellow-accent) */
        }

        /* Angka Saldo Akhir (Footer Jurnal Kas) KUNING */
        #jurnal-kas-table tfoot .total-angka-rupiah { 
            font-size: 1.25rem; 
            color: #ffeb3b; /* KUNING (yellow-accent) */
            font-weight: bold; /* Dibuat lebih tebal untuk Saldo Akhir */
        }

        /* Warna untuk Dana Masuk di Jurnal Kas (Kuning) */
        #jurnal-kas-table .text-yellow-accent {
            color: #ffeb3b; 
            font-weight: bold;
        }
        /* Warna untuk Dana Keluar di Jurnal Kas (Merah) */
        #jurnal-kas-table .text-red-danger {
            color: #ef5350; 
            font-weight: bold;
        }
    </style>
</head>
<body class="p-4 sm:p-10">

    <div class="max-w-6xl mx-auto rounded-xl shadow-2xl">
        
        <div class="bg-dark-green text-text-light py-4 px-6 flex justify-center items-center">
            <h1 class="text-3xl font-bold text-center text-yellow-accent">
                Catatan Pembukuan Haul - Bendahara
            </h1>
        </div>

        
        <div class="bg-medium-green p-8 text-text-light">

            <h2 class="text-2xl font-bold mb-4 text-yellow-accent border-b border-yellow-accent/50 pb-3">
                Jurnal Kas Umum (Dana Masuk & Keluar)
            </h2>
            <div class="table-wrapper overflow-x-auto shadow-lg rounded-xl mb-4">
                <table id="jurnal-kas-table" class="min-w-full divide-y divide-text-light/20">
                    <thead class="bg-dark-green/80 text-text-light">
                        <tr>
                            <th class="px-4 py-3 font-bold uppercase tracking-wider rounded-tl-xl w-12 kolom-no">NO</th>
                            <th class="px-4 py-3 text-left font-bold uppercase tracking-wider w-24 kolom-tanggal">TANGGAL</th>
                            <th class="px-4 py-3 text-left font-bold uppercase tracking-wider w-48">URAIAN</th>
                            <th class="px-4 py-3 text-left font-bold uppercase tracking-wider w-48">KATEGORI</th>
                            <th class="px-4 py-3 font-bold uppercase tracking-wider w-32">DANA MASUK (RP)</th> 
                            <th class="px-4 py-3 font-bold uppercase tracking-wider w-32">DANA KELUAR (RP)</th>
                            <th class="px-4 py-3 font-bold uppercase tracking-wider rounded-tr-xl w-32">SALDO (RP)</th>
                        </tr>
                    </thead>
                    <tbody id="jurnal-kas-table-body" class="bg-medium-green/50 divide-y divide-text-light/10">
                        <tr><td colspan="7" class="py-6 text-center text-text-light/70">Memuat Jurnal Kas...</td></tr>
                    </tbody>
                    <tfoot>
                        <tr class="bg-dark-green/80 font-extrabold border-t-2 border-yellow-accent">
                            <td colspan="4" class="px-4 py-3 text-right">TOTAL SALDO AKHIR:</td>
                            <td colspan="3" id="total-saldo-akhir" class="px-4 py-3 text-right total-angka-rupiah">0</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            
            <div id="jurnal-kas-pagination" class="flex justify-center mt-4 mb-10 space-x-2">
                </div>

            
            <div id="pengeluaran-input-container" class="p-6 rounded-xl bg-dark-green/50 shadow-lg mb-10 hidden">
                <h2 class="text-2xl font-bold mb-6 text-red-danger border-b border-red-danger/50 pb-3">
                    Input Pengeluaran / Dana Keluar
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="date" id="kas-date-input" class="p-3 border border-text-light/30 rounded-lg w-full bg-medium-green/50 text-text-light focus:ring-yellow-accent focus:border-yellow-accent" required>
                    
                    <input type="text" id="kas-uraian-input" class="p-3 border border-text-light/30 rounded-lg w-full bg-medium-green/50 text-text-light placeholder:text-text-light/60 focus:ring-yellow-accent focus:border-yellow-accent" placeholder="Uraian (Contoh: Bayar listrik tenda)" required>
                    
                    <select id="kas-kategori-input" class="p-3 border border-text-light/30 rounded-lg w-full bg-medium-green/50 text-text-light focus:ring-yellow-accent focus:border-yellow-accent" required>
                        <option value="" disabled selected>-- Pilih Kategori --</option>
                        <option value="Ongkos Kiai">Ongkos Kiai</option>
                        <option value="Bayar Khataman">Bayar Khataman</option>
                        <option value="Bayar Konsumsi">Bayar Konsumsi</option>
                        <option value="Bayar Persewaan">Bayar Persewaan</option>
                        <option value="Bayar Pekerja">Bayar Pekerja</option>
                        <option value="Lain-Lain">Lain-Lain</option>
                    </select>
                    
                    <input type="number" id="kas-nilai-keluar-input" class="p-3 border border-text-light/30 rounded-lg w-full bg-medium-green/50 text-text-light placeholder:text-text-light/60 focus:ring-yellow-accent focus:border-yellow-accent text-right" placeholder="Nilai Pengeluaran (Rp)" required>
                </div>
                
                <button onclick="addPengeluaran()" class="bg-red-danger text-white py-3 px-6 rounded-lg hover:bg-red-danger/90 w-full font-bold transition duration-150 shadow-md mt-6">
                    Simpan Dana Keluar
                </button>
            </div>
            
            <h2 class="text-2xl font-bold mb-4 mt-12 text-yellow-accent border-b border-yellow-accent/50 pb-3">
                Ringkasan Data Transaksi Donatur (Dana Masuk)
            </h2>
            <div class="table-wrapper overflow-x-auto shadow-lg rounded-xl mb-4">
                <table id="donatur-table" class="min-w-full divide-y divide-text-light/20">
                    <thead class="bg-dark-green/80 text-text-light">
                        <tr>
                            <th class="px-4 py-3 text-left font-bold uppercase tracking-wider rounded-tl-xl kolom-no">NO</th>
                            <th class="px-4 py-3 text-left font-bold uppercase tracking-wider kolom-tanggal">TANGGAL</th>
                            <th class="px-4 py-3 text-left font-bold uppercase tracking-wider kolom-nama">NAMA DONATUR</th>
                            <th class="px-4 py-3 text-left font-bold uppercase tracking-wider kolom-alamat">ALAMAT</th>
                            <th class="px-4 py-3 font-bold uppercase tracking-wider nilai-kolom">NILAI (RP)</th> 
                            <th class="px-4 py-3 font-bold uppercase tracking-wider alokasi-kolom">PERAWATAN MAKAM (15%)</th>
                            <th class="px-4 py-3 font-bold uppercase tracking-wider alokasi-kolom">BISYAROH PANITIA (15%)</th>
                            <th class="px-4 py-3 font-bold uppercase tracking-wider rounded-tr-xl alokasi-kolom">BIAYA HAUL (70%)</th>
                        </tr>
                    </thead>
                    <tbody id="donatur-table-body" class="bg-medium-green/50 divide-y divide-text-light/10">
                        <tr><td colspan="8" class="py-6 text-center text-text-light/70">Memuat data...</td></tr>
                    </tbody>
                    <tfoot>
                        <tr class="bg-dark-green/80 font-extrabold border-t-2 border-yellow-accent">
                            <td colspan="4" class="px-4 py-3 text-right">TOTAL KESELURUHAN:</td> 
                            
                            <td id="total-donasi-input" class="px-4 py-3 text-right total-angka-rupiah">0</td> 
                            <td id="total-perawatan-makam" class="px-4 py-3 text-right total-angka-rupiah">0</td> 
                            <td id="total-bisyaroh-panitia" class="px-4 py-3 text-right total-angka-rupiah">0</td> 
                            <td id="total-biaya-haul" class="px-4 py-3 text-right total-angka-rupiah">0</td> 
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div id="donatur-pagination" class="flex justify-center mt-4 mb-10 space-x-2">
                </div>

            <div id="donasi-input-container" class="p-6 rounded-xl bg-dark-green/50 shadow-lg mb-10 hidden">
                <h2 class="text-2xl font-bold mb-6 text-yellow-accent border-b border-yellow-accent/50 pb-3">
                    Input Data Donatur Baru
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="date" id="donatur-date-input" class="p-3 border border-text-light/30 rounded-lg w-full bg-medium-green/50 text-text-light focus:ring-yellow-accent focus:border-yellow-accent" required>
                    
                    <input type="text" id="donatur-name-input" class="p-3 border border-text-light/30 rounded-lg w-full bg-medium-green/50 text-text-light placeholder:text-text-light/60 focus:ring-yellow-accent focus:border-yellow-accent" placeholder="Nama Donatur (Contoh: Saripin)" required>
                    
                    <input type="text" id="donatur-alamat-input" class="p-3 border border-text-light/30 rounded-lg w-full bg-medium-green/50 text-text-light placeholder:text-text-light/60 focus:ring-yellow-accent focus:border-yellow-accent" placeholder="Alamat (Contoh: Ngablak)" required>
                    
                    <input type="number" id="donasi-nilai-input" class="p-3 border border-text-light/30 rounded-lg w-full bg-medium-green/50 text-text-light placeholder:text-text-light/60 focus:ring-yellow-accent focus:border-yellow-accent text-right" placeholder="Nilai Donasi (Rp)" required>
                </div>
                
                <button onclick="addDonatur()" class="bg-yellow-accent text-dark-green py-3 px-6 rounded-lg hover:bg-yellow-accent/90 w-full font-bold transition duration-150 shadow-md mt-6">
                    Simpan Donasi & Alokasikan Dana
                </button>
            </div>
            
            <div class="p-4 rounded-xl bg-dark-green/50 shadow-inner">
                
                <div id="login-form-container" class="flex flex-grow justify-end items-center gap-4">
                    <input type="email" id="admin-email-input" class="p-2 border border-text-light/30 rounded bg-medium-green/50 text-text-light placeholder:text-text-light/60 focus:ring-yellow-accent focus:border-yellow-accent" placeholder="Email Admin" value="darwono78@gmail.com" required>
                    <input type="password" id="admin-password-input" class="p-2 border border-text-light/30 rounded bg-medium-green/50 text-text-light placeholder:text-text-light/60 focus:ring-yellow-accent focus:border-yellow-accent" placeholder="Password Admin" value="haul2025" required>
                    <button onclick="adminLogin()" class="bg-yellow-accent text-dark-green py-2 px-4 rounded hover:bg-yellow-accent/90 font-semibold transition duration-150 shadow-md">
                        Login Admin
                    </button>
                </div>
                
                <div id="admin-actions-container" class="hidden mt-4">
                    <div class="flex justify-between items-center gap-4">
                        <button onclick="confirmResetData()" class="bg-red-danger text-white py-2 px-4 rounded hover:bg-red-danger/90 text-sm transition duration-150 shadow-md">
                            Reset Data (Hapus Permanen)
                        </button>
                        
                        <button onclick="adminLogout()" class="bg-red-danger text-white py-2 px-4 rounded hover:bg-red-danger/90 text-sm transition duration-150 shadow-md">
                            Logout
                        </button>
                    </div>
                    <p class="text-sm font-semibold mt-3 text-yellow-accent/80 text-right">Mode Admin Aktif.</p>
                </div>
            </div>
            
        </div>
        
    </div>

    <script type="module">
        
        // --------------------------------------------------------------------------------
        // 1. FIREBASE SETUP DAN KONFIGURASI
        // --------------------------------------------------------------------------------
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp, writeBatch, doc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        
        // Konfigurasi Firebase Anda
        const firebaseConfig = {
            apiKey: "AIzaSyAHIO0RZgoq6eyjeERTpjOugzJLzqG2S-w",
            authDomain: "catatan-keuangan-haul.firebaseapp.com",
            projectId: "catatan-keuangan-haul",
            storageBucket: "catatan-keuangan-haul.appspot.com", 
            messagingSenderId: "955355049778", 
            appId: "1:955355049778:web:0b844b27b82a88cc0cf12b" 
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const donaturCol = collection(db, "transaksi_haul"); 
        const pengeluaranCol = collection(db, "transaksi_keluar"); 

        let allDonatur = []; 
        let allPengeluaran = []; 
        let isAdminLoggedIn = false; 
        
        // Variable untuk melacak halaman saat ini dan batas baris
        let currentDonaturPage = 1;
        let currentJurnalKasPage = 1;
        const ROWS_PER_PAGE = 10; // Batasan 10 baris per halaman

        // Konstanta Prosentase Alokasi
        const PERSENTASE = {
            PERAWATAN_MAKAM: 0.15, // 15%
            BISYAROH_PANITIA: 0.15, // 15%
            BIAYA_HAUL: 0.70     // 70%
        };

        // --------------------------------------------------------------------------------
        // 2. HELPER FUNCTIONS
        // --------------------------------------------------------------------------------

        const formatRupiah = (angka) => {
            if (typeof angka !== 'number' || isNaN(angka)) return '0'; 
            const sign = angka < 0 ? '-' : '';
            const absoluteAngka = Math.abs(Math.floor(angka));
            const numberString = absoluteAngka.toString();
            const rupiah = numberString.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            return sign + rupiah;
        };
        
        // Fungsi untuk menghitung alokasi dana dari nilai donasi
        const calculateAlokasi = (nilai) => {
            const nilaiDonasi = parseFloat(nilai) || 0;
            if (nilaiDonasi <= 0) {
                 return { perawatan_makam: 0, bisyaroh_panitia: 0, biaya_haul: 0 };
            }
            
            const perawatan_makam = Math.round(nilaiDonasi * PERSENTASE.PERAWATAN_MAKAM);
            const bisyaroh_panitia = Math.round(nilaiDonasi * PERSENTASE.BISYAROH_PANITIA);
            const biaya_haul = nilaiDonasi - perawatan_makam - bisyaroh_panitia;
            
            return { perawatan_makam, bisyaroh_panitia, biaya_haul };
        }

        const updateFooter = (id, value) => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = formatRupiah(value); 
            }
        };
        
        const updateAdminView = () => {
            const isLogged = isAdminLoggedIn;
            
            document.getElementById('login-form-container')?.classList.toggle('hidden', isLogged);
            document.getElementById('admin-actions-container')?.classList.toggle('hidden', !isLogged);
            document.getElementById('donasi-input-container')?.classList.toggle('hidden', !isLogged);
            document.getElementById('pengeluaran-input-container')?.classList.toggle('hidden', !isLogged);
        };
        
        // Fungsi Generik untuk Membuat Tombol Pagination
        const setupPagination = (data, currentPage, containerId, renderFunction) => {
            const totalPages = Math.ceil(data.length / ROWS_PER_PAGE);
            const container = document.getElementById(containerId);
            container.innerHTML = ''; // Bersihkan konten lama

            if (totalPages <= 1) return; // Tidak perlu pagination jika hanya 1 halaman

            // Fungsi untuk membuat tombol
            const createButton = (label, page, isActive, isSpecial) => {
                const button = document.createElement('button');
                button.textContent = label;
                button.classList.add('px-4', 'py-2', 'rounded-lg', 'font-bold', 'transition', 'duration-150', 'shadow-md', 'text-sm');

                if (isActive) {
                    // Tombol Aktif (Warna Kuning Solid)
                    button.classList.add('bg-yellow-accent', 'text-dark-green');
                } else {
                    // Tombol Non-Aktif (Warna Hijau Gelap dengan Border Kuning)
                    button.classList.add('bg-dark-green', 'text-yellow-accent', 'hover:bg-dark-green/70', 'border', 'border-yellow-accent');
                    button.onclick = () => {
                        // *** PERUBAHAN INTI LOGIKA PAGINATION ***
                        if (containerId === 'donatur-pagination') {
                            currentDonaturPage = page;
                        } else {
                            currentJurnalKasPage = page;
                        }
                        
                        // Panggil fungsi render ulang yang SPESIFIK untuk tabel ini
                        renderFunction(); 
                        
                        // Scroll ke atas tabel setelah pindah halaman
                        document.getElementById(containerId).previousElementSibling.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    };
                }
                
                // Handle Tombol "<<" dan ">>"
                if (isSpecial) {
                    // Tombol Panah (Previous/Next) nonaktif jika sudah di ujung
                    button.disabled = isActive; 
                }

                container.appendChild(button);
            };

            // Tombol "<<" (Previous)
            createButton('<<', Math.max(1, currentPage - 1), currentPage === 1, true);

            // Tampilkan hingga 5 halaman di sekitar halaman aktif
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);
            
            // Logika untuk memastikan 5 tombol (jika memungkinkan)
            if (endPage - startPage < 4) {
                if (startPage > 1) {
                    startPage = Math.max(1, endPage - 4);
                } else if (endPage < totalPages) {
                    endPage = Math.min(totalPages, startPage + 4);
                }
            }
            
            // Pastikan endPage tidak melebihi totalPages
            endPage = Math.min(totalPages, endPage);

            for (let i = startPage; i <= endPage; i++) {
                createButton(i.toString(), i, i === currentPage, false);
            }
            
            // Tombol ">>" (Next)
            createButton('>>', Math.min(totalPages, currentPage + 1), currentPage === totalPages, true);
        };


        // --------------------------------------------------------------------------------
        // 3. FIREBASE AUTH & ADMIN ACTIONS
        // --------------------------------------------------------------------------------

        onAuthStateChanged(auth, (user) => {
            if (user) {
                isAdminLoggedIn = true;
            } else {
                isAdminLoggedIn = false;
            }
            updateAdminView();
            loadAndRenderData(); 
        });


        window.adminLogin = async () => {
            const email = document.getElementById('admin-email-input').value;
            const password = document.getElementById('admin-password-input').value;
            
            if (!email || !password) {
                alert('Mohon masukkan Email dan Password Admin.');
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
                
            } catch (error) {
                console.error("Login Error:", error.code);
                let errorMessage = 'Login Gagal. ';
                if (error.code === 'auth/wrong-password') {
                    errorMessage += 'Password salah.';
                } else if (error.code === 'auth/user-not-found') {
                    errorMessage += 'Akun Admin tidak ditemukan.';
                } else {
                    errorMessage += 'Terjadi kesalahan sistem.';
                }
                alert(errorMessage);
            }
        };

        window.adminLogout = async () => {
            if (confirm('Anda yakin ingin keluar dari mode Bendahara?')) {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error("Logout Error:", error);
                    alert(`Logout Gagal: ${error.message}`);
                }
            }
        };
        
        window.confirmResetData = async () => {
             if (!isAdminLoggedIn) return alert('Hanya Bendahara yang dapat mereset data.');
             
             if (!confirm('PERINGATAN! Anda yakin ingin MENGHAPUS SEMUA data Donasi dan Pengeluaran? Tindakan ini tidak bisa dibatalkan.')) return;
             
             if (!confirm('KONFIRMASI TERAKHIR: Ini akan menghapus PERMANEN semua data di Firebase. LANJUTKAN?')) return;
             
             try {
                const donaturSnapshot = await getDocs(donaturCol);
                const pengeluaranSnapshot = await getDocs(pengeluaranCol); 
                const batch = writeBatch(db); 
                
                donaturSnapshot.docs.forEach((d) => {
                    batch.delete(doc(db, "transaksi_haul", d.id));
                });
                
                pengeluaranSnapshot.docs.forEach((d) => { 
                    batch.delete(doc(db, "transaksi_keluar", d.id));
                });
                
                await batch.commit();

                alert('SEMUA DATA DONASI DAN PENGELUARAN BERHASIL DIHAPUS PERMANEN DARI FIREBASE.');
                // Reset halaman ke 1 setelah reset data
                currentDonaturPage = 1;
                currentJurnalKasPage = 1;
                await loadAndRenderData(); 
             } catch (error) {
                 console.error("Gagal mereset data:", error);
                 alert('Gagal menghapus data di Firestore. Cek console log.');
             }
        };


        // --------------------------------------------------------------------------------
        // 4. FIRESTORE CRUD (CREATE & READ)
        // --------------------------------------------------------------------------------

        const loadAndRenderData = async () => {
            allDonatur = [];
            allPengeluaran = []; 

            const tableBodyDonasi = document.getElementById('donatur-table-body');
            const tableBodyKas = document.getElementById('jurnal-kas-table-body');
            
            tableBodyDonasi.innerHTML = `<tr><td colspan="8" class="py-6 text-center text-text-light/70">Memuat data donasi...</td></tr>`;
            tableBodyKas.innerHTML = `<tr><td colspan="7" class="py-6 text-center text-text-light/70">Memuat Jurnal Kas...</td></tr>`;

            try {
                // --- 1. LOAD DONASI (DANA MASUK) ---
                const donaturQuery = query(donaturCol, orderBy("timestamp", "asc")); 
                const donaturSnapshot = await getDocs(donaturQuery);
                donaturSnapshot.forEach(doc => {
                    const data = doc.data();
                    const nilaiDonasi = parseFloat(data.nilai || data.danaMasuk || 0);

                    let alokasiData = data.alokasi;
                    
                    if (!alokasiData || 
                        alokasiData.perawatan_makam === undefined || 
                        alokasiData.bisyaroh_panitia === undefined ||
                        alokasiData.biaya_haul === undefined) 
                    {
                        alokasiData = calculateAlokasi(nilaiDonasi);
                    }

                    allDonatur.push({
                        id: doc.id, 
                        date: data.date,
                        nama: data.nama || data.uraian || 'Tanpa Nama',
                        alamat: data.alamat || '-',
                        nilai: nilaiDonasi, 
                        alokasi: alokasiData,
                        timestamp: data.timestamp ? data.timestamp.toMillis() : new Date(data.date).getTime(), 
                    });
                });
                
                // --- 2. LOAD PENGELUARAN (DANA KELUAR) ---
                const pengeluaranQuery = query(pengeluaranCol, orderBy("timestamp", "asc")); 
                const pengeluaranSnapshot = await getDocs(pengeluaranQuery);
                pengeluaranSnapshot.forEach(doc => {
                    const data = doc.data();
                    const nilaiKeluar = parseFloat(data.nilai_keluar) || 0;
                    
                    allPengeluaran.push({
                        id: doc.id,
                        date: data.date,
                        uraian: data.uraian,
                        kategori: data.kategori,
                        nilai_keluar: nilaiKeluar,
                        timestamp: data.timestamp ? data.timestamp.toMillis() : new Date(data.date).getTime(), 
                    });
                });

                renderAllDataInitial(); // Panggil fungsi render awal
                
            } catch (error) {
                console.error("Gagal memuat data dari Firestore:", error);
                tableBodyDonasi.innerHTML = `
                    <tr>
                        <td colspan="8" class="py-6 text-center text-red-danger">
                            ðŸ”´ GAGAL MEMUAT DATA DONASI.
                        </td>
                    </tr>`;
                tableBodyKas.innerHTML = `
                    <tr>
                        <td colspan="7" class="py-6 text-center text-red-danger">
                            ðŸ”´ GAGAL MEMUAT DATA JURNAL.
                        </td>
                    </tr>`;
            }
        };

        window.addDonatur = async () => {
            if (!isAdminLoggedIn) return alert('Hanya Bendahara yang dapat menginput data. Mohon Login terlebih dahulu.');

            const date = document.getElementById('donatur-date-input').value;
            const nama = document.getElementById('donatur-name-input').value; 
            const alamat = document.getElementById('donatur-alamat-input').value;
            let nilai = parseInt(document.getElementById('donasi-nilai-input').value) || 0;
            
            if (!date || !nama || !nilai || nilai <= 0) {
                alert('Mohon isi Tanggal, Nama Donatur, dan Nilai Donasi yang valid.');
                return;
            }
            
            const alokasiHitungan = calculateAlokasi(nilai);
            
            const newDonasi = {
                date: date,
                nama: nama,
                alamat: alamat,
                nilai: nilai, 
                alokasi: alokasiHitungan,
                timestamp: serverTimestamp() 
            };

            try {
                await addDoc(donaturCol, newDonasi);
                
                document.getElementById('donatur-name-input').value = '';
                document.getElementById('donatur-alamat-input').value = '';
                document.getElementById('donasi-nilai-input').value = '';
                
                alert('Donasi berhasil ditambahkan & dana dialokasikan!');
                // Reset halaman ke 1 setelah tambah data
                currentDonaturPage = 1; 
                await loadAndRenderData(); 
            } catch (error) {
                console.error("Gagal menambahkan Donasi:", error);
                alert("Gagal menyimpan donasi. Cek console log.");
            }
        };

        window.addPengeluaran = async () => {
            if (!isAdminLoggedIn) return alert('Hanya Bendahara yang dapat menginput data. Mohon Login terlebih dahulu.');

            const date = document.getElementById('kas-date-input').value;
            const uraian = document.getElementById('kas-uraian-input').value; 
            const kategori = document.getElementById('kas-kategori-input').value;
            let nilai_keluar = parseInt(document.getElementById('kas-nilai-keluar-input').value) || 0;
            
            if (!date || !uraian || !kategori || nilai_keluar <= 0) {
                alert('Mohon isi Tanggal, Uraian, Kategori, dan Nilai Pengeluaran yang valid.');
                return;
            }
            
            const newPengeluaran = {
                date: date,
                uraian: uraian,
                kategori: kategori,
                nilai_keluar: nilai_keluar, 
                timestamp: serverTimestamp() 
            };

            try {
                await addDoc(pengeluaranCol, newPengeluaran);
                
                document.getElementById('kas-uraian-input').value = '';
                document.getElementById('kas-nilai-keluar-input').value = '';
                document.getElementById('kas-kategori-input').value = '';
                
                alert('Pengeluaran berhasil dicatat!');
                // Reset halaman ke 1 setelah tambah data
                currentJurnalKasPage = 1;
                await loadAndRenderData(); 
            } catch (error) {
                console.error("Gagal menambahkan Pengeluaran:", error);
                alert("Gagal menyimpan pengeluaran. Cek console log.");
            }
        };


        // --------------------------------------------------------------------------------
        // 5. RENDER DATA (LOGIC TOTAL & SALDO)
        // --------------------------------------------------------------------------------

        const renderAllDataInitial = () => {
            // PENTING: Donatur harus di-render duluan agar total donasi terhitung, 
            // karena total donasi dipakai oleh Jurnal Kas.
            renderDonaturTable();
            renderJurnalKasTable();
        };

        const renderDonaturTable = () => {
            const tableBody = document.getElementById('donatur-table-body');
            tableBody.innerHTML = '';
            
            let totalDonasiInput = 0;
            let totalPerawatanMakam = 0;
            let totalBisyarohPanitia = 0;
            let totalBiayaHaul = 0;
            
            if (allDonatur.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="8" class="py-6 text-center text-text-light/70">Belum ada data donasi yang dicatat.</td></tr>`;
                updateFooter('total-donasi-input', 0); 
                updateFooter('total-perawatan-makam', 0); 
                updateFooter('total-bisyaroh-panitia', 0); 
                updateFooter('total-biaya-haul', 0); 
                setupPagination([], 1, 'donatur-pagination', renderDonaturTable); // Reset pagination
                return;
            }

            // --- LOGIKA PAGINATION DONATUR ---
            const startIndex = (currentDonaturPage - 1) * ROWS_PER_PAGE;
            const endIndex = startIndex + ROWS_PER_PAGE;
            const paginatedData = allDonatur.slice(startIndex, endIndex);
            
            // Hitung Total Keseluruhan (Hitung Semua Data)
            allDonatur.forEach((d) => {
                const nilaiDonasi = parseFloat(d.nilai) || 0;
                const pm = parseFloat(d.alokasi.perawatan_makam) || 0;
                const bp = parseFloat(d.alokasi.bisyaroh_panitia) || 0;
                const bh = parseFloat(d.alokasi.biaya_haul) || 0;
                
                totalDonasiInput += nilaiDonasi;
                totalPerawatanMakam += pm;
                totalBisyarohPanitia += bp;
                totalBiayaHaul += bh;
            });

            // Render data untuk halaman yang aktif
            paginatedData.forEach((d, index) => {
                const rowNumber = startIndex + index + 1; // Nomor urut global
                const nilaiDonasi = parseFloat(d.nilai) || 0;
                const pm = parseFloat(d.alokasi.perawatan_makam) || 0;
                const bp = parseFloat(d.alokasi.bisyaroh_panitia) || 0;
                const bh = parseFloat(d.alokasi.biaya_haul) || 0;
                
                const row = tableBody.insertRow();
                
                const dateObj = new Date(d.date + 'T00:00:00');
                const formattedDate = dateObj.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' });
                
                row.innerHTML = `
                    <td class="px-4 py-3 kolom-no text-center">${rowNumber}</td>
                    <td class="px-4 py-3 kolom-tanggal text-left">${formattedDate}</td>
                    <td class="px-4 py-3 kolom-nama kolom-nama-alamat text-left">${d.nama}</td> 
                    <td class="px-4 py-3 kolom-alamat kolom-nama-alamat text-left">${d.alamat}</td> 
                    <td class="px-4 py-3 text-right kolom-nilai-alokasi">${formatRupiah(nilaiDonasi)}</td> 
                    <td class="px-4 py-3 text-right kolom-nilai-alokasi">${formatRupiah(pm)}</td> 
                    <td class="px-4 py-3 text-right kolom-nilai-alokasi">${formatRupiah(bp)}</td> 
                    <td class="px-4 py-3 text-right kolom-nilai-alokasi">${formatRupiah(bh)}</td> 
                `;
            });

            // Update Footer Total
            updateFooter('total-donasi-input', totalDonasiInput);
            updateFooter('total-perawatan-makam', totalPerawatanMakam); 
            updateFooter('total-bisyaroh-panitia', totalBisyarohPanitia); 
            updateFooter('total-biaya-haul', totalBiayaHaul); 
            
            // Setup Pagination
            setupPagination(allDonatur, currentDonaturPage, 'donatur-pagination', renderDonaturTable);
        };

        const renderJurnalKasTable = () => {
            const tableBody = document.getElementById('jurnal-kas-table-body');
            tableBody.innerHTML = '';
            
            // Ambil total Donasi dari footer tabel donatur
            // Ini PENTING: harus ambil dari DOM karena ini adalah total dari SEMUA data donasi.
            const totalDonasiText = document.getElementById('total-donasi-input').textContent;
            const totalDonasi = parseFloat(totalDonasiText.replace(/\./g, '')) || 0;
            
            const kasEntries = [];

            // 1. Tambahkan Total Donasi sebagai BARIS PERTAMA JURNAL (Dana Masuk)
            if (totalDonasi > 0) {
                kasEntries.push({
                    date: new Date().toLocaleDateString('en-CA'), 
                    uraian: 'TOTAL SELURUH DONASI (Awal Kas)',
                    kategori: 'Donatur',
                    masuk: totalDonasi,
                    keluar: 0,
                    timestamp: 0 
                });
            }

            // 2. Tambahkan Semua Pengeluaran (Dana Keluar)
            allPengeluaran.forEach(p => {
                kasEntries.push({
                    date: p.date,
                    uraian: p.uraian,
                    kategori: p.kategori,
                    masuk: 0,
                    keluar: p.nilai_keluar,
                    timestamp: p.timestamp 
                });
            });

            // 3. Urutkan Jurnal Kas berdasarkan Tanggal/Timestamp
            kasEntries.sort((a, b) => {
                if (a.timestamp === 0 && b.timestamp !== 0) return -1; 
                if (b.timestamp === 0 && a.timestamp !== 0) return 1;
                return a.timestamp - b.timestamp;
            });
            
            // Total Saldo Akhir (Seluruh Data)
            const finalSaldo = kasEntries.reduce((acc, curr) => acc + curr.masuk - curr.keluar, 0);

            // 4. Cek Jika Kosong
            if (kasEntries.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="7" class="py-6 text-center text-text-light/70">Jurnal Kas kosong. Silakan catat donasi atau pengeluaran.</td></tr>`;
                updateFooter('total-saldo-akhir', 0);
                setupPagination([], 1, 'jurnal-kas-pagination', renderJurnalKasTable); // Reset pagination
                return;
            }

            // --- LOGIKA PAGINATION JURNAL KAS ---
            const startIndex = (currentJurnalKasPage - 1) * ROWS_PER_PAGE;
            // Batasi data yang akan dirender hanya di halaman ini
            const paginatedData = kasEntries.slice(startIndex, startIndex + ROWS_PER_PAGE);

            // 5. Hitung Saldo Awal untuk Halaman Aktif
            // Saldo harus dihitung kumulatif dari semua entri SEBELUM halaman ini
            let saldo = 0;
            for (let i = 0; i < startIndex; i++) {
                saldo += kasEntries[i].masuk - kasEntries[i].keluar;
            }

            // 6. Render Jurnal Kas & Lanjutkan Hitung Saldo Halaman Aktif
            paginatedData.forEach((entry, index) => {
                saldo += entry.masuk - entry.keluar;
                const rowNumber = startIndex + index + 1; // Nomor urut global

                const dateObj = new Date(entry.date + 'T00:00:00');
                const formattedDate = dateObj.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' });
                
                // Menentukan warna saldo (Kuning untuk Saldo Positif, Merah untuk Negatif)
                const saldoClass = saldo >= 0 ? 'text-yellow-accent' : 'text-red-danger';
                
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td class="px-4 py-3 kolom-no text-center">${rowNumber}</td>
                    <td class="px-4 py-3 kolom-tanggal text-left">${formattedDate}</td>
                    <td class="px-4 py-3 text-left">${entry.uraian}</td>
                    <td class="px-4 py-3 text-left">${entry.kategori}</td>
                    <td class="px-4 py-3 text-right kolom-nilai-alokasi text-yellow-accent">${entry.masuk > 0 ? formatRupiah(entry.masuk) : ''}</td>
                    <td class="px-4 py-3 text-right kolom-nilai-alokasi text-red-danger">${entry.keluar > 0 ? formatRupiah(entry.keluar) : ''}</td>
                    <td class="px-4 py-3 text-right total-angka-rupiah ${saldoClass}">${formatRupiah(saldo)}</td> 
                `;
            });
            
            // Update Saldo Akhir (Total Keseluruhan)
            updateFooter('total-saldo-akhir', finalSaldo);
            
            // Setup Pagination
            setupPagination(kasEntries, currentJurnalKasPage, 'jurnal-kas-pagination', renderJurnalKasTable);
        };

        // --------------------------------------------------------------------------------
        // 6. INISIALISASI
        // --------------------------------------------------------------------------------

        window.onload = () => {
            const today = new Date().toLocaleDateString('en-CA');
            const dateInputDonatur = document.getElementById('donatur-date-input');
            const dateInputKas = document.getElementById('kas-date-input'); 
            
            if (dateInputDonatur) {
                dateInputDonatur.value = today;
            }
            if (dateInputKas) { 
                dateInputKas.value = today;
            }
        };
    </script>
</body>
</html>
