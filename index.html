<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pembukuan Haul: Donatur, Jurnal & Ekspor Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKx3Kf+c8vEwJ+a0wYpQc/tWw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* Gaya agar tabel bisa digeser jika terlalu lebar */
        .table-wrapper {
            overflow-x: auto; 
        }

        /* --- PERBAIKAN FONT DAN TEBAL --- */
        body {
            font-family: Cambria, 'Times New Roman', Times, serif; 
        }
        
        table {
            font-size: 0.9rem; 
            width: 100%; 
        }

        td {
            font-weight: normal; 
        }

        /* --- STICKY COLUMN --- */
        th, td {
            padding: 8px 12px;
            text-align: left;
            white-space: nowrap; /* Jangan memutus baris di sel */
        }
        
        .sticky-col-1 {
            position: sticky;
            left: 0;
            z-index: 10;
        }

        /* Membuat header sticky column tetap di atas */
        .sticky-col-1.header {
            z-index: 20; 
        }
        
        /* Memastikan warna latar untuk kolom sticky */
        .bg-gray-200 { 
            background-color: #e5e7eb; 
        }
        .bg-white {
            background-color: #fff;
        }
        
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

    <div class="max-w-7xl mx-auto bg-white p-6 rounded-lg shadow-xl">
        <h1 class="text-3xl font-extrabold text-center text-gray-800 mb-2">
            Catatan Keuangan Haul
        </h1>
        <p class="text-center text-gray-600 mb-6">
            Pencatatan Donasi Jariyah & Jurnal Kas Umum
        </p>

        <div id="admin-controls" class="mt-4 mb-8">
            <div id="login-form-container" class="space-y-2 p-4 border rounded shadow bg-gray-50 max-w-sm mx-auto">
                <h3 class="font-bold text-center text-lg text-gray-700">Akses Admin</h3>
                <input type="email" id="admin-email" placeholder="Email Admin" class="w-full p-2 border rounded" required>
                <input type="password" id="admin-password" placeholder="Password Admin" class="w-full p-2 border rounded" required>
                <button onclick="adminLogin()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 rounded transition">
                    <i class="fa-solid fa-right-to-bracket mr-2"></i>Login Admin
                </button>
                <p class="text-xs text-red-500 text-center">Pastikan Email/Password telah terdaftar di Firebase Auth Anda.</p>
            </div>

            <div id="admin-tools-container" class="hidden">
                <div class="flex flex-col md:flex-row gap-2 justify-between mb-4">
                    <button onclick="confirmResetData()" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition w-full md:w-auto">
                        <i class="fa-solid fa-trash-can mr-2"></i>Reset Data
                    </button>
                    <button onclick="adminLogout()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded transition w-full md:w-auto">
                        <i class="fa-solid fa-right-from-bracket mr-2"></i>Logout Admin
                    </button>
                </div>

                <div class="mb-8 p-4 border rounded-lg shadow bg-green-50">
                    <h2 class="text-xl font-bold mb-3 text-green-700">Input Data Donasi Jariyah</h2>
                    <form id="form-donasi" class="space-y-3">
                        <input type="hidden" id="donatur-id-input">
                        <input type="date" id="donasi-tanggal" class="w-full p-2 border rounded" required>
                        <input type="text" id="donasi-nama" placeholder="Nama Donatur" class="w-full p-2 border rounded" required>
                        <input type="text" id="donasi-alamat" placeholder="Alamat (Opsional)" class="w-full p-2 border rounded">
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">Rp</span>
                            <input type="number" id="donasi-nilai" placeholder="Nominal Jariyah (cth: 100000)" class="w-full p-2 border rounded pl-10" required>
                        </div>
                        <button type="submit" id="submit-donasi-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded transition">
                            <i class="fa-solid fa-floppy-disk mr-2"></i>Simpan Donasi
                        </button>
                        <button type="button" onclick="resetDonasiForm()" class="w-full bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 rounded transition" id="cancel-donasi-btn" style="display:none;">
                            <i class="fa-solid fa-xmark mr-2"></i>Batal Edit
                        </button>
                    </form>
                </div>

                <div class="mb-8 p-4 border rounded-lg shadow bg-red-50">
                    <h2 class="text-xl font-bold mb-3 text-red-700">Input Jurnal Kas Umum (Dana Keluar)</h2>
                    <form id="form-jurnal" class="space-y-3">
                        <input type="hidden" id="jurnal-id-input">
                        <input type="date" id="jurnal-tanggal" class="w-full p-2 border rounded" required>
                        <input type="text" id="jurnal-uraian" placeholder="Uraian (Contoh: Beli Konsumsi Panitia)" class="w-full p-2 border rounded" required>
                        <select id="jurnal-kategori" class="w-full p-2 border rounded" required>
                            <option value="">Pilih Kategori Pengeluaran</option>
                            <option value="Biaya Haul">Biaya Haul (70%)</option>
                            <option value="Perawatan Makam">Perawatan Makam (15%)</option>
                            <option value="Ongkos Panitia">Ongkos Panitia (15%)</option>
                            <option value="Lainnya">Lainnya</option>
                        </select>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">Rp</span>
                            <input type="number" id="jurnal-dana-keluar" placeholder="Dana Keluar (cth: 50000)" class="w-full p-2 border rounded pl-10" required>
                        </div>
                        <button type="submit" id="submit-jurnal-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded transition">
                            <i class="fa-solid fa-floppy-disk mr-2"></i>Simpan Pengeluaran
                        </button>
                        <button type="button" onclick="resetJurnalForm()" class="w-full bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 rounded transition" id="cancel-jurnal-btn" style="display:none;">
                            <i class="fa-solid fa-xmark mr-2"></i>Batal Edit
                        </button>
                    </form>
                </div>
            </div>
        </div>
        <hr class="my-8">

        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex justify-between items-center">
            Jurnal Kas Umum
            <button onclick="exportJurnalDetailPDF()" class="bg-gray-500 hover:bg-gray-700 text-white text-sm py-1 px-3 rounded transition">
                <i class="fa-solid fa-file-pdf mr-2"></i>Unduh PDF Detail
            </button>
        </h2>
        <div id="jurnal-table-container" class="table-wrapper">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-200">
                    <tr>
                        <th class="sticky-col-1 header bg-gray-200 text-xs font-bold uppercase tracking-wider">NO</th>
                        <th class="text-xs font-bold uppercase tracking-wider">Tanggal</th>
                        <th class="text-xs font-bold uppercase tracking-wider">Uraian / Keterangan</th>
                        <th id="jurnal-kategori-header" class="text-xs font-bold uppercase tracking-wider admin-only" style="display:none;">Kategori</th>
                        <th class="text-xs font-bold uppercase tracking-wider text-right">Dana Masuk (Rp)</th>
                        <th class="text-xs font-bold uppercase tracking-wider text-right">Dana Keluar (Rp)</th>
                        <th class="text-xs font-bold uppercase tracking-wider text-right">Saldo (Rp)</th>
                        <th id="jurnal-aksi-header" class="text-xs font-bold uppercase tracking-wider text-center admin-only" style="display:none;">Aksi</th>
                    </tr>
                </thead>
                <tbody id="jurnal-kas-umum-body" class="bg-white divide-y divide-gray-200">
                    <tr><td colspan="8" class="text-center py-4 text-gray-500">Memuat data...</td></tr>
                </tbody>
                <tfoot id="jurnal-kas-umum-foot" class="bg-gray-100 font-bold">
                    </tfoot>
            </table>
        </div>
        <div class="flex justify-center mt-4">
            <button onclick="changeJurnalPage(-1)" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-1 px-3 rounded-l transition">
                <i class="fa-solid fa-chevron-left"></i>
            </button>
            <span id="jurnal-page-info" class="bg-gray-200 py-1 px-4 text-gray-800">Halaman 1/1</span>
            <button onclick="changeJurnalPage(1)" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-1 px-3 rounded-r transition">
                <i class="fa-solid fa-chevron-right"></i>
            </button>
        </div>


        <hr class="my-8">

        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex justify-between items-center">
            Laporan List Donatur Jariyah
            <div class="space-x-2">
                <button onclick="exportDonaturPDF()" class="bg-green-500 hover:bg-green-700 text-white text-sm py-1 px-3 rounded transition">
                    <i class="fa-solid fa-file-pdf mr-2"></i>Unduh PDF Donatur
                </button>
                <button onclick="exportLpjGlobalPDF()" class="bg-purple-500 hover:bg-purple-700 text-white text-sm py-1 px-3 rounded transition">
                    <i class="fa-solid fa-file-pdf mr-2"></i>Unduh PDF Ringkasan
                </button>
            </div>
        </h2>
        
        <div id="donatur-table-container" class="table-wrapper">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-200">
                    <tr>
                        <th class="sticky-col-1 header bg-gray-200 text-xs font-bold uppercase tracking-wider">NO</th>
                        <th class="text-xs font-bold uppercase tracking-wider">Tanggal</th>
                        <th class="text-xs font-bold uppercase tracking-wider">Nama Donatur</th>
                        <th class="text-xs font-bold uppercase tracking-wider">Alamat</th>
                        <th class="text-xs font-bold uppercase tracking-wider text-right">Jariyah (Rp)</th>
                        <th id="donatur-makam-header" class="text-xs font-bold uppercase tracking-wider text-right admin-only" style="display:none;">Perawatan Makam (15%)</th>
                        <th id="donatur-panitia-header" class="text-xs font-bold uppercase tracking-wider text-right admin-only" style="display:none;">Ongkos Panitia (15%)</th>
                        <th id="donatur-haul-header" class="text-xs font-bold uppercase tracking-wider text-right admin-only" style="display:none;">Biaya Haul (70%)</th>
                        <th class="text-xs font-bold uppercase tracking-wider text-right">Total Jariyah (Rp)</th>
                        <th id="donatur-aksi-header" class="text-xs font-bold uppercase tracking-wider text-center admin-only" style="display:none;">Aksi</th>
                    </tr>
                </thead>
                <tbody id="donatur-list-body" class="bg-white divide-y divide-gray-200">
                    <tr><td colspan="10" class="text-center py-4 text-gray-500">Memuat data...</td></tr>
                </tbody>
                <tfoot id="donatur-list-foot" class="bg-gray-100 font-bold">
                    </tfoot>
            </table>
        </div>
        <div class="flex justify-center mt-4">
            <button onclick="changeDonaturPage(-1)" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-1 px-3 rounded-l transition">
                <i class="fa-solid fa-chevron-left"></i>
            </button>
            <span id="donatur-page-info" class="bg-gray-200 py-1 px-4 text-gray-800">Halaman 1/1</span>
            <button onclick="changeDonaturPage(1)" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-1 px-3 rounded-r transition">
                <i class="fa-solid fa-chevron-right"></i>
            </button>
        </div>


        <p class="text-center text-xs text-gray-500 mt-8">
            Dibuat dengan ❤️ untuk Pembukuan Haul.
        </p>

    </div>

    <script>
        const { jsPDF } = window.jspdf;
        
        // ================================================================================
        // 1. INICIALISASI FIREBASE & KONFIGURASI
        // ================================================================================

        const firebaseConfig = {
            apiKey: "AIzaSyAHIO0RZgoq6eyjeERTpjOugzJLzqG2S-w",
            authDomain: "catatan-keuangan-haul.firebaseapp.com",
            projectId: "catatan-keuangan-haul",
            storageBucket: "catatan-keuangan-haul.firebasestorage.app",
            messagingSenderId: "955355049778",
            appId: "1:955355049778:web:0b844b27b82a88cc0cf12b"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore();
        const auth = app.auth(); // <-- Inisialisasi Firebase Auth

        const DONATUR_COLLECTION = 'donatur_haul';
        const JURNAL_COLLECTION = 'jurnal_haul';
        
        // Data Utama
        let allTransactions = []; // Data Donatur
        let jurnalTransactions = []; // Data Jurnal Kas Umum

        let isAdminLoggedIn = false; // Status admin, diatur oleh Firebase Auth
        
        // Pagination
        const itemsPerPage = 10;
        let currentDonaturPage = 1;
        let currentJurnalPage = 1;

        // ================================================================================
        // 2. UTILITAS
        // ================================================================================

        const formatRupiah = (angka) => {
            if (typeof angka !== 'number') return 'Rp 0';
            const sisa = angka.toString().length % 3;
            let rupiah = angka.toString().substring(0, sisa);
            const ribuan = angka.toString().substring(sisa).match(/\d{3}/g);

            if (ribuan) {
                const separator = sisa ? '.' : '';
                rupiah += separator + ribuan.join('.');
            }
            
            // Tambahkan minus jika negatif, tapi biasanya saldo tidak negatif
            return (rupiah.startsWith('-') ? '- Rp ' : 'Rp ') + rupiah.replace(/^-/, ''); 
        };

        const updateAdminView = () => {
            const adminElements = document.querySelectorAll('.admin-only');
            const forms = document.getElementById('admin-tools-container');
            
            // Tampilkan/Sembunyikan form input dan kolom admin
            if (isAdminLoggedIn) {
                adminElements.forEach(el => el.style.display = 'table-cell');
                forms.classList.remove('hidden');
                document.getElementById('login-form-container').classList.add('hidden');
            } else {
                adminElements.forEach(el => el.style.display = 'none');
                forms.classList.add('hidden');
                document.getElementById('login-form-container').classList.remove('hidden');
            }

            // Render ulang tabel untuk menerapkan perubahan tampilan kolom
            renderAllTables();
        };
        
        // ================================================================================
        // 3. FIREBASE AUTHENTICATION
        // ================================================================================
        
        // ADMIN LOGIN
        window.adminLogin = async () => {
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;

            if (!email || !password) {
                return alert('Mohon isi Email dan Password.');
            }

            try {
                // Gunakan Firebase Auth untuk login
                await auth.signInWithEmailAndPassword(email, password);
                // alert('Login berhasil!'); // Notifikasi akan terjadi di onAuthStateChanged
            } catch (error) {
                console.error("Login Error: ", error);
                alert(`Login gagal: ${error.message}`);
            }
        };

        // ADMIN LOGOUT
        window.adminLogout = async () => {
            try {
                await auth.signOut();
                alert('Anda telah logout.');
            } catch (error) {
                console.error("Logout Error: ", error);
                alert(`Logout gagal: ${error.message}`);
            }
        };
        
        // ADMIN STATE LISTENER (Menggantikan ADMIN_PASSWORD & sessionStorage)
        auth.onAuthStateChanged(user => {
            if (user) {
                // User is signed in
                isAdminLoggedIn = true;
                document.getElementById('admin-email').value = '';
                document.getElementById('admin-password').value = '';
            } else {
                // User is signed out
                isAdminLoggedIn = false;
            }
            updateAdminView();
        });


        // ================================================================================
        // 4. FIREBASE FIRESTORE DATA (LOAD, SUBMIT, DELETE)
        // ================================================================================

        // LOAD DATA
        const loadDataFromFirestore = async () => {
            try {
                // --- 1. Load Donatur (Urutkan berdasarkan timestamp) ---
                const donaturSnapshot = await db.collection(DONATUR_COLLECTION).orderBy('timestamp', 'asc').get();
                allTransactions = donaturSnapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data(), 
                    nilai: Number(doc.data().nilai) // Pastikan nilai tetap berupa number
                }));
                
                // --- 2. Load Jurnal (Urutkan berdasarkan timestamp) ---
                const jurnalSnapshot = await db.collection(JURNAL_COLLECTION).orderBy('timestamp', 'asc').get();
                jurnalTransactions = jurnalSnapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data(), 
                    danaKeluar: Number(doc.data().danaKeluar)
                }));
                
                renderAllTables();
                
            } catch (error) {
                console.error("Error loading data from Firestore: ", error);
                alert("Gagal memuat data dari Firebase. Cek koneksi internet dan konsol.");
            }
        };

        // ================================================================================
        // DONASI JARIYAH (SUBMIT)
        // ================================================================================
        const resetDonasiForm = () => {
            document.getElementById('form-donasi').reset();
            document.getElementById('donatur-id-input').value = '';
            document.getElementById('submit-donasi-btn').textContent = 'Simpan Donasi';
            document.getElementById('cancel-donasi-btn').style.display = 'none';
        }
        
        window.editDonatur = (id) => {
            if (!isAdminLoggedIn) return alert('Akses Ditolak. Silakan login sebagai Admin.');
            const transaction = allTransactions.find(t => t.id === id);
            if (transaction) {
                document.getElementById('donatur-id-input').value = transaction.id;
                document.getElementById('donasi-tanggal').value = transaction.tanggal;
                document.getElementById('donasi-nama').value = transaction.nama;
                document.getElementById('donasi-alamat').value = transaction.alamat;
                document.getElementById('donasi-nilai').value = transaction.nilai;
                
                document.getElementById('submit-donasi-btn').textContent = 'Update Donasi';
                document.getElementById('cancel-donasi-btn').style.display = 'block';
                document.getElementById('donasi-tanggal').focus(); // Fokus ke form
            }
        };

        window.deleteDonatur = async (id) => {
            if (!isAdminLoggedIn) return alert('Akses Ditolak. Silakan login sebagai Admin untuk menghapus data.');
            if (!confirm('Anda yakin ingin menghapus data donatur ini? Menghapus donasi akan mempengaruhi saldo total kas.')) return;

            try {
                await db.collection(DONATUR_COLLECTION).doc(id).delete();
                await loadDataFromFirestore(); // Muat ulang data setelah delete
                alert('Data Donatur berhasil dihapus.');
            } catch (error) {
                console.error("Error deleting donatur data: ", error);
                alert("Gagal menghapus data donatur dari Firebase.");
            }
        };

        document.getElementById('form-donasi').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!isAdminLoggedIn) return alert('Akses Ditolak. Silakan login sebagai Admin untuk menginput data.');
            
            const tanggal = document.getElementById('donasi-tanggal').value;
            const nama = document.getElementById('donasi-nama').value;
            const alamat = document.getElementById('donasi-alamat').value;
            const nilai = parseFloat(document.getElementById('donasi-nilai').value);
            
            if (isNaN(nilai) || nilai <= 0) return alert('Nilai donasi tidak valid.');
            if (!tanggal || !nama) return alert('Tanggal dan Nama Donatur harus diisi.');

            const existingId = document.getElementById('donatur-id-input').value;
            
            const transactionData = { 
                tanggal, 
                nama, 
                alamat, 
                nilai, // Nilai sudah berupa number
            };

            try {
                if (existingId) {
                    // Mode Edit
                    await db.collection(DONATUR_COLLECTION).doc(existingId).update(transactionData);
                    alert('Data Donatur berhasil diubah!');
                } else {
                    // Mode Create
                    transactionData.timestamp = Date.now(); // Tambahkan timestamp saat create
                    await db.collection(DONATUR_COLLECTION).add(transactionData);
                    alert('Donasi berhasil dicatat!');
                }
                
                resetDonasiForm();
                await loadDataFromFirestore(); // Muat ulang data setelah submit

            } catch (error) {
                console.error("Error saving donatur data: ", error);
                alert("Gagal menyimpan data donatur ke Firebase.");
            }
        });

        // ================================================================================
        // JURNAL KAS UMUM (SUBMIT)
        // ================================================================================

        const resetJurnalForm = () => {
            document.getElementById('form-jurnal').reset();
            document.getElementById('jurnal-id-input').value = '';
            document.getElementById('submit-jurnal-btn').textContent = 'Simpan Pengeluaran';
            document.getElementById('cancel-jurnal-btn').style.display = 'none';
        }

        window.editJurnal = (id) => {
            if (!isAdminLoggedIn) return alert('Akses Ditolak. Silakan login sebagai Admin.');
            
            // Cari data di array jurnalTransactions (bukan donasi)
            const transaction = jurnalTransactions.find(t => t.id === id); 
            if (transaction) {
                document.getElementById('jurnal-id-input').value = transaction.id;
                document.getElementById('jurnal-tanggal').value = transaction.tanggal;
                document.getElementById('jurnal-uraian').value = transaction.uraian;
                document.getElementById('jurnal-kategori').value = transaction.kategori;
                document.getElementById('jurnal-dana-keluar').value = transaction.danaKeluar; // danaKeluar saja
                
                document.getElementById('submit-jurnal-btn').textContent = 'Update Pengeluaran';
                document.getElementById('cancel-jurnal-btn').style.display = 'block';
                document.getElementById('jurnal-tanggal').focus(); // Fokus ke form
            }
        };

        window.deleteJurnal = async (id) => {
            if (!isAdminLoggedIn) return alert('Akses Ditolak. Silakan login sebagai Admin untuk menghapus data.');
            if (!confirm('Anda yakin ingin menghapus data pengeluaran ini?')) return;

            try {
                await db.collection(JURNAL_COLLECTION).doc(id).delete();
                await loadDataFromFirestore(); // Muat ulang data setelah delete
                alert('Data Jurnal berhasil dihapus.');
            } catch (error) {
                console.error("Error deleting jurnal data: ", error);
                alert("Gagal menghapus data jurnal dari Firebase.");
            }
        };

        document.getElementById('form-jurnal').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!isAdminLoggedIn) return alert('Akses Ditolak. Silakan login sebagai Admin untuk menginput data.');

            const tanggal = document.getElementById('jurnal-tanggal').value;
            const uraian = document.getElementById('jurnal-uraian').value;
            const kategori = document.getElementById('jurnal-kategori').value;
            const danaKeluar = parseFloat(document.getElementById('jurnal-dana-keluar').value);

            if (isNaN(danaKeluar) || danaKeluar <= 0) return alert('Nilai dana keluar tidak valid.');
            if (!tanggal || !uraian || !kategori) return alert('Semua kolom harus diisi.');

            const existingId = document.getElementById('jurnal-id-input').value;

            const jurnalData = { 
                tanggal, 
                uraian, 
                kategori, 
                danaMasuk: 0, // Dana masuk hanya dari Donasi, bukan input form ini
                danaKeluar // Sudah berupa number
            };

            try {
                if (existingId) {
                    // Mode Edit
                    await db.collection(JURNAL_COLLECTION).doc(existingId).update(jurnalData);
                    alert('Data Jurnal berhasil diubah!');
                } else {
                    // Mode Create
                    jurnalData.timestamp = Date.now(); // Tambahkan timestamp saat create
                    await db.collection(JURNAL_COLLECTION).add(jurnalData);
                    alert('Pengeluaran berhasil dicatat!');
                }

                resetJurnalForm();
                await loadDataFromFirestore(); // Muat ulang data setelah submit
                
            } catch (error) {
                console.error("Error saving jurnal data: ", error);
                alert("Gagal menyimpan data jurnal ke Firebase.");
            }
        });

        // ================================================================================
        // RESET DATA (Menggunakan Batch Write)
        // ================================================================================

        window.confirmResetData = async () => {
            if (!isAdminLoggedIn) return;
            if (!confirm('PERINGATAN! Anda yakin ingin MENGHAPUS SEMUA data Donasi dan Jurnal di Firebase? Tindakan ini tidak bisa dibatalkan.')) return;
            
            const email = prompt('Untuk konfirmasi, ketik ulang email admin Anda:');
            const password = prompt('Ketik ulang password admin Anda:');

            if (!email || !password) return alert('Pembatalan reset data.');

            try {
                // 1. Re-otentikasi untuk keamanan
                const credentials = await auth.signInWithEmailAndPassword(email, password);
                
                // 2. Jika otentikasi berhasil, lakukan reset data
                const batch = db.batch();
                
                // Hapus semua data Donatur
                const donaturSnap = await db.collection(DONATUR_COLLECTION).get();
                donaturSnap.docs.forEach((doc) => batch.delete(doc.ref));
                
                // Hapus semua data Jurnal
                const jurnalSnap = await db.collection(JURNAL_COLLECTION).get();
                jurnalSnap.docs.forEach((doc) => batch.delete(doc.ref));
                
                await batch.commit();

                // Muat ulang data
                await loadDataFromFirestore(); 
                alert('Semua data berhasil direset (dihapus).');
                await auth.signOut(); // Logout otomatis setelah reset
                
            } catch (error) {
                 console.error("Error resetting data: ", error);
                 alert(`Gagal mereset data. Kemungkinan: Password/Email salah atau ${error.message}`);
            }
        };


        // ================================================================================
        // 5. RENDER TABLES (DONATUR & JURNAL)
        // ================================================================================

        const renderDonaturTable = (data, page) => {
            const start = (page - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginatedData = data.slice(start, end);

            const tbody = document.getElementById('donatur-list-body');
            const tfoot = document.getElementById('donatur-list-foot');
            tbody.innerHTML = '';
            tfoot.innerHTML = '';

            let totalJariyah = 0;
            let totalMakam = 0;
            let totalPanitia = 0;
            let totalHaul = 0;

            paginatedData.forEach((t, index) => {
                const no = start + index + 1;
                totalJariyah += t.nilai;

                const makam = Math.round(t.nilai * 0.15);
                const panitia = Math.round(t.nilai * 0.15);
                const haul = t.nilai - makam - panitia; // Sisanya

                totalMakam += makam;
                totalPanitia += panitia;
                totalHaul += haul;

                const actionCell = isAdminLoggedIn ? 
                    `<td class="px-6 py-4 whitespace-nowrap text-right admin-only">
                        <button onclick="editDonatur('${t.id}')" class="text-blue-600 hover:text-blue-900 mr-2"><i class="fa-solid fa-pen-to-square"></i></button>
                        <button onclick="deleteDonatur('${t.id}')" class="text-red-600 hover:text-red-900"><i class="fa-solid fa-trash-can"></i></button>
                    </td>` : `<td class="admin-only" style="display:none;"></td>`;

                const adminCells = isAdminLoggedIn ? 
                    `<td class="px-6 py-4 whitespace-nowrap text-right admin-only">${formatRupiah(makam)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right admin-only">${formatRupiah(panitia)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right admin-only">${formatRupiah(haul)}</td>` : '';

                tbody.innerHTML += `
                    <tr class="${(index % 2 === 0 ? 'bg-white' : 'bg-gray-50')}">
                        <td class="sticky-col-1 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} px-6 py-4 whitespace-nowrap font-medium">${no}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${t.tanggal}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${t.nama}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${t.alamat || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">${formatRupiah(t.nilai)}</td>
                        ${adminCells}
                        <td class="px-6 py-4 whitespace-nowrap text-right font-bold text-green-700">${formatRupiah(t.nilai)}</td>
                        ${actionCell}
                    </tr>
                `;
            });

            // TFOOT
            const colspanPublic = 4; // NO, Tanggal, Nama, Alamat
            const colspanAdmin = 3; // Makam, Panitia, Haul

            const totalColspan = isAdminLoggedIn ? colspanPublic + colspanAdmin : colspanPublic;
            const totalActionCol = isAdminLoggedIn ? 1 : 0;
            const totalMakamCell = isAdminLoggedIn ? `<td class="px-6 py-4 whitespace-nowrap text-right">${formatRupiah(totalMakam)}</td>` : '';
            const totalPanitiaCell = isAdminLoggedIn ? `<td class="px-6 py-4 whitespace-nowrap text-right">${formatRupiah(totalPanitia)}</td>` : '';
            const totalHaulCell = isAdminLoggedIn ? `<td class="px-6 py-4 whitespace-nowrap text-right">${formatRupiah(totalHaul)}</td>` : '';
            const totalAksiCell = isAdminLoggedIn ? `<td class="px-6 py-4 whitespace-nowrap text-right"></td>` : '';


            tfoot.innerHTML = `
                <tr>
                    <td colspan="${totalColspan}" class="sticky-col-1 px-6 py-4 whitespace-nowrap text-right font-bold bg-gray-100">SUBTOTAL HALAMAN:</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">${formatRupiah(totalJariyah)}</td>
                    ${totalMakamCell}
                    ${totalPanitiaCell}
                    ${totalHaulCell}
                    <td class="px-6 py-4 whitespace-nowrap text-right text-green-700">${formatRupiah(totalJariyah)}</td>
                    ${totalAksiCell}
                </tr>
                <tr>
                    <td colspan="${totalColspan}" class="sticky-col-1 px-6 py-4 whitespace-nowrap text-right font-extrabold bg-gray-200">GRAND TOTAL SELURUH DONASI:</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right font-extrabold bg-gray-200">${formatRupiah(allTransactions.reduce((sum, t) => sum + t.nilai, 0))}</td>
                    <td colspan="${4 + totalActionCol}" class="bg-gray-200"></td>
                </tr>
            `;

            document.getElementById('donatur-page-info').textContent = `Halaman ${page}/${Math.ceil(data.length / itemsPerPage)}`;
            return allTransactions.reduce((sum, t) => sum + t.nilai, 0); // Total donasi bersih
        };
        
        const changeDonaturPage = (change) => {
            const totalPages = Math.ceil(allTransactions.length / itemsPerPage);
            const newPage = currentDonaturPage + change;
            if (newPage > 0 && newPage <= totalPages) {
                currentDonaturPage = newPage;
                renderDonaturTable(allTransactions, currentDonaturPage);
            }
        };

        const renderJurnalTable = (totalDonasi, page) => {
            // Gabungkan Donasi (sebagai dana masuk) dan Pengeluaran (jurnalTransactions)
            const donasiEntry = {
                id: 'DONASI',
                timestamp: allTransactions.length > 0 ? new Date(allTransactions[allTransactions.length - 1].tanggal).getTime() - 1 : Date.now(), // Masuk sebelum pengeluaran terakhir
                tanggal: allTransactions.length > 0 ? allTransactions[allTransactions.length - 1].tanggal : new Date().toISOString().substring(0, 10),
                uraian: 'TOTAL DONASI JARIYAH HAUL',
                kategori: 'Dana Masuk',
                danaMasuk: totalDonasi,
                danaKeluar: 0,
            };

            const combinedTransactions = [...jurnalTransactions, donasiEntry].sort((a, b) => a.timestamp - b.timestamp);
            
            const start = (page - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginatedData = combinedTransactions.slice(start, end);

            const tbody = document.getElementById('jurnal-kas-umum-body');
            const tfoot = document.getElementById('jurnal-kas-umum-foot');
            tbody.innerHTML = '';
            tfoot.innerHTML = '';

            let saldo = 0;
            let totalMasuk = 0;
            let totalKeluar = 0;

            // Hitung saldo sebelum halaman ini
            for (let i = 0; i < start; i++) {
                saldo += combinedTransactions[i].danaMasuk - combinedTransactions[i].danaKeluar;
            }

            paginatedData.forEach((t, index) => {
                const no = start + index + 1;
                const danaMasuk = t.danaMasuk || 0;
                const danaKeluar = t.danaKeluar || 0;
                
                saldo += danaMasuk - danaKeluar;
                totalMasuk += danaMasuk;
                totalKeluar += danaKeluar;

                const actionCell = isAdminLoggedIn && t.id !== 'DONASI' ? 
                    `<td class="px-6 py-4 whitespace-nowrap text-right admin-only">
                        <button onclick="editJurnal('${t.id}')" class="text-blue-600 hover:text-blue-900 mr-2"><i class="fa-solid fa-pen-to-square"></i></button>
                        <button onclick="deleteJurnal('${t.id}')" class="text-red-600 hover:text-red-900"><i class="fa-solid fa-trash-can"></i></button>
                    </td>` : `<td class="admin-only" style="display:none;"></td>`;

                const uraianCell = isAdminLoggedIn ? t.uraian : `${t.uraian} (${t.kategori})`;
                const kategoriCell = isAdminLoggedIn ? `<td class="px-6 py-4 whitespace-nowrap admin-only">${t.kategori}</td>` : '';
                
                const bgColor = t.id === 'DONASI' ? 'bg-green-100 font-bold' : (index % 2 === 0 ? 'bg-white' : 'bg-gray-50');

                tbody.innerHTML += `
                    <tr class="${bgColor}">
                        <td class="sticky-col-1 ${bgColor} px-6 py-4 whitespace-nowrap font-medium">${no}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${t.tanggal}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${uraianCell}</td>
                        ${kategoriCell}
                        <td class="px-6 py-4 whitespace-nowrap text-right text-green-600">${formatRupiah(danaMasuk)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-red-600">${formatRupiah(danaKeluar)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right font-bold ${saldo < 0 ? 'text-red-700' : 'text-gray-900'}">${formatRupiah(saldo)}</td>
                        ${actionCell}
                    </tr>
                `;
            });

            // TFOOT
            const totalColspan = isAdminLoggedIn ? 3 : 2; // NO, Tgl, Uraian, Kategori(admin)
            const saldoAwal = combinedTransactions.slice(0, start).reduce((sum, t) => sum + t.danaMasuk - t.danaKeluar, 0);

            tfoot.innerHTML = `
                <tr>
                    <td colspan="${totalColspan}" class="sticky-col-1 px-6 py-4 whitespace-nowrap text-right font-bold bg-gray-100">SALDO AWAL HALAMAN:</td>
                    <td colspan="${1 + (isAdminLoggedIn ? 1 : 0)}" class="px-6 py-4 whitespace-nowrap text-right font-bold bg-gray-100"></td>
                    <td class="px-6 py-4 whitespace-nowrap text-right font-bold bg-gray-100">${formatRupiah(saldoAwal)}</td>
                    <td colspan="${isAdminLoggedIn ? 1 : 0}" class="bg-gray-100"></td>
                </tr>
                <tr>
                    <td colspan="${totalColspan}" class="sticky-col-1 px-6 py-4 whitespace-nowrap text-right font-bold bg-gray-200">TOTAL AKHIR KAS UMUM:</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right font-bold bg-gray-200 text-green-700">${formatRupiah(combinedTransactions.reduce((sum, t) => sum + t.danaMasuk, 0))}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right font-bold bg-gray-200 text-red-700">${formatRupiah(combinedTransactions.reduce((sum, t) => sum + t.danaKeluar, 0))}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right font-extrabold bg-gray-200 ${saldo < 0 ? 'text-red-700' : 'text-gray-900'}">${formatRupiah(saldo)}</td>
                    <td colspan="${isAdminLoggedIn ? 1 : 0}" class="bg-gray-200"></td>
                </tr>
            `;

            document.getElementById('jurnal-page-info').textContent = `Halaman ${page}/${Math.ceil(combinedTransactions.length / itemsPerPage)}`;
        };
        
        const changeJurnalPage = (change) => {
            const combinedTransactions = [...jurnalTransactions, {id: 'DONASI', timestamp: 0, danaMasuk: allTransactions.reduce((sum, t) => sum + t.nilai, 0), danaKeluar: 0, tanggal: ''}];
            const totalPages = Math.ceil(combinedTransactions.length / itemsPerPage);
            const newPage = currentJurnalPage + change;
            if (newPage > 0 && newPage <= totalPages) {
                currentJurnalPage = newPage;
                renderJurnalTable(allTransactions.reduce((sum, t) => sum + t.nilai, 0), currentJurnalPage);
            }
        };


        const renderAllTables = () => {
            // Urutkan donatur sebelum merender
            allTransactions.sort((a, b) => a.timestamp - b.timestamp);
            jurnalTransactions.sort((a, b) => a.timestamp - b.timestamp);
            const totalDonasi = renderDonaturTable(allTransactions, currentDonaturPage);
            renderJurnalTable(totalDonasi, currentJurnalPage);
        };
        
        // ================================================================================
        // 6. EKSPOR PDF (LOGIC SAMA, TAPI DIPISAH UNTUK KEBERSIHAN)
        // ================================================================================

        const addSignatures = (doc, yPos) => {
            doc.setFontSize(10);
            const signatureData = [
                ["Mengetahui,", "Dibuat Oleh,"],
                ["[Nama Penanggung Jawab]", "[Nama Bendahara]"],
                ["NIP/Jabatan", "NIP/Jabatan"]
            ];
            doc.autoTable({
                startY: yPos,
                body: signatureData,
                theme: 'plain',
                styles: { fontSize: 10, cellPadding: 1, halign: 'center' },
                columnStyles: { 0: { cellWidth: 80 }, 1: { cellWidth: 80 } },
                margin: { left: 20 }
            });
        };

        window.exportDonaturPDF = () => {
            const doc = new jsPDF.jsPDF({ orientation: 'landscape', format: 'a4' });
            doc.text('LAPORAN LIST DONATUR JARIYAH HAUL', 148.5, 15, null, null, 'center');
            
            const totalJariyah = allTransactions.reduce((sum, t) => sum + t.nilai, 0);

            const tableData = allTransactions.map((t, index) => [
                index + 1,
                t.tanggal,
                t.nama,
                t.alamat || '-',
                formatRupiah(t.nilai).replace('Rp ', ''),
                formatRupiah(t.nilai).replace('Rp ', '')
            ]);

            doc.autoTable({
                head: [['NO', 'Tanggal', 'Nama Donatur', 'Alamat', 'Jariyah (Rp)', 'Total Jariyah (Rp)']],
                body: tableData,
                startY: 20,
                theme: 'grid',
                headStyles: { fillColor: [41, 128, 185], halign: 'center' },
                styles: { fontSize: 8 },
                columnStyles: {
                    4: { halign: 'right' },
                    5: { halign: 'right', fontStyle: 'bold' },
                },
                foot: [['', '', '', 'GRAND TOTAL', formatRupiah(totalJariyah).replace('Rp ', ''), formatRupiah(totalJariyah).replace('Rp ', '')]],
                footStyles: { halign: 'right', fontStyle: 'bold', fillColor: [200, 200, 200] }
            });

            addSignatures(doc, doc.lastAutoTable.finalY + 10);
            doc.save("Laporan_List_Donatur.pdf");
        };

        window.exportJurnalDetailPDF = () => {
            const doc = new jsPDF.jsPDF({ orientation: 'landscape', format: 'a4' });
            doc.text('LAPORAN DETAIL JURNAL KAS UMUM HAUL', 148.5, 15, null, null, 'center');

            const totalDonasi = allTransactions.reduce((sum, t) => sum + t.nilai, 0);
            const donasiEntry = {
                id: 'DONASI',
                timestamp: allTransactions.length > 0 ? new Date(allTransactions[allTransactions.length - 1].tanggal).getTime() - 1 : Date.now(),
                tanggal: allTransactions.length > 0 ? allTransactions[allTransactions.length - 1].tanggal : new Date().toISOString().substring(0, 10),
                uraian: 'TOTAL DONASI JARIYAH',
                kategori: 'Dana Masuk',
                danaMasuk: totalDonasi,
                danaKeluar: 0,
            };

            const combinedTransactions = [...jurnalTransactions, donasiEntry].sort((a, b) => a.timestamp - b.timestamp);

            let saldo = 0;
            const tableData = combinedTransactions.map((t, index) => {
                saldo += t.danaMasuk - t.danaKeluar;
                return [
                    index + 1,
                    t.tanggal,
                    t.uraian,
                    t.kategori,
                    t.danaMasuk > 0 ? formatRupiah(t.danaMasuk).replace('Rp ', '') : '',
                    t.danaKeluar > 0 ? formatRupiah(t.danaKeluar).replace('Rp ', '') : '',
                    formatRupiah(saldo).replace('Rp ', ''),
                ];
            });

            doc.autoTable({
                head: [['NO', 'Tanggal', 'Uraian', 'Kategori', 'Dana Masuk (Rp)', 'Dana Keluar (Rp)', 'Saldo (Rp)']],
                body: tableData,
                startY: 20,
                theme: 'grid',
                headStyles: { fillColor: [41, 128, 185], halign: 'center' },
                styles: { fontSize: 8 },
                columnStyles: {
                    4: { halign: 'right', textColor: [0, 150, 0] },
                    5: { halign: 'right', textColor: [180, 0, 0] },
                    6: { halign: 'right', fontStyle: 'bold' },
                },
                foot: [['', '', '', 'GRAND TOTAL', formatRupiah(combinedTransactions.reduce((sum, t) => sum + t.danaMasuk, 0)).replace('Rp ', ''), formatRupiah(combinedTransactions.reduce((sum, t) => sum + t.danaKeluar, 0)).replace('Rp ', ''), formatRupiah(saldo).replace('Rp ', '')]],
                footStyles: { halign: 'right', fontStyle: 'bold', fillColor: [200, 200, 200] }
            });

            addSignatures(doc, doc.lastAutoTable.finalY + 10);
            doc.save("Laporan_Detail_Jurnal.pdf");
        };

        window.exportLpjGlobalPDF = () => {
            const doc = new jsPDF.jsPDF({ orientation: 'portrait', format: 'a4' });
            doc.text('LAPORAN PERTANGGUNGJAWABAN (LPJ) GLOBAL RINGKASAN', 105, 15, null, null, 'center');
            
            const totalDonasi = allTransactions.reduce((sum, t) => sum + t.nilai, 0);
            const totalMakam = Math.round(totalDonasi * 0.15);
            const totalPanitia = Math.round(totalDonasi * 0.15);
            const totalHaul = totalDonasi - totalMakam - totalPanitia;

            const pengeluaran = jurnalTransactions.reduce((acc, t) => {
                acc[t.kategori] = (acc[t.kategori] || 0) + t.danaKeluar;
                return acc;
            }, {});

            const tableData = [
                ['A. DANA MASUK', ''],
                ['Total Donasi Jariyah', formatRupiah(totalDonasi).replace('Rp ', '')],
                ['', ''],
                ['B. ALOKASI DANA MASUK', ''],
                ['1. Perawatan Makam (15% dari Donasi)', formatRupiah(totalMakam).replace('Rp ', '')],
                ['2. Ongkos Panitia (15% dari Donasi)', formatRupiah(totalPanitia).replace('Rp ', '')],
                ['3. Biaya Haul (70% dari Donasi)', formatRupiah(totalHaul).replace('Rp ', '')],
                ['', ''],
                ['C. PENGELUARAN AKTUAL', ''],
                ...Object.keys(pengeluaran).map(k => [`Pengeluaran Kategori: ${k}`, formatRupiah(pengeluaran[k]).replace('Rp ', '')]),
                ['Total Pengeluaran Aktual', formatRupiah(Object.values(pengeluaran).reduce((s, v) => s + v, 0)).replace('Rp ', '')],
                ['', ''],
            ];

            const totalPengeluaran = Object.values(pengeluaran).reduce((s, v) => s + v, 0);
            const saldoAkhir = totalDonasi - totalPengeluaran;

            doc.autoTable({
                head: [['Uraian', 'Jumlah (Rp)']],
                body: tableData,
                startY: 20,
                theme: 'striped',
                headStyles: { fillColor: [41, 128, 185], halign: 'center' },
                styles: { fontSize: 10 },
                columnStyles: {
                    0: { cellWidth: 120 },
                    1: { halign: 'right' },
                },
                foot: [['SALDO AKHIR KAS (Masuk - Keluar)', formatRupiah(saldoAkhir).replace('Rp ', '')]],
                footStyles: { halign: 'right', fontStyle: 'bold', fillColor: [200, 200, 200] }
            });
            
            addSignatures(doc, doc.lastAutoTable.finalY + 10);
            doc.save("LPJ_Global_Ringkasan.pdf");
        };


        // --------------------------------------------------------------------------------
        // 7. INITIAL LOAD
        // --------------------------------------------------------------------------------

        window.onload = () => {
            // Hanya panggil load data. Status admin akan otomatis ditangani oleh onAuthStateChanged.
            loadDataFromFirestore(); 
        };
    </script>
</body>
</html>
