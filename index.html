<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan List Donatur Jariyah</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Menggunakan font Inter secara default */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Animasi masuk modal */
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-down {
            animation: fadeInDown 0.3s ease-out forwards;
        }
        /* Styling untuk baris total */
        .total-row {
            background-color: #166534; /* Dark Green */
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen bg-gray-100 font-sans p-4 sm:p-6 lg:p-8">
        <!-- Konten aplikasi akan dirender di sini oleh JavaScript -->
        <div class="text-center p-10">
            <svg class="animate-spin h-8 w-8 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-sm text-gray-600">Memuat Aplikasi...</p>
        </div>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, addDoc, onSnapshot, doc, updateDoc, deleteDoc, Timestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // setLogLevel('debug'); // Uncomment untuk debugging Firebase

        // --- Konfigurasi dan Global Variables ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let donations = []; // Mengganti transactions menjadi donations
        let isLoading = true;
        let error = null;
        let isModalOpen = false;
        let editingDonation = null;
        let isConfirmModalOpen = false;
        let donationToDelete = null;
        let formData = {
            tanggal: new Date().toISOString().substring(0, 10),
            namaDonatur: '',
            alamat: '',
            nominalJariyah: '',
        };

        // --- Konstanta Pembagian Persentase ---
        const P_MAKAM = 0.15; // 15%
        const P_PANITIA = 0.15; // 15%
        const P_HAUL = 0.70; // 70%

        // --- Fungsi Utilitas ---

        // Fungsi untuk memformat nominal ke Rupiah
        const formatRupiah = (number) => {
            const num = Number(number);
            if (isNaN(num)) return 'Rp 0';
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0,
            }).format(num);
        };

        // Fungsi untuk memformat tanggal ke format lokal
        const formatDate = (timestamp) => {
            if (!timestamp) return '-';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('id-ID', {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
            });
        };

        // Path Collection Firestore
        const getCollectionPath = (currentUserId) => {
            if (!currentUserId) return null;
            return `artifacts/${appId}/users/${currentUserId}/jariyah_donations`;
        };
        
        // Fungsi untuk menghitung pembagian
        const calculateDistribution = (nominal) => {
            const n = Number(nominal);
            return {
                makam: Math.round(n * P_MAKAM),
                panitia: Math.round(n * P_PANITIA),
                haul: Math.round(n * P_HAUL),
            };
        };

        // --- State Management dan Render Ulang UI ---
        const renderApp = () => {
            const appDiv = document.getElementById('app');
            if (!appDiv) return;

            // Perhitungan Total Donasi
            const totalJariyahKumulatif = donations.reduce((sum, d) => sum + Number(d.nominalJariyah || 0), 0);
            
            // Perhitungan Total Pembagian
            const totalDistribusi = calculateDistribution(totalJariyahKumulatif);

            // Template UI menggunakan string literal
            appDiv.innerHTML = `
                <header class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl sm:text-3xl font-extrabold text-green-700">
                        <span class="block text-sm font-medium text-green-500">2. Laporan List</span>
                        Donatur Jariyah
                    </h1>
                    <div class="flex space-x-2">
                        <button id="add-donation-btn" 
                            class="flex items-center px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg shadow-md hover:bg-green-700 transition duration-150 transform hover:scale-[1.02]">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 mr-1">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                            </svg>
                            <span class="hidden sm:inline">Tambah Donasi</span>
                            <span class="sm:hidden">Tambah</span>
                        </button>
                        <button id="sign-out-btn" title="Keluar / Sign Out"
                            class="p-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5.636 5.636a9 9 0 1 0 12.728 0M12 2v10" />
                            </svg>
                        </button>
                    </div>
                </header>
                
                <!-- Keterangan Pembagian & UID -->
                <p class="text-sm text-gray-700 mb-2">
                    Total jariyah akan dibagi secara otomatis: Perawatan Makam (15%), Ongkos Panitia (15%), Biaya Haul (70%).
                </p>
                <p class="text-xs text-gray-500 mb-4">
                    ID Pengguna (UID): <span class="font-mono text-green-500">${userId || 'Menunggu Autentikasi...'}</span>
                </p>

                <!-- Ringkasan Global (Mirip Tampilan Gambar) -->
                <div class="mb-8 p-5 bg-white rounded-xl shadow-lg border-b-4 border-green-600">
                    <p class="text-lg font-semibold text-gray-800 mb-2">Total Akumulasi Jariyah Saat Ini</p>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        ${SummaryValue('Total Jariyah', totalJariyahKumulatif, 'text-green-800', 'bg-green-50')}
                        ${SummaryValue('Perawatan Makam (15%)', totalDistribusi.makam, 'text-gray-700', 'bg-yellow-50')}
                        ${SummaryValue('Ongkos Panitia (15%)', totalDistribusi.panitia, 'text-gray-700', 'bg-yellow-50')}
                        ${SummaryValue('Biaya Haul (70%)', totalDistribusi.haul, 'text-gray-700', 'bg-yellow-50')}
                    </div>
                </div>


                <!-- Pesan Error Global -->
                ${error ? `<div class="p-3 mb-4 text-sm text-red-700 bg-red-100 rounded-lg" role="alert">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline mr-1">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.021 3.375 1.77 3.375h14.714c1.749 0 2.635-1.875 1.77-3.375l-7.385-12.285a1.875 1.875 0 0 0-3.232 0l-7.385 12.285Z" />
                    </svg>
                    ${error}
                </div>` : ''}

                <!-- Tabel Data Donasi -->
                <h2 class="text-xl font-bold text-gray-800 mb-4">List Donatur (${donations.length} Data)</h2>
                ${DonationTable(donations, totalJariyahKumulatif)}

                <!-- Modals -->
                ${isModalOpen ? InputModal() : ''}
                ${isConfirmModalOpen ? ConfirmDeleteModal() : ''}
            `;

            // Pasang Event Listeners setelah HTML dirender
            setupEventListeners();
        };

        const setupEventListeners = () => {
            const addBtn = document.getElementById('add-donation-btn');
            if (addBtn) {
                addBtn.onclick = () => {
                    // Reset form state dan buka modal
                    formData = {
                        tanggal: new Date().toISOString().substring(0, 10),
                        namaDonatur: '',
                        alamat: '',
                        nominalJariyah: '',
                    };
                    editingDonation = null;
                    error = null;
                    isModalOpen = true;
                    renderApp();
                };
            }

            const signOutBtn = document.getElementById('sign-out-btn');
            if (signOutBtn) {
                signOutBtn.onclick = async () => {
                    if (auth && auth.currentUser) {
                        try {
                            await signOut(auth);
                            console.log("Sign Out Berhasil.");
                        } catch (e) {
                            console.error("Sign Out Gagal:", e);
                        }
                    }
                };
            }

            // Event Listeners Modal
            const modalForm = document.getElementById('modal-form');
            if (modalForm) {
                modalForm.onsubmit = handleSubmit;
            }

            const modalCloseBtn = document.getElementById('modal-close-btn');
            if (modalCloseBtn) {
                modalCloseBtn.onclick = handleModalClose;
            }

            const nominalInput = document.getElementById('nominalJariyah');
            if (nominalInput) {
                nominalInput.oninput = handleNominalChange;
            }
            
            // Event Listeners Aksi Tabel (Edit/Delete)
            donations.forEach(d => {
                const editBtn = document.getElementById(`edit-btn-${d.id}`);
                const deleteBtn = document.getElementById(`delete-btn-${d.id}`);
                if (editBtn) {
                    editBtn.onclick = () => handleEdit(d);
                }
                if (deleteBtn) {
                    deleteBtn.onclick = () => handleDelete(d);
                }
            });
            
            // Event Listeners Confirm Delete Modal
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            if (confirmDeleteBtn) {
                confirmDeleteBtn.onclick = confirmDelete;
            }
            if (cancelDeleteBtn) {
                cancelDeleteBtn.onclick = () => {
                    isConfirmModalOpen = false;
                    donationToDelete = null;
                    renderApp();
                };
            }
        };

        // --- Komponen UI Pembantu (sebagai fungsi yang mengembalikan string HTML) ---
        
        const SummaryValue = (title, value, valueColor, bgColor) => `
            <div class="p-3 rounded-lg shadow-sm ${bgColor} border border-gray-200">
                <p class="text-xs font-semibold text-gray-500">${title}</p>
                <h3 class="text-lg font-bold ${valueColor} mt-1">
                    ${formatRupiah(value)}
                </h3>
            </div>
        `;

        const DonationTable = (data, totalKumulatif) => {
            let runningTotal = 0;
            const rows = data.map((item, index) => {
                const nominal = Number(item.nominalJariyah || 0);
                const distribution = calculateDistribution(nominal);
                
                runningTotal += nominal;

                return `
                    <tr class="hover:bg-green-50 transition duration-100">
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-700 w-12 text-center">${index + 1}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-700 w-24">${formatDate(item.tanggal)}</td>
                        <td class="px-3 py-3 text-sm font-medium text-gray-900 w-48">${item.namaDonatur}</td>
                        <td class="px-3 py-3 text-sm font-medium text-gray-900 w-48">${item.alamat}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm font-mono text-right text-purple-700 bg-purple-100 w-32">
                            ${formatRupiah(nominal)}
                        </td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm font-mono text-right text-white bg-green-700 w-32">
                            ${formatRupiah(runningTotal)}
                        </td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm font-mono text-right text-gray-700 w-32">
                            ${formatRupiah(distribution.makam)}
                        </td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm font-mono text-right text-gray-700 w-32">
                            ${formatRupiah(distribution.panitia)}
                        </td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm font-mono text-right text-gray-700 w-32">
                            ${formatRupiah(distribution.haul)}
                        </td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm font-medium w-24 text-center">
                            <div class="flex justify-center space-x-2">
                                <button id="edit-btn-${item.id}"
                                    class="text-blue-600 hover:text-blue-900 p-1 rounded-full hover:bg-blue-100 transition text-xs"
                                    title="Edit">
                                    Edit
                                </button>
                                <button id="delete-btn-${item.id}"
                                    class="text-red-600 hover:text-red-900 p-1 rounded-full hover:bg-red-100 transition text-xs"
                                    title="Hapus">
                                    Hapus
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="bg-white rounded-xl shadow-lg overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr class="bg-gray-200">
                                <th rowspan="2" class="px-3 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider w-12">No</th>
                                <th rowspan="2" class="px-3 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider w-24">Tanggal</th>
                                <th rowspan="2" class="px-3 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider w-48">Nama Donatur</th>
                                <th rowspan="2" class="px-3 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider w-48">Alamat</th>
                                <th rowspan="2" class="px-3 py-3 text-right text-xs font-bold text-white uppercase tracking-wider bg-purple-600 w-32">Jariyah (RP)</th>
                                <th rowspan="2" class="px-3 py-3 text-right text-xs font-bold text-white uppercase tracking-wider bg-green-700 w-32">TOTAL JARIYAH (RP)</th>
                                <th colspan="3" class="px-3 py-2 text-center text-xs font-bold text-white uppercase tracking-wider bg-yellow-800 border-b border-gray-300">PRESENTASE DONASI</th>
                                <th rowspan="2" class="px-3 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider w-24">Aksi</th>
                            </tr>
                            <tr class="bg-yellow-800">
                                <th class="px-3 py-2 text-right text-xs font-bold text-white uppercase tracking-wider w-32">Perawatan Makam (15%)</th>
                                <th class="px-3 py-2 text-right text-xs font-bold text-white uppercase tracking-wider w-32">Ongkos Panitia (15%)</th>
                                <th class="px-3 py-2 text-right text-xs font-bold text-white uppercase tracking-wider w-32">Biaya Haul (70%)</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${data.length === 0 ? `
                                <tr>
                                    <td colspan="10" class="px-6 py-4 text-center text-sm text-gray-500">
                                        ${isLoading ? 'Memuat data...' : 'Belum ada data donatur. Silakan input donasi baru.'}
                                    </td>
                                </tr>
                            ` : rows}
                        </tbody>
                        <!-- Total Baris (Opsional, sudah ada di atas, tapi bisa ditambah untuk visual) -->
                        <tfoot class="total-row">
                            <tr>
                                <td colspan="5" class="px-3 py-3 text-right text-sm">TOTAL KUMULATIF AKHIR</td>
                                <td class="px-3 py-3 text-right text-lg font-extrabold text-yellow-300">${formatRupiah(totalKumulatif)}</td>
                                <td class="px-3 py-3 text-right text-sm">${formatRupiah(calculateDistribution(totalKumulatif).makam)}</td>
                                <td class="px-3 py-3 text-right text-sm">${formatRupiah(calculateDistribution(totalKumulatif).panitia)}</td>
                                <td class="px-3 py-3 text-right text-sm">${formatRupiah(calculateDistribution(totalKumulatif).haul)}</td>
                                <td class="px-3 py-3"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
        };

        const InputModal = () => `
            <div class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4">
                <div class="relative p-6 border w-full max-w-lg shadow-lg rounded-xl bg-white animate-fade-in-down">
                    <h3 class="text-xl font-bold text-gray-900 mb-4 border-b pb-2">
                        ${editingDonation ? 'Edit Data Donasi' : 'Input Donasi Jariyah Baru'}
                    </h3>
                    ${error ? `<div class="p-3 mb-4 text-sm text-red-700 bg-red-100 rounded-lg" role="alert">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline mr-1"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.021 3.375 1.77 3.375h14.714c1.749 0 2.635-1.875 1.77-3.375l-7.385-12.285a1.875 1.875 0 0 0-3.232 0l-7.385 12.285Z" /></svg>
                        ${error}
                    </div>` : ''}
                    <form id="modal-form" class="space-y-4">
                        <!-- Bidang Tanggal -->
                        <div>
                            <label for="tanggal" class="block text-sm font-medium text-gray-700">Tanggal Donasi *</label>
                            <input type="date" name="tanggal" id="tanggal" required value="${formData.tanggal}" onchange="handleInputChange(event)"
                                class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-2 border"/>
                        </div>
                        <!-- Bidang Nama Donatur -->
                        <div>
                            <label for="namaDonatur" class="block text-sm font-medium text-gray-700">Nama Donatur *</label>
                            <input type="text" name="namaDonatur" id="namaDonatur" required placeholder="Contoh: Bpk. Sarpin" value="${formData.namaDonatur}" onchange="handleInputChange(event)"
                                class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-2 border"/>
                        </div>
                        <!-- Bidang Alamat -->
                        <div>
                            <label for="alamat" class="block text-sm font-medium text-gray-700">Alamat</label>
                            <input type="text" name="alamat" id="alamat" placeholder="Contoh: Ngablak" value="${formData.alamat}" onchange="handleInputChange(event)"
                                class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-2 border"/>
                        </div>
                        <!-- Bidang Nominal Jariyah -->
                        <div>
                            <label for="nominalJariyah" class="block text-sm font-medium text-gray-700">Nominal Jariyah (Rp) *</label>
                            <div class="mt-1 relative rounded-lg shadow-sm">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span class="text-gray-500 sm:text-sm">Rp</span>
                                </div>
                                <input type="text" name="nominalJariyah" id="nominalJariyah" required placeholder="Masukkan angka donasi saja" value="${formData.nominalJariyah}"
                                    class="block w-full rounded-lg pl-10 pr-3 border-gray-300 focus:border-green-500 focus:ring-green-500 p-2 border text-right font-mono text-lg"/>
                            </div>
                        </div>

                        <div class="flex justify-end space-x-4 pt-4">
                            <button type="button" id="modal-close-btn"
                                class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">
                                Batal
                            </button>
                            <button type="submit"
                                class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 transition">
                                ${editingDonation ? 'Simpan Perubahan' : 'Tambah Donasi'}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        
        const ConfirmDeleteModal = () => `
            <div class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4">
                <div class="relative p-6 border w-full max-w-sm shadow-xl rounded-xl bg-white transform transition-all animate-fade-in-down">
                    <h3 class="text-lg font-bold text-red-700 mb-3">Konfirmasi Penghapusan</h3>
                    <p class="text-sm text-gray-600 mb-4">
                        Apakah Anda yakin ingin menghapus donasi dari <strong>${donationToDelete?.namaDonatur || ''}</strong> sebesar <span class="font-semibold">${formatRupiah(donationToDelete?.nominalJariyah)}</span>? Aksi ini tidak dapat dibatalkan.
                    </p>
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancel-delete-btn"
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">
                            Batal
                        </button>
                        <button type="button" id="confirm-delete-btn"
                            class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition">
                            Ya, Hapus
                        </button>
                    </div>
                </div>
            </div>
        `;


        // --- Penanganan Form (Global Functions) ---
        window.handleInputChange = (e) => {
            const { name, value } = e.target;
            formData = { ...formData, [name]: value };
        };

        const handleNominalChange = (e) => {
            const rawValue = e.target.value.replace(/\D/g, ''); // Hanya angka
            formData = { ...formData, nominalJariyah: rawValue };
            renderApp(); // Render ulang untuk memastikan nilai input yang bersih
        };

        const handleModalClose = () => {
            isModalOpen = false;
            editingDonation = null;
            error = null;
            renderApp();
        };

        // --- Operasi CRUD Firebase ---
        
        const handleSubmit = async (e) => {
            e.preventDefault();

            if (!db || !userId) {
                error = "Autentikasi belum selesai. Mohon tunggu sebentar.";
                renderApp();
                return;
            }

            const nominalValue = parseInt(formData.nominalJariyah || '0', 10);
            if (nominalValue <= 0) {
                error = "Nominal jariyah harus lebih dari Rp 0.";
                renderApp();
                return;
            }
            
            const dateObject = new Date(formData.tanggal);
            if (isNaN(dateObject.getTime())) {
                error = "Format tanggal tidak valid.";
                renderApp();
                return;
            }
            
            const dataToSave = {
                tanggal: Timestamp.fromDate(dateObject), 
                namaDonatur: formData.namaDonatur.trim() || 'Anonim',
                alamat: formData.alamat.trim() || '-',
                nominalJariyah: nominalValue,
                userId: userId, 
            };

            try {
                const path = getCollectionPath(userId);
                if (!path) return;
                
                if (editingDonation) {
                    // Mode Edit
                    const docRef = doc(db, path, editingDonation.id); 
                    await updateDoc(docRef, dataToSave);
                } else {
                    // Mode Tambah Baru
                    await addDoc(collection(db, path), dataToSave); 
                }
                
                // Reset state
                formData = {
                    tanggal: new Date().toISOString().substring(0, 10),
                    namaDonatur: '',
                    alamat: '',
                    nominalJariyah: '',
                };
                isModalOpen = false;
                editingDonation = null;
                error = null;
                renderApp();
            } catch (e) {
                console.error("Kesalahan saat menyimpan data:", e);
                error = `Kesalahan saat menyimpan data: ${e.message}`;
                renderApp();
            }
        };

        const handleEdit = (donation) => {
            editingDonation = donation;
            
            let dateStr;
            if (donation.tanggal.toDate) {
                dateStr = donation.tanggal.toDate().toISOString().substring(0, 10);
            } else {
                dateStr = new Date(donation.tanggal).toISOString().substring(0, 10);
            }

            formData = {
                tanggal: dateStr,
                namaDonatur: donation.namaDonatur,
                alamat: donation.alamat,
                nominalJariyah: String(donation.nominalJariyah),
            };
            error = null;
            isModalOpen = true;
            renderApp();
        };

        const handleDelete = (donation) => {
            donationToDelete = donation;
            isConfirmModalOpen = true;
            renderApp();
        };

        const confirmDelete = async () => {
            if (!donationToDelete || !db || !userId) return;

            try {
                const path = getCollectionPath(userId);
                if (!path) return;
                
                const docRef = doc(db, path, donationToDelete.id); 
                await deleteDoc(docRef);
                
                isConfirmModalOpen = false;
                donationToDelete = null;
                renderApp();
            } catch (e) {
                console.error("Kesalahan saat menghapus data:", e);
                error = `Kesalahan saat menghapus data: ${e.message}`;
                isConfirmModalOpen = false;
                donationToDelete = null;
                renderApp();
            }
        };


        // --- Inisialisasi Firebase dan Autentikasi ---
        const initFirebase = () => {
            if (!firebaseConfig.projectId) {
                error = "Error: Konfigurasi Firebase tidak lengkap.";
                isLoading = false;
                renderApp();
                return;
            }

            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            
            // 1. Siapkan listener untuk memantau perubahan status autentikasi
            onAuthStateChanged(auth, (user) => {
                const currentUserId = user ? user.uid : null;
                const wasAuthReady = isAuthReady;

                userId = currentUserId;
                isAuthReady = true;

                if (!wasAuthReady) {
                    console.log('DEBUG: Auth State Ready. UserID:', userId);
                    // Setelah autentikasi siap, panggil listener data
                    setupDataListener();
                }
                
                renderApp(); // Render ulang setelah status auth berubah
            });

            // 2. Lakukan sign-in awal
            const performInitialSignIn = async () => {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (e) {
                    console.error("Kesalahan saat sign-in:", e);
                    error = `Kesalahan saat sign-in: ${e.message}`;
                    isLoading = false;
                    renderApp();
                }
            };

            performInitialSignIn();
        };
        
        // --- Listener Data Donasi (Real-time) ---
        let unsubscribeSnapshot = null;
        const setupDataListener = () => {
            // Hentikan listener lama jika ada
            if (unsubscribeSnapshot) {
                unsubscribeSnapshot();
                unsubscribeSnapshot = null;
            }
            
            if (!isAuthReady || !db || !userId) {
                console.log('DEBUG: Gagal melampirkan listener, Auth/DB belum siap.');
                return;
            }

            const path = getCollectionPath(userId);
            if (!path) return;
            
            console.log('DEBUG: Melampirkan onSnapshot ke jalur:', path); 

            const colRef = collection(db, path);
            const q = query(colRef); 

            isLoading = true;
            renderApp();

            unsubscribeSnapshot = onSnapshot(q, (snapshot) => {
                const newDonations = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    newDonations.push({
                        id: doc.id,
                        ...data,
                        // Pastikan nominalJariyah adalah angka
                        nominalJariyah: Number(data.nominalJariyah || 0),
                    });
                });

                // Urutkan berdasarkan tanggal (descending, terbaru di atas)
                newDonations.sort((a, b) => {
                    const dateA = a.tanggal?.toMillis ? a.tanggal.toMillis() : new Date(a.tanggal).getTime();
                    const dateB = b.tanggal?.toMillis ? b.tanggal.toMillis() : new Date(b.tanggal).getTime();
                    return dateB - dateA; 
                });

                donations = newDonations;
                isLoading = false;
                error = null;
                renderApp(); // Render ulang dengan data baru
            }, (e) => {
                console.error("Kesalahan saat mengambil data:", e);
                console.error("DEBUG Diagnostik Error: UserID:", userId, "Path:", path); 
                if (isAuthReady) {
                    error = `Kesalahan saat mengambil data: ${e.message}. Pastikan Aturan Keamanan Firestore sudah dipublikasikan.`;
                }
                isLoading = false;
                renderApp(); // Render ulang dengan pesan error
            });
        };

        // Inisialisasi saat window dimuat
        window.onload = initFirebase;

    </script>
</body>
</html>
