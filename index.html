<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Keuangan Haul</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            min-height: 10vh;
        }
        .container-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
        }
        .nav-item {
            cursor: pointer;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border-radius: 0.5rem 0.5rem 0 0;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }
        .nav-item.active {
            color: #4f46e5;
            border-bottom: 3px solid #4f46e5;
            background-color: #eef2ff;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .table-header th {
            background-color: #4f46e5;
            color: white;
            padding: 0.75rem 1rem;
            text-align: left;
        }
        .table-row:nth-child(even) {
            background-color: #f3f4f6;
        }
        .text-masuk { color: #10b981; } /* Emerald green */
        .text-keluar { color: #ef4444; } /* Red */
    </style>
</head>
<body>

<div id="loading-overlay" class="fixed inset-0 bg-gray-100 bg-opacity-75 flex items-center justify-center z-50">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
    <div class="ml-4 text-indigo-600 font-semibold">Memuat Data...</div>
</div>

<div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
    <header class="text-center mb-10">
        <h1 class="text-4xl font-extrabold text-gray-900">Admin Keuangan Haul</h1>
        <p class="mt-2 text-lg text-gray-500">Pencatatan Transaksi, Donatur, dan Laporan LPJ</p>
        <p id="user-info" class="text-xs text-gray-400 mt-1">Status: Memuat...</p>
    </header>

    <div class="container-card mb-8">
        <!-- Navigasi Tab -->
        <div class="flex border-b border-gray-200">
            <div id="tab-input-transaksi" class="nav-item active" onclick="showTab('input-transaksi')">Input Transaksi</div>
            <div id="tab-input-donatur" class="nav-item" onclick="showTab('input-donatur')">Input Donatur</div>
            <div id="tab-list-transaksi" class="nav-item" onclick="showTab('list-transaksi')">Daftar Transaksi</div>
            <div id="tab-laporan-keuangan" class="nav-item" onclick="showTab('laporan-keuangan')">Laporan Keuangan (LPJ)</div>
        </div>

        <!-- Konten Tab -->
        <div id="content-input-transaksi" class="tab-content mt-6">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Input Transaksi (Pemasukan/Pengeluaran)</h2>
            <form id="form-transaksi" onsubmit="saveTransaksi(event)">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="jenis" class="block text-sm font-medium text-gray-700">Jenis Transaksi</label>
                        <select id="jenis" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                            <option value="keluar">Pengeluaran</option>
                            <option value="masuk">Pemasukan</option>
                        </select>
                    </div>
                    <div>
                        <label for="tanggal" class="block text-sm font-medium text-gray-700">Tanggal</label>
                        <input type="date" id="tanggal" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>
                    <div>
                        <label for="kategori" class="block text-sm font-medium text-gray-700">Kategori (LPJ)</label>
                        <select id="kategori" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                            <!-- Kategori Pemasukan -->
                            <option value="Donatur (Total Donasi)">Donatur (Pemasukan)</option>
                            <!-- Kategori Pengeluaran -->
                            <option value="Ongkos Kiai">Ongkos Kiai</option>
                            <option value="Bayar Khataman">Bayar Khataman</option>
                            <option value="Bayar Konsumsi">Bayar Konsumsi</option>
                            <option value="Bayar Persewaan">Bayar Persewaan</option>
                            <option value="Lain-lain">Lain-lain (Pengeluaran)</option>
                        </select>
                    </div>
                    <div>
                        <label for="jumlah" class="block text-sm font-medium text-gray-700">Jumlah (Rp)</label>
                        <input type="number" id="jumlah" required min="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" placeholder="Cth: 700000">
                    </div>
                </div>
                <div class="mt-4">
                    <label for="deskripsi" class="block text-sm font-medium text-gray-700">Deskripsi/Keterangan</label>
                    <textarea id="deskripsi" rows="2" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" placeholder="Cth: Pembayaran honor Kiai di acara Haul"></textarea>
                </div>
                <div class="mt-6">
                    <button type="submit" class="btn-primary w-full">Simpan Transaksi</button>
                </div>
            </form>
            <div id="transaksi-message" class="mt-4 text-center text-sm font-medium"></div>
        </div>

        <div id="content-input-donatur" class="tab-content mt-6 hidden">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Input Donatur (Sekaligus Mencatat Pemasukan)</h2>
            <form id="form-donatur" onsubmit="saveDonatur(event)">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="nama_donatur" class="block text-sm font-medium text-gray-700">Nama Donatur</label>
                        <input type="text" id="nama_donatur" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" placeholder="Cth: Hamba Allah">
                    </div>
                    <div>
                        <label for="alamat_donatur" class="block text-sm font-medium text-gray-700">Alamat</label>
                        <input type="text" id="alamat_donatur" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" placeholder="Cth: Ngablak">
                    </div>
                    <div>
                        <label for="tanggal_donasi" class="block text-sm font-medium text-gray-700">Tanggal Donasi</label>
                        <input type="date" id="tanggal_donasi" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>
                    <div>
                        <label for="jumlah_donasi" class="block text-sm font-medium text-gray-700">Jumlah Donasi (Rp)</label>
                        <input type="number" id="jumlah_donasi" required min="1000" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" placeholder="Cth: 13953500">
                    </div>
                </div>
                <div class="mt-6">
                    <button type="submit" class="btn-primary w-full">Simpan Donasi</button>
                </div>
            </form>
            <div id="donatur-message" class="mt-4 text-center text-sm font-medium"></div>
        </div>

        <div id="content-list-transaksi" class="tab-content mt-6 hidden">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Daftar Semua Transaksi</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden">
                    <thead>
                        <tr class="table-header">
                            <th class="rounded-tl-lg">Tanggal</th>
                            <th>Deskripsi/Keterangan</th>
                            <th>Kategori</th>
                            <th>Jenis</th>
                            <th class="text-right">Jumlah (Rp)</th>
                            <th class="rounded-tr-lg">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="transaksi-list" class="bg-white divide-y divide-gray-200">
                        <!-- Data transaksi akan dimuat di sini -->
                    </tbody>
                </table>
            </div>
            <p id="no-transaksi" class="mt-4 text-center text-gray-500 hidden">Belum ada data transaksi yang tercatat.</p>
        </div>

        <div id="content-laporan-keuangan" class="tab-content mt-6 hidden">
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-900">LPJ Keuangan Haul</h2>
            <p class="text-center text-gray-600 mb-8">Laporan Global LPJ (Ringkasan Per Kategori)</p>

            <div class="max-w-3xl mx-auto">
                <!-- Tabel Laporan -->
                <table class="w-full text-lg border-collapse border border-gray-300 rounded-xl overflow-hidden shadow-lg">
                    <!-- Header Uraian -->
                    <thead>
                        <tr>
                            <th class="bg-purple-600 text-white p-3 text-left w-2/3 border-r border-gray-300 rounded-tl-xl">URAIAN</th>
                            <th class="bg-purple-600 text-white p-3 text-right w-1/3 rounded-tr-xl">JUMLAH (Rp)</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-800">
                        <!-- DANA MASUK -->
                        <tr class="bg-green-100 font-bold">
                            <td class="p-3 border-r border-gray-300">DANA MASUK</td>
                            <td class="p-3 text-right">-</td>
                        </tr>
                        <tr>
                            <td class="p-3 pl-6 border-r border-gray-300">Donatur (Total Donasi)</td>
                            <td id="laporan-donatur" class="p-3 text-right font-medium text-masuk">Rp 0</td>
                        </tr>
                        <!-- TOTAL DANA MASUK -->
                        <tr class="bg-green-300 font-bold text-xl">
                            <td class="p-3 border-r border-gray-300">TOTAL DANA MASUK</td>
                            <td id="laporan-total-masuk" class="p-3 text-right text-masuk">Rp 0</td>
                        </tr>
                        
                        <!-- DANA KELUAR -->
                        <tr class="bg-red-100 font-bold">
                            <td class="p-3 border-r border-gray-300 mt-4">DANA KELUAR</td>
                            <td class="p-3 text-right">-</td>
                        </tr>
                        
                        <!-- Pengeluaran Detail -->
                        <tr>
                            <td class="p-3 pl-6 border-r border-gray-300">Ongkos Kiai</td>
                            <td id="laporan-ongkos-kiai" class="p-3 text-right font-medium text-keluar">Rp 0</td>
                        </tr>
                        <tr>
                            <td class="p-3 pl-6 border-r border-gray-300">Bayar Khataman</td>
                            <td id="laporan-bayar-khataman" class="p-3 text-right font-medium text-keluar">Rp 0</td>
                        </tr>
                        <tr>
                            <td class="p-3 pl-6 border-r border-gray-300">Bayar Konsumsi</td>
                            <td id="laporan-bayar-konsumsi" class="p-3 text-right font-medium text-keluar">Rp 0</td>
                        </tr>
                        <tr>
                            <td class="p-3 pl-6 border-r border-gray-300">Bayar Persewaan</td>
                            <td id="laporan-bayar-persewaan" class="p-3 text-right font-medium text-keluar">Rp 0</td>
                        </tr>
                        <tr>
                            <td class="p-3 pl-6 border-r border-gray-300">Lain-lain</td>
                            <td id="laporan-lain-lain" class="p-3 text-right font-medium text-keluar">Rp 0</td>
                        </tr>

                        <!-- TOTAL DANA KELUAR -->
                        <tr class="bg-red-300 font-bold text-xl">
                            <td class="p-3 border-r border-gray-300">TOTAL DANA KELUAR</td>
                            <td id="laporan-total-keluar" class="p-3 text-right text-keluar">Rp 0</td>
                        </tr>
                    </tbody>
                    <!-- SALDO AKHIR -->
                    <tfoot class="font-extrabold text-2xl">
                        <tr class="bg-blue-200">
                            <td class="p-4 border-r border-gray-300 rounded-bl-xl">SALDO AKHIR</td>
                            <td id="laporan-saldo-akhir" class="p-4 text-right text-indigo-700 rounded-br-xl">Rp 0</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <p id="laporan-date" class="mt-8 text-sm text-gray-500 text-center">Data per tanggal: </p>
        </div>

    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, addDoc, onSnapshot, collection, query, orderBy, serverTimestamp, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- VARIABEL GLOBAL FIREBASE (WAJIB DARI CANVAS) ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app;
    let db;
    let auth;
    let userId = null;
    let isAuthReady = false;
    
    // Konfigurasi Firestore untuk Path data
    const DATA_COLLECTION_PATH = `/artifacts/${appId}/public/data`;
    const TRANSAKSI_COLLECTION = "transaksi";
    const DONATUR_COLLECTION = "donatur_haul";
    
    // Kategori Pengeluaran (sesuai LPJ)
    const KATEGORI_PENGELUARAN = {
        'Ongkos Kiai': 0,
        'Bayar Khataman': 0,
        'Bayar Konsumsi': 0,
        'Bayar Persewaan': 0,
        'Lain-lain': 0
    };
    
    // Helper function untuk format mata uang Rupiah
    const formatRupiah = (number) => {
        return new Intl.NumberFormat('id-ID', {
            style: 'currency',
            currency: 'IDR',
            minimumFractionDigits: 0
        }).format(number);
    };

    // Fungsi untuk menampilkan pesan (pengganti alert)
    const displayMessage = (id, message, isError = false) => {
        const element = document.getElementById(id);
        element.textContent = message;
        element.className = 'mt-4 text-center text-sm font-medium ' + (isError ? 'text-red-600' : 'text-green-600');
        setTimeout(() => element.textContent = '', 5000);
    };

    // --- 1. INISIALISASI FIREBASE DAN AUTHENTIKASI ---
    const initializeFirebase = async () => {
        try {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config tidak ditemukan.");
                document.getElementById('user-info').textContent = "ERROR: Konfigurasi Firebase tidak lengkap.";
                document.getElementById('loading-overlay').classList.add('hidden');
                return;
            }

            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Menggunakan onAuthStateChanged untuk mengelola status auth
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-info').textContent = 'Masuk sebagai: ' + userId;
                } else {
                    userId = null;
                    document.getElementById('user-info').textContent = "Belum Masuk.";
                    await signInAnonymously(auth); // Masuk Anonim jika tidak ada token
                }
                isAuthReady = true;
                document.getElementById('loading-overlay').classList.add('hidden');
                setupDataListeners();
            });

            // Lakukan sign in dengan custom token jika tersedia, jika tidak onAuthStateChanged akan menangani
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            }

        } catch (error) {
            console.error("Error in Firebase initialization or authentication:", error);
            document.getElementById('user-info').textContent = 'Error Auth: ' + error.message;
            document.getElementById('loading-overlay').classList.add('hidden');
        }
    };
    
    // --- 2. LISTENER DATA REAL-TIME ---
    const setupDataListeners = () => {
        if (!db || !isAuthReady) return; // Pastikan Firebase siap

        const transaksiRef = collection(db, DATA_COLLECTION_PATH + '/' + TRANSAKSI_COLLECTION);
        const q = query(transaksiRef, orderBy("timestamp", "desc"));

        onSnapshot(q, (snapshot) => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderTransaksiList(data);
            generateLaporan(data);
        }, (error) => {
            console.error("Error getting real-time transactions:", error);
        });
    };

    // --- 3. FUNGSI SIMPAN DATA ---
    
    // Menyimpan Transaksi Umum (Pemasukan/Pengeluaran)
    const saveTransaksi = async (e) => {
        e.preventDefault();
        if (!db || !userId) {
            displayMessage('transaksi-message', 'Error: Koneksi database belum siap.', true);
            return;
        }

        const jenis = document.getElementById('jenis').value;
        const tanggal = document.getElementById('tanggal').value;
        const kategori = document.getElementById('kategori').value;
        const jumlah = parseInt(document.getElementById('jumlah').value);
        const deskripsi = document.getElementById('deskripsi').value;

        try {
            const newTransaction = {
                jenis: jenis, // 'masuk' atau 'keluar'
                tanggal: tanggal, // format 'YYYY-MM-DD'
                kategori: kategori, // kategori LPJ
                jumlah: jumlah, // dalam bentuk number
                deskripsi: deskripsi,
                userId: userId,
                timestamp: serverTimestamp() 
            };
            
            await addDoc(collection(db, DATA_COLLECTION_PATH + '/' + TRANSAKSI_COLLECTION), newTransaction);
            
            displayMessage('transaksi-message', 'Transaksi berhasil disimpan!');
            document.getElementById('form-transaksi').reset();
        } catch (error) {
            console.error("Error saving transaction:", error);
            displayMessage('transaksi-message', 'Gagal menyimpan transaksi: ' + error.message, true);
        }
    };

    // Menyimpan Donatur (Sekaligus mencatat Pemasukan)
    const saveDonatur = async (e) => {
        e.preventDefault();
        if (!db || !userId) {
            displayMessage('donatur-message', 'Error: Koneksi database belum siap.', true);
            return;
        }

        const nama = document.getElementById('nama_donatur').value;
        const alamat = document.getElementById('alamat_donatur').value;
        const tanggal = document.getElementById('tanggal_donasi').value;
        const jumlah = parseInt(document.getElementById('jumlah_donasi').value);

        try {
            // 1. Simpan ke koleksi donatur_haul
            const newDonatur = {
                nama: nama,
                alamat: alamat,
                tanggal: tanggal,
                jumlah: jumlah,
                userId: userId,
                timestamp: serverTimestamp() 
            };
            
            await addDoc(collection(db, DATA_COLLECTION_PATH + '/' + DONATUR_COLLECTION), newDonatur);
            
            // 2. Simpan sebagai Transaksi Pemasukan
            const newTransaction = {
                jenis: 'masuk',
                tanggal: tanggal,
                kategori: 'Donatur (Total Donasi)',
                jumlah: jumlah,
                deskripsi: 'Donasi dari ' + nama + ' (' + alamat + ')',
                userId: userId,
                timestamp: serverTimestamp() 
            };
            
            await addDoc(collection(db, DATA_COLLECTION_PATH + '/' + TRANSAKSI_COLLECTION), newTransaction);

            displayMessage('donatur-message', 'Data Donatur dan Pemasukan berhasil disimpan!');
            document.getElementById('form-donatur').reset();
        } catch (error) {
            console.error("Error saving donatur/transaction:", error);
            displayMessage('donatur-message', 'Gagal menyimpan data: ' + error.message, true);
        }
    };
    
    // --- 4. FUNGSI HAPUS DATA ---
    window.deleteTransaksi = async (id) => {
        if (!db) return;
        
        // Menggunakan modal kustom sebagai ganti window.confirm()
        if (!await customConfirm('Apakah Anda yakin ingin menghapus transaksi ini? Data akan hilang permanen.')) {
            return;
        }

        try {
            await deleteDoc(doc(db, DATA_COLLECTION_PATH + '/' + TRANSAKSI_COLLECTION, id));
            // Feedback akan diberikan oleh onSnapshot listener
        } catch (error) {
            console.error("Error deleting transaction:", error);
            displayMessage('transaksi-message', 'Gagal menghapus transaksi: ' + error.message, true);
        }
    };
    
    // Fungsi konfirmasi kustom (pengganti window.confirm)
    const customConfirm = async (message) => {
        return new Promise(resolve => {
            // Mengganti template literal dengan string concatenation
            const modalHtml = 
                '<div id="custom-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">' +
                    '<div class="relative bg-white rounded-lg shadow-xl max-w-sm mx-auto p-6">' +
                        '<h3 class="text-lg leading-6 font-medium text-gray-900">Konfirmasi Hapus Data</h3>' +
                        '<div class="mt-2">' +
                            '<p class="text-sm text-gray-500">' + message + '</p>' +
                        '</div>' +
                        '<div class="mt-4 flex justify-end space-x-3">' +
                            '<button id="modal-cancel" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">Batal</button>' +
                            '<button id="modal-confirm" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">Ya, Hapus</button>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = document.getElementById('custom-modal');
            
            document.getElementById('modal-cancel').onclick = () => {
                modal.remove();
                resolve(false);
            };
            
            document.getElementById('modal-confirm').onclick = () => {
                modal.remove();
                resolve(true);
            };
        });
    };


    // --- 5. FUNGSI RENDER TAMPILAN ---
    
    // Menampilkan daftar transaksi
    const renderTransaksiList = (data) => {
        const listElement = document.getElementById('transaksi-list');
        const noTransaksiElement = document.getElementById('no-transaksi');
        listElement.innerHTML = '';

        if (data.length === 0) {
            noTransaksiElement.classList.remove('hidden');
            return;
        }

        noTransaksiElement.classList.add('hidden');

        data.forEach(item => {
            const jenisClass = item.jenis === 'masuk' ? 'text-masuk' : 'text-keluar';
            const row = document.createElement('tr');
            row.className = 'table-row border-b hover:bg-gray-50';
            
            // Mengganti template literal dengan string concatenation
            row.innerHTML = 
                '<td class="p-3">' + item.tanggal + '</td>' +
                '<td class="p-3">' + item.deskripsi + '</td>' +
                '<td class="p-3">' + item.kategori + '</td>' +
                '<td class="p-3 font-semibold ' + jenisClass + '">' + item.jenis.toUpperCase() + '</td>' +
                '<td class="p-3 text-right font-semibold ' + jenisClass + '">' + formatRupiah(item.jumlah) + '</td>' +
                '<td class="p-3">' +
                    '<button onclick="deleteTransaksi(\'' + item.id + '\')" class="text-red-500 hover:text-red-700 text-sm font-medium transition duration-150">Hapus</button>' +
                '</td>';
                
            listElement.appendChild(row);
        });
    };

    // Membuat Laporan Keuangan (LPJ)
    const generateLaporan = (data) => {
        let totalMasuk = 0;
        let totalKeluar = 0;
        
        // Reset kategori pengeluaran
        const summaryKeluar = { ...KATEGORI_PENGELUARAN };
        
        // Iterasi data untuk perhitungan
        data.forEach(item => {
            if (item.jenis === 'masuk') {
                totalMasuk += item.jumlah;
            } else if (item.jenis === 'keluar') {
                totalKeluar += item.jumlah;
                
                // Agregasi berdasarkan kategori pengeluaran
                if (summaryKeluar.hasOwnProperty(item.kategori)) {
                    summaryKeluar[item.kategori] += item.jumlah;
                } else if (item.kategori === 'Donatur (Total Donasi)') {
                    // Abaikan karena ini adalah pemasukan
                } else {
                    // Masukkan ke Lain-lain jika kategori pengeluaran tidak terdaftar
                    summaryKeluar['Lain-lain'] += item.jumlah;
                }
            }
        });

        const saldoAkhir = totalMasuk - totalKeluar;
        const today = new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });

        // Update tampilan laporan
        document.getElementById('laporan-donatur').textContent = formatRupiah(totalMasuk);
        document.getElementById('laporan-total-masuk').textContent = formatRupiah(totalMasuk);
        
        document.getElementById('laporan-ongkos-kiai').textContent = formatRupiah(summaryKeluar['Ongkos Kiai']);
        document.getElementById('laporan-bayar-khataman').textContent = formatRupiah(summaryKeluar['Bayar Khataman']);
        document.getElementById('laporan-bayar-konsumsi').textContent = formatRupiah(summaryKeluar['Bayar Konsumsi']);
        document.getElementById('laporan-bayar-persewaan').textContent = formatRupiah(summaryKeluar['Bayar Persewaan']);
        document.getElementById('laporan-lain-lain').textContent = formatRupiah(summaryKeluar['Lain-lain']);
        
        document.getElementById('laporan-total-keluar').textContent = formatRupiah(totalKeluar);
        document.getElementById('laporan-saldo-akhir').textContent = formatRupiah(saldoAkhir);
        document.getElementById('laporan-date').textContent = 'Data per tanggal: ' + today;
        
        // Ubah warna saldo akhir jika minus
        const saldoElement = document.getElementById('laporan-saldo-akhir');
        if (saldoAkhir < 0) {
            saldoElement.classList.add('text-red-700');
            saldoElement.classList.remove('text-indigo-700');
        } else {
            saldoElement.classList.add('text-indigo-700');
            saldoElement.classList.remove('text-red-700');
        }
    };
    
    // --- 6. FUNGSI NAVIGASI TAB ---
    window.showTab = (tabId) => {
        const tabs = ['input-transaksi', 'input-donatur', 'list-transaksi', 'laporan-keuangan'];
        
        // Sembunyikan semua konten dan hapus status aktif
        tabs.forEach(id => {
            document.getElementById('content-' + id).classList.add('hidden');
            document.getElementById('tab-' + id).classList.remove('active');
            document.getElementById('tab-' + id).classList.add('border-b-2', 'border-transparent');
            document.getElementById('tab-' + id).classList.remove('bg-indigo-50');
        });

        // Tampilkan konten yang dipilih dan beri status aktif
        document.getElementById('content-' + tabId).classList.remove('hidden');
        document.getElementById('tab-' + tabId).classList.add('active');
        document.getElementById('tab-' + tabId).classList.remove('border-b-2', 'border-transparent');
    };
    
    // Mulai inisialisasi saat dokumen dimuat
    initializeFirebase();

    // Set tanggal hari ini sebagai default
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('tanggal').value = today;
    document.getElementById('tanggal_donasi').value = today;

</script>
</body>
</html>
