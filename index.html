<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Urutan Data Tanggal Otomatis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Menggunakan Font Inter */
        body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; }
        .container { max-width: 800px; }
    </style>
</head>
<body>

    <div id="app" class="container mx-auto p-4 md:p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">Pengurutan Data Berdasarkan Tanggal</h1>
        
        <!-- Kartu Input Data -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-xl font-semibold text-indigo-600 mb-4">Input Data Baru</h2>
            <div id="auth-status" class="text-xs text-gray-500 mb-4"></div>
            
            <form id="dataForm" class="space-y-4">
                <div>
                    <label for="tanggalInput" class="block text-sm font-medium text-gray-700">Tanggal:</label>
                    <!-- Tipe input date akan memastikan format yang konsisten -->
                    <input type="date" id="tanggalInput" required 
                           class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="deskripsiInput" class="block text-sm font-medium text-gray-700">Deskripsi/Keterangan:</label>
                    <textarea id="deskripsiInput" rows="3" required 
                              class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:border-indigo-500 focus:ring-indigo-500"></textarea>
                </div>
                <button type="submit" id="submitButton"
                        class="w-full py-3 px-4 border border-transparent rounded-lg shadow-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                    Simpan Data
                </button>
            </form>
            <p id="message" class="mt-4 text-sm text-center font-medium"></p>
        </div>

        <!-- Daftar Data Terurut -->
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Daftar Data (Terurut: Tanggal Terlama di Atas)</h2>
        <div id="dataList" class="space-y-4">
            <p class="text-gray-500 text-center py-8" id="loadingMessage">Memuat data...</p>
        </div>
    </div>

    <!-- Script Firebase dan Logika Aplikasi -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, addDoc, onSnapshot, query, orderBy, 
            doc, deleteDoc, setDoc, serverTimestamp, setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // setLogLevel('Debug'); // Opsional: Aktifkan untuk melihat log detail di konsol

        // 1. Inisialisasi Firebase & Variabel Global (Wajib Ada)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId = null;
        let isAuthReady = false;

        const authStatusEl = document.getElementById('auth-status');
        const dataListEl = document.getElementById('dataList');
        const loadingMessageEl = document.getElementById('loadingMessage');
        const messageEl = document.getElementById('message');
        const dataForm = document.getElementById('dataForm');

        // Helper untuk menampilkan pesan singkat
        function showMessage(text, isError = false) {
            messageEl.textContent = text;
            messageEl.className = `mt-4 text-sm text-center font-medium ${isError ? 'text-red-600' : 'text-green-600'}`;
            setTimeout(() => { messageEl.textContent = ''; }, 3000);
        }

        // 2. Setup Firebase dan Otentikasi
        async function setupFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase Config tidak ditemukan.");
                    authStatusEl.textContent = "Error: Konfigurasi Firebase hilang.";
                    return;
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatusEl.textContent = `User ID (Publik): ${userId}`;
                    } else {
                        userId = 'anon-' + crypto.randomUUID(); // Fallback ID jika anonim
                        authStatusEl.textContent = `Belum terotentikasi. ID Anonim: ${userId}`;
                    }
                    isAuthReady = true;
                    // Setelah otentikasi siap, mulai mendengarkan data
                    if (db && isAuthReady) {
                        listenForData();
                    }
                });

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Kesalahan inisialisasi atau otentikasi Firebase:", error);
                showMessage(`Gagal inisialisasi: ${error.message}`, true);
            }
        }

        // 3. Fungsi untuk Menyimpan Data
        async function saveData(tanggal, deskripsi) {
            if (!db) return showMessage("Database belum siap.", true);

            const collectionPath = `/artifacts/${appId}/public/data/urutan_data`;
            const dataToSave = {
                tanggal: tanggal, // Tanggal dalam format YYYY-MM-DD (String)
                deskripsi: deskripsi,
                createdAt: serverTimestamp(), // Timestamp untuk urutan sekunder (jika tanggal sama)
                userId: userId
            };

            try {
                await addDoc(collection(db, collectionPath), dataToSave);
                showMessage("Data berhasil disimpan!", false);
            } catch (e) {
                console.error("Error menambahkan dokumen: ", e);
                showMessage(`Gagal menyimpan data: ${e.message}`, true);
            }
        }

        // 4. Fungsi untuk Mendengarkan dan Menampilkan Data
        function listenForData() {
            if (!db || !isAuthReady) return;

            const collectionPath = `/artifacts/${appId}/public/data/urutan_data`;
            
            // --- INI PERUBAHAN UTAMA UNTUK SORTING ---
            // Kita mengurutkan query berdasarkan field 'tanggal' secara Ascending (terlama ke terbaru)
            const dataQuery = query(
                collection(db, collectionPath),
                orderBy('tanggal', 'asc') 
            );
            // ------------------------------------------

            onSnapshot(dataQuery, (snapshot) => {
                loadingMessageEl.style.display = 'none';
                dataListEl.innerHTML = ''; // Kosongkan daftar data lama

                if (snapshot.empty) {
                    dataListEl.innerHTML = '<p class="text-gray-500 p-4 bg-yellow-50 rounded-lg">Belum ada data yang tersimpan.</p>';
                    return;
                }

                snapshot.docs.forEach((doc) => {
                    const data = doc.data();
                    const docId = doc.id;
                    
                    // Format tanggal agar lebih mudah dibaca (opsional)
                    // Karena Firestore menyimpan string 'YYYY-MM-DD', kita bisa langsung memakainya atau memformatnya
                    const formattedDate = new Date(data.tanggal + 'T00:00:00').toLocaleDateString('id-ID', {
                        year: 'numeric', month: 'long', day: 'numeric'
                    });

                    const itemHtml = `
                        <div class="bg-white p-4 rounded-xl shadow border-l-4 ${data.tanggal === new Date().toISOString().slice(0, 10) ? 'border-indigo-500' : 'border-gray-200'} flex justify-between items-start">
                            <div class="flex-grow">
                                <p class="text-sm font-light text-gray-500 mb-1">Tanggal: <span class="font-medium text-gray-800">${formattedDate}</span></p>
                                <p class="text-gray-900">${data.deskripsi}</p>
                            </div>
                            <!-- Tombol Hapus (Contoh interaksi) -->
                            <button data-id="${docId}" class="delete-btn text-red-500 hover:text-red-700 ml-4 p-1 rounded-full hover:bg-red-50 transition duration-150">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    `;
                    dataListEl.insertAdjacentHTML('beforeend', itemHtml);
                });

                // Tambahkan listener ke tombol hapus setelah rendering
                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', handleDelete);
                });

            }, (error) => {
                console.error("Error mendengarkan data:", error);
                loadingMessageEl.textContent = `Gagal memuat data: ${error.message}`;
            });
        }

        // 5. Fungsi Hapus Data (Contoh Interaksi)
        async function handleDelete(event) {
            const docId = event.currentTarget.dataset.id;
            if (!db || !docId) return;

            // Gunakan konfirmasi modal kustom jika ini adalah aplikasi produksi
            if (!confirm("Apakah Anda yakin ingin menghapus data ini?")) return; 

            const docRef = doc(db, `/artifacts/${appId}/public/data/urutan_data`, docId);
            try {
                await deleteDoc(docRef);
                showMessage("Data berhasil dihapus.", false);
            } catch (e) {
                console.error("Error menghapus dokumen: ", e);
                showMessage(`Gagal menghapus data: ${e.message}`, true);
            }
        }

        // 6. Event Listener untuk Form Submission
        dataForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const tanggal = document.getElementById('tanggalInput').value;
            const deskripsi = document.getElementById('deskripsiInput').value;
            
            if (tanggal && deskripsi) {
                saveData(tanggal, deskripsi);
                dataForm.reset(); // Kosongkan form setelah submit
            } else {
                showMessage("Mohon lengkapi semua field.", true);
            }
        });

        // Mulai aplikasi
        setupFirebase();
    </script>
</body>
</html>
