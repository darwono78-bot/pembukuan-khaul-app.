<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pembukuan Haul: Real-time, Donatur, Jurnal & Ekspor PDF</title>
    <!-- Tailwind CSS untuk styling modern -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF dan Autotable untuk ekspor PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* Gaya agar tabel bisa digeser jika terlalu lebar */
        .table-wrapper {
            overflow-x: auto; 
        }

        /* --- PERBAIKAN FONT DAN TEBAL --- */
        /* Ganti font global ke Cambria / Times New Roman / Serif */
        body {
            font-family: Cambria, 'Times New Roman', Times, serif; 
            background-color: #f7f9fb;
        }
        
        /* Ganti font size global untuk isi tabel agar tidak terlalu besar */
        table {
            font-size: 0.9rem; 
            width: 100%; 
        }

        /* Styling Card */
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }

        /* Hapus tebal default dari sel tabel */
        td {
            font-weight: normal; 
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Pembukuan Khaul Yayasan</h1>
            <p class="text-gray-500">Pencatatan donasi dan pengeluaran Khaul secara real-time.</p>
        </header>

        <!-- Display User ID for Collaboration -->
        <div id="user-info" class="mb-6 p-3 bg-indigo-100 text-indigo-800 rounded-lg text-sm hidden">
            <p><span class="font-semibold">User ID:</span> <span id="user-id" class="break-all">Loading...</span></p>
            <p class="text-xs mt-1">Gunakan ID ini untuk verifikasi kolaborasi.</p>
        </div>

        <!-- Ringkasan Keuangan -->
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-8">
            <div class="card p-4 rounded-xl bg-green-50 border-l-4 border-green-500">
                <p class="text-sm text-gray-500">Total Pemasukan</p>
                <p id="total-pemasukan" class="text-2xl font-bold text-green-700">Rp 0</p>
            </div>
            <div class="card p-4 rounded-xl bg-red-50 border-l-4 border-red-500">
                <p class="text-sm text-gray-500">Total Pengeluaran</p>
                <p id="total-pengeluaran" class="text-2xl font-bold text-red-700">Rp 0</p>
            </div>
            <div class="card p-4 rounded-xl bg-blue-50 border-l-4 border-blue-500">
                <p class="text-sm text-gray-500">Saldo Akhir</p>
                <p id="saldo-akhir" class="text-2xl font-bold text-blue-700">Rp 0</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Form Input Transaksi -->
            <div class="lg:col-span-1 card bg-white p-6 rounded-xl h-fit">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">Catat Transaksi</h2>
                <form id="transaction-form">
                    <div class="mb-4">
                        <label for="type" class="block text-sm font-medium text-gray-700 mb-1">Jenis</label>
                        <select id="type" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="pemasukan">Pemasukan (Donasi)</option>
                            <option value="pengeluaran">Pengeluaran</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Keterangan/Nama Donatur</label>
                        <input type="text" id="description" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label for="amount" class="block text-sm font-medium text-gray-700 mb-1">Jumlah (Rp)</label>
                        <input type="number" id="amount" required min="1" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white p-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-150">Simpan Transaksi</button>
                </form>

                <div class="mt-8 pt-4 border-t border-gray-200">
                    <h3 class="text-lg font-semibold mb-3 text-gray-700">Laporan PDF</h3>
                    <button id="export-donatur-pdf" class="w-full mb-2 bg-purple-600 text-white p-2 rounded-lg font-medium hover:bg-purple-700 transition duration-150 text-sm">
                        Ekspor LPJ Donatur
                    </button>
                    <button id="export-jurnal-pdf" class="w-full mb-2 bg-purple-600 text-white p-2 rounded-lg font-medium hover:bg-purple-700 transition duration-150 text-sm">
                        Ekspor LPJ Jurnal Umum
                    </button>
                    <button id="export-ringkasan-pdf" class="w-full bg-purple-600 text-white p-2 rounded-lg font-medium hover:bg-purple-700 transition duration-150 text-sm">
                        Ekspor Ringkasan Global
                    </button>
                </div>
            </div>

            <!-- Daftar Transaksi (Jurnal) -->
            <div class="lg:col-span-3">
                <div class="card bg-white p-6 rounded-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">Jurnal Transaksi (Terakhir)</h2>
                    <div class="table-wrapper">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12">Tgl</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-7/12">Keterangan</th>
                                    <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-2/12">Debit (Masuk)</th>
                                    <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-2/12">Kredit (Keluar)</th>
                                    <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="jurnal-list" class="bg-white divide-y divide-gray-200">
                                <!-- Data Jurnal akan dimasukkan di sini oleh JavaScript -->
                            </tbody>
                            <tfoot id="jurnal-footer" class="bg-gray-100 font-semibold">
                                <!-- Total Jurnal akan dimasukkan di sini -->
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- Daftar Donatur -->
                <div class="card bg-white p-6 rounded-xl">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">Total Donasi Per Donatur</h2>
                    <div class="table-wrapper">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12">No</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-9/12">Nama/Keterangan Donatur</th>
                                    <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-2/12">Total Donasi</th>
                                </tr>
                            </thead>
                            <tbody id="donatur-list" class="bg-white divide-y divide-gray-200">
                                <!-- Data Donatur akan dimasukkan di sini oleh JavaScript -->
                            </tbody>
                            <tfoot id="donatur-footer" class="bg-gray-100 font-semibold">
                                <!-- Total Donasi akan dimasukkan di sini -->
                            </tfoot>
                        </table>
                    </div>
                </div>
                
                <div id="loading-indicator" class="text-center py-8 text-lg font-medium text-blue-600 hidden">Memuat data dari Firebase...</div>
                <div id="no-data-message" class="text-center py-8 text-gray-500 hidden">Belum ada transaksi tercatat.</div>

            </div>
        </div>
    </div>

    <!-- Modals untuk pesan notifikasi dan konfirmasi -->
    <div id="modal-container"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import modul Firebase yang diperlukan
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Perhatikan import 'doc' dari firestore
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        // Setel level log (Opsional, untuk debugging)
        setLogLevel('debug');

        // Global Variables from Canvas Environment (MANDATORY)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let firebaseConfig = {};
        if (typeof __firebase_config !== 'undefined') {
            try {
                firebaseConfig = JSON.parse(__firebase_config);
            } catch (e) {
                console.error("Error parsing __firebase_config:", e);
            }
        }
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Inisialisasi Firebase
        let app;
        let db;
        let auth;
        let userId = null;
        let allTransactions = []; // State global untuk menyimpan data dari Firestore

        if (Object.keys(firebaseConfig).length > 0) {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                showModal('error', 'Gagal menginisialisasi Firebase. Pastikan konfigurasi sudah benar.');
            }
        } else {
            console.error("Firebase config is missing or invalid.");
            showModal('error', 'Konfigurasi Firebase tidak ditemukan.');
        }

        // --------------------------------------------------------------------------------
        // 1. UTILITY UI (Modals dan Formatting)
        // --------------------------------------------------------------------------------
        
        // Custom Modal Function (Pengganti alert/confirm)
        const showModal = (type, message, onConfirm = null) => {
            const container = document.getElementById('modal-container');
            container.innerHTML = ''; // Bersihkan container

            const isConfirm = typeof onConfirm === 'function';
            const modalClass = type === 'success' ? 'bg-green-600 hover:bg-green-700' : 
                               type === 'error' ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700';
            const title = type === 'success' ? 'Sukses!' : 
                          type === 'error' ? 'Terjadi Kesalahan!' : 'Konfirmasi';
            const buttonText = isConfirm ? 'Ya, Lanjutkan' : 'OK';

            const modalHtml = `
                <div id="custom-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                    <div class="relative top-20 mx-auto p-5 border w-96 card bg-white rounded-md">
                        <div class="mt-3 text-center">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 ${type === 'error' ? 'text-red-600' : ''}">${title}</h3>
                            <div class="mt-2 px-7 py-3">
                                <p class="text-sm text-gray-500">${message}</p>
                            </div>
                            <div class="flex justify-center items-center px-4 py-3 space-x-4">
                                ${isConfirm ? 
                                    `<button id="modal-cancel" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Batal</button>` 
                                    : ''}
                                <button id="modal-ok" class="px-4 py-2 text-white rounded-md font-medium ${modalClass}">
                                    ${buttonText}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML = modalHtml;

            document.getElementById('modal-ok').onclick = () => {
                document.getElementById('custom-modal').remove();
                if (isConfirm) onConfirm(true);
            };
            
            if (isConfirm) {
                document.getElementById('modal-cancel').onclick = () => {
                    document.getElementById('custom-modal').remove();
                    onConfirm(false);
                };
            }
        };

        const formatRupiah = (number) => {
            // Pastikan input adalah angka, jika tidak kembalikan 0
            if (typeof number !== 'number' || isNaN(number)) {
                number = 0;
            }
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(number);
        };

        // --------------------------------------------------------------------------------
        // 2. FIREBASE AUTH & CRUD
        // --------------------------------------------------------------------------------

        const getCollectionRef = (collectionName) => {
            // Menggunakan path PUBLIC karena ini adalah buku keuangan bersama (kolaboratif)
            const path = `/artifacts/${appId}/public/data/${collectionName}`;
            return collection(db, path);
        };

        const initializeAuth = async () => {
            if (!auth) return;

            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                // Hanya tampilkan error fatal, listener onAuthStateChanged akan menangani sisanya
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id').textContent = userId;
                    document.getElementById('user-info').classList.remove('hidden');
                    startRealtimeListener(); // Mulai mendengarkan data setelah otentikasi
                } else {
                    userId = null;
                    document.getElementById('user-id').textContent = 'N/A';
                    document.getElementById('user-info').classList.add('hidden');
                }
            });
        };

        const addTransaction = async (data) => {
            if (!userId) {
                showModal('error', 'Otentikasi belum siap. Silakan coba lagi.');
                return;
            }
            try {
                const transactionsRef = getCollectionRef('transactions');
                await addDoc(transactionsRef, {
                    ...data,
                    amount: parseFloat(data.amount), // Pastikan disimpan sebagai number
                    userId: userId, 
                    timestamp: serverTimestamp()
                });
                showModal('success', 'Transaksi berhasil dicatat!');
                document.getElementById('transaction-form').reset();
            } catch (e) {
                console.error("Error adding document: ", e);
                showModal('error', `Gagal mencatat transaksi: ${e.message}`);
            }
        };
        
        const deleteTransaction = async (id) => {
            if (!userId) {
                showModal('error', 'Otentikasi diperlukan untuk menghapus.');
                return;
            }

            showModal('confirmation', 'Anda yakin ingin menghapus transaksi ini?', async (confirmed) => {
                if (confirmed) {
                    try {
                        const docRef = doc(getCollectionRef('transactions'), id);
                        await deleteDoc(docRef);
                        showModal('success', 'Transaksi berhasil dihapus.');
                    } catch (e) {
                        console.error("Error deleting document: ", e);
                        showModal('error', `Gagal menghapus transaksi: ${e.message}`);
                    }
                }
            });
        };

        const startRealtimeListener = () => {
            if (!db || !userId) return;
            
            const transactionsRef = getCollectionRef('transactions');
            const q = query(transactionsRef); // Query dasar tanpa orderBy

            const loadingIndicator = document.getElementById('loading-indicator');
            loadingIndicator.classList.remove('hidden');

            onSnapshot(q, (querySnapshot) => {
                const transactions = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    // Konversi Firestore Timestamp ke milidetik, atau gunakan 0 jika belum ada (saat serverTimestamp)
                    const timestampMs = data.timestamp ? data.timestamp.seconds * 1000 : 0;
                    transactions.push({ id: doc.id, ...data, timestamp: timestampMs });
                });
                
                // Perbarui state global dan render ulang
                allTransactions = transactions;
                renderAllTables();
                loadingIndicator.classList.add('hidden');

            }, (error) => {
                console.error("Error listening to transactions:", error);
                loadingIndicator.classList.add('hidden');
                showModal('error', `Gagal memuat data real-time: ${error.message}`);
            });
        };

        // --------------------------------------------------------------------------------
        // 3. RENDER UI (Jurnal dan Donatur)
        // --------------------------------------------------------------------------------

        const renderJurnalTable = () => {
            const listElement = document.getElementById('jurnal-list');
            const footerElement = document.getElementById('jurnal-footer');
            const noDataMessage = document.getElementById('no-data-message');
            listElement.innerHTML = '';
            footerElement.innerHTML = '';

            const sortedTransactions = [...allTransactions].sort((a, b) => b.timestamp - a.timestamp);

            if (sortedTransactions.length === 0) {
                noDataMessage.classList.remove('hidden');
                return;
            }
            noDataMessage.classList.add('hidden');

            let totalPemasukan = 0;
            let totalPengeluaran = 0;

            sortedTransactions.forEach(transaction => {
                const amount = parseFloat(transaction.amount);
                const isPemasukan = transaction.type === 'pemasukan';

                if (isPemasukan) {
                    totalPemasukan += amount;
                } else {
                    totalPengeluaran += amount;
                }

                const date = transaction.timestamp > 0 ? new Date(transaction.timestamp).toLocaleDateString('id-ID') : 'Pending...';
                
                const debit = isPemasukan ? formatRupiah(amount) : '-';
                const kredit = !isPemasukan ? formatRupiah(amount) : '-';

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition duration-100';
                row.innerHTML = `
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${date}</td>
                    <td class="px-3 py-2 text-sm text-gray-900">${transaction.description}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-right font-medium text-green-600">${debit}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-right font-medium text-red-600">${kredit}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-red-600 hover:text-red-900 delete-btn" data-id="${transaction.id}">Hapus</button>
                    </td>
                `;
                listElement.appendChild(row);
            });

            // Footer (Total)
            const saldo = totalPemasukan - totalPengeluaran;
            footerElement.innerHTML = `
                <tr>
                    <td colspan="2" class="px-3 py-2 text-right">TOTAL</td>
                    <td class="px-3 py-2 text-right text-green-700">${formatRupiah(totalPemasukan)}</td>
                    <td class="px-3 py-2 text-right text-red-700">${formatRupiah(totalPengeluaran)}</td>
                    <td class="px-3 py-2 text-right"></td>
                </tr>
                <tr>
                    <td colspan="2" class="px-3 py-2 text-right">SALDO AKHIR</td>
                    <td colspan="2" class="px-3 py-2 text-center text-blue-700 font-bold">${formatRupiah(saldo)}</td>
                    <td class="px-3 py-2 text-right"></td>
                </tr>
            `;

            // Update Ringkasan Keuangan di atas
            document.getElementById('total-pemasukan').textContent = formatRupiah(totalPemasukan);
            document.getElementById('total-pengeluaran').textContent = formatRupiah(totalPengeluaran);
            document.getElementById('saldo-akhir').textContent = formatRupiah(saldo);

            // Setup Event Listener untuk tombol Hapus
            document.querySelectorAll('#jurnal-list .delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.getAttribute('data-id');
                    deleteTransaction(id);
                });
            });
        };

        const renderDonaturTable = () => {
            const donaturMap = new Map();

            // Filter hanya pemasukan dan hitung total per donatur/keterangan
            allTransactions
                .filter(t => t.type === 'pemasukan')
                .forEach(t => {
                    const desc = t.description.trim().toUpperCase(); // Case insensitive grouping
                    const currentTotal = donaturMap.get(desc) || 0;
                    donaturMap.set(desc, currentTotal + parseFloat(t.amount));
                });
            
            const donaturData = Array.from(donaturMap.entries()).map(([description, total]) => ({ description, total }));
            
            // Urutkan berdasarkan total terbesar
            donaturData.sort((a, b) => b.total - a.total);

            const listElement = document.getElementById('donatur-list');
            const footerElement = document.getElementById('donatur-footer');
            listElement.innerHTML = '';
            footerElement.innerHTML = '';

            let grandTotalDonasi = 0;
            let counter = 1;

            donaturData.forEach(item => {
                grandTotalDonasi += item.total;

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition duration-100';
                row.innerHTML = `
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 text-center">${counter++}</td>
                    <td class="px-3 py-2 text-sm text-gray-900">${item.description}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-right font-medium text-green-600">${formatRupiah(item.total)}</td>
                `;
                listElement.appendChild(row);
            });

            // Footer (Total Donasi)
            footerElement.innerHTML = `
                <tr>
                    <td colspan="2" class="px-3 py-2 text-right font-bold">TOTAL DONASI (Kotor)</td>
                    <td class="px-3 py-2 text-right text-blue-700 font-bold">${formatRupiah(grandTotalDonasi)}</td>
                </tr>
            `;

            return grandTotalDonasi;
        };

        const renderAllTables = () => {
            renderJurnalTable();
            renderDonaturTable();
        };

        // --------------------------------------------------------------------------------
        // 4. PDF GENERATION LOGIC (JSPDF + AutoTable)
        // --------------------------------------------------------------------------------

        // Font settings for PDF (Using default provided fonts)
        // NOTE: Variabel 'doc' dipindahkan ke dalam masing-masing fungsi untuk menghindari
        // konflik dengan import 'doc' dari Firebase Firestore.

        const formatNumberForPdf = (number) => {
            // Hilangkan simbol 'Rp' dan titik ribuan untuk konsistensi di PDF
            return formatRupiah(number).replace('Rp', '').trim();
        };

        const addHeaderAndFooter = (pdfDoc, title) => {
            const pageWidth = pdfDoc.internal.pageSize.width;

            pdfDoc.setFontSize(14);
            pdfDoc.text(`Laporan Pertanggungjawaban Keuangan Khaul`, pageWidth / 2, 10, { align: 'center' });
            pdfDoc.setFontSize(12);
            pdfDoc.text(title, pageWidth / 2, 16, { align: 'center' });
            
            // Footer
            pdfDoc.setFontSize(8);
            const today = new Date().toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
            pdfDoc.text(`Dicetak pada: ${today}`, 10, pdfDoc.internal.pageSize.height - 10);
            
            // Page Number
            const pageCount = pdfDoc.internal.getNumberOfPages();
            for(let i = 1; i <= pageCount; i++) {
                pdfDoc.setPage(i);
                pdfDoc.text(`Halaman ${i} dari ${pageCount}`, pageWidth - 10, pdfDoc.internal.pageSize.height - 10, { align: 'right' });
            }
            pdfDoc.setPage(1); // Kembali ke halaman 1
        };

        const addSignatures = (pdfDoc, yPos) => {
            const pageWidth = pdfDoc.internal.pageSize.width;
            const margin = 15;

            pdfDoc.setFontSize(10);
            pdfDoc.text("Mengetahui,", margin, yPos + 10);
            pdfDoc.text("Dibuat oleh,", pageWidth - margin - 30, yPos + 10); // Adjusting position for right alignment

            pdfDoc.text("Pimpinan Yayasan", margin, yPos + 40);
            pdfDoc.text("Bendahara Khaul", pageWidth - margin - 30, yPos + 40);
        };

        // --- LPJ Donatur ---
        const generateDonaturPDF = () => {
            // Deklarasi doc di dalam fungsi
            const pdfDoc = new window.jspdf.jsPDF(); 
            addHeaderAndFooter(pdfDoc, 'Laporan Donasi (Pemasukan) Khaul');

            const donaturMap = new Map();
            allTransactions
                .filter(t => t.type === 'pemasukan')
                .forEach(t => {
                    const desc = t.description.trim().toUpperCase(); 
                    const currentTotal = donaturMap.get(desc) || 0;
                    donaturMap.set(desc, currentTotal + parseFloat(t.amount));
                });
            
            const donaturData = Array.from(donaturMap.entries()).map(([description, total]) => ({ description, total }));
            donaturData.sort((a, b) => b.total - a.total); // Urutkan total terbesar

            let grandTotalDonasi = 0;
            const tableBody = donaturData.map((item, index) => {
                grandTotalDonasi += item.total;
                return [
                    index + 1,
                    item.description,
                    formatNumberForPdf(item.total)
                ];
            });

            // Tambahkan baris total
            tableBody.push([
                { content: "TOTAL DONASI KOTOR", colSpan: 2, styles: { halign: 'right', fontStyle: 'bold', fillColor: [200, 220, 255] } },
                { content: formatNumberForPdf(grandTotalDonasi), styles: { halign: 'right', fontStyle: 'bold', fillColor: [200, 220, 255] } }
            ]);

            window.jspdf.autoTable(pdfDoc, {
                startY: 20,
                head: [['No', 'Nama/Keterangan Donatur', 'Jumlah (Rp)']],
                body: tableBody,
                theme: 'grid',
                headStyles: { fillColor: [52, 73, 94] },
                columnStyles: {
                    0: { halign: 'center', cellWidth: 15 },
                    2: { halign: 'right', cellWidth: 40 }
                }
            });
            
            addSignatures(pdfDoc, pdfDoc.lastAutoTable.finalY + 10);
            pdfDoc.save("LPJ_Donatur.pdf");
        };

        // --- LPJ Jurnal Umum ---
        const generateJurnalPDF = () => {
            // Deklarasi doc di dalam fungsi
            const pdfDoc = new window.jspdf.jsPDF();
            addHeaderAndFooter(pdfDoc, 'Laporan Jurnal Umum Khaul');

            const sortedTransactions = [...allTransactions].sort((a, b) => a.timestamp - b.timestamp);
            
            let totalPemasukan = 0;
            let totalPengeluaran = 0;

            const tableBody = sortedTransactions.map((t) => {
                const amount = parseFloat(t.amount);
                const isPemasukan = t.type === 'pemasukan';
                const date = t.timestamp > 0 ? new Date(t.timestamp).toLocaleDateString('id-ID') : 'N/A';
                
                if (isPemasukan) {
                    totalPemasukan += amount;
                } else {
                    totalPengeluaran += amount;
                }

                return [
                    date,
                    t.description,
                    isPemasukan ? formatNumberForPdf(amount) : '-',
                    !isPemasukan ? formatNumberForPdf(amount) : '-'
                ];
            });

            // Tambahkan baris Total
            tableBody.push([
                { content: "TOTAL", colSpan: 2, styles: { halign: 'right', fontStyle: 'bold', fillColor: [200, 220, 255] } },
                { content: formatNumberForPdf(totalPemasukan), styles: { halign: 'right', fontStyle: 'bold', fillColor: [200, 220, 255] } },
                { content: formatNumberForPdf(totalPengeluaran), styles: { halign: 'right', fontStyle: 'bold', fillColor: [200, 220, 255] } }
            ]);

            // Tambahkan baris Saldo Akhir
            const saldo = totalPemasukan - totalPengeluaran;
            tableBody.push([
                { content: "SALDO AKHIR", colSpan: 2, styles: { halign: 'right', fontStyle: 'bold', fillColor: [255, 255, 200] } },
                { content: formatNumberForPdf(saldo), colSpan: 2, styles: { halign: 'center', fontStyle: 'bold', fillColor: [255, 255, 200] } }
            ]);

            window.jspdf.autoTable(pdfDoc, {
                startY: 20,
                head: [['Tanggal', 'Keterangan', 'Debit (Rp)', 'Kredit (Rp)']],
                body: tableBody,
                theme: 'grid',
                headStyles: { fillColor: [52, 73, 94] },
                columnStyles: {
                    2: { halign: 'right', cellWidth: 40 },
                    3: { halign: 'right', cellWidth: 40 }
                }
            });

            addSignatures(pdfDoc, pdfDoc.lastAutoTable.finalY + 10);
            pdfDoc.save("LPJ_Jurnal_Umum.pdf");
        };
        
        // --- LPJ Global Ringkasan ---
        const generateRingkasanPDF = () => {
            // Deklarasi doc di dalam fungsi
            const pdfDoc = new window.jspdf.jsPDF();
            addHeaderAndFooter(pdfDoc, 'Ringkasan Global Keuangan Khaul');
            
            // Hitung ringkasan
            const ringkasan = allTransactions.reduce((acc, t) => {
                const amount = parseFloat(t.amount);
                if (t.type === 'pemasukan') {
                    acc.pemasukan += amount;
                } else {
                    acc.pengeluaran += amount;
                }
                return acc;
            }, { pemasukan: 0, pengeluaran: 0 });

            const saldoAkhir = ringkasan.pemasukan - ringkasan.pengeluaran;

            const tableBody = [
                ["Total Pemasukan (Donasi)", formatNumberForPdf(ringkasan.pemasukan)],
                ["Total Pengeluaran", formatNumberForPdf(ringkasan.pengeluaran)],
                ["SALDO AKHIR", formatNumberForPdf(saldoAkhir)]
            ];

            window.jspdf.autoTable(pdfDoc, {
                startY: 30,
                head: [['Deskripsi', 'Jumlah (Rp)']],
                body: tableBody,
                theme: 'striped',
                headStyles: { fillColor: [52, 73, 94] },
                footStyles: { fontStyle: 'bold', fillColor: [200, 220, 255] },
                didDrawCell: (data) => {
                    // Tambahkan border di baris Saldo Akhir
                    if (data.row.index === 2) {
                         pdfDoc.setDrawColor(0); // Garis hitam
                         pdfDoc.setLineWidth(0.5);
                         pdfDoc.rect(data.cell.x, data.cell.y, data.cell.width, data.cell.height, 'S');
                    }
                },
                styles: {
                    cellPadding: [2, 0.5, 2, 4], 
                },
                columnStyles: {
                    0: { cellWidth: 'wrap', cellPadding: [2, 4, 2, 4] }, 
                    1: { 
                        halign: 'right', 
                        columnWidth: 50,
                        cellPadding: [2, 0, 2, 4] 
                    } 
                }
            });
            
            addSignatures(pdfDoc, pdfDoc.lastAutoTable.finalY + 10);
            pdfDoc.save("LPJ_Global_Ringkasan.pdf");
        };

        // --------------------------------------------------------------------------------
        // 5. INISIALISASI DAN EVENT LISTENERS
        // --------------------------------------------------------------------------------

        // Event Listener Form
        document.getElementById('transaction-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const type = document.getElementById('type').value;
            const description = document.getElementById('description').value;
            const amount = document.getElementById('amount').value; // Ambil sebagai string untuk validasi

            if (isNaN(parseFloat(amount)) || parseFloat(amount) <= 0) {
                showModal('error', 'Jumlah harus angka positif.');
                return;
            }

            const data = { type, description: description.trim(), amount: parseFloat(amount) };
            addTransaction(data);
        });
        
        // Event Listeners PDF
        document.getElementById('export-donatur-pdf').addEventListener('click', generateDonaturPDF);
        document.getElementById('export-jurnal-pdf').addEventListener('click', generateJurnalPDF);
        document.getElementById('export-ringkasan-pdf').addEventListener('click', generateRingkasanPDF);


        window.onload = () => {
            if (db) {
                initializeAuth();
            } else {
                // Tampilkan pesan jika Firebase tidak terinisialisasi
                document.getElementById('loading-indicator').textContent = 'Error: Konfigurasi Firebase tidak ditemukan atau gagal diinisialisasi.';
                document.getElementById('loading-indicator').classList.remove('hidden');
                document.getElementById('no-data-message').classList.add('hidden');
            }
        };
    </script>
</body>
</html>
