<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Keuangan Haul - Kas & Jariyah</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font: Inter for modern look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for elegance and readability */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .container-main {
            max-width: 100%;
            padding: 1rem;
        }
        @media (min-width: 640px) {
            .container-main {
                max-width: 1280px;
                padding: 2rem;
            }
        }
        /* Custom scrollbar for table on mobile */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        /* Style for overall total box (Jariyah) */
        .total-box-jariyah {
            background-color: #10b981; /* Emerald Green */
            color: white;
        }
        /* Style for overall total box (Kas) */
        .total-box-kas {
            background-color: #4f46e5; /* Indigo */
            color: white;
        }
        /* Style for the Total Jariyah column (Running Total) */
        .running-total-cell-jariyah {
            background-color: #d1fae5; /* Light green background */
            color: #047857; /* Dark green text */
            font-weight: 800; /* Extra bold */
        }
        /* Style for the Saldo column (Running Balance) */
        .running-saldo-cell-kas {
            background-color: #e0e7ff; /* Light indigo background */
            color: #4338ca; /* Dark indigo text */
            font-weight: 800;
        }
        /* Style for the initial Jariyah entry (Auto-generated first row) */
        .initial-jariyah-entry {
            background-color: #fff1d6; /* Light Yellow/Cream */
            border-left: 5px solid #f97316; /* Orange border */
            font-weight: bold; /* Make the initial row stand out */
        }
        .data-row:nth-child(even) {
            background-color: #f9fafb; /* Subtle zebra striping */
        }
        .data-row:hover {
            background-color: #eef2ff; /* Light indigo on hover */
        }
        .tab-active {
            border-bottom: 3px solid #4f46e5;
            color: #4f46e5;
            font-weight: 600;
        }
    </style>
</head>
<body>

<!-- Login/Auth Modal (UNMODIFIED) -->
<div id="auth-modal" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center p-4 z-50">
    <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full">
        <h2 class="text-3xl font-bold text-center text-indigo-700 mb-6">Akses Catatan Keuangan</h2>
        <form id="auth-form" class="space-y-4">
            <input type="email" id="auth-email" placeholder="Email (Contoh: admin@haul.com)" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            <input type="password" id="auth-password" placeholder="Kata Sandi" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            <p id="auth-message" class="text-sm text-red-500 text-center"></p>
            <button type="submit" id="login-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                Masuk (Login)
            </button>
            <p class="text-center text-sm text-gray-500">atau</p>
            <button type="button" id="register-button" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                Daftar Akun Baru (Register)
            </button>
        </form>
    </div>
</div>

<!-- Main Application Wrapper - Hidden until authenticated -->
<div id="app-content" class="container-main mx-auto hidden">
    
    <!-- Header & Tab Navigation -->
    <header class="bg-white shadow-lg rounded-xl mb-6">
        <h1 class="text-3xl font-extrabold text-gray-900 text-center py-4">Dashboard Keuangan Jariyah Haul</h1>
        
        <!-- Tabs -->
        <div class="flex border-b border-gray-200">
            <button id="tab-jariyah" data-target="content-jariyah" class="tab-button tab-active p-4 text-gray-600 hover:text-indigo-600 transition">
                1. Laporan Jariyah (Donatur)
            </button>
            <button id="tab-kasumum" data-target="content-kasumum" class="tab-button p-4 text-gray-600 hover:text-indigo-600 transition">
                2. Jurnal Kas Umum (Masuk & Keluar)
            </button>
        </div>
    </header>

    <!-- CONTENT 1: LAPORAN JARIYAH (EXISTING FEATURE) -->
    <div id="content-jariyah" class="tab-content">
        <!-- Overall Summary Box -->
        <div class="flex justify-end mb-6">
            <div class="total-box-jariyah p-4 rounded-xl text-center shadow-lg min-w-[250px]">
                <p class="text-sm font-light opacity-80">Total Akhir Semua Jariyah</p>
                <p id="total-jumlah-jariyah" class="text-3xl font-extrabold">Rp 0</p>
            </div>
        </div>

        <!-- Data Entry Form Jariyah -->
        <div class="bg-white p-6 shadow-xl rounded-xl mb-6 border border-indigo-200">
            <h2 class="text-xl font-semibold mb-4 text-indigo-700">Input Data Jariyah Baru</h2>
            <form id="jariyah-form" class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <input type="date" id="jariyah-tanggal" required class="col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" title="Tanggal">
                <input type="text" id="jariyah-nama" placeholder="Nama Donatur (Wajib)" required class="col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" title="Nama Donatur">
                <input type="text" id="jariyah-alamat" placeholder="Alamat (Opsional)" class="col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" title="Alamat">
                <input type="number" id="jariyah-jumlah" placeholder="Jumlah Jariyah (Wajib)" required min="1" class="col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" title="Jumlah Jariyah">
                <button type="submit" class="col-span-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                    Tambah Catatan
                </button>
            </form>
        </div>

        <!-- Data Table Jariyah -->
        <div class="bg-white p-6 shadow-xl rounded-xl border border-gray-200">
            <div class="table-wrapper">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="text-white">
                        <tr class="table-header">
                            <th rowspan="2" class="px-3 py-3 text-left text-xs uppercase tracking-wider rounded-tl-lg w-12 bg-indigo-800 border-r border-gray-600">NO</th>
                            <th rowspan="2" class="px-3 py-3 text-left text-xs uppercase tracking-wider w-24 bg-indigo-800">TANGGAL</th>
                            <th rowspan="2" class="px-3 py-3 text-left text-xs uppercase tracking-wider min-w-[150px] bg-indigo-800">NAMA DONATUR</th>
                            <th rowspan="2" class="px-3 py-3 text-left text-xs uppercase tracking-wider min-w-[200px] bg-indigo-800">ALAMAT</th>
                            <th rowspan="2" class="px-3 py-3 text-left text-xs uppercase tracking-wider min-w-[120px] bg-indigo-800 border-r border-gray-600">JARIYAH (RP)</th>
                            <th rowspan="2" class="px-3 py-3 text-center text-xs uppercase tracking-wider min-w-[150px] bg-green-700 border-r border-gray-600">TOTAL JARIYAH (RP)</th>
                            <th colspan="3" class="px-3 py-2 text-center text-xs uppercase tracking-wider bg-amber-700 rounded-tr-lg">PRESENTASE DONASI</th>
                            <th rowspan="2" class="px-3 py-3 text-center text-xs uppercase tracking-wider w-16 bg-indigo-800">AKSI</th>
                        </tr>
                        <tr>
                            <th class="px-3 py-3 text-center text-xs uppercase tracking-wider bg-amber-700 border-t border-gray-600">PERAWATAN MAKAM (15%)</th>
                            <th class="px-3 py-3 text-center text-xs uppercase tracking-wider bg-amber-700 border-t border-gray-600">ONGKOS PANITIA (15%)</th>
                            <th class="px-3 py-3 text-center text-xs uppercase tracking-wider bg-amber-700 border-t border-gray-600">BIAYA HAUL (70%)</th>
                        </tr>
                    </thead>
                    <tbody id="jariyah-list" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="10" class="p-4 text-center text-gray-500">Memuat data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- CONTENT 2: JURNAL KAS UMUM (NEW FEATURE) -->
    <div id="content-kasumum" class="tab-content hidden">
         <!-- Overall Summary Box for Kas -->
        <div class="flex justify-end mb-6">
            <div class="total-box-kas p-4 rounded-xl text-center shadow-lg min-w-[250px]">
                <p class="text-sm font-light opacity-80">Saldo Kas Saat Ini</p>
                <p id="total-saldo-kasumum" class="text-3xl font-extrabold">Rp 0</p>
            </div>
        </div>

        <!-- Data Entry Form Kas Umum -->
        <div class="bg-white p-6 shadow-xl rounded-xl mb-6 border border-indigo-200">
            <h2 class="text-xl font-semibold mb-4 text-indigo-700">Input Jurnal Kas Baru</h2>
            <form id="kasumum-form" class="grid grid-cols-1 md:grid-cols-6 gap-4">
                <input type="date" id="kasumum-tanggal" required class="col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" title="Tanggal">
                
                <input type="text" id="kasumum-uraian" placeholder="Uraian (Contoh: Beli konsumsi panitia)" required class="col-span-2 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" title="Uraian Transaksi">
                
                <select id="kasumum-kategori" required class="col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" title="Kategori Transaksi">
                    <option value="" disabled selected>Pilih Kategori</option>
                    <optgroup label="Dana Masuk">
                        <option value="Usaha">Usaha</option>
                        <option value="Pinjaman">Pinjaman</option>
                    </optgroup>
                    <optgroup label="Dana Keluar">
                        <option value="Bisyaroh Kiai">Bisyaroh Kiai</option>
                        <option value="Ongkos persewaan">Ongkos persewaan</option>
                        <option value="Ongkos konsumsi">Ongkos konsumsi</option>
                        <option value="Ongkos pekerja">Ongkos pekerja</option>
                        <option value="Bisyaroh khataman">Bisyaroh khataman</option>
                        <option value="Lain-Lain">Lain-Lain</option>
                    </optgroup>
                </select>

                <input type="number" id="kasumum-jumlah" placeholder="Jumlah (RP) (Wajib)" required min="1" class="col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" title="Jumlah Uang">
                
                <button type="submit" class="col-span-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                    Catat Jurnal
                </button>
            </form>
            <p class="mt-4 text-sm text-gray-500 italic">
                * Catatan: Dana Masuk dari Donatur (Jariyah) otomatis dicatat sebagai baris pertama di tabel di bawah.
            </p>
        </div>

        <!-- Data Table Kas Umum -->
        <div class="bg-white p-6 shadow-xl rounded-xl border border-gray-200">
            <div class="table-wrapper">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-indigo-600 text-white">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs uppercase tracking-wider w-12 rounded-tl-lg">NO</th>
                            <th class="px-3 py-3 text-left text-xs uppercase tracking-wider w-24">TANGGAL</th>
                            <th class="px-3 py-3 text-left text-xs uppercase tracking-wider min-w-[200px]">URAIAN</th>
                            <th class="px-3 py-3 text-left text-xs uppercase tracking-wider min-w-[150px]">KATEGORI</th>
                            <th class="px-3 py-3 text-right text-xs uppercase tracking-wider min-w-[120px] bg-green-700">DANA MASUK (RP)</th>
                            <th class="px-3 py-3 text-right text-xs uppercase tracking-wider min-w-[120px] bg-red-700">DANA KELUAR (RP)</th>
                            <th class="px-3 py-3 text-right text-xs uppercase tracking-wider min-w-[150px] bg-indigo-700">SALDO (RP)</th>
                            <th class="px-3 py-3 text-center text-xs uppercase tracking-wider w-16 rounded-tr-lg">AKSI</th>
                        </tr>
                    </thead>
                    <tbody id="kasumum-list" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="8" class="p-4 text-center text-gray-500">Memuat data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Control Panel -->
    <div class="mt-6 flex justify-between items-center p-4 bg-white rounded-xl shadow-lg border border-gray-200">
        <!-- Rata Kiri: Reset Data -->
        <button id="reset-data" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out text-sm md:text-base">
            <span class="font-bold mr-1">⚠️</span> Reset Data Aktif
        </button>

        <!-- Rata Kanan: User Info & Log Out -->
        <div class="flex items-center space-x-4">
            <p id="user-info" class="text-sm text-gray-600 truncate hidden sm:block">User ID: Memuat...</p>
            <button id="logout" class="bg-gray-700 hover:bg-gray-800 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out text-sm md:text-base">
                Log Out
            </button>
        </div>
    </div>

    <!-- Custom Modal/Notification Area -->
    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div id="custom-modal" class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300 scale-95 opacity-0">
            <h3 id="modal-title" class="text-lg font-bold text-gray-800 mb-3">Peringatan</h3>
            <p id="modal-message" class="text-sm text-gray-600 mb-4"></p>
            <div id="modal-actions" class="flex justify-end space-x-3">
                <button id="modal-cancel" class="px-4 py-2 text-sm font-semibold rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition">Batal</button>
                <button id="modal-confirm" class="px-4 py-2 text-sm font-semibold rounded-lg bg-red-600 text-white hover:bg-red-700 transition">Konfirmasi</button>
            </div>
        </div>
    </div>

</div>

<!-- Firebase and App Script -->
<script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, 
        signInWithEmailAndPassword,
        createUserWithEmailAndPassword,
        signOut,
        onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, 
        collection, 
        addDoc, 
        deleteDoc, 
        doc, 
        query, 
        onSnapshot, 
        getDocs, 
        writeBatch,
        serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-lite.js";

    // PENTING: Gunakan variabel global yang disediakan oleh lingkungan
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    
    // Firebase Config (menggunakan nilai placeholder)
    const firebaseConfig = {
        apiKey: "AIzaSyAHIO0RZgoq6eyjeERTpjOugzJLzqG2S-w",
        authDomain: "catatan-keuangan-haul.firebaseapp.com",
        projectId: "catatan-keuangan-haul",
        storageBucket: "catatan-keuangan-haul.firebasestorage.app",
        messagingSenderId: "955355049778",
        appId: "1:955355049778:web:0b844b27b82a88cc0cf12b"
    };

    // 1. Inisialisasi Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    setLogLevel('Debug');

    let userId = null;
    let isAuthReady = false;
    let currentTab = 'jariyah'; // State untuk tab aktif saat ini
    let globalTotalJariyah = 0; // Variabel global untuk menyimpan total Jariyah

    // --- Elemen DOM ---
    const appContent = document.getElementById('app-content');
    const authModal = document.getElementById('auth-modal');
    const authForm = document.getElementById('auth-form');
    const authEmail = document.getElementById('auth-email');
    const authPassword = document.getElementById('auth-password');
    const authMessage = document.getElementById('auth-message');
    const registerButton = document.getElementById('register-button');
    const logoutButton = document.getElementById('logout');
    const resetButton = document.getElementById('reset-data');
    const userInfoElement = document.getElementById('user-info');
    
    // Tabs
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    // Elemen Jariyah
    const jariyahForm = document.getElementById('jariyah-form');
    const jariyahList = document.getElementById('jariyah-list');
    const totalJumlahJariyahElement = document.getElementById('total-jumlah-jariyah');
    
    // Elemen Kas Umum
    const kasumumForm = document.getElementById('kasumum-form');
    const kasumumList = document.getElementById('kasumum-list');
    const totalSaldoKasUmumElement = document.getElementById('total-saldo-kasumum');
    const kasumumKategoriSelect = document.getElementById('kasumum-kategori'); 
    const kasumumJumlahInput = document.getElementById('kasumum-jumlah'); 

    // --- Konfigurasi ---
    const KATEGORI_MASUK = ['Donatur (Otomatis)', 'Usaha', 'Pinjaman']; 
    const KATEGORI_KELUAR = ['Bisyaroh Kiai', 'Ongkos persewaan', 'Ongkos konsumsi', 'Ongkos pekerja', 'Bisyaroh khataman', 'Lain-Lain'];


    // Fungsi pembantu untuk UI (Modal/Notifikasi)
    const formatRupiah = (number) => {
        // Pastikan input adalah angka yang valid, jika tidak, kembalikan 0
        const validNumber = typeof number === 'number' && isFinite(number) ? number : 0;
        const roundedNumber = Math.round(validNumber);
        return new Intl.NumberFormat('id-ID', {
            style: 'currency',
            currency: 'IDR',
            minimumFractionDigits: 0
        }).format(roundedNumber);
    };
    
    // Fungsi untuk memastikan angka valid sebelum perhitungan/formatting
    const toValidNumber = (value) => {
        const num = parseInt(value, 10);
        return isFinite(num) ? num : 0;
    }

    const showModal = (title, message, isConfirm = false, onConfirm = () => {}) => {
        const modalContainer = document.getElementById('modal-container');
        const modal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalActions = document.getElementById('modal-actions');
        
        modalActions.innerHTML = ''; 

        modalTitle.textContent = title;
        modalMessage.innerHTML = message; // Use innerHTML for formatting
        
        if (isConfirm) {
            // Setup Tombol Konfirmasi/Batal
            const cancelButton = document.createElement('button');
            cancelButton.className = 'px-4 py-2 text-sm font-semibold rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition';
            cancelButton.textContent = 'Batal';
            cancelButton.onclick = hideModal;

            const confirmButton = document.createElement('button');
            confirmButton.className = 'px-4 py-2 text-sm font-semibold rounded-lg bg-red-600 text-white hover:bg-red-700 transition';
            confirmButton.textContent = 'Konfirmasi';
            confirmButton.onclick = () => { onConfirm(); hideModal(); };
            
            modalActions.appendChild(cancelButton);
            modalActions.appendChild(confirmButton);
        } else {
            // Setup Tombol Tutup untuk peringatan sederhana
            const closeBtn = document.createElement('button');
            closeBtn.className = 'px-4 py-2 text-sm font-semibold rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition';
            closeBtn.textContent = 'Tutup';
            closeBtn.onclick = hideModal;
            modalActions.appendChild(closeBtn);
        }
        
        modalActions.classList.add('flex', 'justify-end', 'space-x-3');
        modalContainer.classList.remove('hidden');
        modalContainer.classList.add('flex');
        setTimeout(() => {
            modal.classList.remove('scale-95', 'opacity-0');
            modal.classList.add('scale-100', 'opacity-100');
        }, 10);
    };

    const hideModal = () => {
        const modalContainer = document.getElementById('modal-container');
        const modal = document.getElementById('custom-modal');
        modal.classList.remove('scale-100', 'opacity-100');
        modal.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            modalContainer.classList.remove('flex');
            modalContainer.classList.add('hidden');
        }, 300);
    };

    // --- Logika Pergantian Tab ---
    const switchTab = (targetId) => {
        currentTab = targetId.replace('content-', '');
        
        tabContents.forEach(content => {
            content.classList.add('hidden');
        });
        document.getElementById(targetId).classList.remove('hidden');

        tabButtons.forEach(button => {
            if (button.dataset.target === targetId) {
                button.classList.add('tab-active');
            } else {
                button.classList.remove('tab-active');
            }
        });
        
        // Atur ulang formulir Kas Umum saat berpindah tab
        if (currentTab === 'kasumum') {
            kasumumForm.reset();
            kasumumJumlahInput.readOnly = false;
            kasumumJumlahInput.classList.remove('bg-gray-100');
        }
    }

    tabButtons.forEach(button => {
        button.addEventListener('click', () => switchTab(button.dataset.target));
    });
    
    // --- 2. Alur Otentikasi ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            userId = user.uid;
            userInfoElement.textContent = `User ID: ${userId}`;
            userInfoElement.classList.remove('hidden');
            appContent.classList.remove('hidden');
            authModal.classList.add('hidden');
            isAuthReady = true;
            console.log('User signed in with UID:', userId);
            
            // Setup listeners untuk kedua koleksi saat login
            setupRealtimeListener('jariyah');
            setupRealtimeListener('kasumum');
            
        } else {
            userId = null;
            userInfoElement.textContent = 'User ID: Log Out';
            appContent.classList.add('hidden');
            authModal.classList.remove('hidden');
            isAuthReady = false;
            // Bersihkan UI dan state global
            globalTotalJariyah = 0; // Reset total global saat logout
            jariyahList.innerHTML = '<tr><td colspan="10" class="p-4 text-center text-gray-500 italic">Silakan masuk untuk melihat data Jariyah.</td></tr>';
            totalJumlahJariyahElement.textContent = formatRupiah(0);
            kasumumList.innerHTML = '<tr><td colspan="8" class="p-4 text-center text-gray-500 italic">Silakan masuk untuk melihat data Kas Umum.</td></tr>';
            totalSaldoKasUmumElement.textContent = formatRupiah(0);
        }
    });

    authForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = authEmail.value;
        const password = authPassword.value;
        authMessage.textContent = 'Memproses Login...';
        try {
            await signInWithEmailAndPassword(auth, email, password);
            authMessage.textContent = '';
        } catch (error) {
            console.error("Login Gagal:", error.message);
            authMessage.textContent = 'Login Gagal. Pastikan Email dan Kata Sandi benar.';
        }
    });

    registerButton.addEventListener('click', async () => {
        const email = authEmail.value;
        const password = authPassword.value;
        authMessage.textContent = 'Memproses pendaftaran...';
        try {
            if (!email || !password) {
                 authMessage.textContent = 'Email dan Kata Sandi wajib diisi untuk mendaftar.';
                 return;
            }
            await createUserWithEmailAndPassword(auth, email, password);
            authMessage.textContent = 'Pendaftaran berhasil! Anda akan otomatis masuk.';
        } catch (error) {
            console.error("Register Gagal:", error.message);
            let errorMessage = 'Pendaftaran Gagal. Coba lagi.';
            if (error.code === 'auth/weak-password') {
                errorMessage = 'Kata Sandi terlalu lemah (minimal 6 karakter).';
            } else if (error.code === 'auth/email-already-in-use') {
                errorMessage = 'Email sudah terdaftar. Silakan gunakan email lain atau Login.';
            } else if (error.code === 'auth/invalid-email') {
                 errorMessage = 'Format email tidak valid.';
            }
            authMessage.textContent = errorMessage;
        }
    });


    // --- 3. Fungsi Firestore ---

    // Dapatkan referensi koleksi
    const getCollectionRef = (collectionName) => {
        if (!userId) {
            console.error("Error: User ID is not defined (Not logged in).");
            return null;
        }
        // Path: /artifacts/{appId}/users/{userId}/{collectionName}
        return collection(db, `artifacts/${appId}/users/${userId}/${collectionName}`);
    };

    // --- Handler Jariyah ---
    jariyahForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!isAuthReady || !userId) {
            showModal("Gagal", "Anda harus login untuk menambah data.");
            return;
        }
        const ref = getCollectionRef('jariyah_records');
        if (!ref) return;

        // Gunakan toValidNumber untuk memastikan jumlah adalah angka
        const jumlahInput = toValidNumber(document.getElementById('jariyah-jumlah').value);
        if (jumlahInput <= 0) {
            showModal("Peringatan", "Jumlah Jariyah harus lebih dari 0.");
            return;
        }

        const data = {
            tanggal: document.getElementById('jariyah-tanggal').value,
            nama: document.getElementById('jariyah-nama').value,
            alamat: document.getElementById('jariyah-alamat').value || '-',
            jumlah: jumlahInput,
            timestamp: serverTimestamp() 
        };
        try {
            await addDoc(ref, data);
            jariyahForm.reset();
            document.getElementById('jariyah-tanggal').valueAsDate = new Date(); 
        } catch (e) {
            console.error("Error adding jariyah document: ", e);
            showModal("Gagal Menambah Data Jariyah", "Terjadi kesalahan saat menyimpan data ke database. Coba lagi.");
        }
    });
    
    // --- Handler Kas Umum ---
    kasumumForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!isAuthReady || !userId) {
            showModal("Gagal", "Anda harus login untuk menambah data.");
            return;
        }
        const ref = getCollectionRef('kas_umum_records');
        if (!ref) return;

        const kategori = document.getElementById('kasumum-kategori').value;
        if (!kategori) {
             showModal("Peringatan", "Kategori wajib dipilih.");
             return;
        }
        
        // Gunakan toValidNumber untuk memastikan jumlah adalah angka
        const jumlahInput = toValidNumber(document.getElementById('kasumum-jumlah').value);
        if (jumlahInput <= 0) {
            showModal("Peringatan", "Jumlah uang harus lebih dari 0.");
            return;
        }

        const data = {
            tanggal: document.getElementById('kasumum-tanggal').value,
            uraian: document.getElementById('kasumum-uraian').value,
            kategori: kategori,
            jumlah: jumlahInput,
            timestamp: serverTimestamp() 
        };
        try {
            await addDoc(ref, data);
            kasumumForm.reset();
            document.getElementById('kasumum-tanggal').valueAsDate = new Date(); 
            
        } catch (e) {
            console.error("Error adding kas umum document: ", e);
            showModal("Gagal Mencatat Kas Umum", "Terjadi kesalahan saat menyimpan data ke database. Coba lagi.");
        }
    });

    const deleteRecord = async (docId, type) => {
        if (!isAuthReady || !userId) {
            showModal("Gagal", "Anda harus login untuk menghapus data.");
            return;
        }
        const collectionName = type === 'jariyah' ? 'jariyah_records' : 'kas_umum_records';
        const ref = getCollectionRef(collectionName);
        if (!ref) return;

        try {
            await deleteDoc(doc(ref, docId));
            console.log(`Document (${type}) successfully deleted!`);
        } catch (e) {
            console.error(`Error deleting document (${type}): `, e);
            showModal("Gagal Menghapus Data", "Terjadi kesalahan saat menghapus data. Coba lagi.");
        }
    };

    // --- Real-time Listeners ---
    let unsubscribeJariyah = null;
    let unsubscribeKasUmum = null;
    
    const setupRealtimeListener = (type) => {
        const collectionName = type === 'jariyah' ? 'jariyah_records' : 'kas_umum_records';
        const ref = getCollectionRef(collectionName);
        if (!ref) return;

        // Bersihkan listener sebelumnya
        if (type === 'jariyah' && unsubscribeJariyah) { unsubscribeJariyah(); }
        if (type === 'kasumum' && unsubscribeKasUmum) { unsubscribeKasUmum(); }

        const q = query(ref); 

        const unsubscribe = onSnapshot(q, (snapshot) => {
            let records = [];
            snapshot.forEach((doc) => {
                records.push({ id: doc.id, ...doc.data() });
            });

            // Urutkan berdasarkan timestamp untuk perhitungan saldo/total (terlama dulu)
            records.sort((a, b) => {
                const timeA = a.timestamp?.toMillis() || 0;
                const timeB = b.timestamp?.toMillis() || 0;
                return timeA - timeB; 
            });

            if (type === 'jariyah') {
                calculateAndRenderJariyah(records);
            } else if (type === 'kasumum') {
                calculateAndRenderKasUmum(records);
            }
        }, (error) => {
            console.error(`Error listening to Firestore (${type}): `, error);
            showModal("Kesalahan Database", `Gagal memuat data real-time untuk ${type}.`);
        });

        if (type === 'jariyah') { unsubscribeJariyah = unsubscribe; }
        if (type === 'kasumum') { unsubscribeKasUmum = unsubscribe; }
    };
    
    // --- Logika Rendering Jariyah (Diperbaiki untuk Urutan NO 1, 2, 3...) ---
    const calculateAndRenderJariyah = (records) => {
        let runningTotal = 0;
        let totalJumlahGlobal = 0;

        // 1. Hitung running total (Records sudah terurut ASC: Terlama -> Terbaru)
        records = records.map(record => {
            const jariyah = toValidNumber(record.jumlah);
            totalJumlahGlobal += jariyah;
            runningTotal += jariyah;
            
            // Perhitungan presentase
            const perawatanMakam = Math.round(jariyah * 0.15);
            const ongkosPanitia = Math.round(jariyah * 0.15);
            const biayaHaul = Math.round(jariyah * 0.70);

            return {
                ...record,
                runningTotal: runningTotal, 
                perawatanMakam: perawatanMakam,
                ongkosPanitia: ongkosPanitia,
                biayaHaul: biayaHaul
            };
        });
        
        globalTotalJariyah = totalJumlahGlobal;
        
        // 2. Render Data (Records sudah dalam urutan ASC: Lama ke Baru)

        totalJumlahJariyahElement.textContent = formatRupiah(globalTotalJariyah);
        jariyahList.innerHTML = ''; 
        if (records.length === 0) {
            jariyahList.innerHTML = `<tr><td colspan="10" class="p-4 text-center text-gray-500 italic">Belum ada catatan jariyah. Silakan tambahkan data baru.</td></tr>`;
            return;
        }

        records.forEach((record, index) => {
            const row = document.createElement('tr');
            row.className = 'data-row hover:bg-indigo-50 transition duration-150';

            const formattedDate = record.tanggal ? new Date(record.tanggal + 'T00:00:00').toLocaleDateString('id-ID', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            }) : '-';
            
            // Penomoran NO 1, 2, 3... dari atas ke bawah
            const no = index + 1; 

            row.innerHTML = `
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">${no}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-900 font-medium">${formattedDate}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-900">${record.nama}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">${record.alamat}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm font-semibold text-indigo-600 border-r border-gray-200">${formatRupiah(record.jumlah)}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm running-total-cell-jariyah border-r border-gray-200">${formatRupiah(record.runningTotal)}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-800">${formatRupiah(record.perawatanMakam)}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-800">${formatRupiah(record.ongkosPanitia)}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-800">${formatRupiah(record.biayaHaul)}</td>
                <td class="px-3 py-3 whitespace-nowrap text-center text-sm">
                    <button class="delete-btn text-red-600 hover:text-red-900 p-2 rounded-full hover:bg-red-100 transition" data-id="${record.id}" data-type="jariyah" title="Hapus Catatan">
                        Hapus
                    </button>
                </td>
            `;

            row.querySelector('.delete-btn').addEventListener('click', (e) => {
                const docId = e.currentTarget.dataset.id;
                showModal("Konfirmasi Hapus Jariyah", `Apakah Anda yakin ingin menghapus catatan Jariyah dari ${record.nama}?`, true, () => deleteRecord(docId, 'jariyah'));
            });

            jariyahList.appendChild(row);
        });
    };
    
    // --- Logika Rendering Kas Umum (Diperbaiki untuk Urutan NO 1, 2, 3...) ---
    const calculateAndRenderKasUmum = (dbRecords) => {
        let saldo = 0;
        let records = [];

        // 1. Tambahkan Saldo Awal Jariyah sebagai BARIS PERTAMA (virtual)
        if (globalTotalJariyah > 0) {
            records.push({
                id: 'initial_jariyah', 
                tanggal: new Date().toISOString().split('T')[0], // Tanggal hari ini
                uraian: 'SALDO AWAL KAS DARI TOTAL DONASI JARIYAH',
                kategori: 'Donatur (Otomatis)',
                jumlah: globalTotalJariyah,
                danaMasuk: globalTotalJariyah,
                danaKeluar: 0,
                isInitial: true, 
                timestamp: { toMillis: () => 0 } // Timestamp paling awal (0)
            });
            saldo += globalTotalJariyah;
        }

        // 2. Tambahkan Data Jurnal dari Database dan hitung saldo
        // dbRecords sudah terurut ASC (Terlama -> Terbaru)
        dbRecords.forEach(record => {
            const jumlah = toValidNumber(record.jumlah); 
            const kategori = record.kategori;
            const jenis = KATEGORI_MASUK.includes(kategori) ? 'Masuk' : 'Keluar';
            
            const danaMasuk = jenis === 'Masuk' ? jumlah : 0;
            const danaKeluar = jenis === 'Keluar' ? jumlah : 0;
            
            saldo += danaMasuk - danaKeluar;

            records.push({
                ...record,
                danaMasuk: danaMasuk,
                danaKeluar: danaKeluar,
                saldo: saldo,
                isInitial: false
            });
        });

        // 3. Update Saldo Akhir Global (Saldo adalah hasil dari transaksi terakhir)
        const finalSaldo = records.length > 0 ? records[records.length - 1].saldo : 0;

        totalSaldoKasUmumElement.textContent = formatRupiah(finalSaldo);
        kasumumList.innerHTML = ''; 
        
        if (records.length === 0) {
            kasumumList.innerHTML = `<tr><td colspan="8" class="p-4 text-center text-gray-500 italic">Belum ada catatan Kas Umum. Silakan tambahkan data baru.</td></tr>`;
            return;
        }

        // 4. Render Data (Records sudah dalam urutan ASC: Lama ke Baru)
        records.forEach((record, index) => {
            const row = document.createElement('tr');
            
            if (record.isInitial) {
                row.className = 'initial-jariyah-entry data-row transition duration-150';
            } else {
                row.className = 'data-row hover:bg-indigo-50 transition duration-150';
            }

            const formattedDate = record.tanggal ? new Date(record.tanggal + 'T00:00:00').toLocaleDateString('id-ID', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            }) : '-';
            
            // Penomoran NO 1, 2, 3... dari atas ke bawah
            const no = index + 1;

            row.innerHTML = `
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">${no}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-900 font-medium">${formattedDate}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-800">${record.uraian}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm font-semibold ${record.danaMasuk > 0 ? 'text-green-600' : 'text-red-600'}">${record.kategori}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm text-right font-semibold text-green-700">${record.danaMasuk > 0 ? formatRupiah(record.danaMasuk) : '-'}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm text-right font-semibold text-red-700">${record.danaKeluar > 0 ? formatRupiah(record.danaKeluar) : '-'}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm text-right running-saldo-cell-kas">${formatRupiah(record.saldo)}</td>
                <td class="px-3 py-3 whitespace-nowrap text-center text-sm">
                    ${record.isInitial 
                        ? '<span class="text-xs text-orange-500 font-bold">Otomatis</span>' 
                        : `<button class="delete-btn text-red-600 hover:text-red-900 p-2 rounded-full hover:bg-red-100 transition" data-id="${record.id}" data-type="kasumum" title="Hapus Catatan">Hapus</button>`
                    }
                </td>
            `;
            
            if (!record.isInitial) {
                row.querySelector('.delete-btn').addEventListener('click', (e) => {
                    const docId = e.currentTarget.dataset.id;
                    showModal("Konfirmasi Hapus Jurnal", `Apakah Anda yakin ingin menghapus jurnal: ${record.uraian}?`, true, () => deleteRecord(docId, 'kasumum'));
                });
            }

            kasumumList.appendChild(row);
        });
    };


    // --- 4. Aksi Panel Kontrol ---
    logoutButton.addEventListener('click', async () => {
        showModal("Konfirmasi Log Out", "Apakah Anda yakin ingin keluar?", true, async () => {
            try {
                if (unsubscribeJariyah) { unsubscribeJariyah(); }
                if (unsubscribeKasUmum) { unsubscribeKasUmum(); }
                await signOut(auth);
            } catch (error) {
                console.error("Error signing out: ", error);
                showModal("Gagal Log Out", "Terjadi kesalahan saat keluar. Coba lagi.");
            }
        });
    });

    resetButton.addEventListener('click', () => {
        const activeCollection = currentTab === 'jariyah' ? 'jariyah_records' : 'kas_umum_records';
        const collectionDisplay = currentTab === 'jariyah' ? 'Catatan Jariyah' : 'Jurnal Kas Umum';

        showModal("KONFIRMASI RESET DATA KRITIS", `⚠️ PERINGATAN! Ini akan **menghapus SEMUA data ${collectionDisplay}** Anda secara permanen. Lanjutkan?`, true, async () => {
            if (!isAuthReady || !userId) {
                showModal("Gagal", "Anda harus login untuk mereset data.");
                return;
            }

            const ref = getCollectionRef(activeCollection);
            if (!ref) return;

            try {
                const snapshot = await getDocs(ref);
                if (snapshot.empty) {
                    showModal("Info", `Tidak ada data ${collectionDisplay} untuk direset.`, false);
                    return;
                }

                const batch = writeBatch(db);
                snapshot.docs.forEach((d) => {
                    batch.delete(d.ref);
                });

                await batch.commit();
                showModal("Sukses Reset", `Semua data ${collectionDisplay} berhasil dihapus.`, false);
            } catch (e) {
                console.error("Error resetting data: ", e);
                showModal("Gagal Reset", "Terjadi kesalahan saat menghapus data secara massal. Coba lagi.");
            }
        });
    });
    
    // Set tanggal default saat dimuat
    document.getElementById('jariyah-tanggal').valueAsDate = new Date(); 
    document.getElementById('kasumum-tanggal').valueAsDate = new Date(); 

    // Inisialisasi dengan tab Jariyah aktif
    switchTab('content-jariyah');

</script>
</body>
</html>
