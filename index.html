<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pembukuan Haul: Donatur, Jurnal & Ekspor Lokal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* Gaya agar tabel bisa digeser jika terlalu lebar */
        .table-wrapper {
            overflow-x: auto; 
        }

        /* --- PERBAIKAN FONT DAN TEBAL --- */
        /* Ganti font global ke Cambria / Times New Roman / Serif */
        body {
            font-family: Cambria, 'Times New Roman', Times, serif; 
        }
        
        /* Ganti font size global untuk isi tabel agar tidak terlalu besar */
        table {
            font-size: 0.9rem; 
            width: 100%; 
        }

        /* Hapus tebal default dari sel tabel (di JS, kita tambahkan lagi hanya pada total akhir) */
        td {
            font-weight: normal; 
        }

        /* Class untuk Baris Total Akhir Jurnal dan Donatur agar TEBAL */
        .total-row-bold td {
            font-weight: bold !important;
        }

        /* --- PENYESUAIAN LEBAR KOLOM AGAR TIDAK DEMPET --- */
        #jurnal-table th:nth-child(2), 
        #jurnal-table td:nth-child(2),
        #donatur-table th:nth-child(2),
        #donatur-table td:nth-child(2) {
            /* Kolom Tanggal: Beri minimum lebar 110px */
            min-width: 110px; 
        }

        #jurnal-table th:nth-child(3),
        #jurnal-table td:nth-child(3) {
            /* Kolom Uraian (jika tidak login, ini akan jadi uraian+keterangan) */
            min-width: 250px; 
        }
        
        #donatur-table th:nth-child(3),
        #donatur-table td:nth-child(3) {
            /* Kolom Nama Donatur */
            min-width: 150px; 
        }

        /* --- STICKY COLUMNS --- */
        .sticky-col {
            position: sticky;
            left: 0;
            z-index: 10;
            border-right: 1px solid #e5e7eb; 
            min-width: 50px;
        }
        
        .sticky-col-right {
            position: sticky;
            right: 0;
            z-index: 10;
            border-left: 1px solid #e5e7eb; 
            min-width: 120px;
            background-color: #f3f4f6; 
        }
        
        .sticky-no-cell {
            background-color: white !important; 
            font-weight: bold;
        }
        .sticky-action-cell {
            background-color: #f3f4f6 !important; 
        }

        /* Header Tabel */
        .header-bg-donatur {
            background-color: #6B46C1; 
            color: white;
        }
        .header-bg-jurnal {
            background-color: #059669; 
            color: white;
        }
        
        /* Gaya untuk Tombol Admin Kecil */
        .btn-admin-small {
            padding: 0.5rem 1rem; /* Padding lebih kecil */
            font-size: 0.875rem; /* Text lebih kecil */
        }
        
        /* Gaya untuk tombol pagination */
        .pagination-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 700; /* font-bold */
            transition: all 150ms;
        }
        .pagination-btn-active {
            background-color: #FBBF24; /* bg-yellow-400 */
            color: #1F2937; /* text-gray-800 */
        }
        .pagination-btn-inactive {
            background-color: #E5E7EB; /* bg-gray-200 */
            color: #4B5563; /* text-gray-600 */
        }
        .pagination-btn:not(.pagination-btn-active):hover {
            background-color: #D1D5DB; /* hover:bg-gray-300 */
        }
    </style>
</head>
<body class="bg-gray-100 p-8">

    <div class="max-w-7xl mx-auto bg-white p-6 rounded-lg shadow-xl">
        <h1 class="text-3xl font-bold text-center text-green-700 mb-4">
            Pembukuan Donatur Haul
        </h1>
        
        <div class="flex flex-wrap gap-4 mb-8 justify-center border-b pb-4">
            <button onclick="exportDonaturPDF()" class="py-2 px-4 bg-purple-600 text-white font-bold rounded hover:bg-purple-700 transition duration-150">
                Unduh PDF List Donatur
            </button>
            <button onclick="exportJurnalDetailPDF()" class="py-2 px-4 bg-green-600 text-white font-bold rounded hover:bg-green-700 transition duration-150">
                Unduh PDF Laporan Detail Jurnal
            </button>
            <button onclick="exportLpjGlobalPDF()" class="py-2 px-4 bg-yellow-600 text-white font-bold rounded hover:bg-yellow-700 transition duration-150">
                Unduh PDF Laporan Global (LPJ)
            </button>
        </div>

        <hr class="my-8">
        
        <h2 class="text-xl font-semibold mb-4 text-gray-700">1. Jurnal Kas Umum (Dana Masuk & Keluar)</h2>
        
        <div class="table-wrapper mb-4">
            <table class="min-w-full divide-y divide-gray-200" id="jurnal-table">
                <thead class="header-bg-jurnal">
                    <tr>
                        <th class="sticky-col px-4 py-3 text-center text-xs font-medium uppercase tracking-wider">NO</th>
                        <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Tanggal</th>
                        <th id="th-jurnal-uraian" class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Uraian</th>
                        <th id="th-jurnal-kategori" class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider hidden">Kategori</th>
                        <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider bg-green-900">Dana Masuk (Rp)</th>
                        <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider bg-red-900">Dana Keluar (Rp)</th>
                        <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider">Saldo (Rp)</th>
                        <th id="th-jurnal-aksi" class="sticky-col-right px-4 py-3 text-center text-xs font-medium uppercase tracking-wider hidden">Aksi</th>
                    </tr>
                </thead>
                <tbody id="jurnal-table-body" class="bg-white divide-y divide-gray-200">
                    <tr><td colspan="8" class="py-4 text-center text-gray-500">Jurnal Kas Umum belum terisi.</td></tr>
                </tbody>
                <tfoot class="bg-gray-100 total-row-bold"> 
                    <tr>
                        <td id="td-jurnal-total-col" colspan="3" class="px-4 py-3 text-right text-sm bg-gray-200">**TOTAL AKUMULASI KAS:**</td>
                        <td id="td-jurnal-total-kategori" class="px-4 py-3 text-right text-sm bg-gray-200 hidden"></td>
                        <td class="px-4 py-3 text-right text-sm text-green-700" id="total-dana-masuk-jurnal">Rp 0</td>
                        <td class="px-4 py-3 text-right text-sm text-red-700" id="total-dana-keluar-jurnal">Rp 0</td>
                        <td class="px-4 py-3 text-right text-sm bg-blue-100 text-blue-700" id="saldo-akhir-jurnal">Rp 0</td>
                        <td id="td-jurnal-total-aksi" class="sticky-col-right px-4 py-3 text-right text-sm bg-gray-200 hidden"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        
        <div id="jurnal-pagination-container" class="flex justify-center gap-2 py-4 mb-12">
            </div>
        
        <hr class="my-8">

        <h2 class="text-xl font-semibold mb-4 text-gray-700">2. Laporan List Donatur Jariyah</h2>
        <p id="donatur-note-persentase" class="mb-4 text-sm text-gray-600 hidden">Total Jariyah akan dibagi secara otomatis: Perawatan Makam (15%), Ongkos Panitia (15%), Biaya Haul (70%).</p>
        
        <div class="table-wrapper mb-4"> 
            <table class="min-w-full divide-y divide-gray-200" id="donatur-table">
                <thead class="header-bg-donatur">
                    <tr>
                        <th class="sticky-col px-4 py-3 text-center text-xs font-medium uppercase tracking-wider" rowspan="2">NO</th>
                        <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider" rowspan="2">Tanggal</th>
                        <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider" rowspan="2">Nama Donatur</th>
                        <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider" rowspan="2">Alamat</th>
                        <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider bg-purple-700" rowspan="2">Jariyah (Rp)</th>
                        <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider bg-green-700" rowspan="2">Total Jariyah (Rp)</th>
                        <th id="th-donatur-presentase" class="px-4 py-3 text-center text-xs font-medium uppercase tracking-wider bg-yellow-700 hidden" colspan="3">Presentase Donasi</th>
                        <th id="th-donatur-aksi" class="sticky-col-right px-4 py-3 text-center text-xs font-medium uppercase tracking-wider hidden" rowspan="2">Aksi</th>
                    </tr>
                    <tr id="donatur-presentase-row" class="bg-yellow-600 text-white hidden">
                        <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider">Perawatan Makam (15%)</th>
                        <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider">Ongkos Panitia (15%)</th>
                        <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider">Biaya Haul (70%)</th>
                    </tr>
                </thead>
                <tbody id="donatur-table-body" class="bg-white divide-y divide-gray-200">
                    <tr><td colspan="10" class="py-4 text-center text-gray-500">Belum ada data donasi yang dicatat.</td></tr>
                </tbody>
                <tfoot class="bg-gray-200">
                    <tr id="total-akumulasi-row" class="font-bold hidden"> <td id="td-donatur-total-col-1" colspan="6" class="px-4 py-3 text-right text-sm bg-gray-300">TOTAL AKUMULASI (Pembagian Presentase):</td>
                        <td id="total-makam-footer" class="px-4 py-3 text-right text-sm text-yellow-800 hidden">Rp 0</td>
                        <td id="total-panitia-footer" class="px-4 py-3 text-right text-sm text-yellow-800 hidden">Rp 0</td>
                        <td id="total-haul-footer" class="px-4 py-3 text-right text-sm text-yellow-800 hidden">Rp 0</td>
                        <td id="td-donatur-total-col-2" class="sticky-col-right px-4 py-3 text-right text-sm bg-gray-300 hidden"></td>
                    </tr>
                    <tr class="total-row-bold"> 
                         <td id="td-donatur-total-col-3" colspan="5" class="px-4 py-3 text-right text-sm">**TOTAL KESELURUHAN DONASI:**</td>
                        <td class="px-4 py-3 text-right text-sm bg-green-100 text-green-700" id="total-jariyah-footer">Rp 0</td>
                        <td id="td-donatur-total-col-4" colspan="4" class="px-4 py-3 text-right text-sm hidden"></td> 
                    </tr>
                </tfoot>
            </table>
        </div>

        <div id="donatur-pagination-container" class="flex justify-center gap-2 py-4 mb-12">
            </div>


        <div id="login-form-container" class="flex flex-wrap justify-center items-center gap-2 py-4 border-t border-b mb-8"> 
            <input type="password" id="admin-password-input" placeholder="Masukkan Password Admin" class="flex-grow max-w-sm border border-gray-300 rounded-md shadow-sm p-2 text-sm">
            <button onclick="adminLogin()" class="py-2 px-4 bg-blue-600 text-white font-bold rounded hover:bg-blue-700 transition duration-150 text-sm">
                Login Admin
            </button>
        </div>

        <hr class="my-8">

        <div id="jurnal-input-container" class="hidden">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">3. Input Jurnal Kas Umum (Dana Keluar)</h2>
            <form id="form-jurnal" class="grid grid-cols-1 md:grid-cols-4 gap-4 bg-gray-50 p-6 rounded-lg border mb-8">
                
                <input type="hidden" id="jurnal-id-input" value="">

                <div><label for="tanggal-input-jurnal" class="block text-sm font-medium text-gray-700">Tanggal</label><input type="date" id="tanggal-input-jurnal" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                <div><label for="uraian-input" class="block text-sm font-medium text-gray-700">Uraian / Keterangan</label><input type="text" id="uraian-input" required placeholder="Contoh: Pembayaran Konsumsi" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                
                <div>
                    <label for="kategori-input" class="block text-sm font-medium text-gray-700">Kategori Dana Keluar</label>
                    <select id="kategori-input" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        <option value="">Pilih Kategori Pengeluaran</option>
                        <option value="Ongkos Kiai">1. Ongkos Kiai</option>
                        <option value="Bayar Khataman">2. Bayar Khataman</option>
                        <option value="Bayar Konsumsi">3. Bayar Konsumsi</option>
                        <option value="Bayar Persewaan">4. Bayar Persewaan</option>
                        <option value="Bayar Pekerja">5. Bayar Pekerja</option>
                        <option value="Lain-lain">6. Lain-lain</option>
                    </select>
                </div>

                <div><label for="dana-keluar-input" class="block text-sm font-medium text-gray-700">Dana Keluar (Rp)</label><input type="number" id="dana-keluar-input" required min="1" placeholder="Masukkan jumlah pengeluaran" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                
                <div class="col-span-full mt-4 flex gap-4">
                    <button type="submit" id="jurnal-submit-btn" class="w-full py-3 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150">
                        Catat Pengeluaran
                    </button>
                    <button type="button" id="jurnal-cancel-btn" class="hidden py-3 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-gray-500 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition duration-150" onclick="resetJurnalForm()">
                        Batal Edit
                    </button>
                </div>
            </form>
        </div>

        <hr class="my-8">

        <div id="donasi-input-container" class="hidden">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">4. Input Data Donasi Jariyah</h2>
            <form id="form-donasi" class="grid grid-cols-1 md:grid-cols-4 gap-4 bg-gray-50 p-6 rounded-lg border mb-8">
                
                <input type="hidden" id="donatur-id-input" value="">

                <div class="md:col-span-2"><label for="tanggal-input-donasi" class="block text-sm font-medium text-gray-700">Tanggal</label><input type="date" id="tanggal-input-donasi" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                <div class="md:col-span-2"><label for="nama-donatur-input" class="block text-sm font-medium text-gray-700">Nama Donatur</label><input type="text" id="nama-donatur-input" required placeholder="Nama lengkap donatur" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                <div class="md:col-span-2"><label for="alamat-input" class="block text-sm font-medium text-gray-700">Alamat</label><input type="text" id="alamat-input" required placeholder="Alamat donatur" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                <div class="md:col-span-2"><label for="jariyah-input" class="block text-sm font-medium text-gray-700">Jariyah (Nominal Rupiah)</label><input type="number" id="jariyah-input" required min="1" placeholder="Masukkan jumlah donasi (misal: 100000)" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                
                <div class="col-span-full mt-4 flex gap-4">
                    <button type="submit" id="donasi-submit-btn" class="w-full py-3 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150">
                        Catat Donasi
                    </button>
                    <button type="button" id="donasi-cancel-btn" class="hidden py-3 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-gray-500 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition duration-150" onclick="resetDonasiForm()">
                        Batal Edit
                    </button>
                </div>
            </form>
        </div>
        
        <div id="admin-actions-container" class="hidden flex justify-between items-center mt-4 pt-4 border-t">
            <button onclick="confirmResetData()" class="btn-admin-small bg-yellow-600 text-white font-bold rounded hover:bg-yellow-700 transition duration-150">
                Reset Data
            </button>
            
            <button onclick="adminLogout()" class="btn-admin-small bg-red-600 text-white font-bold rounded hover:bg-red-900 transition duration-150">
                Logout Admin
            </button>
        </div>

    </div>

    <script type="module">
        // --------------------------------------------------------------------------------
        // 1. FIREBASE SETUP DAN KONFIGURASI BARU
        // --------------------------------------------------------------------------------
        
        // Import fungsi-fungsi yang diperlukan dari Firebase SDK (Versi 9 modular)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        
        // Konfigurasi Firebase Anda
        const firebaseConfig = {
            // HARAP DOUBLE CHECK APAKAH KUNCI INI SUDAH SESUAI DENGAN YANG KAKAK BERIKAN
            apiKey: "AIzaSyAHIO0RZgoq6eyjeERTpjOugzJLzqG2S-w",
            authDomain: "catatan-keuangan-haul.firebaseapp.com",
            projectId: "catatan-keuangan-haul",
            storageBucket: "catatan-keuangan-haul.firebasestorage.app",
            messagingSenderId: "955355049778",
            appId: "1:955355049778:web:0b844b27b82a88cc0cf12b"
        };
        
        // Initialize Firebase dan dapatkan referensi Auth & Firestore
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Definisikan Collection (Nama tabel di Firestore)
        const donaturCol = collection(db, "donatur");
        const jurnalCol = collection(db, "jurnal");

        // --------------------------------------------------------------------------------
        // 2. GLOBAL VARIABLES
        // --------------------------------------------------------------------------------

        // allTransactions akan menampung data gabungan dari donatur dan jurnal (yang sudah di-fetch dari Firestore)
        let allTransactions = []; 
        let isAdminLoggedIn = false; 

        // Pagination variables (Tetap menggunakan logic pagination lama)
        const itemsPerPage = 10;
        let currentDonaturPage = 1;
        let currentJurnalPage = 1;

        // --------------------------------------------------------------------------------
        // 3. HELPER FUNCTIONS
        // --------------------------------------------------------------------------------

        const formatRupiah = (angka) => {
            const numberString = angka.toString().replace(/[^,\d]/g, '');
            const split = numberString.split(',');
            const sisa = split[0].length % 3;
            let rupiah = split[0].substr(0, sisa);
            const ribuan = split[0].substr(sisa).match(/\d{3}/gi);

            if (ribuan) {
                const separator = sisa ? '.' : '';
                rupiah += separator + ribuan.join('.');
            }

            rupiah = split[1] !== undefined ? rupiah + ',' + split[1] : rupiah;
            return 'Rp ' + rupiah;
        };

        const updateAdminView = () => {
            const isLogged = isAdminLoggedIn;
            
            // 1. Tampilkan/Sembunyikan Panel Login/Logout
            // Catatan: Pastikan di HTML Anda ada id='login-form-container' dan id='admin-actions-container'
            document.getElementById('login-form-container').classList.toggle('hidden', isLogged);
            document.getElementById('admin-actions-container').classList.toggle('hidden', !isLogged);
            
            // --- JURNAL KAS UMUM (RAPIH PUBLIK) ---
            const thJurnalUraian = document.getElementById('th-jurnal-uraian');
            
            // Logika Gabungan Header: Jika TIDAK LOGIN, gabungkan Uraian dan Kategori di header
            thJurnalUraian.setAttribute('colspan', isLogged ? '1' : '2');
            thJurnalUraian.textContent = isLogged ? 'Uraian' : 'Uraian / Keterangan'; // Ubah teks header
            
            // Lindungi dari Null: Periksa keberadaan elemen sebelum memanipulasi classList
            const thKategori = document.getElementById('th-jurnal-kategori');
            const thAksiJurnal = document.getElementById('th-jurnal-aksi');
            if (thKategori) thKategori.classList.toggle('hidden', !isLogged);
            if (thAksiJurnal) thAksiJurnal.classList.toggle('hidden', !isLogged);
            
            // Update colspan total jurnal (Footer)
            // Catatan: Pastikan di HTML ada td-jurnal-total-col
            document.getElementById('td-jurnal-total-col').setAttribute('colspan', isLogged ? '3' : '4'); 
            const tdKategori = document.getElementById('td-jurnal-total-kategori');
            const tdAksiJurnal = document.getElementById('td-jurnal-total-aksi');
            if (tdKategori) tdKategori.classList.toggle('hidden', !isLogged);
            if (tdAksiJurnal) tdAksiJurnal.classList.toggle('hidden', !isLogged);


            // --- LAPORAN DONATUR (RAPIH PUBLIK) ---
            // Catatan: Pastikan di HTML ada donatur-note-persentase
            document.getElementById('donatur-note-persentase').classList.toggle('hidden', !isLogged);
            const thPresentase = document.getElementById('th-donatur-presentase');
            const rowPresentase = document.getElementById('donatur-presentase-row');
            const thAksiDonatur = document.getElementById('th-donatur-aksi');
            if (thPresentase) thPresentase.classList.toggle('hidden', !isLogged);
            if (rowPresentase) rowPresentase.classList.toggle('hidden', !isLogged);
            if (thAksiDonatur) thAksiDonatur.classList.toggle('hidden', !isLogged);
            
            // Update colspan total donatur (Footer)
            
            // 1. Baris TOTAL AKUMULASI (Presentase) - Disembunyikan saat publik
            const totalAkumulasiRow = document.getElementById('total-akumulasi-row');
            if (totalAkumulasiRow) totalAkumulasiRow.classList.toggle('hidden', !isLogged);
            
            const tdCol1 = document.getElementById('td-donatur-total-col-1');
            if (tdCol1) tdCol1.setAttribute('colspan', isLogged ? '6' : '4');
            
            const tdCol2 = document.getElementById('td-donatur-total-col-2');
            const totalMakam = document.getElementById('total-makam-footer');
            const totalPanitia = document.getElementById('total-panitia-footer');
            const totalHaul = document.getElementById('total-haul-footer');
            if (tdCol2) tdCol2.classList.toggle('hidden', !isLogged); 
            if (totalMakam) totalMakam.classList.toggle('hidden', !isLogged);
            if (totalPanitia) totalPanitia.classList.toggle('hidden', !isLogged);
            if (totalHaul) totalHaul.classList.toggle('hidden', !isLogged);
            
            // 2. Baris TOTAL KESELURUHAN DONASI
            // Kolom 4 (Kolom kosong sisa presentase dan aksi)
            const tdCol4 = document.getElementById('td-donatur-total-col-4');
            if (tdCol4) tdCol4.classList.toggle('hidden', !isLogged); 
            if (tdCol4) tdCol4.setAttribute('colspan', isLogged ? '4' : '0'); 


            // 3. Tampilkan/Sembunyikan Input Forms
            document.getElementById('jurnal-input-container').classList.toggle('hidden', !isLogged);
            document.getElementById('donasi-input-container').classList.toggle('hidden', !isLogged);
            
            // Reset halaman ke 1 saat admin view berubah 
            currentDonaturPage = 1;
            currentJurnalPage = 1;
            
            // Render ulang tabel untuk menampilkan/menyembunyikan baris/kolom aksi
            renderAllTables();
        };
        
        window.goToPage = goToPage; // Agar bisa dipanggil dari HTML
        
        // --------------------------------------------------------------------------------
        // 4. FIREBASE AUTH LOGIC (LOGIN/LOGOUT)
        // --------------------------------------------------------------------------------

        // Mengelola perubahan status login
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in (Admin)
                isAdminLoggedIn = true;
            } else {
                // User is signed out (Publik)
                isAdminLoggedIn = false;
            }
            updateAdminView();
            // Panggil fungsi untuk mengambil data setiap kali status login berubah
            loadAndRenderData(); 
        });


        window.adminLogin = async () => {
            // Ambil input email dan password yang baru kita tambahkan di HTML
            const email = document.getElementById('admin-email-input').value;
            const password = document.getElementById('admin-password-input').value;
            
            if (!email || !password) {
                alert('Mohon masukkan Email dan Password Admin.');
                return;
            }

            try {
                // Bersihkan input setelah login dicoba
                document.getElementById('admin-email-input').value = '';
                document.getElementById('admin-password-input').value = '';

                // Autentikasi menggunakan Firebase
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                
                alert('Login Berhasil! Anda memiliki akses admin.');
                // onAuthStateChanged akan menangani pemanggilan updateAdminView() dan loadAndRenderData()
                
                // Scroll ke bagian input Jurnal setelah login
                window.scrollTo({ top: document.getElementById('jurnal-input-container').offsetTop - 50, behavior: 'smooth' });
                
            } catch (error) {
                console.error("Login Error:", error);
                // Menangani error umum (misalnya: email/password salah)
                alert(`Login Gagal. Pastikan Email dan Password Anda benar.`);
            }
        };

        window.adminLogout = async () => {
            if (confirm('Anda yakin ingin keluar dari mode Admin?')) {
                try {
                    await signOut(auth);
                    alert('Logout Berhasil. Kembali ke mode Tampilan Publik.');
                    
                    // Scroll ke tombol login setelah logout
                    window.scrollTo({ top: document.getElementById('login-form-container').offsetTop - 50, behavior: 'smooth' });
                } catch (error) {
                    console.error("Logout Error:", error);
                    alert(`Logout Gagal: ${error.message}`);
                }
            }
        };
        
        // --------------------------------------------------------------------------------
        // 5. FIRESTORE CRUD (CREATE, READ, UPDATE, DELETE)
        // --------------------------------------------------------------------------------

        // *** READ: Mengambil Data dari Firestore dan Menggabungkannya ***
        const loadAndRenderData = async () => {
            // Reset array global
            allTransactions = [];

            try {
                // 1. Ambil data Donatur
                const donaturSnapshot = await getDocs(donaturCol);
                donaturSnapshot.forEach(doc => {
                    const data = doc.data();
                    allTransactions.push({
                        id: doc.id, // ID Firestore
                        type: 'IN',
                        description: data.description,
                        amount: data.amount,
                        timestamp: data.timestamp ? data.timestamp.toDate().getTime() : new Date(data.date).getTime(), // Convert Firestore Timestamp ke milidetik
                        date: data.date,
                        donaturName: data.donaturName // Hanya di data donatur
                    });
                });

                // 2. Ambil data Jurnal
                const jurnalSnapshot = await getDocs(jurnalCol);
                jurnalSnapshot.forEach(doc => {
                    const data = doc.data();
                    allTransactions.push({
                        id: doc.id, // ID Firestore
                        type: data.type, // IN atau OUT
                        description: data.description,
                        amount: data.amount,
                        timestamp: data.timestamp ? data.timestamp.toDate().getTime() : new Date(data.date).getTime(),
                        date: data.date,
                    });
                });

                // Setelah semua data diambil, render ulang
                renderAllTables();
                
            } catch (error) {
                console.error("Gagal memuat data dari Firestore:", error);
                alert("Gagal memuat data. Periksa koneksi Firebase Anda di console log.");
            }
        };
        
        // *** CREATE: Menambah Transaksi Jurnal (Pengeluaran/Pemasukan) ***
        window.addTransaction = async () => {
            if (!isAdminLoggedIn) {
                alert('Akses ditolak. Silakan login sebagai Admin.');
                return;
            }
            
            // ... (Kode untuk mengambil nilai input seperti sebelumnya) ...
            const type = document.getElementById('jurnal-type-input').value;
            const description = document.getElementById('jurnal-description-input').value;
            let amount = parseInt(document.getElementById('jurnal-amount-input').value.replace(/\./g, ''));
            const date = document.getElementById('jurnal-date-input').value;
            
            if (!type || !description || isNaN(amount) || amount <= 0 || !date) {
                alert('Semua field Jurnal harus diisi dengan benar.');
                return;
            }
            
            // Objek data yang akan disimpan ke Firestore
            const newTransaction = {
                type: type,
                description: description,
                amount: amount,
                date: date,
                // Gunakan serverTimestamp untuk sorting yang akurat
                timestamp: serverTimestamp() 
            };

            try {
                // Simpan ke collection 'jurnal' di Firestore
                await addDoc(jurnalCol, newTransaction);
                
                // Bersihkan input
                document.getElementById('jurnal-description-input').value = '';
                document.getElementById('jurnal-amount-input').value = '';
                // Biarkan type dan date tetap, pengguna mungkin menambahkan entri lain di hari yang sama
                
                alert('Transaksi Jurnal berhasil ditambahkan.');
                // Muat ulang dan render data
                await loadAndRenderData();

            } catch (error) {
                console.error("Gagal menambahkan Jurnal:", error);
                alert("Gagal menyimpan transaksi. Cek console log.");
            }
        };

        // *** CREATE: Menambah Data Donatur ***
        window.addDonatur = async () => {
            if (!isAdminLoggedIn) {
                alert('Akses ditolak. Silakan login sebagai Admin.');
                return;
            }
            
            const donaturName = document.getElementById('donatur-name-input').value;
            const description = document.getElementById('donatur-description-input').value;
            let amount = parseInt(document.getElementById('donatur-amount-input').value.replace(/\./g, ''));
            const date = document.getElementById('donatur-date-input').value;
            
            if (!donaturName || !description || isNaN(amount) || amount <= 0 || !date) {
                alert('Semua field Donatur harus diisi dengan benar.');
                return;
            }

            const newDonatur = {
                donaturName: donaturName,
                description: description,
                amount: amount,
                date: date,
                timestamp: serverTimestamp() 
            };

            try {
                // Simpan ke collection 'donatur' di Firestore
                await addDoc(donaturCol, newDonatur);
                
                // Bersihkan input
                document.getElementById('donatur-name-input').value = '';
                document.getElementById('donatur-description-input').value = '';
                document.getElementById('donatur-amount-input').value = '';
                
                alert('Data Donatur berhasil ditambahkan.');
                await loadAndRenderData();
            } catch (error) {
                console.error("Gagal menambahkan Donatur:", error);
                alert("Gagal menyimpan donatur. Cek console log.");
            }
        };
        
        // *** UPDATE: Mengedit Transaksi/Donatur ***
        window.editTransaction = async (id, currentType) => {
            if (!isAdminLoggedIn) return;
            
            const transaction = allTransactions.find(t => t.id === id);
            if (!transaction) return;
            
            const newDescription = prompt('Edit Keterangan:', transaction.description);
            let newAmount = prompt('Edit Jumlah (tanpa Rp atau titik):', transaction.amount);
            const newDate = prompt('Edit Tanggal (YYYY-MM-DD):', transaction.date);
            
            if (newDescription === null || newAmount === null || newDate === null) return; 

            newAmount = parseInt(newAmount);

            if (isNaN(newAmount) || newAmount <= 0) {
                alert('Jumlah harus berupa angka positif.');
                return;
            }
            
            // Tentukan koleksi (donatur atau jurnal) berdasarkan keberadaan properti donaturName
            const collectionRef = transaction.donaturName ? donaturCol : jurnalCol;
            const docRef = doc(collectionRef, id);

            const updatedData = {
                description: newDescription,
                amount: newAmount,
                date: newDate,
                // Jika Donatur, izinkan edit nama juga
                ...(transaction.donaturName && { donaturName: prompt('Edit Nama Donatur:', transaction.donaturName) }) 
            };

            try {
                await updateDoc(docRef, updatedData);
                alert('Data berhasil diperbarui!');
                await loadAndRenderData();
            } catch (error) {
                console.error("Gagal mengedit data:", error);
                alert('Gagal mengedit data. Cek console log.');
            }
        };

        // *** DELETE: Menghapus Transaksi/Donatur ***
        window.deleteTransaction = async (id) => {
            if (!isAdminLoggedIn) return;

            if (!confirm('Anda yakin ingin menghapus data ini? Tindakan ini tidak dapat dibatalkan.')) return;

            const transaction = allTransactions.find(t => t.id === id);
            if (!transaction) return;
            
            // Tentukan koleksi (donatur atau jurnal)
            const collectionRef = transaction.donaturName ? donaturCol : jurnalCol;
            const docRef = doc(collectionRef, id);

            try {
                await deleteDoc(docRef);
                alert('Data berhasil dihapus!');
                await loadAndRenderData();
            } catch (error) {
                console.error("Gagal menghapus data:", error);
                alert('Gagal menghapus data. Cek console log.');
            }
        };

        // *** RESET: Penghapusan Semua Data ***
        window.confirmResetData = async () => {
             if (!isAdminLoggedIn) return;
             
             if (!confirm('PERINGATAN! Anda yakin ingin MENGHAPUS SEMUA data Donasi dan Jurnal? Tindakan ini tidak bisa dibatalkan.')) return;
             
             if (!confirm('KONFIRMASI TERAKHIR: Ini akan menghapus PERMANEN semua data Donatur dan Jurnal di Firebase. LANJUTKAN?')) return;
             
             try {
                // Hapus semua Donatur
                const donaturSnapshot = await getDocs(donaturCol);
                const donaturDeletePromises = donaturSnapshot.docs.map(d => deleteDoc(doc(db, "donatur", d.id)));
                await Promise.all(donaturDeletePromises);

                // Hapus semua Jurnal
                const jurnalSnapshot = await getDocs(jurnalCol);
                const jurnalDeletePromises = jurnalSnapshot.docs.map(d => deleteDoc(doc(db, "jurnal", d.id)));
                await Promise.all(jurnalDeletePromises);

                alert('SEMUA DATA DONATUR DAN JURNAL BERHASIL DIHAPUS PERMANEN DARI FIREBASE.');
                // Muat ulang data (akan menjadi kosong)
                await loadAndRenderData();
             } catch (error) {
                 console.error("Gagal mereset data:", error);
                 alert('Gagal menghapus data di Firestore. Cek console log.');
             }
        };
        
        // --------------------------------------------------------------------------------
        // 6. RENDER & PDF LOGIC (Dipertahankan)
        // --------------------------------------------------------------------------------

        // ... (Fungsi renderDonaturTable, renderJurnalTable, exportPDFGlobal, exportPDFRingkasan, dan addSignatures tetap sama, karena mereka membaca data dari array 'allTransactions' yang kini sudah diisi oleh Firestore) ...
        
        const renderDonaturTable = (transactions, page) => {
            // ... (Isi fungsi renderDonaturTable lama) ...
            const donaturBody = document.getElementById('donatur-table-body');
            const donaturTotalElement = document.getElementById('donatur-total');
            const donaturPagination = document.getElementById('donatur-pagination');

            // 1. Filter dan Hitung Total Donasi
            const donasiTransactions = transactions.filter(t => t.type === 'IN' && t.donaturName);
            const totalDonasi = donasiTransactions.reduce((sum, t) => sum + t.amount, 0);
            donaturTotalElement.textContent = formatRupiah(totalDonasi);

            // 2. Terapkan Pagination
            const start = (page - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginatedDonasi = donasiTransactions.slice(start, end);
            const totalPages = Math.ceil(donasiTransactions.length / itemsPerPage);

            // 3. Render Tabel
            donaturBody.innerHTML = '';
            if (paginatedDonasi.length === 0) {
                donaturBody.innerHTML = '<tr><td colspan="6" class="py-2 text-center text-gray-500">Belum ada data Donatur.</td></tr>';
            } else {
                paginatedDonasi.forEach((t, index) => {
                    const row = donaturBody.insertRow();
                    row.innerHTML = `
                        <td class="py-2 px-4 border-b">${start + index + 1}</td>
                        <td class="py-2 px-4 border-b">${t.date}</td>
                        <td class="py-2 px-4 border-b">${t.donaturName}</td>
                        <td class="py-2 px-4 border-b">${t.description}</td>
                        <td class="py-2 px-4 border-b text-right">${formatRupiah(t.amount)}</td>
                        <td class="py-2 px-4 border-b admin-only ${isAdminLoggedIn ? '' : 'hidden'}">
                            <button onclick="editTransaction('${t.id}', '${t.type}')" class="text-blue-600 hover:text-blue-800 text-xs mr-2">Edit</button>
                            <button onclick="deleteTransaction('${t.id}')" class="text-red-600 hover:text-red-800 text-xs">Hapus</button>
                        </td>
                    `;
                });
            }

            // 4. Render Pagination
            donaturPagination.innerHTML = '';
            for (let i = 1; i <= totalPages; i++) {
                donaturPagination.innerHTML += `
                    <button onclick="goToPage('donatur-table', ${i})" class="mx-1 px-3 py-1 border rounded ${i === page ? 'bg-blue-600 text-white' : 'bg-white text-blue-600 hover:bg-gray-100'} text-sm">${i}</button>
                `;
            }

            // 5. Update Kolom Admin
            updateAdminView();
            return totalDonasi;
        };

        const renderJurnalTable = (totalDonasi, page) => {
            // ... (Isi fungsi renderJurnalTable lama) ...
            const jurnalBody = document.getElementById('jurnal-table-body');
            const jurnalTotalMasukElement = document.getElementById('jurnal-total-masuk');
            const jurnalTotalKeluarElement = document.getElementById('jurnal-total-keluar');
            const jurnalSaldoAkhirElement = document.getElementById('jurnal-saldo-akhir');
            const jurnalPagination = document.getElementById('jurnal-pagination');

            // 1. Gabungkan dan Filter Jurnal (Hanya Transaksi Jurnal, Donatur sudah dihitung di totalDonasi)
            const jurnalTransactions = allTransactions.filter(t => !t.donaturName);
            
            // Total Pemasukan Jurnal (selain donasi)
            const totalMasukJurnal = jurnalTransactions.filter(t => t.type === 'IN').reduce((sum, t) => sum + t.amount, 0);
            const totalKeluar = jurnalTransactions.filter(t => t.type === 'OUT').reduce((sum, t) => sum + t.amount, 0);

            // Total Pemasukan Global = Total Donasi + Total Masuk Jurnal
            const totalMasukGlobal = totalDonasi + totalMasukJurnal;
            const saldoAkhir = totalMasukGlobal - totalKeluar;

            // Update Ringkasan Keuangan
            jurnalTotalMasukElement.textContent = formatRupiah(totalMasukGlobal);
            jurnalTotalKeluarElement.textContent = formatRupiah(totalKeluar);
            jurnalSaldoAkhirElement.textContent = formatRupiah(saldoAkhir);
            jurnalSaldoAkhirElement.classList.toggle('text-red-600', saldoAkhir < 0);
            jurnalSaldoAkhirElement.classList.toggle('text-green-600', saldoAkhir >= 0);

            // 2. Terapkan Pagination
            const start = (page - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginatedJurnal = jurnalTransactions.slice(start, end);
            const totalPages = Math.ceil(jurnalTransactions.length / itemsPerPage);

            // 3. Render Tabel
            jurnalBody.innerHTML = '';
            if (paginatedJurnal.length === 0) {
                jurnalBody.innerHTML = '<tr><td colspan="7" class="py-2 text-center text-gray-500">Belum ada data Jurnal (Pemasukan/Pengeluaran).</td></tr>';
            } else {
                paginatedJurnal.forEach((t, index) => {
                    const row = jurnalBody.insertRow();
                    const amountClass = t.type === 'IN' ? 'text-green-600' : 'text-red-600';
                    row.innerHTML = `
                        <td class="py-2 px-4 border-b">${start + index + 1}</td>
                        <td class="py-2 px-4 border-b">${t.date}</td>
                        <td class="py-2 px-4 border-b">${t.description}</td>
                        <td class="py-2 px-4 border-b">${t.type}</td>
                        <td class="py-2 px-4 border-b text-right ${amountClass}">${formatRupiah(t.amount)}</td>
                        <td class="py-2 px-4 border-b admin-only ${isAdminLoggedIn ? '' : 'hidden'}">
                            <button onclick="editTransaction('${t.id}', '${t.type}')" class="text-blue-600 hover:text-blue-800 text-xs mr-2">Edit</button>
                            <button onclick="deleteTransaction('${t.id}')" class="text-red-600 hover:text-red-800 text-xs">Hapus</button>
                        </td>
                    `;
                });
            }

            // 4. Render Pagination
            jurnalPagination.innerHTML = '';
            for (let i = 1; i <= totalPages; i++) {
                jurnalPagination.innerHTML += `
                    <button onclick="goToPage('jurnal-table', ${i})" class="mx-1 px-3 py-1 border rounded ${i === page ? 'bg-blue-600 text-white' : 'bg-white text-blue-600 hover:bg-gray-100'} text-sm">${i}</button>
                `;
            }

            // 5. Update Kolom Admin
            updateAdminView();
        };

        const renderAllTables = () => {
            // Urutkan semua transaksi berdasarkan timestamp (paling baru di bawah)
            allTransactions.sort((a, b) => a.timestamp - b.timestamp);
            const totalDonasi = renderDonaturTable(allTransactions, currentDonaturPage);
            renderJurnalTable(totalDonasi, currentJurnalPage);
        };
        
        // ... (Fungsi exportPDFGlobal dan exportPDFRingkasan tetap di sini) ...

        // Tambahkan kembali fungsi PDF Anda di sini:
        const addSignatures = (doc, y) => {
            doc.setFontSize(10);
            doc.text("Pati, " + new Date().toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}), 145, y + 10);
            
            doc.text("Mengetahui,", 30, y + 20);
            doc.text("Dibuat Oleh,", 150, y + 20);

            doc.text("(.....................................)", 30, y + 45);
            doc.text("(.....................................)", 150, y + 45);
            
            doc.setFontSize(10);
            doc.text("Ketua Haul", 35, y + 50);
            doc.text("Sekretaris Haul", 150, y + 50);
        };

        // Mengganti fungsi exportPDFGlobal agar tidak menggunakan `saveTransactions()` yang sudah dihapus
        window.exportPDFGlobal = () => {
            if (allTransactions.length === 0) {
                alert("Tidak ada data untuk diekspor.");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(16);
            doc.text("Laporan Pembukuan Keuangan Haul (Global)", 105, 15, null, null, "center");
            
            doc.setFontSize(12);
            doc.text("Data Donatur", 14, 25);
            
            // 1. Tabel Donatur
            const donasiData = allTransactions.filter(t => t.type === 'IN' && t.donaturName).map((t, index) => [
                index + 1,
                t.date,
                t.donaturName,
                t.description,
                formatRupiah(t.amount)
            ]);
            const donasiHeaders = [['No', 'Tanggal', 'Nama Donatur', 'Keterangan', 'Jumlah (Rp)']];
            const totalDonasi = donasiData.reduce((sum, row) => sum + parseInt(row[4].replace(/[^0-9]/g, '')), 0);
            
            if (donasiData.length > 0) {
                donasiData.push(['', '', '', { content: 'TOTAL DONASI', styles: { fontStyle: 'bold' } }, { content: formatRupiah(totalDonasi), styles: { fontStyle: 'bold' } }]);
            }

            doc.autoTable({
                startY: 30,
                head: donasiHeaders,
                body: donasiData,
                theme: 'striped',
                headStyles: { fillColor: [52, 58, 64] },
                didDrawPage: function (data) {
                    // Footer (halaman)
                    doc.setFontSize(10);
                    doc.text("Halaman " + doc.internal.getNumberOfPages(), data.settings.margin.left, doc.internal.pageSize.height - 10);
                },
                columnStyles: {
                    4: { halign: 'right' },
                }
            });

            // 2. Tabel Jurnal
            const jurnalData = allTransactions.filter(t => !t.donaturName).map((t, index) => [
                index + 1,
                t.date,
                t.description,
                t.type,
                formatRupiah(t.amount)
            ]);
            const jurnalHeaders = [['No', 'Tanggal', 'Keterangan', 'Jenis', 'Jumlah (Rp)']];
            const totalMasukJurnal = jurnalData.filter(row => row[3] === 'IN').reduce((sum, row) => sum + parseInt(row[4].replace(/[^0-9]/g, '')), 0);
            const totalKeluarJurnal = jurnalData.filter(row => row[3] === 'OUT').reduce((sum, row) => sum + parseInt(row[4].replace(/[^0-9]/g, '')), 0);
            
            doc.setFontSize(12);
            doc.text("Data Jurnal (Pemasukan Non-Donasi & Pengeluaran)", 14, doc.lastAutoTable.finalY + 10);

            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 15,
                head: jurnalHeaders,
                body: jurnalData,
                theme: 'striped',
                headStyles: { fillColor: [52, 58, 64] },
                didDrawPage: function (data) {
                    doc.setFontSize(10);
                    doc.text("Halaman " + doc.internal.getNumberOfPages(), data.settings.margin.left, doc.internal.pageSize.height - 10);
                },
                columnStyles: {
                    4: { halign: 'right' },
                }
            });

            // Ringkasan Keuangan
            const totalMasukGlobal = totalDonasi + totalMasukJurnal;
            const saldoAkhir = totalMasukGlobal - totalKeluarJurnal;

            doc.setFontSize(12);
            doc.text("Ringkasan Keuangan Akhir:", 14, doc.lastAutoTable.finalY + 10);
            
            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 15,
                body: [
                    ['Total Pemasukan (Donasi + Jurnal)', formatRupiah(totalMasukGlobal)],
                    ['Total Pengeluaran (Jurnal OUT)', formatRupiah(totalKeluarJurnal)],
                    [{ content: 'SALDO AKHIR', styles: { fontStyle: 'bold' } }, { content: formatRupiah(saldoAkhir), styles: { fontStyle: 'bold', textColor: saldoAkhir < 0 ? [220, 38, 38] : [16, 185, 129] } }]
                ],
                theme: 'plain',
                styles: { fontSize: 10 },
                columnStyles: {
                    1: { halign: 'right' },
                }
            });

            addSignatures(doc, doc.lastAutoTable.finalY + 10);
            doc.save("LPJ_Global_Lengkap.pdf");
        };

        window.exportPDFRingkasan = () => {
            if (allTransactions.length === 0) {
                alert("Tidak ada data untuk diekspor.");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(16);
            doc.text("Laporan Pembukuan Keuangan Haul (Ringkasan)", 105, 15, null, null, "center");
            
            const donasiTransactions = allTransactions.filter(t => t.type === 'IN' && t.donaturName);
            const jurnalTransactions = allTransactions.filter(t => !t.donaturName);
            
            const totalDonasi = donasiTransactions.reduce((sum, t) => sum + t.amount, 0);
            const totalMasukJurnal = jurnalTransactions.filter(t => t.type === 'IN').reduce((sum, t) => sum + t.amount, 0);
            const totalKeluarJurnal = jurnalTransactions.filter(t => t.type === 'OUT').reduce((sum, t) => sum + t.amount, 0);
            const totalMasukGlobal = totalDonasi + totalMasukJurnal;
            const saldoAkhir = totalMasukGlobal - totalKeluarJurnal;

            doc.setFontSize(12);
            doc.text("Periode: " + (allTransactions.length > 0 ? allTransactions[0].date + " s/d " + allTransactions[allTransactions.length - 1].date : '-'), 14, 25);
            
            const ringkasanData = [
                ['Total Penerimaan Donasi', formatRupiah(totalDonasi)],
                ['Total Penerimaan Jurnal (Non-Donasi)', formatRupiah(totalMasukJurnal)],
                [{ content: 'TOTAL PEMASUKAN GLOBAL', styles: { fontStyle: 'bold' } }, { content: formatRupiah(totalMasukGlobal), styles: { fontStyle: 'bold' } }],
                ['Total Pengeluaran (Jurnal OUT)', formatRupiah(totalKeluarJurnal)],
                [{ content: 'SALDO AKHIR', styles: { fontStyle: 'bold' } }, { content: formatRupiah(saldoAkhir), styles: { fontStyle: 'bold', textColor: saldoAkhir < 0 ? [220, 38, 38] : [16, 185, 129] } }]
            ];

            doc.autoTable({
                startY: 35,
                body: ringkasanData,
                theme: 'grid',
                styles: { fontSize: 10, cellPadding: [2, 0.5, 2, 4], minCellHeight: 8 },
                columnStyles: { 
                    1: { halign: 'right' },
                },
                columnWidth: ['wrap', 40]
            });
            
            addSignatures(doc, doc.lastAutoTable.finalY + 10);
            doc.save("LPJ_Global_Ringkasan.pdf");
        };

        // --------------------------------------------------------------------------------
        // 7. INISIALISASI (Mengganti window.onload lama)
        // --------------------------------------------------------------------------------

        window.onload = () => {
            // Panggil fungsi yang akan dicek oleh onAuthStateChanged
            // onAuthStateChanged akan otomatis memanggil updateAdminView dan loadAndRenderData setelah status login terdeteksi.
            // Tidak perlu memanggil loadAndRenderData() atau updateAdminView() di sini.
            console.log("Web Siap. Menunggu status autentikasi Firebase...");
        };
        
    </script>
</body>
</html>



