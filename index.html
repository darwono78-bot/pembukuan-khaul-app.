<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pembukuan Haul: Donatur, Jurnal & Ekspor</title>
    <!-- Tailwind CSS untuk styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF dan AutoTable untuk ekspor PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <!-- Font & Custom Styles -->
    <style>
        /* Gaya agar tabel bisa digeser jika terlalu lebar */
        .table-wrapper {
            overflow-x: auto; 
        }

        /* Ganti font global ke Cambria / Times New Roman / Serif */
        body {
            font-family: Cambria, 'Times New Roman', Times, serif; 
        }
        
        /* Ganti font size global untuk isi tabel agar tidak terlalu besar */
        table {
            font-size: 0.9rem; 
            width: 100%; 
        }

        /* Hapus tebal default dari sel tabel (di JS, kita tambahkan lagi hanya pada total akhir) */
        td {
            font-weight: normal;
        }

        /* Styling untuk tombol */
        .btn-primary {
            @apply px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-300;
        }
        .btn-danger {
            @apply px-4 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-300;
        }
        .input-text {
            @apply p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500;
        }
        .header-section {
             @apply bg-gray-50 p-4 rounded-xl shadow-inner mb-4 border border-gray-200;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-10">
            <h1 class="text-3xl font-bold text-gray-900 border-b-2 border-indigo-600 pb-2">Pembukuan Keuangan Haul</h1>
            <p class="text-gray-600 mt-2">Pencatatan Donatur, Pengeluaran (Jurnal), dan Ekspor Data Real-Time (Powered by Firebase)</p>
        </header>

        <!-- Bagian Autentikasi dan Status Pengguna -->
        <div id="auth-section" class="header-section flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0">
            <div id="user-status" class="text-sm text-gray-700">
                Memuat status pengguna...
            </div>
            <div id="auth-controls" class="space-x-2">
                <button id="logout-btn" class="btn-danger hidden">Logout</button>
                <div id="login-form-container" class="space-x-2 hidden">
                    <input type="email" id="email-input" class="input-text w-32" placeholder="Email Anda">
                    <input type="password" id="password-input" class="input-text w-32" placeholder="Password Anda">
                    <button id="login-btn" class="btn-primary">Login</button>
                    <p id="auth-error" class="text-red-500 text-xs mt-1"></p>
                </div>
            </div>
        </div>
        
        <!-- Bagian Input Data -->
        <div class="header-section grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Form Donasi/Pemasukan -->
            <div class="bg-white p-6 rounded-xl shadow">
                <h2 class="text-xl font-semibold mb-4 text-indigo-700">1. Catat Donasi (Pemasukan)</h2>
                <div class="space-y-3">
                    <input type="date" id="donatur-date" class="input-text w-full">
                    <input type="text" id="donatur-name" class="input-text w-full" placeholder="Nama Donatur (cth: Hamba Allah/Bpk. Budi)">
                    <input type="number" id="donatur-amount" class="input-text w-full" placeholder="Jumlah Donasi (cth: 500000)">
                    <button id="save-donasi-btn" class="btn-primary w-full disabled:opacity-50" disabled>Simpan Donasi</button>
                </div>
            </div>

            <!-- Form Jurnal/Pengeluaran -->
            <div class="bg-white p-6 rounded-xl shadow">
                <h2 class="text-xl font-semibold mb-4 text-indigo-700">2. Catat Jurnal (Pengeluaran)</h2>
                <div class="space-y-3">
                    <input type="date" id="jurnal-date" class="input-text w-full">
                    <input type="text" id="jurnal-desc" class="input-text w-full" placeholder="Uraian Pengeluaran (cth: Pembelian bahan baku)">
                    <input type="number" id="jurnal-amount" class="input-text w-full" placeholder="Jumlah Pengeluaran (cth: 250000)">
                    <button id="save-jurnal-btn" class="btn-primary w-full disabled:opacity-50" disabled>Simpan Jurnal</button>
                </div>
            </div>
        </div>

        <!-- Bagian Laporan dan Ekspor -->
        <div class="header-section">
            <h2 class="text-xl font-semibold mb-4 text-indigo-700">3. Laporan dan Ekspor Data</h2>
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                <button id="export-ringkasan-btn" class="btn-primary flex-1 disabled:opacity-50" disabled>Ekspor Laporan Ringkasan (PDF)</button>
                <button id="export-jurnal-btn" class="btn-primary flex-1 disabled:opacity-50" disabled>Ekspor Laporan Jurnal Detail (PDF)</button>
            </div>
        </div>

        <!-- Bagian Tampilan Donatur -->
        <section class="mt-8 bg-white p-6 rounded-xl shadow">
            <h2 class="text-xl font-semibold mb-4 text-indigo-700">Daftar Donatur (Pemasukan)</h2>
            <div class="table-wrapper">
                <table id="donatur-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-indigo-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tgl.</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Donatur</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Jumlah (Rp)</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="donatur-body" class="bg-white divide-y divide-gray-200">
                        <!-- Data akan dimasukkan di sini oleh JS -->
                    </tbody>
                </table>
            </div>
            <div id="donatur-pagination" class="flex justify-between items-center mt-4">
                <button id="donatur-prev" class="px-3 py-1 border rounded-lg text-sm disabled:opacity-50">Sebelumnya</button>
                <span id="donatur-info" class="text-sm text-gray-600">Halaman 1</span>
                <button id="donatur-next" class="px-3 py-1 border rounded-lg text-sm disabled:opacity-50">Berikutnya</button>
            </div>
        </section>

        <!-- Bagian Tampilan Jurnal -->
        <section class="mt-8 bg-white p-6 rounded-xl shadow">
            <h2 class="text-xl font-semibold mb-4 text-indigo-700">Daftar Jurnal (Pengeluaran)</h2>
            <div class="table-wrapper">
                <table id="jurnal-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-indigo-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tgl.</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Uraian</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Jumlah (Rp)</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="jurnal-body" class="bg-white divide-y divide-gray-200">
                        <!-- Data akan dimasukkan di sini oleh JS -->
                    </tbody>
                </table>
            </div>
            <div id="jurnal-pagination" class="flex justify-between items-center mt-4">
                <button id="jurnal-prev" class="px-3 py-1 border rounded-lg text-sm disabled:opacity-50">Sebelumnya</button>
                <span id="jurnal-info" class="text-sm text-gray-600">Halaman 1</span>
                <button id="jurnal-next" class="px-3 py-1 border rounded-lg text-sm disabled:opacity-50">Berikutnya</button>
            </div>
        </section>

        <!-- Pesan Modal Kustom -->
        <div id="custom-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6">
                <h3 id="modal-title" class="text-xl font-bold mb-4 text-gray-800">Judul Pesan</h3>
                <p id="modal-message" class="text-gray-700 mb-6">Isi pesan di sini.</p>
                <div class="flex justify-end space-x-3">
                    <button id="modal-cancel-btn" class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 hidden">Batal</button>
                    <button id="modal-confirm-btn" class="btn-primary">OK</button>
                </div>
            </div>
        </div>

    </div>

    <!-- SCRIPT FIREBASE DAN LOGIKA APLIKASI -->
    <script type="module">
        // Import modul Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            query, 
            orderBy, 
            onSnapshot, 
            addDoc, 
            doc, 
            deleteDoc, 
            getDocs,
            Timestamp,
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Variables for Firebase & Auth
        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // Mendapatkan konfigurasi Firebase dari variabel global
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { /* Your default config here if needed for pure local testing */ };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Atur log level debug untuk melihat detail di console
        setLogLevel('debug');


        // --------------------------------------------------------------------------------
        // 1. FIREBASE INITIALIZATION & AUTHENTICATION
        // --------------------------------------------------------------------------------

        const initFirebase = async () => {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Listener untuk perubahan status otentikasi
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Pengguna terautentikasi. UID:", userId);
                        document.getElementById('user-status').textContent = `Status: Terautentikasi (UID: ${userId.substring(0, 8)}...)`;
                        document.getElementById('logout-btn').classList.remove('hidden');
                        document.getElementById('login-form-container').classList.add('hidden');
                        
                        // Aktifkan tombol input dan ekspor setelah autentikasi
                        enableInputsAndExports(true);

                        // Muat data hanya setelah autentikasi siap
                        if (!isAuthReady) {
                            isAuthReady = true;
                            loadTransactions();
                            // Panggil ini untuk menyesuaikan tampilan saat load pertama
                            updateAdminView(); 
                        }
                    } else {
                        userId = null;
                        console.log("Pengguna tidak terautentikasi. Mencoba login anonim/kustom.");
                        document.getElementById('user-status').textContent = 'Status: Belum Login';
                        document.getElementById('logout-btn').classList.add('hidden');
                        document.getElementById('login-form-container').classList.remove('hidden');
                        
                        // Nonaktifkan tombol input dan ekspor
                        enableInputsAndExports(false);
                        
                        // Jika belum siap, set isAuthReady setelah mencoba login kustom/anonim
                        if (!isAuthReady) {
                            try {
                                if (initialAuthToken) {
                                    await signInWithCustomToken(auth, initialAuthToken);
                                    console.log("Login dengan token kustom berhasil.");
                                } else {
                                    await signInAnonymously(auth);
                                    console.log("Login anonim berhasil.");
                                }
                            } catch (error) {
                                console.error("Gagal login kustom/anonim:", error.message);
                                isAuthReady = true; // Tetap set ke true agar proses bisa berlanjut
                                // Tampilkan pesan error pada form login jika ada
                                document.getElementById('auth-error').textContent = `Error auth: ${error.code}`;
                            }
                        }
                    }
                });

            } catch (error) {
                console.error("Kesalahan saat inisialisasi Firebase:", error);
                document.getElementById('user-status').textContent = `Error Init: ${error.message}`;
            }
        };

        const handleLogin = async () => {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            const errorElement = document.getElementById('auth-error');
            errorElement.textContent = '';

            if (!email || !password) {
                errorElement.textContent = "Email dan Password harus diisi.";
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
                console.log("Login Email/Password berhasil!");
            } catch (error) {
                console.error("Gagal Login:", error);
                errorElement.textContent = `Login Gagal: ${error.message}`;
            }
        };

        const handleLogout = async () => {
            try {
                await signOut(auth);
                console.log("Logout berhasil.");
                // Setelah logout, onAuthStateChanged akan memicu sign-in anonim/kustom lagi
            } catch (error) {
                console.error("Gagal Logout:", error);
            }
        };

        const enableInputsAndExports = (isEnabled) => {
            document.getElementById('save-donasi-btn').disabled = !isEnabled;
            document.getElementById('save-jurnal-btn').disabled = !isEnabled;
            document.getElementById('export-ringkasan-btn').disabled = !isEnabled;
            document.getElementById('export-jurnal-btn').disabled = !isEnabled;
        };


        // --------------------------------------------------------------------------------
        // 2. FIRESTORE OPERATIONS (CRUD)
        // --------------------------------------------------------------------------------
        const COLLECTION_NAME = "transactions";

        // Fungsi untuk mendapatkan path koleksi transaksi pengguna
        const getCollectionPath = () => {
            // Menggunakan path /artifacts/{appId}/public/data/{COLLECTION_NAME}
            // agar data bisa diakses (dibaca/ditulis) oleh semua pengguna yang terautentikasi di aplikasi ini.
            return `/artifacts/${appId}/public/data/${COLLECTION_NAME}`;
        };

        /**
         * Mengambil data transaksi dari Firestore secara real-time.
         */
        const loadTransactions = () => {
            if (!isAuthReady || !userId) {
                console.log("Menunggu otentikasi selesai sebelum memuat data Firestore.");
                return;
            }
            
            const transactionsRef = collection(db, getCollectionPath());
            const q = query(transactionsRef, orderBy("timestamp", "desc")); // Urutkan berdasarkan waktu terbaru

            // onSnapshot akan mendengarkan perubahan secara real-time
            onSnapshot(q, (snapshot) => {
                const fetchedTransactions = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // Konversi Firebase Timestamp menjadi JavaScript Date/number
                    const timestampMs = data.timestamp instanceof Timestamp ? data.timestamp.toMillis() : data.timestamp;
                    
                    fetchedTransactions.push({
                        id: doc.id,
                        ...data,
                        timestamp: timestampMs,
                        date: data.date, // Tetap gunakan string tanggal untuk tampilan
                    });
                });
                
                console.log(`Data transaksi berhasil dimuat: ${fetchedTransactions.length} entri.`);
                allTransactions = fetchedTransactions; // Perbarui data global
                renderAllTables(); // Render ulang tabel
            }, (error) => {
                console.error("Kesalahan saat mengambil data dari Firestore:", error);
                showCustomModal("Error", "Gagal memuat data dari database. Silakan periksa koneksi atau hak akses.", "OK");
            });
        };

        /**
         * Menyimpan transaksi baru ke Firestore.
         * @param {Object} transactionData - Data transaksi (type, date, description/name, amount).
         */
        const saveTransaction = async (transactionData) => {
            if (!userId) {
                showCustomModal("Akses Ditolak", "Anda harus login untuk menyimpan data.", "OK");
                return;
            }
            try {
                // Tambahkan timestamp saat ini untuk pengurutan
                const dataToSave = {
                    ...transactionData,
                    timestamp: Timestamp.now(), 
                    userId: userId // Opsional: Tandai siapa yang membuat
                };
                
                const docRef = await addDoc(collection(db, getCollectionPath()), dataToSave);
                console.log("Dokumen berhasil ditulis dengan ID: ", docRef.id);
            } catch (e) {
                console.error("Error saat menambahkan dokumen: ", e);
                showCustomModal("Error", "Gagal menyimpan transaksi ke database.", "OK");
            }
        };

        /**
         * Menghapus transaksi dari Firestore.
         * @param {string} id - ID dokumen transaksi.
         */
        const deleteTransaction = async (id) => {
            if (!userId) {
                showCustomModal("Akses Ditolak", "Anda harus login untuk menghapus data.", "OK");
                return;
            }
            try {
                await deleteDoc(doc(db, getCollectionPath(), id));
                console.log("Dokumen berhasil dihapus:", id);
                // onSnapshot akan otomatis merender ulang tabel
            } catch (e) {
                console.error("Error saat menghapus dokumen: ", e);
                showCustomModal("Error", "Gagal menghapus transaksi dari database.", "OK");
            }
        };


        // --------------------------------------------------------------------------------
        // 3. LOGIC & DATA HANDLING (Dipertahankan dari file lama, diubah untuk Firestore)
        // --------------------------------------------------------------------------------
        window.jsPDF = window.jspdf.jsPDF;
        const TRANSACTIONS_PER_PAGE = 10;
        let allTransactions = [];
        let currentDonaturPage = 1;
        let currentJurnalPage = 1;

        // Helper: Format Rupiah
        const formatRupiah = (number) => {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(number);
        };

        // Helper: Tampilkan Modal
        const showCustomModal = (title, message, confirmText = "OK", onConfirm = null, onCancel = null) => {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal-confirm-btn').textContent = confirmText;
            
            const modal = document.getElementById('custom-modal');
            const confirmBtn = document.getElementById('modal-confirm-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            // Reset event listeners
            confirmBtn.onclick = null;
            cancelBtn.onclick = null;
            cancelBtn.classList.add('hidden'); // Sembunyikan batal secara default

            if (onConfirm) {
                // Ini adalah dialog konfirmasi
                cancelBtn.classList.remove('hidden');
                confirmBtn.onclick = () => {
                    modal.classList.add('hidden');
                    onConfirm();
                };
                cancelBtn.onclick = () => {
                    modal.classList.add('hidden');
                    if (onCancel) onCancel();
                };
            } else {
                // Ini adalah dialog info/alert
                confirmBtn.onclick = () => modal.classList.add('hidden');
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        // Paginasi Donatur
        const updateDonaturPagination = (totalPages) => {
            document.getElementById('donatur-prev').disabled = currentDonaturPage === 1;
            document.getElementById('donatur-next').disabled = currentDonaturPage === totalPages || totalPages === 0;
            document.getElementById('donatur-info').textContent = `Halaman ${currentDonaturPage} dari ${totalPages === 0 ? 1 : totalPages}`;
        };

        // Paginasi Jurnal
        const updateJurnalPagination = (totalPages) => {
            document.getElementById('jurnal-prev').disabled = currentJurnalPage === 1;
            document.getElementById('jurnal-next').disabled = currentJurnalPage === totalPages || totalPages === 0;
            document.getElementById('jurnal-info').textContent = `Halaman ${currentJurnalPage} dari ${totalPages === 0 ? 1 : totalPages}`;
        };

        // Render Donatur Table
        const renderDonaturTable = (transactions, page) => {
            const donaturData = transactions.filter(t => t.type === 'donasi');
            const totalDonasi = donaturData.reduce((sum, t) => sum + t.amount, 0);
            const totalPages = Math.ceil(donaturData.length / TRANSACTIONS_PER_PAGE);

            currentDonaturPage = Math.max(1, Math.min(page, totalPages || 1));
            updateDonaturPagination(totalPages);

            const start = (currentDonaturPage - 1) * TRANSACTIONS_PER_PAGE;
            const end = start + TRANSACTIONS_PER_PAGE;
            const pageData = donaturData.slice(start, end);

            const tbody = document.getElementById('donatur-body');
            tbody.innerHTML = '';

            pageData.forEach(t => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="px-6 py-2 whitespace-nowrap">${t.date}</td>
                    <td class="px-6 py-2 whitespace-nowrap">${t.name}</td>
                    <td class="px-6 py-2 whitespace-nowrap text-right">${formatRupiah(t.amount)}</td>
                    <td class="px-6 py-2 whitespace-nowrap text-center">
                        <button data-id="${t.id}" class="delete-btn text-red-600 hover:text-red-900 text-sm disabled:opacity-50" ${userId ? '' : 'disabled'}>Hapus</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Baris Total
            if (donaturData.length > 0) {
                const trTotal = document.createElement('tr');
                trTotal.className = 'bg-indigo-100 font-bold';
                trTotal.innerHTML = `
                    <td colspan="2" class="px-6 py-2 whitespace-nowrap text-right">TOTAL DONASI</td>
                    <td class="px-6 py-2 whitespace-nowrap text-right">${formatRupiah(totalDonasi)}</td>
                    <td class="px-6 py-2 whitespace-nowrap"></td>
                `;
                tbody.appendChild(trTotal);
            } else if (isAuthReady) {
                 const trNoData = document.createElement('tr');
                 trNoData.innerHTML = `<td colspan="4" class="px-6 py-4 text-center text-gray-500">Belum ada data Donasi.</td>`;
                 tbody.appendChild(trNoData);
            }


            return totalDonasi;
        };

        // Render Jurnal Table
        const renderJurnalTable = (totalDonasi, page) => {
            const jurnalData = allTransactions.filter(t => t.type === 'jurnal');
            const totalPengeluaran = jurnalData.reduce((sum, t) => sum + t.amount, 0);
            const saldoAkhir = totalDonasi - totalPengeluaran;
            const totalPages = Math.ceil(jurnalData.length / TRANSACTIONS_PER_PAGE);

            currentJurnalPage = Math.max(1, Math.min(page, totalPages || 1));
            updateJurnalPagination(totalPages);

            const start = (currentJurnalPage - 1) * TRANSACTIONS_PER_PAGE;
            const end = start + TRANSACTIONS_PER_PAGE;
            const pageData = jurnalData.slice(start, end);

            const tbody = document.getElementById('jurnal-body');
            tbody.innerHTML = '';

            pageData.forEach(t => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="px-6 py-2 whitespace-nowrap">${t.date}</td>
                    <td class="px-6 py-2 whitespace-nowrap">${t.description}</td>
                    <td class="px-6 py-2 whitespace-nowrap text-right">${formatRupiah(t.amount)}</td>
                    <td class="px-6 py-2 whitespace-nowrap text-center">
                        <button data-id="${t.id}" class="delete-btn text-red-600 hover:text-red-900 text-sm disabled:opacity-50" ${userId ? '' : 'disabled'}>Hapus</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Baris Total
            if (allTransactions.length > 0) {
                // Baris Total Pengeluaran
                let trTotal = document.createElement('tr');
                trTotal.className = 'bg-red-100 font-bold';
                trTotal.innerHTML = `
                    <td colspan="2" class="px-6 py-2 whitespace-nowrap text-right">TOTAL PENGELUARAN</td>
                    <td class="px-6 py-2 whitespace-nowrap text-right">${formatRupiah(totalPengeluaran)}</td>
                    <td class="px-6 py-2 whitespace-nowrap"></td>
                `;
                tbody.appendChild(trTotal);

                // Baris Saldo Akhir
                let trSaldo = document.createElement('tr');
                const saldoClass = saldoAkhir >= 0 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                trSaldo.className = `${saldoClass} font-extrabold text-lg`;
                trSaldo.innerHTML = `
                    <td colspan="2" class="px-6 py-2 whitespace-nowrap text-right">SALDO AKHIR</td>
                    <td class="px-6 py-2 whitespace-nowrap text-right">${formatRupiah(saldoAkhir)}</td>
                    <td class="px-6 py-2 whitespace-nowrap"></td>
                `;
                tbody.appendChild(trSaldo);
            } else if (isAuthReady) {
                 const trNoData = document.createElement('tr');
                 trNoData.innerHTML = `<td colspan="4" class="px-6 py-4 text-center text-gray-500">Belum ada data Jurnal (Pengeluaran).</td>`;
                 tbody.appendChild(trNoData);
            }
        };


        // --------------------------------------------------------------------------------
        // 4. PDF EXPORT LOGIC (Dipertahankan)
        // --------------------------------------------------------------------------------
        
        // Fungsi untuk menambahkan tanda tangan ke PDF
        const addSignatures = (doc, yPos) => {
            doc.setFontSize(10);
            doc.text("Pati, " + new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }), 140, yPos);
            
            yPos += 5;
            doc.text("Dibuat Oleh,", 30, yPos);
            doc.text("Mengetahui,", 140, yPos);

            yPos += 20; // Ruang untuk tanda tangan
            doc.text("( Nama Petugas )", 30, yPos);
            doc.text("( Nama Penanggung Jawab )", 140, yPos);
        };

        // Ekspor Laporan Jurnal Detail (Laporan Pengeluaran)
        const exportJurnalDetail = () => {
             const jurnalData = allTransactions.filter(t => t.type === 'jurnal').sort((a, b) => a.timestamp - b.timestamp);
             const totalPengeluaran = jurnalData.reduce((sum, t) => sum + t.amount, 0);

             if (jurnalData.length === 0) {
                 showCustomModal("Informasi", "Tidak ada data jurnal untuk diekspor.", "OK");
                 return;
             }

             const doc = new jsPDF();

             // Header
             doc.setFontSize(14);
             doc.text("Laporan Jurnal Pengeluaran Haul", 105, 15, { align: "center" });
             doc.setFontSize(10);
             doc.text("Tanggal Cetak: " + new Date().toLocaleDateString('id-ID'), 10, 25);

             const tableData = jurnalData.map((t, index) => [
                 index + 1,
                 t.date,
                 t.description,
                 formatRupiah(t.amount)
             ]);

             // Tambahkan baris total
             tableData.push([
                 { content: "TOTAL PENGELUARAN", colSpan: 3, styles: { fontStyle: 'bold', halign: 'right', fillColor: [220, 220, 220] } },
                 { content: formatRupiah(totalPengeluaran), styles: { fontStyle: 'bold', halign: 'right', fillColor: [220, 220, 220] } }
             ]);


             doc.autoTable({
                 startY: 30,
                 head: [['No', 'Tanggal', 'Uraian Pengeluaran', 'Jumlah (Rp)']],
                 body: tableData,
                 theme: 'grid',
                 styles: { font: 'Times', fontSize: 9, cellPadding: 2 },
                 headStyles: { fillColor: [25, 118, 210], textColor: 255, fontStyle: 'bold', halign: 'center' },
                 columnStyles: {
                     0: { halign: 'center', cellWidth: 10 },
                     1: { halign: 'center', cellWidth: 25 },
                     3: { halign: 'right', cellWidth: 40 }
                 },
                 didParseCell: (data) => {
                     // Agar Total baris tidak memiliki border
                     if (data.row.raw.length > 0 && data.row.raw[0].content && data.row.raw[0].content.includes("TOTAL")) {
                         data.cell.styles.lineWidth = 0.1; 
                     }
                 }
             });

             addSignatures(doc, doc.lastAutoTable.finalY + 10);
             doc.save("LPJ_Jurnal_Detail.pdf");
        };


        // Ekspor Laporan Ringkasan (Donasi, Pengeluaran, Saldo)
        const exportRingkasan = () => {
            const donaturData = allTransactions.filter(t => t.type === 'donasi');
            const jurnalData = allTransactions.filter(t => t.type === 'jurnal');

            const totalDonasi = donaturData.reduce((sum, t) => sum + t.amount, 0);
            const totalPengeluaran = jurnalData.reduce((sum, t) => sum + t.amount, 0);
            const saldoAkhir = totalDonasi - totalPengeluaran;

            if (allTransactions.length === 0) {
                 showCustomModal("Informasi", "Tidak ada data transaksi untuk diekspor.", "OK");
                 return;
            }

            const doc = new jsPDF();
            
            // Header
            doc.setFontSize(14);
            doc.text("Laporan Ringkasan Keuangan Haul", 105, 15, { align: "center" });
            doc.setFontSize(10);
            doc.text("Tanggal Cetak: " + new Date().toLocaleDateString('id-ID'), 10, 25);
            
            // Data Ringkasan
            const summaryData = [
                ['Total Donasi (Pemasukan)', formatRupiah(totalDonasi)],
                ['Total Pengeluaran (Jurnal)', formatRupiah(totalPengeluaran)],
                [
                    { content: "SALDO AKHIR", styles: { fontStyle: 'bold', fillColor: [200, 230, 200] } },
                    { content: formatRupiah(saldoAkhir), styles: { fontStyle: 'bold', halign: 'right', fillColor: [200, 230, 200] } }
                ]
            ];

            doc.autoTable({
                startY: 30,
                head: [['Uraian', 'Jumlah']],
                body: summaryData,
                theme: 'grid',
                styles: { font: 'Times', fontSize: 10, cellPadding: 2 },
                headStyles: { fillColor: [79, 70, 229], textColor: 255, fontStyle: 'bold' },
                columnStyles: {
                    1: { halign: 'right' }
                }
            });

            // Teks Daftar Donatur
            doc.setFontSize(12);
            doc.text("Detail Daftar Donatur:", 10, doc.lastAutoTable.finalY + 10);

            // Data Donatur
            const donaturTableData = donaturData.sort((a, b) => a.timestamp - b.timestamp).map((t, index) => [
                index + 1,
                t.date,
                t.name,
                formatRupiah(t.amount)
            ]);

            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 15,
                head: [['No', 'Tanggal', 'Nama Donatur', 'Jumlah (Rp)']],
                body: donaturTableData,
                theme: 'striped',
                styles: { font: 'Times', fontSize: 8, cellPadding: [2, 0.5, 2, 4], halign: 'left' },
                headStyles: { fillColor: [191, 219, 254], textColor: 0, fontStyle: 'bold', halign: 'center' },
                // Penyesuaian agar angka Rupiah menempel nol ke batas kanan
                tableWidth: 'wrap',
                cellPadding: [2, 0.5, 2, 4], 
                cellStyles: { 
                    3: { halign: 'right' } 
                },
                columnStyles: {
                    0: { columnWidth: 10, halign: 'center' },
                    1: { columnWidth: 20, halign: 'center' }, 
                    2: { columnWidth: 'wrap' },
                    3: { 
                        halign: 'right', 
                        columnWidth: 40,
                        cellPadding: [2, 0.5, 2, 4] 
                    } 
                }
            });
            
            addSignatures(doc, doc.lastAutoTable.finalY + 10);
            doc.save("LPJ_Global_Ringkasan.pdf");
        };


        // --------------------------------------------------------------------------------
        // 5. RENDER ALL & EVENT LISTENERS
        // --------------------------------------------------------------------------------

        const renderAllTables = () => {
            // Urutkan data berdasarkan waktu, terbaru di atas (sesuai query Firestore, tapi diurutkan di client untuk kepastian)
            allTransactions.sort((a, b) => b.timestamp - a.timestamp); 
            const totalDonasi = renderDonaturTable(allTransactions, currentDonaturPage);
            renderJurnalTable(totalDonasi, currentJurnalPage);
        };

        const updateAdminView = () => {
             // Secara default, tombol delete akan di-disable jika userId null
             const deleteButtons = document.querySelectorAll('.delete-btn');
             deleteButtons.forEach(btn => {
                 btn.disabled = !userId;
             });
        };

        // Event listener untuk tombol Simpan Donasi
        document.getElementById('save-donasi-btn').addEventListener('click', () => {
            const date = document.getElementById('donatur-date').value;
            const name = document.getElementById('donatur-name').value;
            const amount = parseInt(document.getElementById('donatur-amount').value);

            if (!date || !name || isNaN(amount) || amount <= 0) {
                showCustomModal("Input Salah", "Semua kolom Donasi harus diisi dengan benar.", "OK");
                return;
            }

            saveTransaction({
                type: 'donasi',
                date: date,
                name: name,
                amount: amount
            });

            // Bersihkan form
            document.getElementById('donatur-name').value = '';
            document.getElementById('donatur-amount').value = '';
        });

        // Event listener untuk tombol Simpan Jurnal
        document.getElementById('save-jurnal-btn').addEventListener('click', () => {
            const date = document.getElementById('jurnal-date').value;
            const description = document.getElementById('jurnal-desc').value;
            const amount = parseInt(document.getElementById('jurnal-amount').value);

            if (!date || !description || isNaN(amount) || amount <= 0) {
                showCustomModal("Input Salah", "Semua kolom Jurnal harus diisi dengan benar.", "OK");
                return;
            }

            saveTransaction({
                type: 'jurnal',
                date: date,
                description: description,
                amount: amount
            });
            
            // Bersihkan form
            document.getElementById('jurnal-desc').value = '';
            document.getElementById('jurnal-amount').value = '';
        });

        // Delegasi Event untuk tombol Hapus (Donatur & Jurnal)
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-btn')) {
                const docId = e.target.dataset.id;
                showCustomModal(
                    "Konfirmasi Hapus", 
                    "Apakah Anda yakin ingin menghapus data ini secara permanen?", 
                    "Ya, Hapus", 
                    () => deleteTransaction(docId)
                );
            }
        });

        // Event listener untuk ekspor
        document.getElementById('export-ringkasan-btn').addEventListener('click', exportRingkasan);
        document.getElementById('export-jurnal-btn').addEventListener('click', exportJurnalDetail);

        // Event listener untuk Paginasi Donatur
        document.getElementById('donatur-prev').addEventListener('click', () => { currentDonaturPage--; renderAllTables(); });
        document.getElementById('donatur-next').addEventListener('click', () => { currentDonaturPage++; renderAllTables(); });

        // Event listener untuk Paginasi Jurnal
        document.getElementById('jurnal-prev').addEventListener('click', () => { currentJurnalPage--; renderAllTables(); });
        document.getElementById('jurnal-next').addEventListener('click', () => { currentJurnalPage++; renderAllTables(); });

        // Event listener Auth
        document.getElementById('login-btn').addEventListener('click', handleLogin);
        document.getElementById('logout-btn').addEventListener('click', handleLogout);

        // Inisialisasi Firebase saat window dimuat
        window.onload = () => {
            // Set tanggal hari ini secara default pada input tanggal
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('donatur-date').value = today;
            document.getElementById('jurnal-date').value = today;

            initFirebase();
            // loadTransactions akan dipanggil di dalam onAuthStateChanged setelah autentikasi siap
        };

    </script>
</body>
</html>
