<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pembukuan Khaul - Kas Umum (Donatur & Pengeluaran)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .container-app {
            max-width: 1200px;
        }
        .input-field {
            @apply w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-150;
        }
        .header-title {
            @apply text-3xl font-bold text-center text-white mb-6 p-4 rounded-lg shadow-inner;
        }
        .section-title {
            @apply text-xl font-semibold text-gray-700 border-b pb-2 mb-4 mt-8;
        }
        .btn-action {
            @apply font-bold py-3 px-6 rounded-lg transition duration-150 shadow-md hover:shadow-lg w-full;
        }
        .grid-form {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        .grid-form button {
            grid-column: span 2;
        }
        @media (max-width: 640px) {
             .grid-form {
                grid-template-columns: 1fr;
            }
            .grid-form button {
                grid-column: span 1;
            }
        }
    </style>

    <script type="module">
        
        // --- VARIABEL GLOBAL & UTILITY ---
        const STORAGE_KEY_JURNAL = 'khaul_jurnal_umum_transaksi'; 
        let allTransactions = []; 
        
        // Konstanta Persentase Donatur
        const PERAWATAN_MAKAM = 0.15; // 15%
        const ONGKOS_PANITIA = 0.15; // 15%
        const BIAYA_KHAUL = 0.70; // 70%
        
        // Kategori LPJ (Digunakan untuk Pengeluaran)
        const KATEGORI_PENGELUARAN = [
            "Ongkos Kiai", "Bayar Kataman", "Bayar Konsumsi", "Bayar Persewaan", "Bayar Pekerja", "Lain-lain"
        ];

        const formatRupiah = (angka) => {
            if (angka === undefined || angka === null) return 'Rp 0';
            const num = Math.round(angka); 
            // Pastikan format Indonesia (Rp 1.000.000)
            return 'Rp ' + num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        };

        // --- DATA HANDLING (localStorage) ---

        const loadTransactions = () => {
            try {
                const data = localStorage.getItem(STORAGE_KEY_JURNAL);
                allTransactions = data ? JSON.parse(data) : [];
                
                // Pastikan nilai uang adalah Number
                allTransactions = allTransactions.map(t => ({
                    ...t,
                    nilai: Number(t.nilai) || 0,
                    timestamp: Number(t.timestamp) || 0
                }));

            } catch (error) {
                console.error("Gagal memuat data dari localStorage:", error);
                allTransactions = [];
            }
            renderTables(allTransactions);
        };

        const saveTransactions = () => {
            localStorage.setItem(STORAGE_KEY_JURNAL, JSON.stringify(allTransactions));
        };
        
        // --- INPUT & FORM FUNCTIONS ---

        const handleCatatDonasi = () => {
            const tanggal = document.getElementById('tanggal-donasi-input').value;
            const namaDonatur = document.getElementById('nama-donatur-input').value;
            const alamat = document.getElementById('alamat-input').value;
            const jumlahJariyah = Number(document.getElementById('jumlah-jariyah-input').value);

            if (!tanggal || !namaDonatur || !alamat || jumlahJariyah <= 0) {
                alert("Semua kolom Donatur wajib diisi dan jumlah harus lebih dari nol.");
                return;
            }
            
            const newTransaction = {
                id: Date.now(),
                type: 'masuk', // Tipe Transaksi
                tanggal: tanggal,
                timestamp: new Date(tanggal).getTime(),
                nama: namaDonatur,
                alamat: alamat,
                uraian: `Donasi Jariyah dari ${namaDonatur}`,
                kategori: 'Donatur', // Kategori LPJ Dana Masuk
                nilai: jumlahJariyah, 
            };

            allTransactions.push(newTransaction);
            saveTransactions();
            renderTables(allTransactions);
            alert(`Donasi dari ${namaDonatur} sejumlah ${formatRupiah(jumlahJariyah)} berhasil dicatat!`);

            document.getElementById('form-catat-donasi').reset();
        };

        const handleCatatPengeluaran = () => {
            const tanggal = document.getElementById('tanggal-keluar-input').value;
            const uraian = document.getElementById('uraian-input').value;
            const kategori = document.getElementById('kategori-input').value;
            const jumlahKeluar = Number(document.getElementById('jumlah-keluar-input').value);

            // Perhatian: Ini adalah bagian validasi yang sering membuat error!
            if (!tanggal || !uraian || !kategori || jumlahKeluar <= 0) {
                alert("Semua kolom Pengeluaran wajib diisi. Pastikan Anda memilih Kategori LPJ dan jumlahnya lebih dari nol.");
                return;
            }

            const newTransaction = {
                id: Date.now() + 1, // Pastikan ID berbeda dari donasi
                type: 'keluar', // Tipe Transaksi
                tanggal: tanggal,
                timestamp: new Date(tanggal).getTime(),
                nama: '-',
                alamat: '-',
                uraian: uraian,
                kategori: kategori, 
                nilai: jumlahKeluar, 
            };

            allTransactions.push(newTransaction);
            saveTransactions();
            renderTables(allTransactions);
            alert(`Pengeluaran untuk ${uraian} sejumlah ${formatRupiah(jumlahKeluar)} berhasil dicatat.`);
            
            document.getElementById('form-catat-pengeluaran').reset();
        };
        
        const handleDeleteTransaction = (id) => {
            if (confirm("Apakah Anda yakin ingin menghapus transaksi ini?")) {
                allTransactions = allTransactions.filter(t => t.id !== id);
                saveTransactions();
                renderTables(allTransactions);
                alert("Transaksi berhasil dihapus.");
            }
        };
        window.handleDeleteTransaction = handleDeleteTransaction; 

        // --- RENDER MAIN FUNCTION ---

        const renderTables = (data) => {
            // Urutkan semua transaksi berdasarkan waktu (ASCENDING) untuk perhitungan Saldo
            const sortedAscending = [...data].sort((a, b) => a.timestamp - b.timestamp);
            
            let runningBalance = 0;
            let totalDanaMasuk = 0;
            let totalDanaKeluar = 0;
            
            // Hitung Saldo Berjalan dan total akumulasi
            const processedTransactions = sortedAscending.map((t, index) => {
                const danaMasuk = t.type === 'masuk' ? t.nilai : 0;
                const danaKeluar = t.type === 'keluar' ? t.nilai : 0;

                runningBalance += danaMasuk;
                runningBalance -= danaKeluar;
                
                totalDanaMasuk += danaMasuk;
                totalDanaKeluar += danaKeluar;

                return { 
                    ...t, 
                    noUrut: index + 1,
                    danaMasuk: danaMasuk,
                    danaKeluar: danaKeluar,
                    saldoBerjalan: runningBalance
                };
            });
            
            // Render 1: Tabel Donatur (Hanya menampilkan transaksi 'masuk' dan prosentase)
            renderDonaturTable(processedTransactions.filter(t => t.type === 'masuk'), totalDanaMasuk);

            // Render 2: Tabel Jurnal Kas Umum (Menampilkan semua transaksi)
            renderJurnalTable(processedTransactions, totalDanaMasuk, totalDanaKeluar, runningBalance);
        };
        
        // --- RENDER 1: TABEL DONATUR (DANA MASUK + PROSENTASE) ---

        const renderDonaturTable = (donations, totalDanaMasuk) => {
            const tableBody = document.getElementById('donatur-table-body');
            tableBody.innerHTML = '';
            
            if (donations.length === 0) {
                 // Update Footer jika kosong
                document.getElementById('total-semua-donasi').textContent = formatRupiah(0);
                document.getElementById('total-makam').textContent = formatRupiah(0);
                document.getElementById('total-panitia').textContent = formatRupiah(0);
                document.getElementById('total-khaul').textContent = formatRupiah(0);
                tableBody.innerHTML = `<tr><td colspan="10" class="py-4 text-center text-gray-500">Belum ada data donatur yang dicatat.</td></tr>`;
                return;
            }
            
            let totalMakam = 0;
            let totalPanitia = 0;
            let totalKhaul = 0;

            donations.forEach((d, index) => {
                
                // Hitung Prosentase per baris
                const makam = Math.round(d.nilai * PERAWATAN_MAKAM);
                const panitia = Math.round(d.nilai * ONGKOS_PANITIA);
                const khaul = Math.round(d.nilai * BIAYA_KHAUL);
                
                totalMakam += makam;
                totalPanitia += panitia;
                totalKhaul += khaul;

                const row = tableBody.insertRow();
                const date = new Date(d.tanggal);
                const formattedDate = date.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
                
                // Karena data di sini sudah filtered dan sorted ASC, noUrut harus dihitung ulang untuk tampilan ini
                const displayNo = index + 1; 

                row.className = index % 2 === 0 ? 'hover:bg-gray-50' : 'bg-gray-50 hover:bg-gray-100';
                
                // Kolom Donatur
                row.insertCell().textContent = displayNo; // No
                row.insertCell().textContent = formattedDate; // Tanggal
                row.insertCell().textContent = d.nama; // Nama Donatur
                row.insertCell().textContent = d.alamat; // Alamat Donatur
                
                const nilaiCell = row.insertCell();
                nilaiCell.textContent = formatRupiah(d.nilai); // Jariyah
                nilaiCell.className = 'py-3 px-3 text-right text-blue-600';
                
                const totalJariyahCell = row.insertCell();
                // Hitung Saldo Donasi Berjalan
                let currentRunningDonasi = 0;
                for (let i = 0; i <= index; i++) {
                     currentRunningDonasi += donations[i].nilai;
                }
                totalJariyahCell.textContent = formatRupiah(currentRunningDonasi); 
                totalJariyahCell.className = 'py-3 px-3 text-right font-bold text-green-700 bg-green-50';
                
                // Kolom Prosentase
                const makamCell = row.insertCell();
                makamCell.textContent = formatRupiah(makam);
                makamCell.className = 'py-3 px-3 text-right bg-yellow-50 text-yellow-800';
                const panitiaCell = row.insertCell();
                panitiaCell.textContent = formatRupiah(panitia);
                panitiaCell.className = 'py-3 px-3 text-right bg-yellow-50 text-yellow-800';
                const khaulCell = row.insertCell();
                khaulCell.textContent = formatRupiah(khaul);
                khaulCell.className = 'py-3 px-3 text-right bg-yellow-50 text-yellow-800';

                // Aksi
                const actionCell = row.insertCell();
                actionCell.className = 'py-3 px-3 text-center';
                actionCell.innerHTML = `<button onclick="window.handleDeleteTransaction(${d.id})" class="text-red-500 hover:text-red-700 font-bold p-1 rounded-full hover:bg-red-50 transition duration-150 text-xs">Hapus</button>`;
            });

            // Update Total Footer Donatur
            document.getElementById('total-semua-donasi').textContent = formatRupiah(totalDanaMasuk);
            document.getElementById('total-makam').textContent = formatRupiah(totalMakam);
            document.getElementById('total-panitia').textContent = formatRupiah(totalPanitia);
            document.getElementById('total-khaul').textContent = formatRupiah(totalKhaul);
        };

        // --- RENDER 2: TABEL JURNAL KAS UMUM (DANA MASUK & KELUAR) ---
        
        const renderJurnalTable = (transactions, totalMasuk, totalKeluar, saldoAkhir) => {
            const tableBody = document.getElementById('jurnal-table-body');
            tableBody.innerHTML = '';

            if (transactions.length === 0) {
                document.getElementById('total-dana-masuk-jurnal').textContent = formatRupiah(0);
                document.getElementById('total-dana-keluar-jurnal').textContent = formatRupiah(0);
                document.getElementById('saldo-akhir-jurnal').textContent = formatRupiah(0);
                tableBody.innerHTML = `<tr><td colspan="9" class="py-4 text-center text-gray-500">Belum ada transaksi di Jurnal Kas.</td></tr>`;
                return;
            }

            // Data sudah diurutkan ASCENDING, kita tampilkan saja
            transactions.forEach((t) => {
                const row = tableBody.insertRow();
                const date = new Date(t.tanggal);
                const formattedDate = date.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
                
                row.className = t.type === 'masuk' ? 'bg-green-50 hover:bg-green-100' : 'bg-red-50 hover:bg-red-100';

                // 1. No
                row.insertCell().textContent = t.noUrut;
                // 2. Tanggal
                row.insertCell().textContent = formattedDate;
                // 3. Uraian
                row.insertCell().textContent = t.uraian;
                // 4. Kategori LPJ (Hanya terlihat Admin, tapi kita tampilkan untuk verifikasi)
                row.insertCell().textContent = t.kategori;
                // 5. Dana Masuk
                const masukCell = row.insertCell();
                masukCell.textContent = formatRupiah(t.danaMasuk);
                masukCell.className = 'py-3 px-3 text-right font-bold text-green-700';
                // 6. Dana Keluar
                const keluarCell = row.insertCell();
                keluarCell.textContent = formatRupiah(t.danaKeluar);
                keluarCell.className = 'py-3 px-3 text-right font-bold text-red-700';
                // 7. Saldo Berjalan
                const saldoCell = row.insertCell();
                saldoCell.textContent = formatRupiah(t.saldoBerjalan);
                saldoCell.className = 'py-3 px-3 text-right font-bold';
                // 8. Aksi
                const actionCell = row.insertCell();
                actionCell.className = 'py-3 px-3 text-center';
                actionCell.innerHTML = `<button onclick="window.handleDeleteTransaction(${t.id})" class="text-red-500 hover:text-red-700 font-bold p-1 rounded-full hover:bg-red-50 transition duration-150 text-xs">Hapus</button>`;
            });

            // Update Total Footer Jurnal
            document.getElementById('total-dana-masuk-jurnal').textContent = formatRupiah(totalMasuk);
            document.getElementById('total-dana-keluar-jurnal').textContent = formatRupiah(totalKeluar);
            document.getElementById('saldo-akhir-jurnal').textContent = formatRupiah(saldoAkhir);
        };
        
        // --- FUNGSI EKSPOR PDF (BARU) ---
        
        window.generatePDF = (type) => {
             const { jsPDF } = window.jspdf;
             if (typeof jsPDF === 'undefined') {
                alert("Gagal memuat modul PDF. Harap muat ulang halaman.");
                return;
            }
            
            // Urutkan ulang data untuk perhitungan Saldo berjalan yang benar
            const sortedAscending = [...allTransactions].sort((a, b) => a.timestamp - b.timestamp);
            let runningBalance = 0;
            const processedTransactions = sortedAscending.map((t, index) => {
                const danaMasuk = t.type === 'masuk' ? t.nilai : 0;
                const danaKeluar = t.type === 'keluar' ? t.nilai : 0;
                runningBalance += danaMasuk - danaKeluar;
                return { ...t, saldoBerjalan: runningBalance, noUrut: index + 1 };
            });

            const doc = new jsPDF('p', 'mm', 'a4');
            const currentDate = new Date().toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' });
            let filename = '';
            let startY = 40;

            // --- Logika Laporan Donatur (type: 'donatur') ---
            if (type === 'donatur') {
                filename = `List_Donatur_Khaul_${currentDate}.pdf`;
                const title = 'LAPORAN LIST DONATUR JARIYAH';
                
                // Filter hanya Donasi Masuk
                const donaturTransactions = processedTransactions.filter(t => t.type === 'masuk');
                let saldoDonatur = 0; 
                let totalJariyah = 0;

                const rowsDonatur = donaturTransactions.map((t, index) => {
                    const date = new Date(t.tanggal).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
                    saldoDonatur += t.nilai;
                    totalJariyah += t.nilai;
                    
                    return [
                        index + 1, // No
                        date, // Tanggal
                        t.nama || '-', // Nama Donatur
                        t.alamat || '-', // Alamat
                        formatRupiah(t.nilai), // Jariyah (Nilai Donasi)
                        formatRupiah(saldoDonatur) // Total Jariyah (Saldo Berjalan Donatur)
                    ];
                });
                
                const totalFooter = [
                    ['', '', '', '', 'TOTAL JARIYAH:', formatRupiah(totalJariyah)]
                ];
                
                doc.setFontSize(16);
                doc.text(title, 14, 20);
                doc.setFontSize(10);
                doc.text(`Dicetak pada: ${currentDate}`, 14, 26);

                doc.autoTable({
                    head: [['No', 'Tanggal', 'Nama Donatur', 'Alamat', 'Jariyah', 'Total Jariyah']],
                    body: rowsDonatur,
                    foot: totalFooter,
                    startY: startY,
                    theme: 'striped',
                    headStyles: { fillColor: [75, 0, 130] }, // Ungu Tua
                    footStyles: { fontStyle: 'bold', fillColor: [200, 240, 200] },
                    columnStyles: {
                        0: { cellWidth: 10, halign: 'center' },
                        4: { halign: 'right' },
                        5: { halign: 'right', fontStyle: 'bold' }
                    },
                    styles: { fontSize: 8 },
                });

            } 
            // --- Logika Laporan Pengeluaran Detail (type: 'detail') ---
            else if (type === 'detail') {
                filename = `Laporan_Pengeluaran_Detail_Khaul_${currentDate}.pdf`;
                const title = 'LAPORAN PENGELUARAN KAS KHAUL DETAIL';
                
                // Filter hanya transaksi Keluar
                const keluarTransactions = processedTransactions.filter(t => t.type === 'keluar');
                
                const rowsKeluar = keluarTransactions.map((t) => {
                    const date = new Date(t.tanggal).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
                    
                    return [
                        t.noUrut, // No (mengambil dari jurnal umum)
                        date, // Tanggal
                        t.uraian, // Uraian
                        formatRupiah(t.danaMasuk), // Dana Masuk (Harusnya Rp 0)
                        formatRupiah(t.danaKeluar), // Dana Keluar
                        formatRupiah(t.saldoBerjalan) // Saldo Berjalan (Jurnal Umum)
                    ];
                });
                
                const totalMasukJurnal = document.getElementById('total-dana-masuk-jurnal').textContent;
                const totalKeluarJurnal = document.getElementById('total-dana-keluar-jurnal').textContent;
                const saldoAkhirJurnal = document.getElementById('saldo-akhir-jurnal').textContent;

                const totalFooter = [
                    ['', '', 'TOTAL AKHIR JURNAL:', totalMasukJurnal, totalKeluarJurnal, saldoAkhirJurnal]
                ];
                
                doc.setFontSize(16);
                doc.text(title, 14, 20);
                doc.setFontSize(10);
                doc.text(`Dicetak pada: ${currentDate}`, 14, 26);

                doc.autoTable({
                    head: [['No', 'Tanggal', 'Uraian', 'Dana Masuk', 'Dana Keluar', 'Saldo Berjalan']],
                    body: rowsKeluar,
                    foot: totalFooter,
                    startY: startY,
                    theme: 'striped',
                    headStyles: { fillColor: [205, 92, 92] }, // Merah Muda
                    footStyles: { fontStyle: 'bold', fillColor: [240, 240, 240] },
                    columnStyles: {
                        0: { cellWidth: 10, halign: 'center' },
                        3: { halign: 'right', textColor: [30, 130, 76] }, 
                        4: { halign: 'right', textColor: [230, 126, 34] }, 
                        5: { halign: 'right', fontStyle: 'bold' }
                    },
                    styles: { fontSize: 8 },
                });
            } 
            // --- Logika Laporan LPJ Global (type: 'ringkasan') ---
            else if (type === 'ringkasan') {
                filename = `Laporan_LPJ_Khaul_Global_${currentDate}.pdf`;
                
                // 1. Hitung Ringkasan per Kategori
                const summary = processedTransactions.reduce((acc, t) => {
                    const key = t.kategori || (t.type === 'masuk' ? 'Donatur' : 'Lain-lain');
                    if (!acc[key]) {
                        acc[key] = { masuk: 0, keluar: 0 };
                    }
                    if (t.type === 'masuk') {
                        acc[key].masuk += t.nilai;
                    } else {
                        acc[key].keluar += t.nilai;
                    }
                    return acc;
                }, {});

                // Tambahkan Kategori Persentase Donasi ke summary
                const totalDonasi = processedTransactions
                    .filter(t => t.type === 'masuk')
                    .reduce((sum, t) => sum + t.nilai, 0);

                const alokasiMakam = Math.round(totalDonasi * PERAWATAN_MAKAM);
                const alokasiPanitia = Math.round(totalDonasi * ONGKOS_PANITIA);
                const alokasiKhaul = Math.round(totalDonasi * BIAYA_KHAUL);
                
                // Kategori-kategori ini dihitung seolah-olah pengeluaran, tapi dananya berasal dari Donasi.
                summary['Perawatan Makam (15% dari Donasi)'] = { masuk: 0, keluar: alokasiMakam };
                summary['Ongkos Panitia (15% dari Donasi)'] = { masuk: 0, keluar: alokasiPanitia };
                summary['Biaya Khaul (70% dari Donasi)'] = { masuk: 0, keluar: alokasiKhaul };
                
                // 2. Persiapkan Data Tabel
                const totalMasukJurnal = document.getElementById('total-dana-masuk-jurnal').textContent;
                const totalKeluarJurnal = document.getElementById('total-dana-keluar-jurnal').textContent;
                const saldoAkhirJurnal = document.getElementById('saldo-akhir-jurnal').textContent;
                
                // Rows Dana Masuk
                const masukRows = Object.keys(summary)
                    .filter(k => summary[k].masuk > 0)
                    .map(k => [k, formatRupiah(summary[k].masuk)]);
                    
                // Rows Dana Keluar
                const keluarRows = Object.keys(summary)
                    .filter(k => summary[k].keluar > 0)
                    .map(k => [k, formatRupiah(summary[k].keluar)]);

                // Urutkan Donatur di paling atas
                masukRows.sort((a, b) => (a[0] === 'Donatur' ? -1 : 1));

                // --- Mulai Cetak LPJ dengan Format Custom ---
                doc.setFontSize(16);
                doc.text('LAPORAN PERTANGGUNG JAWABAN (LPJ) KAS KHAUL GLOBAL', 14, 20);
                doc.setFontSize(10);
                doc.text(`Dicetak pada: ${currentDate}`, 14, 26);
                
                let currentY = 35;
                
                // A. Tabel Pemasukan
                doc.setFontSize(12);
                doc.text('A. REKAPITULASI DANA MASUK', 14, currentY);
                currentY += 5;
                
                const totalMasukRow = [['TOTAL DANA MASUK:', totalMasukJurnal]];
                
                doc.autoTable({
                    head: [['Kategori Pemasukan', 'Jumlah']],
                    body: masukRows,
                    foot: totalMasukRow,
                    startY: currentY,
                    theme: 'grid',
                    headStyles: { fillColor: [39, 174, 96] }, // Hijau
                    footStyles: { fillColor: [30, 130, 76], fontStyle: 'bold' },
                    columnStyles: { 1: { halign: 'right' } },
                    styles: { fontSize: 9 },
                });
                
                currentY = doc.autoTable.previous.finalY + 8;
                
                // B. Tabel Pengeluaran
                doc.setFontSize(12);
                doc.text('B. REKAPITULASI DANA KELUAR', 14, currentY);
                currentY += 5;
                
                const totalKeluarRow = [['TOTAL DANA KELUAR:', totalKeluarJurnal]];

                doc.autoTable({
                    head: [['Kategori Pengeluaran', 'Jumlah']],
                    body: keluarRows,
                    foot: totalKeluarRow,
                    startY: currentY,
                    theme: 'grid',
                    headStyles: { fillColor: [231, 76, 60] }, // Merah
                    footStyles: { fillColor: [192, 57, 43], fontStyle: 'bold' },
                    columnStyles: { 1: { halign: 'right' } },
                    styles: { fontSize: 9 },
                });

                currentY = doc.autoTable.previous.finalY + 10;
                
                // C. Saldo Akhir
                doc.setFontSize(14);
                doc.text(`SALDO AKHIR: ${saldoAkhirJurnal}`, 14, currentY);
            }
            
            doc.save(filename);
        };

        // --- SETUP DAN INISIALISASI ---

        const populateKategoriDropdown = () => {
            const select = document.getElementById('kategori-input');
            KATEGORI_PENGELUARAN.forEach(kategori => {
                const option = document.createElement('option');
                option.value = kategori;
                option.textContent = kategori;
                select.appendChild(option);
            });
        };

        const setupEventListeners = () => {
            // Event Listeners dijamin terpasang di sini
            document.getElementById('btn-catat-donasi').addEventListener('click', handleCatatDonasi);
            document.getElementById('btn-catat-keluar').addEventListener('click', handleCatatPengeluaran);
        };

        window.onload = () => {
            populateKategoriDropdown();
            loadTransactions(); 
            setupEventListeners();
        };
        
        // Export fungsi ke scope global agar bisa dipanggil dari tombol HTML
        window.handleDeleteTransaction = handleDeleteTransaction;
        window.generatePDF = generatePDF; 

    </script>
</head>
<body class="p-4 sm:p-8">
    <div class="container-app mx-auto bg-white p-6 sm:p-10 rounded-xl shadow-2xl">
        
        <h1 class="header-title bg-green-600">
            Aplikasi Pembukuan Khaul - Jurnal Umum
        </h1>

        <div class="section-title border-green-500">
            1. Catat Donasi Jariyah (Dana Masuk)
        </div>
        <form id="form-catat-donasi" class="grid-form">
            <input type="text" id="tanggal-donasi-input" placeholder="Tanggal Donasi" class="input-field" onfocus="this.type='date'" onblur="if(!this.value)this.type='text'">
            <input type="text" id="nama-donatur-input" placeholder="Nama Donatur" class="input-field">
            <input type="text" id="alamat-input" placeholder="Alamat Donatur" class="input-field">
            
            <div class="relative">
                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">Rp</span>
                <input type="number" id="jumlah-jariyah-input" placeholder="Jumlah Jariyah (Angka saja)" class="input-field pl-10">
            </div>
            
            <button type="button" id="btn-catat-donasi" class="btn-action bg-green-600 hover:bg-green-700 text-white">
                Catat Dana Masuk
            </button>
        </form>

        <div class="section-title border-red-500 mt-10">
            2. Catat Pengeluaran (Dana Keluar)
        </div>
        <form id="form-catat-pengeluaran" class="grid-form">
            <input type="text" id="tanggal-keluar-input" placeholder="Tanggal Pengeluaran" class="input-field" onfocus="this.type='date'" onblur="if(!this.value)this.type='text'">
            <input type="text" id="uraian-input" placeholder="Uraian Pengeluaran" class="input-field">
            
            <select id="kategori-input" class="input-field">
                <option value="">-- Pilih Kategori LPJ (Dana Keluar) --</option>
                </select>
            
            <div class="relative">
                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">Rp</span>
                <input type="number" id="jumlah-keluar-input" placeholder="Jumlah Dana Keluar (Angka saja)" class="input-field pl-10">
            </div>
            
            <button type="button" id="btn-catat-keluar" class="btn-action bg-red-600 hover:bg-red-700 text-white">
                Catat Dana Keluar
            </button>
        </form>
        
        <div class="section-title border-gray-500 mt-10">
            3. Unduh Laporan PDF
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-12">
            <button onclick="window.generatePDF('donatur')" class="btn-action bg-purple-600 hover:bg-purple-700 text-white">
                Unduh PDF List Donatur (Kolom 1-6)
            </button>
            <button onclick="window.generatePDF('detail')" class="btn-action bg-orange-600 hover:bg-orange-700 text-white">
                Unduh PDF Pengeluaran Detail (Tanpa Kategori)
            </button>
            <button onclick="window.generatePDF('ringkasan')" class="btn-action bg-blue-600 hover:bg-blue-700 text-white">
                Unduh PDF Laporan LPJ Global (Per Kategori)
            </button>
        </div>


        <div class="section-title border-blue-500">
            4. Laporan List Donatur Jariyah & Pembagian Prosentase
            <p class="text-sm text-gray-500 font-normal mt-1">
                Total Jariyah akan dibagi secara otomatis: Perawatan Makam (15%), Ongkos Panitia (15%), Biaya Khaul (70%).
            </p>
        </div>
        
        <div class="overflow-x-auto rounded-lg shadow-lg mb-4">
            <table class="min-w-full bg-white border border-gray-200 text-sm">
                <thead>
                    <tr class="bg-purple-700 text-white">
                        <th rowspan="2" class="py-3 px-3 border-r">No</th>
                        <th rowspan="2" class="py-3 px-3 border-r">Tanggal</th>
                        <th rowspan="2" class="py-3 px-3 border-r">Nama Donatur</th>
                        <th rowspan="2" class="py-3 px-3 border-r">Alamat</th>
                        <th rowspan="2" class="py-3 px-3 border-r text-right">Jariyah</th>
                        <th rowspan="2" class="py-3 px-3 border-r text-right bg-green-700">Total Jariyah</th>
                        <th colspan="3" class="py-3 px-3 border-b border-l text-center bg-yellow-600">Prosentase Donasi</th>
                        <th rowspan="2" class="py-3 px-3">Aksi</th>
                    </tr>
                    <tr class="bg-yellow-600 text-white font-normal">
                        <th class="py-2 px-3 text-right border-r">Perawatan Makam (15%)</th>
                        <th class="py-2 px-3 text-right border-r">Ongkos Panitia (15%)</th>
                        <th class="py-2 px-3 text-right">Biaya Khaul (70%)</th>
                    </tr>
                </thead>
                <tbody id="donatur-table-body" class="divide-y divide-gray-200 text-gray-700">
                    </tbody>
                <tfoot>
                    <tr class="bg-gray-100 font-bold text-gray-800">
                        <td colspan="4" class="py-3 px-3 text-right">TOTAL AKUMULASI:</td>
                        <td id="total-semua-donasi" class="py-3 px-3 text-right text-blue-700 border-l border-r">Rp 0</td>
                        <td class="py-3 px-3 text-right bg-green-200 border-r">Rp 0</td>
                        <td id="total-makam" class="py-3 px-3 text-right text-yellow-800 border-l">Rp 0</td>
                        <td id="total-panitia" class="py-3 px-3 text-right text-yellow-800">Rp 0</td>
                        <td id="total-khaul" class="py-3 px-3 text-right text-yellow-800 border-r">Rp 0</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="section-title border-green-500">
            5. Jurnal Kas Umum (Dana Masuk & Keluar)
        </div>
        
        <div class="overflow-x-auto rounded-lg shadow-lg">
            <table class="min-w-full bg-white border border-gray-200 text-sm">
                <thead>
                    <tr class="bg-blue-600 text-white">
                        <th class="py-3 px-3 border-r w-10">No</th>
                        <th class="py-3 px-3 border-r">Tanggal</th>
                        <th class="py-3 px-3 border-r w-48">Uraian</th>
                        <th class="py-3 px-3 border-r w-24">Kategori LPJ</th>
                        <th class="py-3 px-3 border-r text-right w-24">Dana Masuk</th>
                        <th class="py-3 px-3 border-r text-right w-24">Dana Keluar</th>
                        <th class="py-3 px-3 border-r text-right w-24">Saldo Berjalan</th>
                        <th class="py-3 px-3 w-16">Aksi</th>
                    </tr>
                </thead>
                <tbody id="jurnal-table-body" class="divide-y divide-gray-200 text-gray-700">
                    </tbody>
                <tfoot>
                    <tr class="bg-blue-100 font-bold text-gray-800">
                        <td colspan="4" class="py-3 px-3 text-right">TOTAL AKUMULASI JURNAL:</td>
                        <td id="total-dana-masuk-jurnal" class="py-3 px-3 text-right text-green-700 border-l border-r">Rp 0</td>
                        <td id="total-dana-keluar-jurnal" class="py-3 px-3 text-right text-red-700 border-r">Rp 0</td>
                        <td id="saldo-akhir-jurnal" class="py-3 px-3 text-right bg-blue-200 border-r">Rp 0</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>

    </div>
</body>
</html>
