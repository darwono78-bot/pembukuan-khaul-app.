<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Pembukuan Keuangan Haul</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Menggunakan Font Inter */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f7f7f7; 
            min-height: 100vh;
        }
        .container { max-width: 800px; }
        
        /* Gaya Kustom untuk Input */
        .input-style {
            /* Warna border yang lebih gelap untuk kontras yang lebih baik */
            border: 1px solid #d1d5db; 
            /* Menggunakan bayangan input standar */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            /* Transisi untuk fokus */
            transition: all 0.15s ease-in-out;
        }
        .input-style:focus {
            /* Menghapus ring default Tailwind dan menggunakan ring kustom */
            --tw-ring-shadow: 0 0 0 3px rgba(99, 102, 241, 0.5); 
            box-shadow: var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow), var(--tw-shadow);
            border-color: #6366f1; /* Indigo-500 */
        }
        
        /* Gaya untuk Tombol Simpan */
        #submitButton {
            background-color: #4f46e5; /* Indigo-600 */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        #submitButton:hover {
            background-color: #4338ca; /* Indigo-700 */
        }
    </style>
</head>
<body>

    <div id="app" class="container mx-auto p-4 md:p-8">
        <!-- JUDUL UTAMA SUDAH DIKEMBALIKAN KE NAMA APLIKASI -->
        <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">Aplikasi Pembukuan Keuangan Haul</h1>
        
        <!-- Kartu Input Data -->
        <div class="bg-white p-8 rounded-xl shadow-2xl mb-8">
            <h2 class="text-2xl font-semibold text-indigo-700 mb-6">Input Data Baru</h2>
            <div id="auth-status" class="text-xs text-red-500 mb-4 font-mono"></div>
            
            <form id="dataForm" class="space-y-6">
                <div>
                    <label for="tanggalInput" class="block text-sm font-semibold text-gray-700 mb-1">Tanggal:</label>
                    <!-- Input type="date" akan menyimpan format YYYY-MM-DD, yang penting untuk urutan string -->
                    <input type="date" id="tanggalInput" required 
                           class="mt-1 block w-full rounded-lg input-style p-3">
                </div>
                <div>
                    <label for="deskripsiInput" class="block text-sm font-semibold text-gray-700 mb-1">Deskripsi/Keterangan:</label>
                    <textarea id="deskripsiInput" rows="3" required 
                              class="mt-1 block w-full rounded-lg input-style p-3"></textarea>
                </div>
                <button type="submit" id="submitButton"
                        class="w-full py-3 px-4 text-white hover:opacity-90 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition duration-150 ease-in-out">
                    Simpan Data
                </button>
            </form>
            <p id="message" class="mt-4 text-sm text-center font-medium"></p>
        </div>

        <!-- Daftar Data Terurut -->
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Daftar Data (Terurut: Tanggal Terlama di Atas)</h2>
        <div id="dataList" class="space-y-4">
            <p class="text-gray-500 text-center py-8" id="loadingMessage">Memuat data...</p>
        </div>
    </div>

    <!-- Script Firebase dan Logika Aplikasi -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, addDoc, onSnapshot, query, 
            doc, deleteDoc, setDoc, serverTimestamp, setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // orderBy dihapus dari import karena kita akan sorting di JS

        // setLogLevel('Debug'); // Opsional: Aktifkan untuk melihat log detail di konsol

        // 1. Inisialisasi Firebase & Variabel Global (Wajib Ada)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId = null;
        let isAuthReady = false;

        const authStatusEl = document.getElementById('auth-status');
        const dataListEl = document.getElementById('dataList');
        const loadingMessageEl = document.getElementById('loadingMessage');
        const messageEl = document.getElementById('message');
        const dataForm = document.getElementById('dataForm');

        // Helper untuk menampilkan pesan singkat
        function showMessage(text, isError = false) {
            messageEl.textContent = text;
            messageEl.className = `mt-4 text-sm text-center font-semibold ${isError ? 'text-red-600' : 'text-green-600'}`;
            setTimeout(() => { messageEl.textContent = ''; }, 4000);
        }

        // 2. Setup Firebase dan Otentikasi
        async function setupFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase Config tidak ditemukan.");
                    authStatusEl.textContent = "Error: Konfigurasi Firebase hilang.";
                    return;
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatusEl.textContent = `STATUS: Terautentikasi (ID: ${userId.substring(0, 8)}...)`;
                        authStatusEl.className = 'text-xs text-green-600 mb-4 font-mono';
                    } else {
                        userId = 'anon-' + crypto.randomUUID(); // Fallback ID jika anonim
                        authStatusEl.textContent = `STATUS: Anonim (ID: ${userId.substring(0, 8)}...)`;
                        authStatusEl.className = 'text-xs text-yellow-600 mb-4 font-mono';
                    }
                    isAuthReady = true;
                    // Setelah otentikasi siap, mulai mendengarkan data
                    if (db && isAuthReady) {
                        listenForData();
                    }
                });

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Kesalahan inisialisasi atau otentikasi Firebase:", error);
                showMessage(`Gagal inisialisasi: ${error.message}`, true);
            }
        }

        // 3. Fungsi untuk Menyimpan Data
        async function saveData(tanggal, deskripsi) {
            if (!db) return showMessage("Database belum siap.", true);

            const collectionPath = `/artifacts/${appId}/public/data/urutan_data`;
            
            // PENTING: Pastikan tanggal disimpan dalam format YYYY-MM-DD
            const dataToSave = {
                tanggal: tanggal, // Format YYYY-MM-DD (String)
                deskripsi: deskripsi,
                // serverTimestamp() digunakan untuk urutan sekunder/pemecah seri
                createdAt: serverTimestamp(), 
                userId: userId
            };

            try {
                await addDoc(collection(db, collectionPath), dataToSave);
                showMessage("Data berhasil disimpan!", false);
            } catch (e) {
                console.error("Error menambahkan dokumen: ", e);
                showMessage(`Gagal menyimpan data: ${e.message}`, true);
            }
        }

        // 4. Fungsi untuk Mendengarkan dan Menampilkan Data
        function listenForData() {
            if (!db || !isAuthReady) return;

            const collectionPath = `/artifacts/${appId}/public/data/urutan_data`;
            
            // Query hanya mengambil data tanpa orderBy (untuk menghindari isu index)
            const dataQuery = query(collection(db, collectionPath));

            onSnapshot(dataQuery, (snapshot) => {
                loadingMessageEl.style.display = 'none';

                if (snapshot.empty) {
                    dataListEl.innerHTML = '<p class="text-gray-600 p-4 bg-gray-100 rounded-lg text-center">Belum ada data yang tersimpan. Silakan input data baru di atas.</p>';
                    return;
                }
                
                // ----------------------------------------------------
                // PERBAIKAN UTAMA: Mengurutkan data di sisi KLIEN (JavaScript)
                // ----------------------------------------------------
                let dataArray = [];
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    dataArray.push({ id: doc.id, ...data });
                });

                // Urutkan data: Tanggal Terlama di Atas (ASCENDING)
                dataArray.sort((a, b) => {
                    // Konversi string tanggal (YYYY-MM-DD) menjadi nilai yang dapat dibandingkan
                    // Contoh: '2025-01-01' vs '2024-12-31'
                    if (a.tanggal < b.tanggal) return -1; // a (lebih lama) di atas b
                    if (a.tanggal > b.tanggal) return 1;  // a (lebih baru) di bawah b

                    // Jika tanggal sama, gunakan createdAt (Timestamp) sebagai pemecah seri
                    // serverTimestamp() adalah objek Firebase, kita bandingkan .seconds
                    const aTime = a.createdAt?.seconds || 0;
                    const bTime = b.createdAt?.seconds || 0;
                    
                    if (aTime < bTime) return -1; // a (lebih dulu dibuat) di atas b
                    if (aTime > bTime) return 1;  // a (lebih lambat dibuat) di bawah b
                    
                    return 0; // Urutan sama
                });
                
                // Kosongkan daftar data lama
                dataListEl.innerHTML = ''; 
                // Ambil tanggal hari ini dalam format YYYY-MM-DD
                const today = new Date().toISOString().slice(0, 10);

                dataArray.forEach((data) => {
                    const docId = data.id;
                    
                    // Format tanggal agar lebih mudah dibaca
                    const dateObj = new Date(data.tanggal + 'T00:00:00');
                    const formattedDate = dateObj.toLocaleDateString('id-ID', {
                        year: 'numeric', month: 'short', day: 'numeric' // Contoh: 1 Jan 2025
                    });

                    const isToday = data.tanggal === today;

                    const itemHtml = `
                        <div class="bg-white p-5 rounded-xl shadow-md border-l-4 ${isToday ? 'border-red-500' : 'border-indigo-400'} flex justify-between items-start transition duration-200 hover:shadow-lg">
                            <div class="flex-grow">
                                <p class="text-sm font-light text-gray-500 mb-1">
                                    <span class="font-bold text-base ${isToday ? 'text-red-600' : 'text-indigo-600'}">${formattedDate}</span>
                                    ${isToday ? '<span class="ml-2 text-xs text-red-500 font-bold">(HARI INI)</span>' : ''}
                                </p>
                                <p class="text-gray-900 font-medium">${data.deskripsi}</p>
                            </div>
                            <!-- Tombol Hapus (Contoh interaksi) -->
                            <button data-id="${docId}" class="delete-btn text-red-500 hover:text-white hover:bg-red-600 ml-4 p-2 rounded-lg transition duration-150 shadow-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    `;
                    dataListEl.insertAdjacentHTML('beforeend', itemHtml);
                });

                // Tambahkan listener ke tombol hapus setelah rendering
                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', handleDelete);
                });

            }, (error) => {
                console.error("Error mendengarkan data:", error);
                loadingMessageEl.textContent = `Gagal memuat data: ${error.message}`;
            });
        }

        // 5. Fungsi Hapus Data (Contoh Interaksi)
        async function handleDelete(event) {
            const docId = event.currentTarget.dataset.id;
            if (!db || !docId) return;

            // PENGGANTIAN ALERT/CONFIRM dengan custom modal/message
            // Untuk mempermudah, kita gunakan fungsi confirm() bawaan, tetapi Anda bisa menggantinya dengan modal kustom.
            const isConfirmed = window.confirm("Apakah Anda yakin ingin menghapus data ini?"); 
            if (!isConfirmed) return; 

            const docRef = doc(db, `/artifacts/${appId}/public/data/urutan_data`, docId);
            try {
                await deleteDoc(docRef);
                showMessage("Data berhasil dihapus.", false);
            } catch (e) {
                console.error("Error menghapus dokumen: ", e);
                showMessage(`Gagal menghapus data: ${e.message}`, true);
            }
        }

        // 6. Event Listener untuk Form Submission
        dataForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const tanggal = document.getElementById('tanggalInput').value;
            const deskripsi = document.getElementById('deskripsiInput').value;
            
            if (tanggal && deskripsi) {
                saveData(tanggal, deskripsi);
                dataForm.reset(); // Kosongkan form setelah submit
            } else {
                showMessage("Mohon lengkapi semua field.", true);
            }
        });

        // Mulai aplikasi
        setupFirebase();
    </script>
</body>
</html>
