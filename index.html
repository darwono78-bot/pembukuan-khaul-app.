<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Pembukuan Dana Khaul - Donatur Sederhana</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .container-app {
            max-width: 900px;
        }
        .input-field {
            @apply w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150;
        }
        .header-title {
            @apply text-3xl font-bold text-center text-white mb-6 p-4 rounded-lg shadow-inner;
        }
        .section-title {
            @apply text-xl font-semibold text-gray-700 border-b pb-2 mb-4 mt-8;
        }
        .btn-action {
            @apply font-bold py-3 px-6 rounded-lg transition duration-150 shadow-md hover:shadow-lg w-full;
        }
    </style>

    <script type="module">
        
        // --- VARIABEL GLOBAL & UTILITY ---
        const STORAGE_KEY = 'khaul_donations_simple';
        let allDonations = []; 
        
        const formatRupiah = (angka) => {
            if (angka === undefined || angka === null) return 'Rp 0';
            const num = Math.round(angka);
            return 'Rp ' + num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        };

        // --- DATA HANDLING (localStorage) ---

        const loadDonations = () => {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                allDonations = data ? JSON.parse(data) : [];
            } catch (error) {
                console.error("Gagal memuat data dari localStorage:", error);
                allDonations = [];
            }
            renderTable(allDonations);
        };

        const saveDonations = () => {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(allDonations));
        };
        
        // --- INPUT & FORM FUNCTIONS ---

        const handleCatatDonasi = () => {
            const tanggal = document.getElementById('tanggal-input').value;
            const namaDonatur = document.getElementById('nama-donatur-input').value;
            const alamat = document.getElementById('alamat-input').value;
            const nilaiJariyah = document.getElementById('nilai-jariyah-input').value || 'Jariyah Umum';
            const totalJariyah = Number(document.getElementById('jumlah-jariyah-input').value);

            if (!tanggal || !namaDonatur || !alamat || totalJariyah <= 0) {
                alert("Tanggal, Nama Donatur, Alamat, dan Jumlah Jariyah wajib diisi.");
                return;
            }

            const newDonation = {
                id: Date.now(), // ID unik lokal
                tanggal: tanggal,
                timestamp: new Date(tanggal).getTime(),
                namaDonatur: namaDonatur,
                alamat: alamat,
                nilaiJariyah: nilaiJariyah,
                totalJariyah: totalJariyah,
            };

            allDonations.push(newDonation);
            allDonations.sort((a, b) => b.timestamp - a.timestamp); // Urutkan terbaru di atas
            saveDonations();
            renderTable(allDonations);
            alert(`Donasi dari ${namaDonatur} sejumlah ${formatRupiah(totalJariyah)} berhasil dicatat!`);

            // Reset form
            document.getElementById('form-catat-donasi').reset();
        };
        
        const handleDeleteDonation = (id) => {
            if (confirm("Apakah Anda yakin ingin menghapus donasi ini?")) {
                allDonations = allDonations.filter(d => d.id !== id);
                saveDonations();
                renderTable(allDonations);
                alert("Donasi berhasil dihapus.");
            }
        };
        window.handleDeleteDonation = handleDeleteDonation; // Export ke global scope

        // --- RENDER TABLE FUNCTION ---

        const renderTable = (dataToRender) => {
            const tableBody = document.getElementById('donatur-table-body');
            let totalDonasi = 0;
            
            tableBody.innerHTML = '';
            
            if (dataToRender.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="7" class="py-4 text-center text-gray-500">Belum ada data donatur yang dicatat.</td></tr>`;
                document.getElementById('total-semua-donasi').textContent = formatRupiah(0);
                return;
            }
            
            // Urutkan ASC untuk penomoran yang benar (kalau data ditampilkan DESC)
            const sortedData = [...dataToRender].sort((a, b) => a.timestamp - b.timestamp);
            
            // Balikkan lagi agar data terbaru di atas untuk tampilan (DEFAULT VIEW)
            const finalRows = sortedData.reverse(); 
            
            finalRows.forEach((d, index) => {
                const row = tableBody.insertRow();
                totalDonasi += d.totalJariyah;

                // Format Tanggal
                const date = new Date(d.tanggal);
                const formattedDate = date.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
                
                row.className = index % 2 === 0 ? 'hover:bg-gray-50' : 'bg-gray-50 hover:bg-gray-100';
                
                // 1. No
                row.insertCell().textContent = finalRows.length - index;
                // 2. Tanggal
                row.insertCell().textContent = formattedDate;
                // 3. Nama Donatur
                row.insertCell().textContent = d.namaDonatur;
                // 4. Alamat
                row.insertCell().textContent = d.alamat;
                // 5. Nilai Jariyah (Keterangan)
                row.insertCell().textContent = d.nilaiJariyah;
                // 6. Jumlah Jariyah
                const jumlahCell = row.insertCell();
                jumlahCell.textContent = formatRupiah(d.totalJariyah);
                jumlahCell.className = 'py-3 px-3 text-right font-semibold text-green-600';
                // 7. Aksi (Hapus)
                const actionCell = row.insertCell();
                actionCell.className = 'py-3 px-3 text-center';
                actionCell.innerHTML = `<button onclick="window.handleDeleteDonation(${d.id})" class="text-red-500 hover:text-red-700 font-bold p-1 rounded-full hover:bg-red-50 transition duration-150 text-xs">Hapus</button>`;
            });

            // Update Total
            document.getElementById('total-semua-donasi').textContent = formatRupiah(totalDonasi);
        };
        
        // --- SETUP DAN INISIALISASI ---

        const setupEventListeners = () => {
            document.getElementById('btn-catat-donasi').addEventListener('click', handleCatatDonasi);
        };

        window.onload = () => {
            loadDonations(); 
            setupEventListeners();
        };

    </script>
</head>
<body class="p-4 sm:p-8">
    <div class="container-app mx-auto bg-white p-6 sm:p-10 rounded-xl shadow-2xl">
        
        <h1 class="header-title bg-green-600">
            Aplikasi Pembukuan Dana Khaul - Data Donatur
        </h1>
        
        <div class="section-title border-green-500">
            1. Catat Donasi Jariyah (6 Kolom Dasar)
        </div>
        <form id="form-catat-donasi" class="space-y-4">
            
            <input type="text" id="tanggal-input" placeholder="Tanggal Donasi (Klik untuk pilih)" class="input-field" onfocus="this.type='date'" onblur="if(!this.value)this.type='text'">
            <input type="text" id="nama-donatur-input" placeholder="Nama Donatur (Kolom 3)" class="input-field">
            <input type="text" id="alamat-input" placeholder="Alamat (Kolom 4)" class="input-field">
            <input type="text" id="nilai-jariyah-input" placeholder="Jariyah (Kolom 5 - Keterangan Donasi)" class="input-field">
            
            <div class="relative">
                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">Rp</span>
                <input type="number" id="jumlah-jariyah-input" placeholder="Jumlah Jariyah (Kolom 6 - Angka saja)" class="input-field pl-10">
            </div>
            
            <button type="button" id="btn-catat-donasi" class="btn-action bg-green-600 hover:bg-green-700 text-white">
                Catat Donasi Jariyah
            </button>
        </form>

        <div class="section-title border-blue-500">
            2. Laporan List Donatur Jariyah
        </div>
        
        <div class="overflow-x-auto rounded-lg shadow-lg">
            <table class="min-w-full bg-white border border-gray-200">
                <thead>
                    <tr class="bg-gray-100 text-gray-600 uppercase text-xs leading-normal">
                        <th class="py-3 px-3 text-center">No</th>
                        <th class="py-3 px-3 text-center">Tanggal</th>
                        <th class="py-3 px-3 text-left">Nama Donatur</th>
                        <th class="py-3 px-3 text-left">Alamat</th>
                        <th class="py-3 px-3 text-left">Nilai Jariyah</th>
                        <th class="py-3 px-3 text-right">Jumlah Jariyah</th>
                        <th class="py-3 px-3 text-center">Aksi</th>
                    </tr>
                </thead>
                <tbody id="donatur-table-body" class="text-gray-600 text-sm font-light divide-y divide-gray-200">
                    <tr>
                        <td colspan="7" class="py-4 text-center text-gray-500">Memuat data...</td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr class="bg-green-50 font-bold text-gray-800">
                        <td colspan="5" class="py-3 px-6 text-right">TOTAL SEMUA DONASI:</td>
                        <td id="total-semua-donasi" class="py-3 px-6 text-right text-lg text-green-700">Rp 0</td>
                        <td class="py-3 px-6 text-center"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        
    </div> 
</body>
</html>
