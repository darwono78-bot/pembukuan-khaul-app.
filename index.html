<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catatan Jariyah Haul - Laporan Rinci</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font: Inter for modern look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for elegance and readability */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .container-main {
            max-width: 100%;
            padding: 1rem;
        }
        @media (min-width: 640px) {
            .container-main {
                max-width: 1280px;
                padding: 2rem;
            }
        }
        /* Custom scrollbar for table on mobile */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        /* Style for overall total box */
        .total-box {
            background-color: #10b981; /* Emerald Green */
            color: white;
        }
        /* Style for the Total Jariyah column (Running Total) */
        .running-total-cell {
            background-color: #d1fae5; /* Light green background */
            color: #047857; /* Dark green text */
            font-weight: 800; /* Extra bold */
        }
        .data-row:nth-child(even) {
            background-color: #f9fafb; /* Subtle zebra striping */
        }
        .data-row:hover {
            background-color: #eef2ff; /* Light indigo on hover */
        }
    </style>
</head>
<body>

<!-- Login/Auth Modal - Covers entire screen until authenticated -->
<div id="auth-modal" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center p-4 z-50">
    <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full">
        <h2 class="text-3xl font-bold text-center text-indigo-700 mb-6">Akses Catatan Keuangan</h2>
        <form id="auth-form" class="space-y-4">
            <input type="email" id="auth-email" placeholder="Email (Contoh: admin@haul.com)" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            <input type="password" id="auth-password" placeholder="Kata Sandi" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            <p id="auth-message" class="text-sm text-red-500 text-center"></p>
            <button type="submit" id="login-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                Masuk (Login)
            </button>
            <p class="text-center text-sm text-gray-500">atau</p>
            <button type="button" id="register-button" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                Daftar Akun Baru (Register)
            </button>
        </form>
    </div>
</div>

<!-- Main Application Wrapper - Hidden until authenticated -->
<div id="app-content" class="container-main mx-auto hidden">
    
    <!-- Header -->
    <header class="text-center py-6 bg-white shadow-lg rounded-xl mb-6">
        <h1 class="text-3xl font-extrabold text-gray-900">2. Laporan List Donatur Jariyah</h1>
        <p class="text-sm text-gray-500 mt-1">Total jariyah akan dibagi secara otomatis: Perawatan Makam (15%), Ongkos Panitia (15%), Biaya Haul (70%).</p>
    </header>

    <!-- Overall Summary Box -->
    <div class="flex justify-end mb-6">
        <div class="total-box p-4 rounded-xl text-center shadow-lg min-w-[250px]">
            <p class="text-sm font-light opacity-80">Total Akhir Semua Jariyah</p>
            <p id="total-jumlah" class="text-3xl font-extrabold">Rp 0</p>
        </div>
    </div>

    <!-- Data Entry Form -->
    <div class="bg-white p-6 shadow-xl rounded-xl mb-6 border border-indigo-200">
        <h2 class="text-xl font-semibold mb-4 text-indigo-700">1. Input Data Jariyah Baru</h2>
        <form id="jariyah-form" class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <!-- Tanggal (Date) -->
            <input type="date" id="tanggal" required class="col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" title="Tanggal">
            
            <!-- Nama (Name) -->
            <input type="text" id="nama" placeholder="Nama Donatur (Wajib)" required class="col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" title="Nama Donatur">
            
            <!-- Alamat (Address) -->
            <input type="text" id="alamat" placeholder="Alamat (Opsional)" class="col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" title="Alamat">
            
            <!-- Jariyah (Amount) -->
            <input type="number" id="jumlah" placeholder="Jumlah Jariyah (Wajib)" required min="1" class="col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" title="Jumlah Jariyah">
            
            <!-- Tombol Tambah (Submit Button) -->
            <button type="submit" class="col-span-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                Tambah Catatan
            </button>
        </form>
    </div>

    <!-- Data Table -->
    <div class="bg-white p-6 shadow-xl rounded-xl border border-gray-200">

        <!-- Table Wrapper for horizontal scrolling on mobile -->
        <div class="table-wrapper">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="text-white">
                    <!-- Row 1: Group Headers -->
                    <tr class="table-header">
                        <th rowspan="2" class="px-3 py-3 text-left text-xs uppercase tracking-wider rounded-tl-lg w-12 bg-indigo-800 border-r border-gray-600">NO</th>
                        <th rowspan="2" class="px-3 py-3 text-left text-xs uppercase tracking-wider w-24 bg-indigo-800">TANGGAL</th>
                        <th rowspan="2" class="px-3 py-3 text-left text-xs uppercase tracking-wider min-w-[150px] bg-indigo-800">NAMA DONATUR</th>
                        <th rowspan="2" class="px-3 py-3 text-left text-xs uppercase tracking-wider min-w-[200px] bg-indigo-800">ALAMAT</th>
                        <th rowspan="2" class="px-3 py-3 text-left text-xs uppercase tracking-wider min-w-[120px] bg-indigo-800 border-r border-gray-600">JARIYAH (RP)</th>
                        
                        <!-- TOTAL JARIYAH (Running Total) -->
                        <th rowspan="2" class="px-3 py-3 text-center text-xs uppercase tracking-wider min-w-[150px] bg-green-700 border-r border-gray-600">TOTAL JARIYAH (RP)</th>
                        
                        <!-- PRESENSTASE DONASI -->
                        <th colspan="3" class="px-3 py-2 text-center text-xs uppercase tracking-wider bg-amber-700 rounded-tr-lg">PRESENTASE DONASI</th>
                        
                        <th rowspan="2" class="px-3 py-3 text-center text-xs uppercase tracking-wider w-16 bg-indigo-800">AKSI</th>
                    </tr>
                    <!-- Row 2: Sub-Headers for PRESENTASE DONASI -->
                    <tr>
                        <th class="px-3 py-3 text-center text-xs uppercase tracking-wider bg-amber-700 border-t border-gray-600">PERAWATAN MAKAM (15%)</th>
                        <th class="px-3 py-3 text-center text-xs uppercase tracking-wider bg-amber-700 border-t border-gray-600">ONGKOS PANITIA (15%)</th>
                        <th class="px-3 py-3 text-center text-xs uppercase tracking-wider bg-amber-700 border-t border-gray-600">BIAYA HAUL (70%)</th>
                    </tr>
                </thead>
                <tbody id="jariyah-list" class="bg-white divide-y divide-gray-200">
                    <!-- Data will be inserted here by JavaScript -->
                    <tr>
                        <td colspan="10" class="p-4 text-center text-gray-500">Memuat data...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Control Panel -->
    <div class="mt-6 flex justify-between items-center p-4 bg-white rounded-xl shadow-lg border border-red-200">
        <!-- Rata Kiri: Reset Data -->
        <button id="reset-data" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out text-sm md:text-base">
            <span class="font-bold mr-1">⚠️</span> Reset Semua Data
        </button>

        <!-- Rata Kanan: User Info & Log Out -->
        <div class="flex items-center space-x-4">
            <p id="user-info" class="text-sm text-gray-600 truncate hidden sm:block">User ID: Memuat...</p>
            <button id="logout" class="bg-gray-700 hover:bg-gray-800 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out text-sm md:text-base">
                Log Out
            </button>
        </div>
    </div>

    <!-- Custom Modal/Notification Area -->
    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div id="custom-modal" class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300 scale-95 opacity-0">
            <h3 id="modal-title" class="text-lg font-bold text-gray-800 mb-3">Peringatan</h3>
            <p id="modal-message" class="text-sm text-gray-600 mb-4"></p>
            <div id="modal-actions" class="flex justify-end space-x-3">
                <button id="modal-cancel" class="px-4 py-2 text-sm font-semibold rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition">Batal</button>
                <button id="modal-confirm" class="px-4 py-2 text-sm font-semibold rounded-lg bg-red-600 text-white hover:bg-red-700 transition">Konfirmasi</button>
            </div>
        </div>
    </div>

</div>

<!-- Firebase and App Script -->
<script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, 
        signInWithEmailAndPassword,
        createUserWithEmailAndPassword,
        signOut,
        onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, 
        collection, 
        addDoc, 
        deleteDoc, 
        doc, 
        query, 
        onSnapshot, 
        getDocs, 
        writeBatch,
        serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-lite.js";

    // IMPORTANT: Use the global variables provided by the environment
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    
    // Using the user-provided config directly since it's in the prompt
    const firebaseConfig = {
        apiKey: "AIzaSyAHIO0RZgoq6eyjeERTpjOugzJLzqG2S-w",
        authDomain: "catatan-keuangan-haul.firebaseapp.com",
        projectId: "catatan-keuangan-haul",
        storageBucket: "catatan-keuangan-haul.firebasestorage.app",
        messagingSenderId: "955355049778",
        appId: "1:955355049778:web:0b844b27b82a88cc0cf12b"
    };

    // 1. Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    setLogLevel('Debug');

    let userId = null;
    let isAuthReady = false;

    // DOM elements for Auth
    const appContent = document.getElementById('app-content');
    const authModal = document.getElementById('auth-modal');
    const authForm = document.getElementById('auth-form');
    const authEmail = document.getElementById('auth-email');
    const authPassword = document.getElementById('auth-password');
    const authMessage = document.getElementById('auth-message');
    const registerButton = document.getElementById('register-button');

    // DOM elements for Main App
    const jariyahForm = document.getElementById('jariyah-form');
    const jariyahList = document.getElementById('jariyah-list');
    const totalJumlahElement = document.getElementById('total-jumlah');
    const logoutButton = document.getElementById('logout');
    const resetButton = document.getElementById('reset-data');
    const userInfoElement = document.getElementById('user-info');

    // Helper functions for UI (Modal/Notification)
    const formatRupiah = (number) => {
        // Round to the nearest whole number for display consistency
        const roundedNumber = Math.round(number);
        return new Intl.NumberFormat('id-ID', {
            style: 'currency',
            currency: 'IDR',
            minimumFractionDigits: 0
        }).format(roundedNumber);
    };

    const showModal = (title, message, isConfirm = false, onConfirm = () => {}) => {
        const modalContainer = document.getElementById('modal-container');
        const modal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalActions = document.getElementById('modal-actions');
        
        // Clear previous buttons
        modalActions.innerHTML = ''; 

        modalTitle.textContent = title;
        modalMessage.textContent = message;
        
        if (isConfirm) {
            // Setup Confirm/Cancel buttons
            const cancelButton = document.createElement('button');
            cancelButton.id = 'modal-cancel';
            cancelButton.className = 'px-4 py-2 text-sm font-semibold rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition';
            cancelButton.textContent = 'Batal';
            cancelButton.onclick = hideModal;

            const confirmButton = document.createElement('button');
            confirmButton.id = 'modal-confirm';
            confirmButton.className = 'px-4 py-2 text-sm font-semibold rounded-lg bg-red-600 text-white hover:bg-red-700 transition';
            confirmButton.textContent = 'Konfirmasi';
            confirmButton.onclick = () => { onConfirm(); hideModal(); };
            
            modalActions.appendChild(cancelButton);
            modalActions.appendChild(confirmButton);
        } else {
            // Setup Close button for simple alert
            const closeBtn = document.createElement('button');
            closeBtn.className = 'px-4 py-2 text-sm font-semibold rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition';
            closeBtn.textContent = 'Tutup';
            closeBtn.onclick = hideModal;
            modalActions.appendChild(closeBtn);
        }
        
        modalActions.classList.add('flex', 'justify-end', 'space-x-3');
        modalContainer.classList.remove('hidden');
        modalContainer.classList.add('flex');
        setTimeout(() => {
            modal.classList.remove('scale-95', 'opacity-0');
            modal.classList.add('scale-100', 'opacity-100');
        }, 10);
    };

    const hideModal = () => {
        const modalContainer = document.getElementById('modal-container');
        const modal = document.getElementById('custom-modal');
        modal.classList.remove('scale-100', 'opacity-100');
        modal.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            modalContainer.classList.remove('flex');
            modalContainer.classList.add('hidden');
        }, 300);
    };


    // 2. Authentication Flow

    // Handle Auth State Changes
    onAuthStateChanged(auth, (user) => {
        if (user) {
            // Logged in
            userId = user.uid;
            userInfoElement.textContent = `User ID: ${userId}`;
            userInfoElement.classList.remove('hidden');
            appContent.classList.remove('hidden');
            authModal.classList.add('hidden');
            isAuthReady = true;
            console.log('User signed in with UID:', userId);
            setupRealtimeListener();
        } else {
            // Logged out
            userId = null;
            userInfoElement.textContent = 'User ID: Log Out';
            appContent.classList.add('hidden');
            authModal.classList.remove('hidden');
            isAuthReady = false;
            // Clear data list when logged out
            jariyahList.innerHTML = '<tr><td colspan="10" class="p-4 text-center text-gray-500 italic">Silakan masuk untuk melihat data.</td></tr>';
            totalJumlahElement.textContent = formatRupiah(0);
        }
    });

    // Handle Login/Register Form Submission (Default is Login)
    authForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = authEmail.value;
        const password = authPassword.value;

        authMessage.textContent = 'Memproses Login...';
        try {
            await signInWithEmailAndPassword(auth, email, password);
            authMessage.textContent = '';
            // onAuthStateChanged will handle UI update
        } catch (error) {
            console.error("Login Gagal:", error.message);
            authMessage.textContent = 'Login Gagal. Pastikan Email dan Kata Sandi benar.';
        }
    });

    // Handle Register Button Click
    registerButton.addEventListener('click', async () => {
        const email = authEmail.value;
        const password = authPassword.value;
        authMessage.textContent = 'Memproses pendaftaran...';

        try {
            if (!email || !password) {
                 authMessage.textContent = 'Email dan Kata Sandi wajib diisi untuk mendaftar.';
                 return;
            }
            await createUserWithEmailAndPassword(auth, email, password);
            authMessage.textContent = 'Pendaftaran berhasil! Anda akan otomatis masuk.';
            // onAuthStateChanged will handle UI update
        } catch (error) {
            console.error("Register Gagal:", error.message);
            // Translate common errors
            let errorMessage = 'Pendaftaran Gagal. Coba lagi.';
            if (error.code === 'auth/weak-password') {
                errorMessage = 'Kata Sandi terlalu lemah (minimal 6 karakter).';
            } else if (error.code === 'auth/email-already-in-use') {
                errorMessage = 'Email sudah terdaftar. Silakan gunakan email lain atau Login.';
            } else if (error.code === 'auth/invalid-email') {
                 errorMessage = 'Format email tidak valid.';
            }
            authMessage.textContent = errorMessage;
        }
    });


    // 3. Firestore Functions

    // Get the collection reference (Private Data)
    const getCollectionRef = () => {
        if (!userId) {
            console.error("Error: User ID is not defined (Not logged in).");
            return null;
        }
        // Collection path: /artifacts/{appId}/users/{userId}/jariyah_records
        return collection(db, `artifacts/${appId}/users/${userId}/jariyah_records`);
    };

    // Add new document
    jariyahForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!isAuthReady || !userId) {
            showModal("Gagal", "Anda harus login untuk menambah data.");
            return;
        }

        const ref = getCollectionRef();
        if (!ref) return;

        const data = {
            tanggal: document.getElementById('tanggal').value,
            nama: document.getElementById('nama').value,
            alamat: document.getElementById('alamat').value || '-',
            jumlah: parseInt(document.getElementById('jumlah').value, 10),
            timestamp: serverTimestamp() // Add timestamp for ordering
        };

        try {
            await addDoc(ref, data);
            jariyahForm.reset();
            document.getElementById('tanggal').valueAsDate = new Date(); 
            console.log("Document successfully written!");
        } catch (e) {
            console.error("Error adding document: ", e);
            showModal("Gagal Menambah Data", "Terjadi kesalahan saat menyimpan data ke database. Coba lagi.");
        }
    });

    // Delete document
    const deleteRecord = async (docId) => {
        if (!isAuthReady || !userId) {
            showModal("Gagal", "Anda harus login untuk menghapus data.");
            return;
        }
        
        const ref = getCollectionRef();
        if (!ref) return;

        try {
            await deleteDoc(doc(ref, docId));
            console.log("Document successfully deleted!");
        } catch (e) {
            console.error("Error deleting document: ", e);
            showModal("Gagal Menghapus Data", "Terjadi kesalahan saat menghapus data. Coba lagi.");
        }
    };

    // Real-time listener (onSnapshot)
    let unsubscribe = null;
    const setupRealtimeListener = () => {
        if (unsubscribe) {
            unsubscribe(); // Detach previous listener if exists
        }

        if (!isAuthReady || !userId) {
            console.log("Auth not ready or user ID missing. Listener not set up.");
            return;
        }

        const ref = getCollectionRef();
        if (!ref) return;

        const q = query(ref); 

        unsubscribe = onSnapshot(q, (snapshot) => {
            let records = [];
            let totalJumlahGlobal = 0;
            
            snapshot.forEach((doc) => {
                const data = doc.data();
                records.push({ id: doc.id, ...data });
                totalJumlahGlobal += data.jumlah || 0;
            });

            // 1. Sort data locally by timestamp descending (newest first)
            records.sort((a, b) => {
                const timeA = a.timestamp?.toMillis() || 0;
                const timeB = b.timestamp?.toMillis() || 0;
                return timeB - timeA;
            });

            // 2. Reverse the array to calculate the running total correctly (from oldest to newest)
            records.reverse(); 
            
            let runningTotal = 0;
            
            // 3. Iterate to calculate Running Total and Percentage Splits
            records = records.map(record => {
                const jariyah = record.jumlah || 0;
                
                // Calculate running total
                runningTotal += jariyah;
                
                // Calculate percentages (using Math.round to match common financial display)
                const perawatanMakam = Math.round(jariyah * 0.15);
                const ongkosPanitia = Math.round(jariyah * 0.15);
                const biayaHaul = Math.round(jariyah * 0.70);

                return {
                    ...record,
                    runningTotal: runningTotal, 
                    perawatanMakam: perawatanMakam,
                    ongkosPanitia: ongkosPanitia,
                    biayaHaul: biayaHaul
                };
            });
            
            // 4. Reverse back to descending order (newest first) for display as per image
            records.reverse();

            // Update UI
            renderJariyahList(records);
            totalJumlahElement.textContent = formatRupiah(totalJumlahGlobal);
        }, (error) => {
            console.error("Error listening to Firestore: ", error);
            showModal("Kesalahan Database", "Gagal memuat data real-time.");
        });
    };
    
    // Render list function
    const renderJariyahList = (records) => {
        jariyahList.innerHTML = ''; // Clear existing list
        if (records.length === 0) {
            jariyahList.innerHTML = `
                <tr>
                    <td colspan="10" class="p-4 text-center text-gray-500 italic">Belum ada catatan jariyah. Silakan tambahkan data baru.</td>
                </tr>
            `;
            return;
        }

        records.forEach((record, index) => {
            const row = document.createElement('tr');
            row.className = 'data-row hover:bg-indigo-50 transition duration-150';

            const formattedDate = record.tanggal ? new Date(record.tanggal + 'T00:00:00').toLocaleDateString('id-ID', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            }) : '-';
            
            // Generate table cell (td) content
            row.innerHTML = `
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">${index + 1}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-900 font-medium">${formattedDate}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-900">${record.nama}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">${record.alamat}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm font-semibold text-indigo-600 border-r border-gray-200">${formatRupiah(record.jumlah)}</td>
                
                <!-- COLUMN: TOTAL JARIYAH (Running Total) -->
                <td class="px-3 py-3 whitespace-nowrap text-sm running-total-cell border-r border-gray-200">${formatRupiah(record.runningTotal)}</td>

                <!-- COLUMN: PERAWATAN MAKAM (15%) -->
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-800">${formatRupiah(record.perawatanMakam)}</td>
                
                <!-- COLUMN: ONGOS PANITIA (15%) -->
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-800">${formatRupiah(record.ongkosPanitia)}</td>
                
                <!-- COLUMN: BIAYA HAUL (70%) -->
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-800">${formatRupiah(record.biayaHaul)}</td>

                <td class="px-3 py-3 whitespace-nowrap text-center text-sm">
                    <!-- Edit Placeholder -->
                    <button class="edit-btn text-blue-600 hover:text-blue-800 p-2 rounded-full hover:bg-blue-100 transition mr-1" title="Edit Catatan (Non-aktif)">
                        Edit
                    </button>
                    <!-- Delete Button -->
                    <button class="delete-btn text-red-600 hover:text-red-900 p-2 rounded-full hover:bg-red-100 transition" data-id="${record.id}" title="Hapus Catatan">
                        Hapus
                    </button>
                </td>
            `;

            row.querySelector('.delete-btn').addEventListener('click', (e) => {
                const docId = e.currentTarget.dataset.id;
                showModal("Konfirmasi Hapus", `Apakah Anda yakin ingin menghapus catatan Jariyah dari ${record.nama}?`, true, () => deleteRecord(docId));
            });

            jariyahList.appendChild(row);
        });
    };

    // 4. Control Panel Actions

    // Logout function
    logoutButton.addEventListener('click', async () => {
        showModal("Konfirmasi Log Out", "Apakah Anda yakin ingin keluar?", true, async () => {
            try {
                if (unsubscribe) {
                    unsubscribe(); // Stop listening to data
                }
                await signOut(auth);
                console.log("User logged out.");
            } catch (error) {
                console.error("Error signing out: ", error);
                showModal("Gagal Log Out", "Terjadi kesalahan saat keluar. Coba lagi.");
            }
        });
    });

    // Reset Data function
    resetButton.addEventListener('click', () => {
        showModal("KONFIRMASI RESET DATA KRITIS", "⚠️ PERINGATAN! Ini akan **menghapus SEMUA data jariyah** Anda secara permanen. Tindakan ini tidak bisa dibatalkan. Lanjutkan?", true, async () => {
            if (!isAuthReady || !userId) {
                showModal("Gagal", "Anda harus login untuk mereset data.");
                return;
            }

            const ref = getCollectionRef();
            if (!ref) return;

            try {
                const snapshot = await getDocs(ref);
                if (snapshot.empty) {
                    showModal("Info", "Tidak ada data untuk direset.", false);
                    return;
                }

                const batch = writeBatch(db);
                snapshot.docs.forEach((d) => {
                    batch.delete(d.ref);
                });

                await batch.commit();
                showModal("Sukses Reset", "Semua data jariyah berhasil dihapus.", false);
            } catch (e) {
                console.error("Error resetting data: ", e);
                showModal("Gagal Reset", "Terjadi kesalahan saat menghapus data secara massal. Coba lagi.");
            }
        });
    });
    
    // Set default date to today for convenience on load
    document.getElementById('tanggal').valueAsDate = new Date(); 

</script>
</body>
</html>
