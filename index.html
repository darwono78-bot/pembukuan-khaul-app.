<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pembukuan Haul: Donatur, Jurnal & Ekspor Firebase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        /* Gaya agar tabel bisa digeser jika terlalu lebar */
        .table-wrapper {
            overflow-x: auto; 
        }

        /* --- PERBAIKAN FONT DAN TEBAL --- */
        /* Ganti font global ke Cambria / Times New Roman / Serif */
        body {
            font-family: Cambria, 'Times New Roman', Times, serif; 
        }
        
        /* Ganti font size global untuk isi tabel agar tidak terlalu besar */
        table {
            font-size: 0.9rem; 
            width: 100%; 
        }

        /* Hapus tebal default dari sel tabel (di JS, kita tambahkan lagi hanya pada total akhir) */
        td {
            font-weight: normal; 
        }

        /* Class untuk Baris Total Akhir Jurnal dan Donatur agar TEBAL */
        .total-row-bold td {
            font-weight: bold !important;
        }

        /* --- PENYESUAIAN LEBAR KOLOM AGAR TIDAK DEMPET --- */
        #jurnal-table th:nth-child(2), 
        #jurnal-table td:nth-child(2),
        #donatur-table th:nth-child(2),
        #donatur-table td:nth-child(2) {
            /* Kolom Tanggal: Beri minimum lebar 110px */
            min-width: 110px; 
        }

        #jurnal-table th:nth-child(3),
        #jurnal-table td:nth-child(3) {
            /* Kolom Uraian (jika tidak login, ini akan jadi uraian+keterangan) */
            min-width: 250px; 
        }
        
        #donatur-table th:nth-child(3),
        #donatur-table td:nth-child(3) {
            /* Kolom Nama Donatur */
            min-width: 150px; 
        }

        /* --- STICKY COLUMNS --- */
        .sticky-col {
            position: sticky;
            left: 0;
            z-index: 10;
            border-right: 1px solid #e5e7eb; 
            min-width: 50px;
        }
        
        .sticky-col-right {
            position: sticky;
            right: 0;
            z-index: 10;
            border-left: 1px solid #e5e7eb; 
            min-width: 120px;
            background-color: #f3f4f6; 
        }
        
        .sticky-no-cell {
            background-color: white !important; 
            font-weight: bold;
        }
        .sticky-action-cell {
            background-color: #f3f4f6 !important; 
        }

        /* Header Tabel */
        .header-bg-donatur {
            background-color: #6B46C1; 
            color: white;
        }
        .header-bg-jurnal {
            background-color: #059669; 
            color: white;
        }
        
        /* Gaya untuk Tombol Admin Kecil */
        .btn-admin-small {
            padding: 0.5rem 1rem; /* Padding lebih kecil */
            font-size: 0.875rem; /* Text lebih kecil */
        }
        
        /* Gaya untuk tombol pagination */
        .pagination-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 700; /* font-bold */
            transition: all 150ms;
        }
        .pagination-btn-active {
            background-color: #FBBF24; /* bg-yellow-400 */
            color: #1F2937; /* text-gray-800 */
        }
        .pagination-btn-inactive {
            background-color: #E5E7EB; /* bg-gray-200 */
            color: #4B5563; /* text-gray-600 */
        }
        .pagination-btn:not(.pagination-btn-active):hover {
            background-color: #D1D5DB; /* hover:bg-gray-300 */
        }
        
        /* --- GAYA BARU: TAB NAVIGASI --- */
        .tab-button {
            padding: 1rem 1.5rem;
            font-weight: 600; 
            transition: all 150ms;
            border-bottom: 3px solid transparent; /* default */
            color: #4B5563; /* text-gray-600 */
        }
        .tab-button:hover {
            color: #1F2937; /* text-gray-800 */
        }
        /* Menggunakan warna hijau Jurnal untuk highlight tab aktif */
        .tab-button.active { 
            border-color: #10B981; /* Tailwind green-500 */
            color: #10B981; 
            font-weight: 700;
        }
    </style>
</head>
<body class="bg-gray-100 p-8">

    <div class="max-w-7xl mx-auto bg-white p-6 rounded-lg shadow-xl">
        <h1 class="text-3xl font-bold text-center text-green-700 mb-4">
            Pembukuan Donatur Haul (Firebase)
        </h1>
        
        <div class="flex flex-wrap gap-4 mb-8 justify-center border-b pb-4">
            <button onclick="exportDonaturPDF()" class="py-2 px-4 bg-purple-600 text-white font-bold rounded hover:bg-purple-700 transition duration-150">
                Unduh PDF List Donatur
            </button>
            <button onclick="exportJurnalDetailPDF()" class="py-2 px-4 bg-green-600 text-white font-bold rounded hover:bg-green-700 transition duration-150">
                Unduh PDF Laporan Detail Jurnal
            </button>
            <button onclick="exportLpjGlobalPDF()" class="py-2 px-4 bg-yellow-600 text-white font-bold rounded hover:bg-yellow-700 transition duration-150">
                Unduh PDF Laporan Global (LPJ)
            </button>
        </div>

        <hr class="my-8"> 
        
        <div class="flex border-b border-gray-300 mb-8">
            <button id="tab-donatur" onclick="showTab('donatur')" class="tab-button active">
                1. Laporan List Donatur Jariyah
            </button>
            <button id="tab-jurnal" onclick="showTab('jurnal')" class="tab-button">
                2. Jurnal Kas Umum
            </button>
        </div>

        <div id="tab-content-donatur" class="tab-content">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">1. Laporan List Donatur Jariyah</h2>
            <p id="donatur-note-persentase" class="mb-4 text-sm text-gray-600 hidden">Total Jariyah akan dibagi secara otomatis: Perawatan Makam (15%), Ongkos Panitia (15%), Biaya Haul (70%).</p>
            
            <div class="table-wrapper mb-4"> 
                <table class="min-w-full divide-y divide-gray-200" id="donatur-table">
                    <thead class="header-bg-donatur">
                        <tr>
                            <th class="sticky-col px-4 py-3 text-center text-xs font-medium uppercase tracking-wider" rowspan="2">NO</th>
                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider" rowspan="2">Tanggal</th>
                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider" rowspan="2">Nama Donatur</th>
                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider" rowspan="2">Alamat</th>
                            <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider bg-purple-700" rowspan="2">Jariyah (Rp)</th>
                            <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider bg-green-700" rowspan="2">Total Jariyah (Rp)</th>
                            <th id="th-donatur-presentase" class="px-4 py-3 text-center text-xs font-medium uppercase tracking-wider bg-yellow-700 hidden" colspan="3">Presentase Donasi</th>
                            <th id="th-donatur-aksi" class="sticky-col-right px-4 py-3 text-center text-xs font-medium uppercase tracking-wider hidden" rowspan="2">Aksi</th>
                        </tr>
                        <tr id="donatur-presentase-row" class="bg-yellow-600 text-white hidden">
                            <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider">Perawatan Makam (15%)</th>
                            <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider">Ongkos Panitia (15%)</th>
                            <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider">Biaya Haul (70%)</th>
                        </tr>
                    </thead>
                    <tbody id="donatur-table-body" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="10" class="py-4 text-center text-gray-500">Belum ada data donasi yang dicatat.</td></tr>
                    </tbody>
                    <tfoot class="bg-gray-200">
                        <tr id="total-akumulasi-row" class="font-bold hidden"> <td id="td-donatur-total-col-1" colspan="6" class="px-4 py-3 text-right text-sm bg-gray-300">TOTAL AKUMULASI (Pembagian Presentase):</td>
                            <td id="total-makam-footer" class="px-4 py-3 text-right text-sm text-yellow-800 hidden">Rp 0</td>
                            <td id="total-panitia-footer" class="px-4 py-3 text-right text-sm text-yellow-800 hidden">Rp 0</td>
                            <td id="total-haul-footer" class="px-4 py-3 text-right text-sm text-yellow-800 hidden">Rp 0</td>
                            <td id="td-donatur-total-col-2" class="sticky-col-right px-4 py-3 text-right text-sm bg-gray-300 hidden"></td>
                        </tr>
                        <tr class="total-row-bold"> 
                             <td id="td-donatur-total-col-3" colspan="5" class="px-4 py-3 text-right text-sm">**TOTAL KESELURUHAN DONASI:**</td>
                            <td class="px-4 py-3 text-right text-sm bg-green-100 text-green-700" id="total-jariyah-footer">Rp 0</td>
                            <td id="td-donatur-total-col-4" colspan="4" class="px-4 py-3 text-right text-sm hidden"></td> 
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div id="donatur-pagination-container" class="flex justify-center gap-2 py-4 mb-12">
            </div>

            <hr class="my-8" id="donasi-hr">
            <div id="donasi-input-container" class="hidden">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">4. Input Data Donasi Jariyah</h2>
            <form id="form-donasi" class="grid grid-cols-1 md:grid-cols-4 gap-4 bg-gray-50 p-6 rounded-lg border mb-8">
                <input type="hidden" id="donatur-id-input" value="">
                <div><label for="tanggal-input-donasi" class="block text-sm font-medium text-gray-700">Tanggal</label><input type="date" id="tanggal-input-donasi" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                <div><label for="nama-donatur-input" class="block text-sm font-medium text-gray-700">Nama Donatur</label><input type="text" id="nama-donatur-input" required placeholder="Nama lengkap donatur" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                <div><label for="alamat-input" class="block text-sm font-medium text-gray-700">Alamat</label><input type="text" id="alamat-input" required placeholder="Alamat donatur" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                <div><label for="jariyah-input" class="block text-sm font-medium text-gray-700">Jariyah (Nominal Rupiah)</label><input type="number" id="jariyah-input" required min="1" placeholder="Masukkan jumlah donasi (misal: 100000)" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                <div class="col-span-full mt-4 flex gap-4">
                    <button type="submit" id="donasi-submit-btn" class="w-full py-3 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150">
                        Catat Donasi
                    </button>
                    <button type="button" id="donasi-cancel-btn" class="hidden py-3 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-gray-500 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition duration-150" onclick="resetDonasiForm()">
                        Batal Edit
                    </button>
                </div>
            </form>
        </div>
            </div>

        <div id="tab-content-jurnal" class="tab-content hidden">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">2. Jurnal Kas Umum (Dana Masuk & Keluar)</h2>
            
            <div class="table-wrapper mb-4">
                <table class="min-w-full divide-y divide-gray-200" id="jurnal-table">
                    <thead class="header-bg-jurnal">
                        <tr>
                            <th class="sticky-col px-4 py-3 text-center text-xs font-medium uppercase tracking-wider">NO</th>
                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Tanggal</th>
                            <th id="th-jurnal-uraian" class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">Uraian / Keterangan</th>
                            <th id="th-jurnal-kategori" class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider hidden">Kategori</th>
                            <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider bg-green-900">Dana Masuk (Rp)</th>
                            <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider bg-red-900">Dana Keluar (Rp)</th>
                            <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider">Saldo (Rp)</th>
                            <th id="th-jurnal-aksi" class="sticky-col-right px-4 py-3 text-center text-xs font-medium uppercase tracking-wider hidden">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="jurnal-table-body" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="8" class="py-4 text-center text-gray-500">Jurnal Kas Umum belum terisi.</td></tr>
                    </tbody>
                    <tfoot class="bg-gray-100 total-row-bold"> 
                        <tr>
                            <td id="td-jurnal-total-col" colspan="4" class="px-4 py-3 text-right text-sm bg-gray-200">**TOTAL AKUMULASI KAS:**</td>
                            <td class="px-4 py-3 text-right text-sm text-green-700" id="total-dana-masuk-jurnal">Rp 0</td>
                            <td class="px-4 py-3 text-right text-sm text-red-700" id="total-dana-keluar-jurnal">Rp 0</td>
                            <td class="px-4 py-3 text-right text-sm bg-blue-100 text-blue-700" id="saldo-akhir-jurnal">Rp 0</td>
                            <td id="td-jurnal-total-aksi" class="sticky-col-right px-4 py-3 text-right text-sm bg-gray-200 hidden"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            
            <div id="jurnal-pagination-container" class="flex justify-center gap-2 py-4 mb-12">
            </div>

            <hr class="my-8" id="jurnal-hr">
            <div id="jurnal-input-container" class="hidden">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">Input Jurnal Kas Umum (Dana Keluar)</h2>
                <form id="form-jurnal" class="grid grid-cols-1 md:grid-cols-4 gap-4 bg-gray-50 p-6 rounded-lg border mb-8">
                    
                    <input type="hidden" id="jurnal-id-input" value="">

                    <div><label for="tanggal-input-jurnal" class="block text-sm font-medium text-gray-700">Tanggal</label><input type="date" id="tanggal-input-jurnal" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                    <div><label for="uraian-input" class="block text-sm font-medium text-gray-700">Uraian / Keterangan</label><input type="text" id="uraian-input" required placeholder="Contoh: Pembayaran Konsumsi" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                    
                    <div>
                        <label for="kategori-input" class="block text-sm font-medium text-gray-700">Kategori Dana Keluar</label>
                        <select id="kategori-input" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                            <option value="">Pilih Kategori Pengeluaran</option>
                            <option value="Ongkos Kiai">1. Ongkos Kiai</option>
                            <option value="Bayar Khataman">2. Bayar Khataman</option>
                            <option value="Bayar Konsumsi">3. Bayar Konsumsi</option>
                            <option value="Bayar Persewaan">4. Bayar Persewaan</option>
                            <option value="Bayar Pekerja">5. Bayar Pekerja</option>
                            <option value="Lain-lain">6. Lain-lain</option>
                        </select>
                    </div>

                    <div><label for="dana-keluar-input" class="block text-sm font-medium text-gray-700">Dana Keluar (Rp)</label><input type="number" id="dana-keluar-input" required min="1" placeholder="Masukkan jumlah pengeluaran" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                    
                    <div class="col-span-full mt-4 flex gap-4">
                        <button type="submit" id="jurnal-submit-btn" class="w-full py-3 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150">
                            Catat Pengeluaran
                        </button>
                        <button type="button" id="jurnal-cancel-btn" class="hidden py-3 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-gray-500 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition duration-150" onclick="resetJurnalForm()">
                            Batal Edit
                        </button>
                    </div>
                </form>
            </div>
            </div>


        <div id="login-form-container" class="flex flex-col md:flex-row justify-center items-center gap-2 py-4 border-t border-b mb-8"> 
            <input type="email" id="admin-email-input" placeholder="Masukkan Email Admin" class="flex-grow max-w-xs border border-gray-300 rounded-md shadow-sm p-2">
            <input type="password" id="admin-password-input" placeholder="Masukkan Password Admin" class="flex-grow max-w-xs border border-gray-300 rounded-md shadow-sm p-2">
            <button onclick="adminLogin()" class="py-2 px-4 bg-blue-600 text-white font-bold rounded hover:bg-blue-700 transition duration-150">
                Login Admin
            </button>
        </div>

        <div id="admin-actions-container" class="hidden flex justify-between items-center mt-4 pt-4 border-t">
    <button onclick="confirmResetData()" class="btn-admin-small bg-yellow-600 text-white font-bold rounded hover:bg-yellow-700 transition duration-150">
        Reset Data
    </button>
    
    <button onclick="adminLogout()" class="btn-admin-small bg-red-600 text-white font-bold rounded hover:bg-red-900 transition duration-150">
        Logout Admin
    </button>
</div>

    </div>

    <script>
        const { jsPDF } = window.jspdf;
        
        // ********************************************************************************
        // 1. KONFIGURASI FIREBASE DAN DEKLARASI GLOBAL
        // ********************************************************************************
        // ====================================================================================
        // !!! GANTI DENGAN KONFIGURASI PROYEK FIREBASE ANDA !!!
        // ====================================================================================
        const firebaseConfig = {
          // HARUS DIGANTI DENGAN DATA PROYEK FIREBASE KAKAK
            apiKey: "AIzaSyAHIO0RZgoq6eyjeERTpjOugzJLzqG2S-w",
            authDomain: "catatan-keuangan-haul.firebaseapp.com",
            databaseURL: "https://catatan-keuangan-haul-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "catatan-keuangan-haul",
            storageBucket: "catatan-keuangan-haul.firebasestorage.app",
            messagingSenderId: "955355049778",
            appId: "1:955355049778:web:0b844b27b82a88cc0cf12b"
        };
        // ====================================================================================

        // DEKLARASI GLOBAL (Tidak diinisialisasi di sini)
        let db; 
        let auth;
        
        // Data Utama (Untuk menampung data yang diambil dari Firebase)
        let allTransactions = []; 
        let jurnalTransactions = []; 
        
        let isAdminLoggedIn = false; 
        
        const ITEMS_PER_PAGE = 10;
        let currentDonaturPage = 1;
        let currentJurnalPage = 1;

        // --------------------------------------------------------------------------------
        // NAVIGATION TABS LOGIC
        // --------------------------------------------------------------------------------
        window.showTab = (tabName) => {
            const tabs = ['jurnal', 'donatur'];
            
            tabs.forEach(name => {
                const content = document.getElementById(`tab-content-${name}`);
                const button = document.getElementById(`tab-${name}`);
                
                // Tambahan: Elemen input dan HR dipindahkan ke dalam tab-content
                const inputContainer = document.getElementById(`${name}-input-container`);
                const hrElement = document.getElementById(`${name}-hr`);

                if (name === tabName) {
                    // Tampilkan konten yang dipilih
                    content.classList.remove('hidden');
                    button.classList.add('active');
                    
                    // Tampilkan form input jika admin sedang login
                    if (isAdminLoggedIn) {
                         inputContainer?.classList.remove('hidden');
                         hrElement?.classList.remove('hidden');
                    }
                } else {
                    // Sembunyikan konten lainnya
                    content.classList.add('hidden');
                    button.classList.remove('active');
                    
                    // Sembunyikan form input lainnya
                    inputContainer?.classList.add('hidden');
                    hrElement?.classList.add('hidden');
                }
            });
            
            // Pastikan data di-render ulang setiap kali ganti tab (untuk mengupdate data jika ada perubahan)
            renderAllTables(); 
        }

        // --------------------------------------------------------------------------------
        // HELPER FUNCTIONS 
        // --------------------------------------------------------------------------------
        
        const formatRupiah = (angka) => {
            if (angka === undefined || angka === null || isNaN(angka)) return 'Rp 0';
            const numberString = Math.abs(angka).toString().replace(/[^,\d]/g, '');
            const split = numberString.split(',');
            const sisa = split[0].length % 3;
            let rupiah = split[0].substr(0, sisa);
            const ribuan = split[0].substr(sisa).match(/\d{3}/gi);
            
            if (ribuan) {
                const separator = sisa ? '.' : '';
                rupiah += separator + ribuan.join('.');
            }
            
            rupiah = split[1] !== undefined ? rupiah + ',' + split[1] : rupiah;
            return (angka < 0 ? 'Rp -' : 'Rp ') + rupiah; 
        };

        // ********************************************************************************
        // FUNGSI LOAD DATA (Mengambil data dari Firestore)
        // ********************************************************************************
        const loadTransactions = async () => {
            try {
                // READ OPERATION.
                const donaturRef = db.collection('donaturHaulData').orderBy('timestamp', 'asc');
                const donaturSnapshot = await donaturRef.get();
                allTransactions = donaturSnapshot.docs.map(doc => ({
                    id: doc.id, 
                    ...doc.data(),
                    nilai: parseInt(doc.data().nilai) 
                }));

                const jurnalRef = db.collection('jurnalHaulData').orderBy('timestamp', 'asc');
                const jurnalSnapshot = await jurnalRef.get();
                jurnalTransactions = jurnalSnapshot.docs.map(doc => ({
                    id: doc.id, 
                    ...doc.data(),
                    danaKeluar: parseInt(doc.data().danaKeluar) 
                }));
                
            } catch (error) {
                console.error("Error saat memuat data dari Firebase. Pastikan Rules Firestore sudah diset 'allow read'. Error: ", error);
            }
        };

        
        // --------------------------------------------------------------------------------
        // PAGINATION LOGIC 
        // --------------------------------------------------------------------------------
        
        window.changePage = (tableType, page) => {
            if (tableType === 'donatur') {
                currentDonaturPage = page;
            } else if (tableType === 'jurnal') {
                currentJurnalPage = page;
            }
            renderAllTables();
        };

        const createPagination = (data, totalItems, containerId, tableType, currentPage, renderCallback) => {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            if (totalItems <= ITEMS_PER_PAGE) {
                return;
            }

            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            
            // Tombol "<<"
            const prevBtn = document.createElement('button');
            prevBtn.textContent = '<<';
            prevBtn.className = `pagination-btn ${currentPage === 1 ? 'pagination-btn-inactive cursor-not-allowed' : 'bg-yellow-400 hover:bg-yellow-500'}`;
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => { if (currentPage > 1) renderCallback(tableType, currentPage - 1); };
            container.appendChild(prevBtn);

            // Tampilkan Maksimal 5 Tombol Halaman (dengan ellipsis)
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);

            if (currentPage < 3) {
                endPage = Math.min(totalPages, 5);
                startPage = 1;
            }
            if (currentPage > totalPages - 2) {
                startPage = Math.max(1, totalPages - 4);
                endPage = totalPages;
            }
            
            if (startPage > 1) {
                // ... (ellipsis)
                const ellipsis = document.createElement('span');
                ellipsis.textContent = '...';
                ellipsis.className = 'px-2 py-2 text-gray-500';
                container.appendChild(ellipsis);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const btn = document.createElement('button');
                btn.textContent = i;
                btn.className = `pagination-btn ${i === currentPage ? 'pagination-btn-active' : 'pagination-btn-inactive'}`;
                btn.onclick = () => renderCallback(tableType, i);
                container.appendChild(btn);
            }
            
            if (endPage < totalPages) {
                 // ... (ellipsis)
                const ellipsis = document.createElement('span');
                ellipsis.textContent = '...';
                ellipsis.className = 'px-2 py-2 text-gray-500';
                container.appendChild(ellipsis);
            }

            // Tombol ">>"
            const nextBtn = document.createElement('button');
            nextBtn.textContent = '>>';
            nextBtn.className = `pagination-btn ${currentPage === totalPages ? 'pagination-btn-inactive cursor-not-allowed' : 'bg-yellow-400 hover:bg-yellow-500'}`;
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => { if (currentPage < totalPages) renderCallback(tableType, currentPage + 1); };
            container.appendChild(nextBtn);
        };
        
        
        // --------------------------------------------------------------------------------
        // 2. AUTENTIKASI DAN GLOBAL RENDER CONTROL 
        // --------------------------------------------------------------------------------
        
        const updateAdminView = (currentTab) => {
            const isLogged = isAdminLoggedIn;
            
            // 1. Tampilkan/Sembunyikan Panel Login/Logout
            document.getElementById('login-form-container').classList.toggle('hidden', isLogged);
            document.getElementById('admin-actions-container').classList.toggle('hidden', !isLogged);
            
            // --- JURNAL KAS UMUM (RAPIH PUBLIK) ---
            const thJurnalUraian = document.getElementById('th-jurnal-uraian');
            
            thJurnalUraian.setAttribute('colspan', isLogged ? '1' : '2');
            thJurnalUraian.textContent = isLogged ? 'Uraian' : 'Uraian / Keterangan'; 
            
            document.getElementById('th-jurnal-kategori').classList.toggle('hidden', !isLogged);
            document.getElementById('th-jurnal-aksi').classList.toggle('hidden', !isLogged);
            
            // Update colspan total jurnal (Footer)
            document.getElementById('td-jurnal-total-col').setAttribute('colspan', isLogged ? '3' : '4'); 
            document.getElementById('td-jurnal-total-aksi').classList.toggle('hidden', !isLogged);
            
            // Tampilkan/Sembunyikan Input Jurnal hanya jika di tab Jurnal
            const isJurnalActive = currentTab === 'jurnal';
            document.getElementById('jurnal-input-container').classList.toggle('hidden', !(isLogged && isJurnalActive));
            document.getElementById('jurnal-hr').classList.toggle('hidden', !(isLogged && isJurnalActive));


            // --- LAPORAN DONATUR (RAPIH PUBLIK) ---
            document.getElementById('donatur-note-persentase').classList.toggle('hidden', !isLogged);
            document.getElementById('th-donatur-presentase').classList.toggle('hidden', !isLogged);
            document.getElementById('donatur-presentase-row').classList.toggle('hidden', !isLogged);
            document.getElementById('th-donatur-aksi').classList.toggle('hidden', !isLogged);
            
            // Update colspan total donatur (Footer)
            
            // 1. Baris TOTAL AKUMULASI (Presentase) - Disembunyikan saat publik
            document.getElementById('total-akumulasi-row').classList.toggle('hidden', !isLogged);
            document.getElementById('td-donatur-total-col-1').setAttribute('colspan', isLogged ? '6' : '4'); 
            document.getElementById('td-donatur-total-col-2').classList.toggle('hidden', !isLogged); 
            document.getElementById('total-makam-footer').classList.toggle('hidden', !isLogged);
            document.getElementById('total-panitia-footer').classList.toggle('hidden', !isLogged);
            document.getElementById('total-haul-footer').classList.toggle('hidden', !isLogged);
            
            // 2. Baris TOTAL KESELURUHAN DONASI
            document.getElementById('td-donatur-total-col-3').setAttribute('colspan', '5'); 
            document.getElementById('td-donatur-total-col-4').classList.toggle('hidden', !isLogged); 
            document.getElementById('td-donatur-total-col-4').setAttribute('colspan', isLogged ? '4' : '0'); 


            // Tampilkan/Sembunyikan Input Donasi hanya jika di tab Donatur
            const isDonaturActive = currentTab === 'donatur';
            document.getElementById('donasi-input-container').classList.toggle('hidden', !(isLogged && isDonaturActive));
            document.getElementById('donasi-hr').classList.toggle('hidden', !(isLogged && isDonaturActive));

            
            // Reset halaman ke 1 saat admin view berubah
            currentDonaturPage = 1;
            currentJurnalPage = 1;
            
            // Render ulang tabel untuk menampilkan/menyembunyikan baris/kolom aksi
            renderAllTables();
        };

        const handleAuthStateChange = (user) => {
            isAdminLoggedIn = !!user; 
            // Tentukan tab aktif saat ini untuk mengatur visibilitas form
            const activeTab = document.querySelector('.tab-button.active').id.replace('tab-', '');
            updateAdminView(activeTab);
            if (isAdminLoggedIn) {
                 // Pindah ke Input form yang aktif
                 const activeFormId = activeTab === 'jurnal' ? 'jurnal-input-container' : 'donasi-input-container';
                 window.scrollTo({ top: document.getElementById(activeFormId).offsetTop - 50, behavior: 'smooth' });
            }
        };


        window.adminLogin = async () => {
            const emailInput = document.getElementById('admin-email-input');
            const passwordInput = document.getElementById('admin-password-input');
            const email = emailInput.value.trim();
            const password = passwordInput.value;

            if (!email || !password) {
                alert('Email dan Password Admin harus diisi!');
                return;
            }

            try {
                await auth.signInWithEmailAndPassword(email, password);
                alert('Login Admin Berhasil!');
                passwordInput.value = ''; 
                emailInput.value = '';
            } catch (error) {
                console.error("Login Gagal: ", error);
                alert(`Login Gagal. Pastikan Email dan Password Admin benar, dan user telah dibuat di Firebase Auth. Error: ${error.code}`);
            }
        };

        window.adminLogout = async () => {
            if (confirm('Anda yakin ingin keluar dari mode Admin?')) {
                try {
                    await auth.signOut();
                    alert('Logout Admin Berhasil!');
                    // Pindah ke form login setelah logout
                    window.scrollTo({ top: document.getElementById('login-form-container').offsetTop - 50, behavior: 'smooth' });
                } catch (error) {
                    console.error("Logout Gagal: ", error);
                    alert(`Logout Gagal. Error: ${error.message}`);
                }
            }
        };
        
        window.confirmResetData = async () => {
            if (!isAdminLoggedIn) return; 
            
            if (confirm('PERINGATAN! Anda yakin ingin MENGHAPUS SEMUA data Donasi dan Jurnal dari Firebase? Tindakan ini tidak bisa dibatalkan.')) {
                
                    try {
                        const donaturDocs = await db.collection('donaturHaulData').get();
                        const donaturBatch = db.batch();
                        donaturDocs.forEach(doc => donaturBatch.delete(doc.ref));
                        
                        const jurnalDocs = await db.collection('jurnalHaulData').get();
                        const jurnalBatch = db.batch();
                        jurnalDocs.forEach(doc => jurnalBatch.delete(doc.ref));
                        
                        await donaturBatch.commit();
                        await jurnalBatch.commit();
                        
                        allTransactions = [];
                        jurnalTransactions = [];
                        
                        await loadTransactions(); 
                        renderAllTables();
                        alert('Semua data berhasil direset (dihapus dari Firebase).');
                        
                        await auth.signOut(); 
                        
                    } catch (error) {
                         console.error("Error saat mereset data Firebase: ", error);
                         alert("Gagal mereset data. Pastikan Rules Firestore Anda mengizinkan operasi 'delete' bagi user yang terautentikasi.");
                    }
            }
        };

        // --------------------------------------------------------------------------------
        // 3. DONATUR LOGIC 
        // --------------------------------------------------------------------------------

        const resetDonasiForm = () => {
            document.getElementById('form-donasi').reset();
            document.getElementById('donatur-id-input').value = '';
            document.getElementById('donasi-submit-btn').textContent = 'Catat Donasi';
            document.getElementById('donasi-submit-btn').classList.replace('bg-green-600', 'bg-blue-600');
            document.getElementById('donasi-submit-btn').classList.replace('hover:bg-green-700', 'hover:bg-blue-700');
            document.getElementById('donasi-cancel-btn').classList.add('hidden');
        };

        document.getElementById('form-donasi').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!isAdminLoggedIn) return alert('Akses Ditolak. Silakan login sebagai Admin untuk menginput data.');
            
            const tanggal = document.getElementById('tanggal-input-donasi').value;
            const nama = document.getElementById('nama-donatur-input').value.trim();
            const alamat = document.getElementById('alamat-input').value.trim();
            const nilai = parseInt(document.getElementById('jariyah-input').value);
            
            if (!tanggal || !nama || !alamat || isNaN(nilai) || nilai <= 0) {
                 alert('Mohon isi semua kolom donasi dengan benar.');
                 return;
            }

            const existingId = document.getElementById('donatur-id-input').value;

            const donasiData = { 
                tanggal, 
                nama, 
                alamat, 
                nilai: nilai,
            };
            
            try {
                if (existingId) {
                    // Mode Edit
                    const docRef = db.collection('donaturHaulData').doc(existingId);
                    await docRef.update(donasiData);
                    alert('Data Donatur berhasil diubah di Firebase!');
                } else {
                    // Mode Create
                    await db.collection('donaturHaulData').add({
                        ...donasiData,
                        timestamp: Date.now() 
                    });
                    alert('Donasi berhasil dicatat di Firebase!');
                }
                
                resetDonasiForm();
                await loadTransactions(); 
                renderAllTables();

            } catch (error) {
                console.error("Error saat menyimpan/mengubah Donatur di Firebase: ", error);
                alert("Gagal menyimpan data ke Firebase. Pastikan Rules Firestore Anda mengizinkan operasi 'write' bagi user yang terautentikasi.");
            }
        });

        window.editDonatur = (id) => {
            if (!isAdminLoggedIn) return alert('Akses Ditolak. Silakan login sebagai Admin untuk mengedit data.');
            
            const transaction = allTransactions.find(t => t.id === id);
            if (!transaction) return alert('Data tidak ditemukan.');

            document.getElementById('donatur-id-input').value = transaction.id;
            document.getElementById('tanggal-input-donasi').value = transaction.tanggal;
            document.getElementById('nama-donatur-input').value = transaction.nama;
            document.getElementById('alamat-input').value = transaction.alamat;
            document.getElementById('jariyah-input').value = transaction.nilai;
            
            document.getElementById('donasi-submit-btn').textContent = 'Simpan Perubahan';
            document.getElementById('donasi-submit-btn').classList.replace('bg-blue-600', 'bg-green-600');
            document.getElementById('donasi-submit-btn').classList.replace('hover:bg-blue-700', 'hover:bg-green-700');
            document.getElementById('donasi-cancel-btn').classList.remove('hidden');

            window.scrollTo({ top: document.getElementById('donasi-input-container').offsetTop - 50, behavior: 'smooth' });
        };

        window.deleteDonatur = async (id) => {
             if (!isAdminLoggedIn) return alert('Akses Ditolak. Silakan login sebagai Admin untuk menghapus data.');
            if (!confirm('Anda yakin ingin menghapus data donatur ini? Menghapus donasi akan mempengaruhi saldo total kas.')) return;

            try {
                 const docRef = db.collection('donaturHaulData').doc(id);
                 await docRef.delete();
                 
                 alert('Data Donatur berhasil dihapus dari Firebase.');
                 await loadTransactions(); 
                 renderAllTables();
                 
            } catch (error) {
                 console.error("Error saat menghapus Donatur di Firebase: ", error);
                 alert("Gagal menghapus data dari Firebase. Pastikan Rules Firestore Anda mengizinkan operasi 'delete' bagi user yang terautentikasi.");
            }
        };

        const renderDonaturTable = (data, page = 1) => {
            const tableBody = document.getElementById('donatur-table-body');
            tableBody.innerHTML = '';
            
            const sortedData = [...data].sort((a, b) => a.timestamp - b.timestamp); 
            
            const start = (page - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const dataToDisplay = sortedData.slice(start, end);
            
            let runningTotalJariyah = 0;
            let totalDanaMasuk = 0;
            sortedData.forEach(d => totalDanaMasuk += d.nilai);

            let totalMakamAccumulated = Math.round(totalDanaMasuk * 0.15);
            let totalPanitiaAccumulated = Math.round(totalDanaMasuk * 0.15);
            let totalHaulAccumulated = Math.round(totalDanaMasuk * 0.70);
            
            const isLogged = isAdminLoggedIn;
            const colspanPublic = 6; 

            if (sortedData.length === 0) {
                document.getElementById('total-jariyah-footer').textContent = formatRupiah(0);
                document.getElementById('total-makam-footer').textContent = formatRupiah(0);
                document.getElementById('total-panitia-footer').textContent = formatRupiah(0);
                document.getElementById('total-haul-footer').textContent = formatRupiah(0);
                tableBody.innerHTML = `<tr><td colspan="${isLogged ? 10 : colspanPublic}" class="py-4 text-center text-gray-500">Belum ada data donasi yang dicatat.</td></tr>`;
                createPagination(sortedData, sortedData.length, 'donatur-pagination-container', 'donatur', 1, window.changePage);
                return totalDanaMasuk;
            }
            
            let runningTotalBeforePage = 0;
            for (let i = 0; i < start; i++) {
                runningTotalBeforePage += sortedData[i].nilai;
            }
            runningTotalJariyah = runningTotalBeforePage;
            

            dataToDisplay.forEach((d, index) => {
                runningTotalJariyah += d.nilai;
                
                const makam = runningTotalJariyah * 0.15; 
                const panitia = runningTotalJariyah * 0.15;
                const haul = runningTotalJariyah * 0.70;
                
                const row = tableBody.insertRow();
                const date = new Date(d.tanggal + 'T00:00:00'); 
                const formattedDate = date.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
                const displayNo = start + index + 1; 

                row.className = index % 2 === 0 ? 'hover:bg-gray-50' : 'bg-gray-50 hover:bg-gray-100';
                
                // Kolom 1: NO (Sticky Kiri)
                const noCell = row.insertCell();
                noCell.textContent = displayNo; 
                noCell.className = 'sticky-col px-4 py-3 text-center sticky-no-cell text-gray-800 font-normal'; 

                row.insertCell().textContent = formattedDate; 
                row.insertCell().textContent = d.nama; 
                row.insertCell().textContent = d.alamat; 
                
                const nilaiCell = row.insertCell();
                nilaiCell.textContent = formatRupiah(d.nilai); 
                nilaiCell.className = 'py-3 px-3 text-right text-purple-600 bg-purple-50'; 
                
                const totalJariyahCell = row.insertCell();
                totalJariyahCell.textContent = formatRupiah(runningTotalJariyah); 
                totalJariyahCell.className = 'py-3 px-3 text-right text-white bg-green-600';
                
                // KOLOM PRESENTASE (HANYA UNTUK ADMIN)
                if (isLogged) {
                    row.insertCell().textContent = formatRupiah(Math.round(makam)); 
                    row.insertCell().textContent = formatRupiah(Math.round(panitia)); 
                    row.insertCell().textContent = formatRupiah(Math.round(haul)); 
                }
                
                // Kolom AKSI (Sticky Kanan - HANYA UNTUK ADMIN)
                if (isLogged) {
                    const actionCell = row.insertCell();
                    actionCell.className = 'sticky-col-right px-4 py-3 text-center sticky-action-cell';
                    actionCell.innerHTML = `
                        <button onclick="editDonatur('${d.id}')" class="text-blue-600 hover:text-blue-900 text-sm font-medium mr-2">Edit</button>
                        <button onclick="deleteDonatur('${d.id}')" class="text-red-600 hover:text-red-900 text-sm font-medium">Hapus</button>
                    `;
                }
            });

            // Update Footer 
            document.getElementById('total-jariyah-footer').textContent = formatRupiah(totalDanaMasuk);
            document.getElementById('total-makam-footer').textContent = formatRupiah(totalMakamAccumulated);
            document.getElementById('total-panitia-footer').textContent = formatRupiah(totalPanitiaAccumulated);
            document.getElementById('total-haul-footer').textContent = formatRupiah(totalHaulAccumulated);
            
            createPagination(sortedData, sortedData.length, 'donatur-pagination-container', 'donatur', currentDonaturPage, window.changePage);

            return totalDanaMasuk;
        };

        // --------------------------------------------------------------------------------
        // 4. JURNAL LOGIC 
        // --------------------------------------------------------------------------------

        const resetJurnalForm = () => {
            document.getElementById('form-jurnal').reset();
            document.getElementById('jurnal-id-input').value = '';
            document.getElementById('jurnal-submit-btn').textContent = 'Catat Pengeluaran';
            document.getElementById('jurnal-submit-btn').classList.replace('bg-blue-600', 'bg-red-600');
            document.getElementById('jurnal-submit-btn').classList.replace('hover:bg-red-700', 'hover:bg-blue-700');
            document.getElementById('jurnal-cancel-btn').classList.add('hidden');
        };

        document.getElementById('form-jurnal').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!isAdminLoggedIn) return alert('Akses Ditolak. Silakan login sebagai Admin untuk menginput data.');

            const tanggal = document.getElementById('tanggal-input-jurnal').value;
            const uraian = document.getElementById('uraian-input').value.trim();
            const kategori = document.getElementById('kategori-input').value;
            const danaKeluar = parseInt(document.getElementById('dana-keluar-input').value || 0);
            
            if (!tanggal || !uraian || !kategori || danaKeluar <= 0) {
                 alert('Mohon isi Tanggal, Uraian, Kategori, dan Dana Keluar minimal 1 Rupiah.');
                 return;
            }
            
            const existingId = document.getElementById('jurnal-id-input').value;

            const jurnalData = { 
                tanggal, 
                uraian, 
                kategori, 
                danaMasuk: 0, 
                danaKeluar 
            };

            try {
                if (existingId) {
                    // Mode Edit
                    const docRef = db.collection('jurnalHaulData').doc(existingId);
                    await docRef.update(jurnalData);
                    alert('Data Jurnal berhasil diubah di Firebase!');
                } else {
                    // Mode Create
                    await db.collection('jurnalHaulData').add({
                        ...jurnalData,
                        timestamp: Date.now() 
                    });
                    alert('Pengeluaran berhasil dicatat di Firebase!');
                }

                resetJurnalForm();
                await loadTransactions(); 
                renderAllTables(); 
                
            } catch (error) {
                console.error("Error saat menyimpan/mengubah Jurnal di Firebase: ", error);
                alert("Gagal menyimpan data ke Firebase. Pastikan Rules Firestore Anda mengizinkan operasi 'write' bagi user yang terautentikasi.");
            }
        });
        
        window.editJurnal = (id) => {
            if (!isAdminLoggedIn) return alert('Akses Ditolak. Silakan login sebagai Admin untuk mengedit data.');
            
            const transaction = jurnalTransactions.find(t => t.id === id);
            if (!transaction) return alert('Data tidak ditemukan.');

            document.getElementById('jurnal-id-input').value = transaction.id;
            document.getElementById('tanggal-input-jurnal').value = transaction.tanggal;
            document.getElementById('uraian-input').value = transaction.uraian;
            document.getElementById('kategori-input').value = transaction.kategori;
            document.getElementById('dana-keluar-input').value = transaction.danaKeluar;
            
            document.getElementById('jurnal-submit-btn').textContent = 'Simpan Perubahan';
            document.getElementById('jurnal-submit-btn').classList.replace('bg-red-600', 'bg-blue-600');
            document.getElementById('jurnal-submit-btn').classList.replace('hover:bg-red-700', 'hover:bg-blue-700');
            document.getElementById('jurnal-cancel-btn').classList.remove('hidden');

            window.scrollTo({ top: document.getElementById('jurnal-input-container').offsetTop - 50, behavior: 'smooth' });
        };

        window.deleteJurnal = async (id) => {
            if (!isAdminLoggedIn) return alert('Akses Ditolak. Silakan login sebagai Admin untuk menghapus data.');
            if (!confirm('Anda yakin ingin menghapus data pengeluaran ini?')) return;

            try {
                const docRef = db.collection('jurnalHaulData').doc(id);
                await docRef.delete();
                
                alert('Data Jurnal berhasil dihapus dari Firebase.');
                await loadTransactions(); 
                renderAllTables(); 
                
            } catch (error) {
                console.error("Error saat menghapus Jurnal di Firebase: ", error);
                alert('Gagal menghapus data dari Firebase. Pastikan Rules Firestore Anda mengizinkan operasi "delete" bagi user yang terautentikasi.');
            }
        };

        const renderJurnalTable = (totalDonasi, page = 1) => {
            const tableBody = document.getElementById('jurnal-table-body');
            tableBody.innerHTML = '';
            
            const donasiEntry = {
                id: 'DONASI',
                tanggal: allTransactions.length > 0 ? allTransactions[allTransactions.length - 1].tanggal : new Date().toLocaleDateString('en-CA'), 
                uraian: 'TOTAL AKUMULASI DONASI HAUL',
                kategori: 'Donatur',
                danaMasuk: totalDonasi,
                danaKeluar: 0,
                timestamp: allTransactions.length > 0 ? allTransactions[allTransactions.length - 1].timestamp - 1 : 0
            };
            
            const combinedData = [donasiEntry, ...jurnalTransactions].sort((a, b) => a.timestamp - b.timestamp);
            
            let runningBalance = 0;
            let totalMasuk = 0;
            let totalKeluar = 0;
            let currentIndex = 0;
            const isLogged = isAdminLoggedIn;

            combinedData.forEach(t => {
                totalMasuk += t.danaMasuk;
                totalKeluar += t.danaKeluar;
            });
            const saldoAkhir = totalMasuk - totalKeluar;
            
            const start = (page - 1) * ITEMS_PER_PAGE;
            let runningBalanceBeforePage = 0;
            for (let i = 0; i < start; i++) {
                runningBalanceBeforePage += combinedData[i].danaMasuk - combinedData[i].danaKeluar;
            }
            runningBalance = runningBalanceBeforePage;

            const end = start + ITEMS_PER_PAGE;
            const dataToDisplay = combinedData.slice(start, end);

            if (combinedData.length === 0 || (combinedData.length === 1 && totalDonasi === 0)) {
                document.getElementById('total-dana-masuk-jurnal').textContent = formatRupiah(0);
                document.getElementById('total-dana-keluar-jurnal').textContent = formatRupiah(0);
                document.getElementById('saldo-akhir-jurnal').textContent = formatRupiah(0);
                tableBody.innerHTML = `<tr><td colspan="${isLogged ? 8 : 7}" class="py-4 text-center text-gray-500">Jurnal Kas Umum belum terisi.</td></tr>`;
                 createPagination(combinedData, combinedData.length, 'jurnal-pagination-container', 'jurnal', 1, window.changePage);
                return { totalMasuk: 0, totalKeluar: 0, saldoAkhir: 0 };
            }

            dataToDisplay.forEach((t, index) => {
                
                runningBalance = runningBalance + t.danaMasuk - t.danaKeluar;
                
                const row = tableBody.insertRow();
                const date = new Date(t.tanggal + 'T00:00:00'); 
                const formattedDate = t.id === 'DONASI' ? 'Tgl. Terakhir Donasi' : date.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
                
                row.className = index % 2 === 0 ? 'hover:bg-gray-50' : 'bg-gray-50 hover:bg-gray-100';
                
                // 1. NO
                const noCell = row.insertCell();
                const globalIndex = start + index;
                noCell.textContent = t.id === 'DONASI' ? '' : globalIndex; 
                if (t.id !== 'DONASI') {
                    noCell.textContent = globalIndex;
                }
                noCell.className = 'sticky-col px-4 py-3 text-center sticky-no-cell text-gray-800 bg-gray-100 font-normal'; 
                
                // 2. Tanggal
                row.insertCell().textContent = formattedDate;
                
                // 3. Uraian
                const uraianCell = row.insertCell();
                uraianCell.textContent = isLogged ? t.uraian : `${t.uraian} (${t.kategori})`;
                if (!isLogged) {
                    uraianCell.setAttribute('colspan', '2');
                }
                
                // 4. Kategori (HANYA UNTUK ADMIN)
                if (isLogged) {
                    row.insertCell().textContent = t.kategori; 
                }
                
                // 5. Dana Masuk
                const masukCell = row.insertCell();
                masukCell.textContent = formatRupiah(t.danaMasuk);
                masukCell.className = 'py-3 px-3 text-right text-green-700'; 

                // 6. Dana Keluar
                const keluarCell = row.insertCell();
                keluarCell.textContent = formatRupiah(t.danaKeluar);
                keluarCell.className = 'py-3 px-3 text-right text-red-700';
                
                // 7. Saldo
                const saldoCell = row.insertCell();
                saldoCell.textContent = formatRupiah(runningBalance);
                saldoCell.className = 'py-3 px-3 text-right';

                // 8. Aksi (Sticky Kanan - HANYA UNTUK ADMIN)
                if (isLogged) {
                    const actionCell = row.insertCell();
                    actionCell.className = 'sticky-col-right px-4 py-3 text-center sticky-action-cell';
                    if (t.id !== 'DONASI') {
                        actionCell.innerHTML = `
                            <button onclick="editJurnal('${t.id}')" class="text-blue-600 hover:text-blue-900 text-sm font-medium mr-2">Edit</button>
                            <button onclick="deleteJurnal('${t.id}')" class="text-red-600 hover:text-red-900 text-sm font-medium">Hapus</button>
                        `;
                    } else {
                        actionCell.textContent = '-';
                    }
                }
            });

            // Update Footer 
            document.getElementById('total-dana-masuk-jurnal').textContent = formatRupiah(totalMasuk);
            document.getElementById('total-dana-keluar-jurnal').textContent = formatRupiah(totalKeluar);
            document.getElementById('saldo-akhir-jurnal').textContent = formatRupiah(saldoAkhir);
            
            createPagination(combinedData, combinedData.length, 'jurnal-pagination-container', 'jurnal', currentJurnalPage, window.changePage);


            return { totalMasuk, totalKeluar, saldoAkhir: saldoAkhir };
        };

        // --------------------------------------------------------------------------------
        // 5. PDF EXPORT FUNCTIONS 
        // --------------------------------------------------------------------------------
        
        const addSignatures = (doc, yPos) => {
            doc.setFontSize(10);
            doc.setFont('times', 'normal'); 
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 15;
            const columnSpacing = (pageWidth - 2 * margin) / 3; 
            const col1X = margin + columnSpacing / 2; 
            const col2X = margin + columnSpacing + columnSpacing / 2; 
            const col3X = margin + 2 * columnSpacing + columnSpacing / 2; 

            doc.text("Pati, " + new Date().toLocaleDateString('id-ID', {day: '2-digit', month: 'long', year: 'numeric'}), pageWidth - margin, yPos + 10, { align: 'right' });
            
            yPos += 30; 
            
            doc.text("Mengetahui,", col1X, yPos, { align: 'center' });
            doc.text("Ketua Panitia Haul", col1X, yPos + 5, { align: 'center' });

            doc.text("Bendahara Haul", col2X, yPos + 5, { align: 'center' });

            doc.text("Sekretaris", col3X, yPos + 5, { align: 'center' });
            
            yPos += 40;
            
            doc.text("(.........................................)", col1X, yPos, { align: 'center' });
            doc.text("(.........................................)", col2X, yPos, { align: 'center' });
            doc.text("(.........................................)", col3X, yPos, { align: 'center' });
        };
        
        const setupPDF = (title) => {
             const doc = new jsPDF('p', 'mm', 'a4');
             doc.setFont('times', 'normal'); 
             doc.setFontSize(16);
             doc.text("LPJ Keuangan Haul", 105, 15, { align: 'center' });
             doc.setFontSize(12);
             doc.text(title, 105, 22, { align: 'center' });
             return doc;
        }

        window.exportDonaturPDF = () => {
            const doc = setupPDF("Laporan List Donatur Jariyah");
            const data = [...allTransactions].sort((a, b) => a.timestamp - b.timestamp);
            
            let runningTotalJariyah = 0;
            const tableBody = [];
            
            const header = [['NO', 'Tanggal', 'Nama Donatur', 'Alamat', 'Jariyah (Rp)', 'Total Jariyah (Rp)']];

            data.forEach((d, index) => {
                runningTotalJariyah += d.nilai;
                const formattedDate = new Date(d.tanggal + 'T00:00:00').toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
                
                tableBody.push([
                    index + 1,
                    formattedDate,
                    d.nama,
                    d.alamat,
                    formatRupiah(d.nilai),
                    formatRupiah(runningTotalJariyah)
                ]);
            });

            tableBody.push([
                { content: 'TOTAL KESELURUHAN DONASI:', colSpan: 4, styles: { fillColor: [209, 213, 219], fontStyle: 'bold', halign: 'right' } },
                { content: formatRupiah(runningTotalJariyah), colSpan: 2, styles: { fillColor: [178, 245, 178], fontStyle: 'bold', halign: 'right' } }
            ]);
            
            doc.autoTable({
                head: header,
                body: tableBody,
                startY: 30,
                theme: 'striped',
                headStyles: { 
                    fillColor: [107, 70, 193],
                    columnStyles: {
                        4: { halign: 'right' },
                        5: { halign: 'right' }
                    }
                }, 
                columnStyles: {
                    4: { halign: 'right' },
                    5: { halign: 'right' }
                }
            });
            
            addSignatures(doc, doc.lastAutoTable.finalY + 10);
            doc.save("LPJ_Donatur_List.pdf");
        };

        window.exportJurnalDetailPDF = () => {
             const doc = setupPDF("Laporan Detail Jurnal Kas Umum");
             
             const totalDonasi = allTransactions.reduce((sum, t) => sum + t.nilai, 0); 
             
             const donasiEntry = {
                id: 'DONASI',
                tanggal: allTransactions.length > 0 ? allTransactions[allTransactions.length - 1].tanggal : new Date().toLocaleDateString('en-CA'), 
                uraian: 'TOTAL AKUMULASI DONASI HAUL',
                kategori: 'Donatur', 
                danaMasuk: totalDonasi,
                danaKeluar: 0,
                timestamp: allTransactions.length > 0 ? allTransactions[allTransactions.length - 1].timestamp - 1 : 0
            };
            
            const combinedData = [donasiEntry, ...jurnalTransactions].sort((a, b) => a.timestamp - b.timestamp);
            
            let runningBalance = 0;
            let totalMasuk = 0;
            let totalKeluar = 0;
            let currentIndex = 0;
            const tableBody = [];
            const header = [['NO', 'Tanggal', 'Uraian', 'Kategori', 'Dana Masuk (Rp)', 'Dana Keluar (Rp)', 'Saldo (Rp)']];

            combinedData.forEach((t) => {
                
                runningBalance = runningBalance + t.danaMasuk - t.danaKeluar;
                totalMasuk += t.danaMasuk;
                totalKeluar += t.danaKeluar;
                
                if (t.id !== 'DONASI') {
                    currentIndex++;
                }

                const formattedDate = t.id === 'DONASI' ? 'Tgl. Terakhir Donasi' : new Date(t.tanggal + 'T00:00:00').toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
                const displayNo = t.id === 'DONASI' ? '' : currentIndex;

                tableBody.push([
                    displayNo,
                    formattedDate,
                    t.uraian,
                    t.kategori, 
                    formatRupiah(t.danaMasuk),
                    formatRupiah(t.danaKeluar),
                    formatRupiah(runningBalance)
                ]);
            });

            tableBody.push([
                { content: 'TOTAL AKUMULASI KAS:', colSpan: 4, styles: { fillColor: [209, 213, 219], fontStyle: 'bold', halign: 'right' } },
                { content: formatRupiah(totalMasuk), styles: { fillColor: [178, 245, 178], fontStyle: 'bold', halign: 'right', fontSize: 9 } }, 
                { content: formatRupiah(totalKeluar), styles: { fillColor: [255, 192, 203], fontStyle: 'bold', halign: 'right', fontSize: 9 } }, 
                { content: formatRupiah(runningBalance), styles: { fillColor: [173, 216, 230], fontStyle: 'bold', halign: 'right', fontSize: 9 } }, 
            ]);


             doc.autoTable({
                head: header,
                body: tableBody,
                startY: 30,
                theme: 'striped',
                headStyles: { 
                    fillColor: [5, 150, 105], 
                    fontSize: 9,
                    columnStyles: {
                        4: { halign: 'right' },
                        5: { halign: 'right' },
                        6: { halign: 'right' }
                    }
                }, 
                bodyStyles: { fontSize: 8 }, 
                columnStyles: {
                    4: { halign: 'right', minCellWidth: 25 }, 
                    5: { halign: 'right', minCellWidth: 25 }, 
                    6: { halign: 'right', minCellWidth: 25 }  
                },
                didParseCell: (data) => {
                    if (data.row.index < tableBody.length - 1) { 
                        if (data.column.index >= 4 && data.column.index <= 6) {
                            data.cell.styles.halign = 'right';
                            data.cell.styles.fontSize = 9; 
                        }
                    }
                }
             });
             
             addSignatures(doc, doc.lastAutoTable.finalY + 10);
             doc.save("LPJ_Jurnal_Detail.pdf");
        };

        window.exportLpjGlobalPDF = () => {
            const doc = setupPDF("Laporan Global LPJ (Ringkasan Per Kategori)");
            
            const totalDonasi = allTransactions.reduce((sum, t) => sum + t.nilai, 0); 
            const totalMasuk = totalDonasi;
            const totalKeluar = jurnalTransactions.reduce((sum, t) => sum + t.danaKeluar, 0);
            const saldoAkhir = totalMasuk - totalKeluar;
            
            const jurnalSummary = jurnalTransactions.reduce((acc, t) => {
                acc[t.kategori] = (acc[t.kategori] || 0) + t.danaKeluar;
                return acc;
            }, {});

            const tableBody = [];
            const header = [['URAIAN', 'JUMLAH (Rp)']]; 

            tableBody.push([{ content: 'DANA MASUK', colSpan: 2, styles: { fontStyle: 'bold', fillColor: [178, 245, 178] } }]);
            tableBody.push(['Donatur (Total Donasi)', { content: formatRupiah(totalDonasi || 0), styles: { halign: 'right' } }]);
            tableBody.push([{ content: 'TOTAL DANA MASUK', colSpan: 1, styles: { fontStyle: 'bold', fillColor: [144, 238, 144] } }, { content: formatRupiah(totalMasuk || 0), styles: { fontStyle: 'bold', halign: 'right', fillColor: [144, 238, 144] } }]);
            
            tableBody.push([{ content: 'DANA KELUAR', colSpan: 2, styles: { fontStyle: 'bold', fillColor: [255, 192, 203] } }]);
            
            const categories = [
                { name: 'Ongkos Kiai', key: 'Ongkos Kiai' },
                { name: 'Bayar Khataman', key: 'Bayar Khataman' },
                { name: 'Bayar Konsumsi', key: 'Bayar Konsumsi' },
                { name: 'Bayar Persewaan', key: 'Bayar Persewaan' },
                { name: 'Bayar Pekerja', key: 'Bayar Pekerja' },
                { name: 'Lain-lain', key: 'Lain-lain' }
            ];

            categories.forEach(cat => {
                const amount = jurnalSummary[cat.key] || 0;
                if (amount > 0) {
                    tableBody.push([cat.name, { content: formatRupiah(amount), styles: { halign: 'right' } }]);
                }
            });

            tableBody.push([{ content: 'TOTAL DANA KELUAR', colSpan: 1, styles: { fontStyle: 'bold', fillColor: [255, 182, 193] } }, { content: formatRupiah(totalKeluar || 0), styles: { fontStyle: 'bold', halign: 'right', fillColor: [255, 182, 193] } }]);

            tableBody.push([{ content: 'SALDO AKHIR', colSpan: 1, styles: { fontStyle: 'bold', fillColor: [173, 216, 230] } }, { content: formatRupiah(saldoAkhir || 0), styles: { fontStyle: 'bold', halign: 'right', fillColor: [255, 255, 153] } }]);
            
            doc.autoTable({
                head: header,
                body: tableBody,
                startY: 30,
                theme: 'striped',
                headStyles: { 
                    fillColor: [107, 70, 193],
                    fontSize: 9.5,
                    cellPadding: [2, 0.5, 2, 4], 
                    cellStyles: { 
                        1: { halign: 'right' } 
                    },
                },
                columnStyles: {
                    0: { columnWidth: 'wrap', cellPadding: [2, 4, 2, 4] }, 
                    1: { 
                        halign: 'right', 
                        columnWidth: 40,
                        cellPadding: [2, 0, 2, 4] 
                    } 
                }
            });
            
            addSignatures(doc, doc.lastAutoTable.finalY + 10);
            doc.save("LPJ_Global_Ringkasan.pdf");
        };


        // --------------------------------------------------------------------------------
        // 6. RENDER ALL DAN ONLOAD
        // --------------------------------------------------------------------------------

        const renderAllTables = () => {
            // Urutkan donatur sebelum merender
            allTransactions.sort((a, b) => a.timestamp - b.timestamp);
            const totalDonasi = renderDonaturTable(allTransactions, currentDonaturPage);
            renderJurnalTable(totalDonasi, currentJurnalPage);
        };

        window.onload = async () => { 
            
            // PERBAIKAN UTAMA: INI HARUS DIJALANKAN DI SINI UNTUK MENGHILANGKAN ERROR MERAH
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth(); 
            
            await loadTransactions(); 
            
            // Listener status autentikasi: fungsi handleAuthStateChange akan dipanggil
            // secara otomatis saat status login berubah (login/logout/load halaman)
            auth.onAuthStateChanged((user) => {
                handleAuthStateChange(user); 
                renderAllTables(); 
            });

            // *PENTING: Panggil ini untuk menampilkan Donatur sebagai tab default*
            showTab('donatur'); 
        };
    </script>

</body>
</html>



