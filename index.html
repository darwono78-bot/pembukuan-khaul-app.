<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catatan Jariyah Haul - Pencatatan Keuangan</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font: Inter for modern look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for elegance and readability */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .container-main {
            max-width: 100%;
            padding: 1rem;
        }
        @media (min-width: 640px) {
            .container-main {
                max-width: 1280px;
                padding: 2rem;
            }
        }
        .table-header {
            background-color: #1f2937; /* Dark header */
            color: white;
            font-weight: 600;
        }
        .data-row:nth-child(even) {
            background-color: #f9fafb; /* Subtle zebra striping */
        }
        /* Custom scrollbar for table on mobile */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        /* Style for total box */
        .total-box {
            background-color: #4f46e5; /* Primary purple color */
            color: white;
        }
    </style>
</head>
<body>

<!-- Main Application Wrapper -->
<div id="app" class="container-main mx-auto">
    
    <!-- Header -->
    <header class="text-center py-6 bg-white shadow-lg rounded-xl mb-6">
        <h1 class="text-3xl font-extrabold text-gray-900">Catatan Keuangan Jariyah Haul</h1>
        <p class="text-sm text-gray-500 mt-1">Aplikasi Pencatatan Jariyah Real-time dan Responsif</p>
    </header>

    <!-- Data Entry Form -->
    <div class="bg-white p-6 shadow-xl rounded-xl mb-6 border border-indigo-200">
        <h2 class="text-xl font-semibold mb-4 text-indigo-700">Input Data Jariyah Baru</h2>
        <form id="jariyah-form" class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <!-- Tanggal (Date) -->
            <input type="date" id="tanggal" required class="col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" title="Tanggal">
            
            <!-- Nama (Name) -->
            <input type="text" id="nama" placeholder="Nama Donatur (Wajib)" required class="col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" title="Nama Donatur">
            
            <!-- Alamat (Address) -->
            <input type="text" id="alamat" placeholder="Alamat (Opsional)" class="col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" title="Alamat">
            
            <!-- Jariyah (Amount) -->
            <input type="number" id="jumlah" placeholder="Jumlah Jariyah (Wajib)" required min="1" class="col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" title="Jumlah Jariyah">
            
            <!-- Tombol Tambah (Submit Button) -->
            <button type="submit" class="col-span-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                Tambah Catatan
            </button>
        </form>
    </div>

    <!-- Data Table & Summary -->
    <div class="bg-white p-6 shadow-xl rounded-xl border border-gray-200">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
            <h2 class="text-xl font-semibold text-gray-800 mb-2 sm:mb-0">Daftar Catatan Jariyah</h2>
            <!-- Total Jariyah Box -->
            <div class="total-box p-3 rounded-lg text-center shadow-lg min-w-[200px]">
                <p class="text-xs font-light opacity-80">Total Jariyah</p>
                <p id="total-jumlah" class="text-2xl font-extrabold">Rp 0</p>
            </div>
        </div>

        <!-- Table Wrapper for horizontal scrolling on mobile -->
        <div class="table-wrapper">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="table-header">
                    <tr>
                        <th scope="col" class="px-3 py-3 text-left text-xs uppercase tracking-wider rounded-tl-lg w-12">No.</th>
                        <th scope="col" class="px-3 py-3 text-left text-xs uppercase tracking-wider w-24">Tanggal</th>
                        <th scope="col" class="px-3 py-3 text-left text-xs uppercase tracking-wider min-w-[150px]">Nama Donatur</th>
                        <th scope="col" class="px-3 py-3 text-left text-xs uppercase tracking-wider min-w-[200px]">Alamat</th>
                        <th scope="col" class="px-3 py-3 text-left text-xs uppercase tracking-wider min-w-[120px]">Jariyah</th>
                        <th scope="col" class="px-3 py-3 text-center text-xs uppercase tracking-wider rounded-tr-lg w-16">Aksi</th>
                    </tr>
                </thead>
                <tbody id="jariyah-list" class="bg-white divide-y divide-gray-200">
                    <!-- Data will be inserted here by JavaScript -->
                    <tr>
                        <td colspan="6" class="p-4 text-center text-gray-500">Memuat data...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Control Panel -->
    <div class="mt-6 flex justify-between items-center p-4 bg-white rounded-xl shadow-lg border border-red-200">
        <!-- Rata Kiri: Reset Data -->
        <button id="reset-data" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out text-sm md:text-base">
            <span class="font-bold mr-1">⚠️</span> Reset Semua Data
        </button>

        <!-- Rata Kanan: User Info & Log Out -->
        <div class="flex items-center space-x-4">
            <p id="user-info" class="text-sm text-gray-600 truncate hidden sm:block">User ID: Memuat...</p>
            <button id="logout" class="bg-gray-700 hover:bg-gray-800 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out text-sm md:text-base">
                Log Out
            </button>
        </div>
    </div>

    <!-- Custom Modal/Notification Area -->
    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div id="custom-modal" class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300 scale-95 opacity-0">
            <h3 id="modal-title" class="text-lg font-bold text-gray-800 mb-3">Peringatan</h3>
            <p id="modal-message" class="text-sm text-gray-600 mb-4"></p>
            <div id="modal-actions" class="flex justify-end space-x-3">
                <button id="modal-cancel" class="px-4 py-2 text-sm font-semibold rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition">Batal</button>
                <button id="modal-confirm" class="px-4 py-2 text-sm font-semibold rounded-lg bg-red-600 text-white hover:bg-red-700 transition">Konfirmasi</button>
            </div>
        </div>
    </div>

</div>

<!-- Firebase and App Script -->
<script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, 
        signInAnonymously, 
        signInWithCustomToken, 
        signOut,
        onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, 
        collection, 
        addDoc, 
        deleteDoc, 
        doc, 
        query, 
        onSnapshot, 
        getDocs, 
        writeBatch,
        serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-lite.js";

    // IMPORTANT: Use the global variables provided by the environment
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

    // 1. Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    // Set Firestore log level to debug for better monitoring
    setLogLevel('Debug');

    let userId = null;
    let isAuthReady = false;

    // DOM elements
    const jariyahForm = document.getElementById('jariyah-form');
    const jariyahList = document.getElementById('jariyah-list');
    const totalJumlahElement = document.getElementById('total-jumlah');
    const logoutButton = document.getElementById('logout');
    const resetButton = document.getElementById('reset-data');
    const userInfoElement = document.getElementById('user-info');

    // Helper functions for UI
    const formatRupiah = (number) => {
        return new Intl.NumberFormat('id-ID', {
            style: 'currency',
            currency: 'IDR',
            minimumFractionDigits: 0
        }).format(number);
    };

    const showModal = (title, message, isConfirm = false, onConfirm = () => {}) => {
        const modalContainer = document.getElementById('modal-container');
        const modal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalActions = document.getElementById('modal-actions');

        modalTitle.textContent = title;
        modalMessage.textContent = message;
        
        // Setup actions visibility
        if (isConfirm) {
            modalActions.classList.remove('hidden');
            document.getElementById('modal-confirm').onclick = () => {
                onConfirm();
                hideModal();
            };
            document.getElementById('modal-cancel').onclick = hideModal;
        } else {
            // For simple alerts, we only show a close button (or just hide actions)
            modalActions.classList.add('hidden');
            // We can add a simple close button if needed, but for now, we just show the message
        }

        modalContainer.classList.remove('hidden', 'items-center', 'justify-center');
        modalContainer.classList.add('flex', 'items-center', 'justify-center');
        setTimeout(() => {
            modal.classList.remove('scale-95', 'opacity-0');
            modal.classList.add('scale-100', 'opacity-100');
        }, 10);
    };

    const hideModal = () => {
        const modalContainer = document.getElementById('modal-container');
        const modal = document.getElementById('custom-modal');
        modal.classList.remove('scale-100', 'opacity-100');
        modal.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            modalContainer.classList.remove('flex', 'items-center', 'justify-center');
            modalContainer.classList.add('hidden');
        }, 300);
    };

    // 2. Authentication Setup
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            userId = user.uid;
            userInfoElement.textContent = `User ID: ${userId}`;
            userInfoElement.classList.remove('hidden');
            isAuthReady = true;
            console.log('User signed in with UID:', userId);
            // Once auth is ready, start listening to data
            setupRealtimeListener();
        } else {
            // Attempt initial sign-in
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                showModal("Kesalahan Otentikasi", "Gagal melakukan sign in. Silakan periksa koneksi atau konfigurasi Firebase.");
            }
        }
    });

    // 3. Firestore Functions

    // Get the collection reference (Private Data)
    const getCollectionRef = () => {
        if (!userId) {
            console.error("Error: User ID is not defined.");
            return null;
        }
        // Collection path: /artifacts/{appId}/users/{userId}/jariyah_records
        return collection(db, `artifacts/${appId}/users/${userId}/jariyah_records`);
    };

    // Add new document
    jariyahForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!isAuthReady || !userId) {
            showModal("Gagal", "Otentikasi belum selesai. Mohon tunggu sebentar.");
            return;
        }

        const ref = getCollectionRef();
        if (!ref) return;

        const data = {
            tanggal: document.getElementById('tanggal').value,
            nama: document.getElementById('nama').value,
            alamat: document.getElementById('alamat').value || '-',
            jumlah: parseInt(document.getElementById('jumlah').value, 10),
            timestamp: serverTimestamp() // Add timestamp for ordering
        };

        try {
            await addDoc(ref, data);
            // Clear the form after successful submission
            jariyahForm.reset();
            // Reset date field to current date after submission for convenience
            document.getElementById('tanggal').valueAsDate = new Date(); 
            console.log("Document successfully written!");
        } catch (e) {
            console.error("Error adding document: ", e);
            showModal("Gagal Menambah Data", "Terjadi kesalahan saat menyimpan data ke database. Coba lagi.");
        }
    });

    // Delete document
    const deleteRecord = async (docId) => {
        if (!isAuthReady || !userId) {
            showModal("Gagal", "Otentikasi belum selesai.");
            return;
        }
        
        const ref = getCollectionRef();
        if (!ref) return;

        try {
            await deleteDoc(doc(ref, docId));
            console.log("Document successfully deleted!");
        } catch (e) {
            console.error("Error deleting document: ", e);
            showModal("Gagal Menghapus Data", "Terjadi kesalahan saat menghapus data. Coba lagi.");
        }
    };

    // Real-time listener (onSnapshot)
    const setupRealtimeListener = () => {
        if (!isAuthReady || !userId) {
            console.log("Waiting for Auth to be ready before setting up listener.");
            return;
        }

        const ref = getCollectionRef();
        if (!ref) return;

        // Create a query to order by timestamp (newest first)
        // NOTE: Firestore automatically handles the query creation based on security rules.
        // We avoid explicit orderBy() to prevent indexing issues in the Canvas environment.
        const q = query(ref); 

        // onSnapshot to listen for real-time changes
        onSnapshot(q, (snapshot) => {
            let records = [];
            let totalJumlah = 0;
            
            snapshot.forEach((doc) => {
                const data = doc.data();
                records.push({ id: doc.id, ...data });
                totalJumlah += data.jumlah || 0;
            });

            // Sort data locally by timestamp descending (newest first)
            records.sort((a, b) => {
                const timeA = a.timestamp?.toMillis() || 0;
                const timeB = b.timestamp?.toMillis() || 0;
                return timeB - timeA;
            });


            // Update UI
            renderJariyahList(records);
            totalJumlahElement.textContent = formatRupiah(totalJumlah);
        }, (error) => {
            console.error("Error listening to Firestore: ", error);
            showModal("Kesalahan Database", "Gagal memuat data real-time. Periksa koneksi internet Anda.");
        });
    };
    
    // Render list function
    const renderJariyahList = (records) => {
        jariyahList.innerHTML = ''; // Clear existing list
        if (records.length === 0) {
            jariyahList.innerHTML = `
                <tr>
                    <td colspan="6" class="p-4 text-center text-gray-500 italic">Belum ada catatan jariyah. Silakan tambahkan data baru.</td>
                </tr>
            `;
            return;
        }

        records.forEach((record, index) => {
            const row = document.createElement('tr');
            row.className = 'data-row hover:bg-indigo-50 transition duration-150';

            // Format date string for display
            const formattedDate = record.tanggal ? new Date(record.tanggal).toLocaleDateString('id-ID', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            }) : '-';
            
            // Format number with IDR currency
            const formattedJumlah = formatRupiah(record.jumlah);
            
            // Generate table cell (td) content
            row.innerHTML = `
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">${index + 1}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-900 font-medium">${formattedDate}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-900">${record.nama}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">${record.alamat}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm font-semibold text-green-600">${formattedJumlah}</td>
                <td class="px-3 py-3 whitespace-nowrap text-center">
                    <button class="delete-btn text-red-600 hover:text-red-900 p-2 rounded-full hover:bg-red-100 transition" data-id="${record.id}" title="Hapus Catatan">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 6h6v10H7V6z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </td>
            `;

            // Attach delete event listener
            row.querySelector('.delete-btn').addEventListener('click', (e) => {
                const docId = e.currentTarget.dataset.id;
                showModal("Konfirmasi Hapus", `Apakah Anda yakin ingin menghapus catatan Jariyah dari ${record.nama}?`, true, () => deleteRecord(docId));
            });

            jariyahList.appendChild(row);
        });
    };

    // 4. Control Panel Actions

    // Logout function
    logoutButton.addEventListener('click', async () => {
        showModal("Konfirmasi Log Out", "Apakah Anda yakin ingin keluar? Anda mungkin akan login sebagai pengguna anonim baru jika tidak ada token khusus.", true, async () => {
            try {
                await signOut(auth);
                console.log("User logged out.");
                showModal("Sukses", "Anda telah berhasil Log Out.", false);
                // AuthStateChanged will re-trigger sign in
            } catch (error) {
                console.error("Error signing out: ", error);
                showModal("Gagal Log Out", "Terjadi kesalahan saat keluar. Coba lagi.");
            }
        });
    });

    // Reset Data function
    resetButton.addEventListener('click', () => {
        showModal("KONFIRMASI RESET DATA KRITIS", "⚠️ PERINGATAN! Ini akan **menghapus SEMUA data jariyah** Anda secara permanen. Tindakan ini tidak bisa dibatalkan. Lanjutkan?", true, async () => {
            if (!isAuthReady || !userId) {
                showModal("Gagal", "Otentikasi belum selesai.");
                return;
            }

            const ref = getCollectionRef();
            if (!ref) return;

            try {
                const snapshot = await getDocs(ref);
                if (snapshot.empty) {
                    showModal("Info", "Tidak ada data untuk direset.", false);
                    return;
                }

                const batch = writeBatch(db);
                snapshot.docs.forEach((d) => {
                    batch.delete(d.ref);
                });

                await batch.commit();
                showModal("Sukses Reset", "Semua data jariyah berhasil dihapus.", false);
            } catch (e) {
                console.error("Error resetting data: ", e);
                showModal("Gagal Reset", "Terjadi kesalahan saat menghapus data secara massal. Coba lagi.");
            }
        });
    });
    
    // Set default date to today for convenience on load
    document.getElementById('tanggal').valueAsDate = new Date(); 

</script>
</body>
</html>
