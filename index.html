<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pembukuan Donasi Haul</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dark-green': '#1a472a', // Main background green
                        'medium-green': '#2b6e49', // Card background green
                        'yellow-accent': '#ffeb3b', // Yellow for buttons/highlights
                        'red-danger': '#ef5350', // Red for danger actions
                        'text-light': '#e0e0e0', // Light text color
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #1a472a;
            color: #e0e0e0;
        }
        
        /* ðŸ’¡ FINAL ATTEMPT: Efek Sinar Emas Lembut Menyeluruh pada Bingkai Luar */
        .max-w-6xl {
            /* Hapus border tipis sebelumnya, fokus pada shadow */
            /* Menggunakan beberapa lapisan box-shadow yang lebih agresif untuk efek yang mirip gambar */
            box-shadow: 
                0 0 80px 30px rgba(255, 235, 59, 0.4),   /* Lapisan inti, lebih cerah dan tebal */
                0 0 150px 70px rgba(255, 235, 59, 0.25), /* Lapisan menengah, sangat menyebar */
                0 0 250px 100px rgba(255, 235, 59, 0.1); /* Lapisan terluar, super lembut dan luas */
            border: 1px solid rgba(255, 235, 59, 0.5); /* Tambahkan border kuning tipis yang menyatu dengan glow */
        }

        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none;
          margin: 0;
        }
        ::placeholder {
            color: #a0a0a0;
            opacity: 1;
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
        
        /* Style untuk Tabel Header */
        #donatur-table th {
            font-size: 0.75rem; /* text-xs */
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
        }
        
        /* Style untuk Konten Tabel - FONT SAMA RATA & PADDING */
        #donatur-table td {
            padding: 0.75rem 1rem; 
            vertical-align: top;
            font-weight: normal; 
            font-size: 0.875rem; /* Ukuran seragam (text-sm) */
        }

        /* Wrapper Tabel */
        .table-wrapper {
            /* Tetap berikan shadow dan border pada tabel untuk menonjolkan kontennya */
            box-shadow: 0 0 20px rgba(255, 235, 59, 0.2); 
            border: 1px solid #ffeb3b; 
        }
        
        /* Style khusus untuk kolom agar rapi */
        #donatur-table .nilai-kolom {
            width: 150px; 
            min-width: 150px;
        }
        #donatur-table .kumulatif-kolom {
            width: 170px; 
            min-width: 170px;
            font-weight: normal; 
        }
        #donatur-table .kolom-no {
            width: 40px; 
            text-align: center;
        }
        #donatur-table .kolom-tanggal {
            width: 100px; 
            min-width: 100px;
        }
        /* Style untuk footer agar tetap tebal dan menonjol */
        #donatur-table tfoot td {
            font-weight: bold;
            font-size: 1.125rem; /* text-lg untuk footer (total) */
        }
    </style>
</head>
<body class="bg-dark-green p-4 sm:p-10">

    <div class="max-w-6xl mx-auto rounded-xl shadow-2xl overflow-hidden">
        
        <div class="bg-dark-green text-text-light py-4 px-6 flex justify-center items-center">
            <h1 class="text-3xl font-bold text-center text-yellow-accent">
                Catatan Pembukuan Donatur Haul
            </h1>
        </div>

        
        <div class="bg-medium-green p-8 text-text-light">

            <h2 class="text-2xl font-bold mb-4 text-yellow-accent border-b border-yellow-accent/50 pb-3">
                Ringkasan Data Transaksi
            </h2>
            <div class="table-wrapper overflow-x-auto shadow-lg rounded-xl mb-10">
                <table id="donatur-table" class="min-w-full divide-y divide-text-light/20">
                    <thead class="bg-dark-green/80 text-text-light">
                        <tr>
                            <th class="px-4 py-3 text-left font-bold uppercase tracking-wider rounded-tl-xl kolom-no">NO</th>
                            <th class="px-4 py-3 text-left font-bold uppercase tracking-wider kolom-tanggal">TANGGAL</th>
                            <th class="px-4 py-3 text-left font-bold uppercase tracking-wider">NAMA DONATUR</th>
                            <th class="px-4 py-3 text-left font-bold uppercase tracking-wider">ALAMAT</th>
                            <th class="px-4 py-3 text-right font-bold uppercase tracking-wider nilai-kolom">NILAI (RP)</th>
                            <th class="px-4 py-3 text-right font-bold uppercase tracking-wider rounded-tr-xl kumulatif-kolom">JUMLAH JARIYAH (KUMULATIF)</th>
                        </tr>
                    </thead>
                    <tbody id="donatur-table-body" class="bg-medium-green/50 divide-y divide-text-light/10">
                        <tr><td colspan="6" class="py-6 text-center text-text-light/70">Memuat data...</td></tr>
                    </tbody>
                    <tfoot>
                        <tr class="bg-dark-green/80 font-extrabold border-t-2 border-yellow-accent">
                            <td colspan="4" class="px-4 py-3 text-right text-yellow-accent">TOTAL DONASI KESELURUHAN:</td>
                            <td class="px-4 py-3 text-right text-yellow-accent"></td> 
                            <td id="total-akumulasi-donasi" class="px-4 py-3 text-right text-yellow-accent">0</td> 
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div id="donasi-input-container" class="p-6 rounded-xl bg-dark-green/50 shadow-lg mb-10 hidden">
                <h2 class="text-2xl font-bold mb-6 text-yellow-accent border-b border-yellow-accent/50 pb-3">
                    Input Data Donatur Baru
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="date" id="donatur-date-input" class="p-3 border border-text-light/30 rounded-lg w-full bg-medium-green/50 text-text-light focus:ring-yellow-accent focus:border-yellow-accent" required>
                    
                    <input type="text" id="donatur-name-input" class="p-3 border border-text-light/30 rounded-lg w-full bg-medium-green/50 text-text-light placeholder:text-text-light/60 focus:ring-yellow-accent focus:border-yellow-accent" placeholder="Nama Donatur (Contoh: Saripin)" required>
                    
                    <input type="text" id="donatur-alamat-input" class="p-3 border border-text-light/30 rounded-lg w-full bg-medium-green/50 text-text-light placeholder:text-text-light/60 focus:ring-yellow-accent focus:border-yellow-accent" placeholder="Alamat (Contoh: Ngablak)" required>
                    
                    <input type="number" id="donasi-nilai-input" class="p-3 border border-text-light/30 rounded-lg w-full bg-medium-green/50 text-text-light placeholder:text-text-light/60 focus:ring-yellow-accent focus:border-yellow-accent text-right" placeholder="Nilai Donasi (Rp)" required>
                </div>
                
                <button onclick="addDonatur()" class="bg-yellow-accent text-dark-green py-3 px-6 rounded-lg hover:bg-yellow-accent/90 w-full font-bold transition duration-150 shadow-md mt-6">
                    Simpan Donasi
                </button>
            </div>
            
            <div class="p-4 rounded-xl bg-dark-green/50 shadow-inner">
                
                <div id="login-form-container" class="flex flex-grow justify-end items-center gap-4">
                    <input type="email" id="admin-email-input" class="p-2 border border-text-light/30 rounded bg-medium-green/50 text-text-light placeholder:text-text-light/60 focus:ring-yellow-accent focus:border-yellow-accent" placeholder="Email Admin" value="darwono78@gmail.com" required>
                    <input type="password" id="admin-password-input" class="p-2 border border-text-light/30 rounded bg-medium-green/50 text-text-light placeholder:text-text-light/60 focus:ring-yellow-accent focus:border-yellow-accent" placeholder="Password Admin" value="haul2025" required>
                    <button onclick="adminLogin()" class="bg-yellow-accent text-dark-green py-2 px-4 rounded hover:bg-yellow-accent/90 font-semibold transition duration-150 shadow-md">
                        Login Admin
                    </button>
                </div>
                
                <div id="admin-actions-container" class="hidden mt-4">
                    <div class="flex justify-between items-center gap-4">
                        <button onclick="confirmResetData()" class="bg-red-danger text-white py-2 px-4 rounded hover:bg-red-danger/90 text-sm transition duration-150 shadow-md">
                            Reset Data (Hapus Permanen)
                        </button>
                        
                        <button onclick="adminLogout()" class="bg-red-danger text-white py-2 px-4 rounded hover:bg-red-danger/90 text-sm transition duration-150 shadow-md">
                            Logout
                        </button>
                    </div>
                    <p class="text-sm font-semibold mt-3 text-yellow-accent/80 text-right">Mode Admin Aktif.</p>
                </div>
            </div>
            
        </div>
        
    </div>

    <script type="module">
        
        // --------------------------------------------------------------------------------
        // 1. FIREBASE SETUP DAN KONFIGURASI
        // --------------------------------------------------------------------------------
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, query, orderBy, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAHIO0RZgoq6eyjeERTpjOugzJLzqG2S-w",
            authDomain: "catatan-keuangan-haul.firebaseapp.com",
            projectId: "catatan-keuangan-haul",
            storageBucket: "catatan-keuangan-haul.appspot.com",
            messagingSenderId: "955355049778",
            appId: "1:955355049778:web:0b844b27b82a88cc0cf12b"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const donaturCol = collection(db, "transaksi_haul"); 

        let allDonatur = []; 
        let isAdminLoggedIn = false; 

        // --------------------------------------------------------------------------------
        // 2. HELPER FUNCTIONS
        // --------------------------------------------------------------------------------

        const formatRupiah = (angka) => {
            if (typeof angka !== 'number') return '0';
            const sign = angka < 0 ? '-' : '';
            const absoluteAngka = Math.abs(Math.floor(angka));
            const numberString = absoluteAngka.toString();
            // Format angka dengan titik sebagai pemisah ribuan
            const rupiah = numberString.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            return sign + rupiah;
        };

        const updateFooter = (id, value) => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = formatRupiah(value);
            }
        };
        
        const updateAdminView = () => {
            const isLogged = isAdminLoggedIn;
            
            document.getElementById('login-form-container')?.classList.toggle('hidden', isLogged);
            document.getElementById('admin-actions-container')?.classList.toggle('hidden', !isLogged);
            document.getElementById('donasi-input-container')?.classList.toggle('hidden', !isLogged);
        };

        // --------------------------------------------------------------------------------
        // 3. FIREBASE AUTH LOGIC (LOGIN/LOGOUT)
        // --------------------------------------------------------------------------------

        onAuthStateChanged(auth, (user) => {
            if (user) {
                isAdminLoggedIn = true;
                console.log("Status Admin: LOGIN BERHASIL");
            } else {
                isAdminLoggedIn = false;
                console.log("Status Admin: LOGOUT");
            }
            updateAdminView();
            loadAndRenderDonatur(); 
        });


        window.adminLogin = async () => {
            const email = document.getElementById('admin-email-input').value;
            const password = document.getElementById('admin-password-input').value;
            
            if (!email || !password) {
                alert('Mohon masukkan Email dan Password Admin.');
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
                
            } catch (error) {
                console.error("Login Error:", error.code);
                let errorMessage = 'Login Gagal. ';
                if (error.code === 'auth/wrong-password') {
                    errorMessage += 'Password salah.';
                } else if (error.code === 'auth/user-not-found') {
                    errorMessage += 'Akun Admin tidak ditemukan.';
                } else {
                    errorMessage += 'Terjadi kesalahan sistem.';
                }
                alert(errorMessage);
            }
        };

        window.adminLogout = async () => {
            if (confirm('Anda yakin ingin keluar dari mode Bendahara?')) {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error("Logout Error:", error);
                    alert(`Logout Gagal: ${error.message}`);
                }
            }
        };
        
        window.confirmResetData = async () => {
             if (!isAdminLoggedIn) return alert('Hanya Bendahara yang dapat mereset data.');
             
             if (!confirm('PERINGATAN! Anda yakin ingin MENGHAPUS SEMUA data Donasi? Tindakan ini tidak bisa dibatalkan.')) return;
             
             if (!confirm('KONFIRMASI TERAKHIR: Ini akan menghapus PERMANEN semua donasi di Firebase. LANJUTKAN?')) return;
             
             try {
                const donaturSnapshot = await getDocs(donaturCol);
                const batch = writeBatch(db); 
                
                donaturSnapshot.docs.forEach((d) => {
                    batch.delete(doc(db, "transaksi_haul", d.id));
                });
                
                await batch.commit();

                alert('SEMUA DATA DONASI BERHASIL DIHAPUS PERMANEN DARI FIREBASE.');
                await loadAndRenderDonatur();
             } catch (error) {
                 console.error("Gagal mereset data:", error);
                 alert('Gagal menghapus data di Firestore. Cek console log.');
             }
        };


        // --------------------------------------------------------------------------------
        // 4. FIRESTORE CRUD (CREATE & READ)
        // --------------------------------------------------------------------------------

        const loadAndRenderDonatur = async () => {
            allDonatur = [];
            const tableBody = document.getElementById('donatur-table-body');
            tableBody.innerHTML = `<tr><td colspan="6" class="py-6 text-center text-text-light/70">Memuat data dari Firebase...</td></tr>`;

            try {
                const donaturQuery = query(donaturCol, orderBy("timestamp", "asc")); 
                const donaturSnapshot = await getDocs(donaturQuery);

                donaturSnapshot.forEach(doc => {
                    const data = doc.data();
                    allDonatur.push({
                        id: doc.id, 
                        date: data.date,
                        nama: data.nama || data.uraian || 'Tanpa Nama',
                        alamat: data.alamat || '-',
                        nilai: data.nilai || data.danaMasuk || 0, 
                        timestamp: data.timestamp ? data.timestamp.toMillis() : new Date(data.date).getTime(), 
                    });
                });
                
                renderDonaturTable();
                
            } catch (error) {
                console.error("Gagal memuat data dari Firestore:", error);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="py-6 text-center text-red-danger">
                            ðŸ”´ GAGAL MEMUAT DATA. Cek Koneksi Internet atau Konfigurasi Firebase.
                        </td>
                    </tr>`;
            }
        };
        
        window.addDonatur = async () => {
            if (!isAdminLoggedIn) return alert('Hanya Bendahara yang dapat menginput data. Mohon Login terlebih dahulu.');

            const date = document.getElementById('donatur-date-input').value;
            const nama = document.getElementById('donatur-name-input').value; 
            const alamat = document.getElementById('donatur-alamat-input').value;
            let nilai = parseInt(document.getElementById('donasi-nilai-input').value) || 0;
            
            if (!date || !nama || !nilai || nilai <= 0) {
                alert('Mohon isi Tanggal, Nama Donatur, dan Nilai Donasi yang valid.');
                return;
            }

            const newDonasi = {
                date: date,
                nama: nama,
                alamat: alamat,
                nilai: nilai,
                timestamp: serverTimestamp() 
            };

            try {
                await addDoc(donaturCol, newDonasi);
                
                document.getElementById('donatur-name-input').value = '';
                document.getElementById('donatur-alamat-input').value = '';
                document.getElementById('donasi-nilai-input').value = '';
                
                alert('Donasi berhasil ditambahkan ke Firebase!');
                await loadAndRenderDonatur(); 
            } catch (error) {
                console.error("Gagal menambahkan Donasi:", error);
                alert("Gagal menyimpan donasi. Cek console log.");
            }
        };

        // --------------------------------------------------------------------------------
        // 5. RENDER DATA (LOGIC KUMULATIF)
        // --------------------------------------------------------------------------------

        const renderDonaturTable = () => {
            const tableBody = document.getElementById('donatur-table-body');
            tableBody.innerHTML = '';
            
            let totalNilaiDonasi = 0;
            let totalAkumulasiDonasi = 0;
            
            if (allDonatur.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="py-6 text-center text-text-light/70">Belum ada data donasi yang dicatat.</td></tr>`;
                updateFooter('total-akumulasi-donasi', 0); 
                return;
            }

            allDonatur.forEach((d, index) => {
                totalNilaiDonasi += d.nilai;
                totalAkumulasiDonasi += d.nilai; 

                const row = tableBody.insertRow();
                
                // Format tanggal DD/MM/YYYY
                const dateObj = new Date(d.date + 'T00:00:00');
                const formattedDate = dateObj.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' });
                
                // Hapus semua class font spesifik di dalam <td> untuk memastikan seragam
                row.innerHTML = `
                    <td class="px-4 py-3 kolom-no">${index + 1}</td>
                    <td class="px-4 py-3 kolom-tanggal">${formattedDate}</td>
                    <td class="px-4 py-3">${d.nama}</td>
                    <td class="px-4 py-3">${d.alamat}</td>
                    <td class="px-4 py-3 text-right text-yellow-accent">${formatRupiah(d.nilai)}</td>
                    <td class="px-4 py-3 text-right text-yellow-accent">${formatRupiah(totalAkumulasiDonasi)}</td>
                `;
            });

            // Update Footer Total: Hanya Kumulatif yang diisi
            updateFooter('total-akumulasi-donasi', totalAkumulasiDonasi); 
        };

        // --------------------------------------------------------------------------------
        // 6. INISIALISASI
        // --------------------------------------------------------------------------------

        window.onload = () => {
            const today = new Date().toLocaleDateString('en-CA');
            const dateInput = document.getElementById('donatur-date-input');
            if (dateInput) {
                dateInput.value = today;
            }
        };
    </script>
</body>
</html>
