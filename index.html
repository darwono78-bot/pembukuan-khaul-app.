<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Aplikasi Pembukuan Dana Khaul Online</title>
    
    <style>
        body { font-family: 'Arial', sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; }
        hr { border: 0; border-top: 1px solid #eee; margin: 20px 0; }
        form label { display: block; margin-top: 10px; font-weight: bold; }
        form input, form select, form textarea, form button { width: 100%; padding: 10px; margin-top: 5px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        form button { background-color: #007bff; color: white; border: none; cursor: pointer; margin-top: 15px; }
        form button:hover { background-color: #0056b3; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #e9ecef; }
        .admin-only { background-color: #fff3cd; } 
        #finalSaldo { font-weight: bold; background-color: #d4edda; color: #155724; text-align: right; }
        .dana-masuk { color: green; font-weight: bold; text-align: right; }
        .dana-keluar { color: red; text-align: right; }
        .aksi-btn { padding: 4px 8px; margin: 2px; cursor: pointer; border-radius: 3px; }
        .aksi-btn.edit { background-color: #ffc107; }
        .aksi-btn.delete { background-color: #dc3545; color: white; }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
<div class="container">
    <p id="authStatus"></p>
    
    <div id="loginContainer" style="display: none;">
        <h2>üîê Login Administrator</h2>
        <form id="loginForm">
            <label for="loginEmail">Email:</label>
            <input type="email" id="loginEmail" required>
            <label for="loginPassword">Password:</label>
            <input type="password" id="loginPassword" required>
            <button type="submit">Login</button>
        </form>
        <hr>
    </div>

    <div id="appContainer" style="display: none;">
        
        <h1>üìù Aplikasi Pembukuan Dana Khaul</h1>
        
        <h2>1. Masukkan Donasi (Dana Masuk)</h2>
        <form id="formDonasi">
            <label for="donasiTanggal">Tanggal Donasi (K-2):</label>
            <input type="date" id="donasiTanggal" required>
            <label for="namaDonatur">Nama Donatur (K-3):</label>
            <input type="text" id="namaDonatur" required>
            <label for="alamatDonatur">Alamat (K-4):</label>
            <input type="text" id="alamatDonatur">
            <label for="jumlahJariyah">Jumlah Jariyah/Donasi (Rp) (K-5/6):</label>
            <input type="number" id="jumlahJariyah" min="1" required>
            <button type="submit">Catat Donasi</button>
        </form>
        
        <hr>

        <h2>2. Masukkan Pengeluaran</h2>
        <form id="formPengeluaran">
            <label for="pengeluaranTanggal">Tanggal Transaksi (K-9):</label>
            <input type="date" id="pengeluaranTanggal" required>
            
            <label for="kategori">Kategori Biaya (LPJ) (K-11):</label>
            <select id="kategori" required>
                <option value="">-- Pilih Kategori --</option>
            </select>
            
            <label for="uraian">Uraian / Deskripsi Pengeluaran (K-10):</label>
            <textarea id="uraian" rows="3" required></textarea>
            
            <label for="jumlah">Jumlah Dana Keluar (Rp) (K-12):</label>
            <input type="number" id="jumlah" min="1" required>
            
            <button type="submit">Catat Pengeluaran</button>
        </form>

        <hr>
        
        <h2>3. üìä Dashboard Laporan Kas Berjalan</h2>
        <table id="tabelJurnalKas">
            <thead>
                <tr>
                    <th>No (K-8)</th> 
                    <th>Tanggal (K-9)</th>
                    <th>Uraian (K-10)</th>
                    <th class="admin-only">Kategori (K-11)</th> 
                    <th>Dana Masuk</th>
                    <th>Dana Keluar (K-12)</th>
                    <th>Saldo Berjalan (K-13)</th>
                    <th class="admin-only">Aksi (K-14)</th>
                </tr>
            </thead>
            <tbody id="jurnalBody">
                </tbody>
            <tfoot>
                <tr>
                    <td colspan="6" style="text-align: right; font-weight: bold;">TOTAL SALDO AKHIR:</td>
                    <td colspan="2" id="finalSaldo" style="text-align: right;"></td>
                </tr>
            </tfoot>
        </table>
        
        <button id="downloadLaporanLPJ" style="background-color: green;">Unduh Laporan Pertanggung Jawaban (LPJ) PDF (K-18)</button>
        <button id="downloadListDonatur">Unduh List Donatur PDF (K-16)</button>
        <button id="downloadPengeluaranDetail">Unduh Pengeluaran Detail PDF (K-17)</button>
        
        <button onclick="resetAllData()" style="background-color: red;">Reset Semua Data (K-15)</button>

    </div>
</div>

<script type="module">
    // Import semua fungsi yang diperlukan
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, runTransaction, query, orderBy, getDocs, updateDoc, deleteDoc, Timestamp, where, writeBatch } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";


    // Your web app's Firebase configuration (WAJIB GANTI DENGAN KUNCI ASLI ANDA)
    const firebaseConfig = {
        apiKey: "AIzaSyCLFgGblfLTDvploV-tZGYqAajIzT7t0bc",
        authDomain: "laporan-keuangan-yayasan.firebaseapp.com",
        projectId: "laporan-keuangan-yayasan",
        storageBucket: "laporan-keuangan-yayasan.firebasestorage.app",
        messagingSenderId: "616927572689",
        appId: "1:616927572689:web:3961f22c7a7899e71d8bf0"
    };

    // Inisialisasi Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app); // Inisialisasi Auth

    // =================================================================
    // UTILITY FUNCTIONS & NOMOR URUT AMAN
    // =================================================================
    
    const formatRupiah = (angka) => {
        return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka);
    };
    
    const formatDate = (timestamp) => {
        return (timestamp instanceof Timestamp ? timestamp.toDate() : new Date(timestamp)).toLocaleDateString('id-ID');
    };

    const cleanRupiah = (str) => {
        if (!str) return 0;
        let cleaned = str.replace(/[^\d,\.]/g, ''); 
        cleaned = cleaned.replace(/\./g, '').replace(/,/g, ''); 
        return parseInt(cleaned) || 0;
    };


    const getNextNoTransaksi = async () => {
        const counterRef = doc(db, "metadata", "global_counter");
        let newNo = 0;
        
        try {
            await runTransaction(db, async (transaction) => {
                const counterDoc = await transaction.get(counterRef);
                newNo = (counterDoc.exists() && typeof counterDoc.data().last_no === 'number') ? counterDoc.data().last_no + 1 : 1;
                transaction.set(counterRef, { last_no: newNo });
            });
            return newNo; 
        } catch (e) {
            console.error("Gagal mendapatkan nomor urut: ", e);
            throw new Error("Gagal mengamankan nomor urut transaksi. Cek Firestore Rules.");
        }
    };

    // =================================================================
    // 4. CRUD ACTIONS (Edit & Delete)
    // =================================================================
    
    window.editTransaksi = async (docId, currentUraian, currentJumlah) => {
        if (!auth.currentUser) {
            alert("Anda harus Login untuk mengedit data.");
            return;
        }

        const newUraian = prompt("Masukkan Uraian Transaksi Baru:", currentUraian);
        if (newUraian === null) return; 
        
        let newJumlah = prompt("Masukkan Jumlah Transaksi Baru (Hanya Angka):", currentJumlah);
        newJumlah = parseInt(newJumlah);
        
        if (isNaN(newJumlah) || newJumlah <= 0) {
            alert("Jumlah tidak valid.");
            return;
        }

        try {
            const docRef = doc(db, "jurnal_kas", docId);
            await updateDoc(docRef, {
                uraian: newUraian,
                jumlah: newJumlah
            });
            
            alert("Transaksi berhasil diubah!");
            displayJurnalKas();
            
        } catch (e) {
            alert("Gagal mengedit transaksi. Pastikan Anda sudah Login dan Rules Firebase benar.");
        }
    };

    window.deleteTransaksi = async (docId, noTransaksi, isDonasi = false) => {
        if (!auth.currentUser) {
            alert("Anda harus Login untuk menghapus data.");
            return;
        }

        if (!confirm("Apakah Anda yakin ingin menghapus transaksi ini?")) return;
        
        try {
            await deleteDoc(doc(db, "jurnal_kas", docId));
            
            if (isDonasi) {
                const q = query(collection(db, 'donatur_khaul'), where('no', '==', noTransaksi));
                const snapshot = await getDocs(q);
                snapshot.forEach(async (doc) => {
                    await deleteDoc(doc(db, "donatur_khaul", doc.id));
                });
            }
            
            alert("Transaksi berhasil dihapus!");
            displayJurnalKas(); 
        } catch (e) {
            alert("Gagal menghapus transaksi. Cek Konsol/Rules Firebase.");
        }
    };


    // =================================================================
    // 5. RESET DATA (K-15)
    // =================================================================

    window.resetAllData = async () => {
        if (!auth.currentUser) {
            alert("Anda harus Login untuk melakukan Reset Data.");
            return;
        }
        
        if (!confirm("PERINGATAN: Apakah Anda yakin ingin MENGHAPUS SEMUA DATA JURNAL DAN DONATUR?")) return;
        if (!confirm("KONFIRMASI TERAKHIR: Tindakan ini TIDAK BISA DIBATALKAN. Tekan OK untuk HAPUS SEMUA.")) return;

        try {
            const journalSnapshot = await getDocs(collection(db, "jurnal_kas"));
            const donaturSnapshot = await getDocs(collection(db, "donatur_khaul"));
            
            const batch = writeBatch(db); 

            journalSnapshot.forEach((docEntry) => {
                batch.delete(doc(db, "jurnal_kas", docEntry.id));
            });
            
            donaturSnapshot.forEach((docEntry) => {
                batch.delete(doc(db, "donatur_khaul", docEntry.id));
            });
            
            batch.set(doc(db, "metadata", "global_counter"), { last_no: 0 });

            await batch.commit();

            alert("Semua data berhasil direset dan dihapus!");
            displayJurnalKas(); 

        } catch (e) {
            console.error("Gagal mereset data: ", e);
            alert("Gagal mereset data. Pastikan Anda Login dan Rules Firebase benar.");
        }
    };

    // =================================================================
    // 1. INPUT DONASI (PEMASUKAN)
    // =================================================================

    document.getElementById('formDonasi').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!auth.currentUser) { alert("Anda harus Login untuk mencatat data."); return; }
        
        const donasiTanggal = document.getElementById('donasiTanggal').value;
        const namaDonatur = document.getElementById('namaDonatur').value;
        const alamatDonatur = document.getElementById('alamatDonatur').value;
        const jumlahJariyah = parseInt(document.getElementById('jumlahJariyah').value);

        // ... (Lanjutan kode Donasi sama seperti sebelumnya) ...
        try {
            const nextNo = await getNextNoTransaksi();
            const transactionDate = new Date(donasiTanggal);

            await addDoc(collection(db, "donatur_khaul"), {
                no: nextNo, 
                tanggal: transactionDate, 
                nama_donatur: namaDonatur, 
                alamat: alamatDonatur, 
                jariyah: jumlahJariyah, 
                total_jariyah: jumlahJariyah, 
            });

            await addDoc(collection(db, "jurnal_kas"), {
                no: nextNo, 
                tanggal: transactionDate, 
                uraian: `Donasi dari ${namaDonatur} (${alamatDonatur || 'Tanpa Alamat'})`, 
                kategori: "Dana Masuk (Donasi)", 
                jenis_transaksi: "MASUK",
                jumlah: jumlahJariyah, 
            });

            alert("Donasi berhasil dicatat!");
            document.getElementById('formDonasi').reset();
            displayJurnalKas();
        } catch (e) {
            alert("Gagal mencatat data donasi: " + e.message);
        }
    });


    // =================================================================
    // 2. INPUT PENGELUARAN
    // =================================================================

    function loadKategori() {
        const kategoriSelect = document.getElementById('kategori');
        const q = query(collection(db, "kategori_lpj"), orderBy("nama_kategori", "asc")); 
        
        getDocs(q).then(snapshot => {
            snapshot.forEach(doc => {
                const kategori = doc.data().nama_kategori;
                const option = document.createElement('option');
                option.value = kategori;
                option.textContent = kategori;
                kategoriSelect.appendChild(option);
            });
        }).catch(error => {
            console.error("Gagal memuat kategori: ", error);
        });
    }

    document.getElementById('formPengeluaran').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!auth.currentUser) { alert("Anda harus Login untuk mencatat data."); return; }

        const tanggalInput = document.getElementById('pengeluaranTanggal').value;
        const kategoriInput = document.getElementById('kategori').value;
        const uraianInput = document.getElementById('uraian').value;
        const jumlahInput = parseInt(document.getElementById('jumlah').value);

        // ... (Lanjutan kode Pengeluaran sama seperti sebelumnya) ...
        try {
            const nextNo = await getNextNoTransaksi();
            
            const dataTransaksi = {
                no: nextNo, 
                tanggal: new Date(tanggalInput), 
                uraian: uraianInput, 
                kategori: kategoriInput, 
                jenis_transaksi: "KELUAR",
                jumlah: jumlahInput 
            };

            await addDoc(collection(db, 'jurnal_kas'), dataTransaksi);
            
            alert("Pengeluaran berhasil dicatat!");
            document.getElementById('formPengeluaran').reset();
            displayJurnalKas();
        } catch (error) {
             alert("Gagal mencatat pengeluaran: " + error.message);
        }
    });


    // =================================================================
    // 3. TAMPILAN SALDO BERJALAN (DASHBOARD)
    // =================================================================

    async function displayJurnalKas() {
        if (!auth.currentUser) return; // Hanya tampilkan jika sudah login
        
        const jurnalBody = document.getElementById('jurnalBody');
        const finalSaldoCell = document.getElementById('finalSaldo');
        
        jurnalBody.innerHTML = '';
        let saldoBerjalan = 0;
        
        const q = query(collection(db, 'jurnal_kas'), orderBy('tanggal', 'asc'), orderBy('no', 'asc'));
        const snapshot = await getDocs(q);

        snapshot.forEach(doc => {
            const data = doc.data();
            
            let danaMasuk = 0;
            let danaKeluar = 0;
            let isDonasi = data.kategori === 'Dana Masuk (Donasi)'; 
            
            if (data.jenis_transaksi === 'MASUK') {
                danaMasuk = data.jumlah;
                saldoBerjalan += data.jumlah; 
            } else if (data.jenis_transaksi === 'KELUAR') {
                danaKeluar = data.jumlah;
                saldoBerjalan -= data.jumlah; 
            }

            const row = jurnalBody.insertRow();
            row.insertCell().textContent = data.no; 
            row.insertCell().textContent = formatDate(data.tanggal);
            row.insertCell().textContent = data.uraian;
            
            const kategoriCell = row.insertCell();
            kategoriCell.textContent = data.kategori;
            kategoriCell.classList.add('admin-only');
            
            row.insertCell().textContent = danaMasuk > 0 ? formatRupiah(danaMasuk) : '-';
            row.insertCell().textContent = danaKeluar > 0 ? formatRupiah(danaKeluar) : '-';
            
            const saldoCell = row.insertCell();
            saldoCell.textContent = formatRupiah(saldoBerjalan);

            // Kolom Aksi (Edit/Hapus)
            const aksiCell = row.insertCell();
            aksiCell.innerHTML = `
                <button class="aksi-btn edit" onclick="editTransaksi(
                    '${doc.id}', 
                    '${data.uraian.replace(/'/g, "\\'")}', 
                    ${data.jumlah}
                )">Edit</button> 
                <button class="aksi-btn delete" onclick="deleteTransaksi('${doc.id}', ${data.no}, ${isDonasi})">Hapus</button>
            `;
            aksiCell.classList.add('admin-only');
        });

        finalSaldoCell.textContent = formatRupiah(saldoBerjalan);
    }

    // =================================================================
    // PDF GENERATION (K-16, K-17, K-18)
    // =================================================================

    // ... (Fungsi PDF Generation sama seperti sebelumnya) ...
    const createDataArrayFromSnapshot = (snapshot, type) => { /* ... */ };
    document.getElementById('downloadLaporanLPJ').addEventListener('click', async () => { /* ... */ });
    document.getElementById('downloadListDonatur').addEventListener('click', async () => { /* ... */ });
    document.getElementById('downloadPengeluaranDetail').addEventListener('click', async () => { /* ... */ });


    // =================================================================
    // KODE IMPORT DATA LAMA (HANYA JALAN SEKALI)
    // =================================================================
    const dataToImport = [
        {
            "No": 1, "Tanggal": "21-11-2025", "Nama donatur": "Sarpin", "Alamat": "Gowangkong 1/10 Ngablak", 
            "Jariyah": "2,000,000", "Total Jariyah": "2,000,000", 
            "No__1": 1, "Tanggal__1": "21-11-2025", "Uraian": "ongkos kiai ceramah", 
            "Kategori": "bayar kiai", "Dana masuk": "10,000,000", "Dana Keluar": "1,000,000"
        },
        // ... (Lanjutkan sisa 5 objek data Excel Anda) ...
        {
            "No": 2, "Tanggal": "21-11-2025", "Nama donatur": "ngadiyo", "Alamat": "Gowangkong 1/10 Ngablak", 
            "Jariyah": "2,000,000", "Total Jariyah": "4,000,000", 
            "No__1": 2, "Tanggal__1": "21-11-2025", "Uraian": "ongkos kataman", 
            "Kategori": "bayar kataman", "Dana masuk": "", "Dana Keluar": "600,000"
        },
        {
            "No": 3, "Tanggal": "21-11-2025", "Nama donatur": "ngarpani", "Alamat": "Gowangkong 1/10 Ngablak", 
            "Jariyah": "2,000,000", "Total Jariyah": "6,000,000", 
            "No__1": 3, "Tanggal__1": "21-11-2025", "Uraian": "ongkos konsumsi", 
            "Kategori": "bayar konsumsi", "Dana masuk": "", "Dana Keluar": "1,500,000"
        },
        {
            "No": 4, "Tanggal": "21-11-2025", "Nama donatur": "sular", "Alamat": "Gowangkong 1/10 Ngablak", 
            "Jariyah": "2,000,000", "Total Jariyah": "8,000,000", 
            "No__1": 4, "Tanggal__1": "21-11-2025", "Uraian": "sewa tratak", 
            "Kategori": "bayar persewaan", "Dana masuk": "", "Dana Keluar": "700,000"
        },
        {
            "No": 5, "Tanggal": "21-11-2025", "Nama donatur": "sutris", "Alamat": "Gowangkong 1/10 Ngablak", 
            "Jariyah": "2,000,000", "Total Jariyah": "10,000,000", 
            "No__1": 5, "Tanggal__1": "21-11-2025", "Uraian": "bayar panitia", 
            "Kategori": "bayar pekerja", "Dana masuk": "", "Dana Keluar": "500,000"
        },
        {
            "No__1": 6, "Tanggal__1": "21-11-2025", "Uraian": "Bayar kiai kataman", 
            "Kategori": "bayar kiai", "Dana masuk": "", "Dana Keluar": "500,000",
        }
    ];

    async function importOldData() {
        console.log("Memulai proses impor data lama...");
        
        let currentNo = 0; 
        const totalDonasi = cleanRupiah(dataToImport[4]["Total Jariyah"]); 
        
        if (totalDonasi > 0) {
            currentNo = await getNextNoTransaksi(); 
            await addDoc(collection(db, "jurnal_kas"), {
                no: currentNo, tanggal: new Date("2025-11-21"), 
                uraian: "Transfer Saldo Awal/Total Donasi Massal", kategori: "Dana Masuk (Donasi)",
                jenis_transaksi: "MASUK", jumlah: totalDonasi
            });
        }
        
        for (let i = 0; i < dataToImport.length; i++) {
            const item = dataToImport[i];
            const danaKeluar = cleanRupiah(item["Dana Keluar"]);
            if (danaKeluar > 0) {
                currentNo = await getNextNoTransaksi(); 
                await addDoc(collection(db, "jurnal_kas"), {
                    no: currentNo, tanggal: new Date(`2025-11-21`), 
                    uraian: item["Uraian"], kategori: item["Kategori"], 
                    jenis_transaksi: "KELUAR", jumlah: danaKeluar
                });
            }
        }
        
        for (let i = 0; i < 5; i++) {
            const item = dataToImport[i];
            await addDoc(collection(db, "donatur_khaul"), {
                no: item["No"], tanggal: new Date(`2025-11-21`),
                nama_donatur: item["Nama donatur"], alamat: item["Alamat"],
                jariyah: cleanRupiah(item["Jariyah"]), total_jariyah: cleanRupiah(item["Jariyah"]),
            });
        }

        alert("SEMUA DATA LAMA BERHASIL DIIMPOR! (Lakukan langkah pengamanan 3 dan 4)");
    }

    // =================================================================
    // AUTHENTICATION LOGIC (LOGIN/LOGOUT)
    // =================================================================

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        try {
            await signInWithEmailAndPassword(auth, email, password);
        } catch (error) {
            alert("Gagal Login. Periksa Email dan Password.");
        }
    });

    window.logout = async () => {
        await signOut(auth);
    };

    onAuthStateChanged(auth, async (user) => {
        const loginContainer = document.getElementById('loginContainer');
        const appContainer = document.getElementById('appContainer');
        const authStatus = document.getElementById('authStatus');

        if (user) {
            loginContainer.style.display = 'none';
            appContainer.style.display = 'block';
            authStatus.innerHTML = `Selamat datang, Admin! (<a href='#' onclick='logout()'>Logout</a>)`;
            loadKategori(); // Muat kategori
            displayJurnalKas(); // Muat data
            
            // --- PENTING: LANGKAH 3 (Hanya Jalankan Satu Kali di Awal!) ---
            // UNCOMMENT baris di bawah ini dan jalankan website Anda SATU KALI 
            // untuk membuat akun admin pertama (admin@khaul.com | passwordadmin).
            // Setelah berhasil, segera COMMENT OUT lagi!
            //await createUserWithEmailAndPassword(auth, "darwono78@gmail.com", "adminhaul!1@2#3"); 
            // --- PENTING ---

            // --- PENTING: LANGKAH 4 (Hanya Jalankan Satu Kali di Awal!) ---
            // UNCOMMENT baris di bawah ini dan jalankan website Anda SATU KALI 
            // untuk mengimpor data Excel lama Anda.
            // Setelah berhasil, segera COMMENT OUT lagi!
            importOldData(); 
            // --- PENTING ---
            
        } else {
            loginContainer.style.display = 'block';
            appContainer.style.display = 'none';
            authStatus.textContent = "Anda harus Login untuk mengakses aplikasi.";
        }
    });

    window.onload = () => {
         // onAuthStateChanged akan menangani semua pemuatan data
    };
</script>
</body>
</html>





