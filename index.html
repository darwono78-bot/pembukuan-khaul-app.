<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pembukuan Khaul - Kas Umum (Donatur & Pengeluaran)</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Memuat Library PDF: jsPDF dan AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Konfigurasi Firebase dan modul (LOGIKA AKAN ADA DI BAGIAN 3) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged,
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            addDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            getDocs, 
            orderBy, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Setel level log untuk Firestore
        setLogLevel('Debug');

        // Variabel Global
        let db;
        let auth;
        let userId = null;
        let allTransactions = []; // Menyimpan semua data transaksi untuk keperluan laporan
        let isAdmin = false;

        // Mendapatkan konfigurasi dari lingkungan Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const SECRET_ADMIN_UID = "admin-khaul-2024"; // UID Admin Khusus

        // --- Fungsi Helper ---
        
        // Fungsi untuk format angka ke Rupiah
        const formatRupiah = (angka) => {
            if (typeof angka !== 'number') return 'Rp 0';
            const formatter = new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            });
            return formatter.format(angka);
        };

        // Fungsi untuk mengonversi string Rupiah ke angka
        const parseRupiah = (rupiahString) => {
            // Hapus 'Rp', titik, dan koma, lalu ubah ke float
            const cleanString = rupiahString.replace(/Rp\s?|\.|\,/g, '');
            return parseFloat(cleanString);
        };

        // Mendapatkan referensi koleksi berdasarkan status admin
        const getCollectionRef = (collectionName) => {
            if (userId) {
                // Skema Private: /artifacts/{appId}/users/{userId}/{collectionName}
                return collection(db, `artifacts/${appId}/users/${userId}/${collectionName}`);
            }
            // Skema Public (Fallback jika userId belum siap, tapi idealnya jangan dijalankan)
            return collection(db, `artifacts/${appId}/public/data/${collectionName}`);
        };

        // --- Inisialisasi Firebase ---

        const initializeFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config tidak tersedia.");
                    return;
                }
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Proses autentikasi
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Listener status otentikasi
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        // Cek apakah user adalah admin
                        isAdmin = (userId === SECRET_ADMIN_UID);
                        
                        document.getElementById('user-status').textContent = isAdmin ? `Admin Khaul (${userId})` : `User ID: ${userId}`;
                        
                        // Tampilkan/Sembunyikan elemen admin
                        const adminElements = document.querySelectorAll('[data-admin-only]');
                        adminElements.forEach(el => {
                            el.classList.toggle('hidden', !isAdmin);
                        });
                        
                        // Mulai mendengarkan data jurnal
                        if (db && userId) {
                            listenToJurnal();
                        }
                    } else {
                        userId = null;
                        isAdmin = false;
                        document.getElementById('user-status').textContent = 'Belum Terautentikasi';
                        // Kosongkan tabel jika user keluar
                        document.getElementById('jurnal-table-body').innerHTML = '<tr><td colspan="8" class="text-center py-4 text-gray-500">Silakan login untuk memuat data.</td></tr>';
                    }
                });

            } catch (error) {
                console.error("Kesalahan saat inisialisasi Firebase atau autentikasi:", error);
                document.getElementById('jurnal-table-body').innerHTML = '<tr><td colspan="8" class="text-center py-4 text-red-500">Gagal memuat data. Cek koneksi internet.</td></tr>';
            }
        };

        // --- Operasi Data (CRUD & Listener) ---

        // Fungsi utama untuk mendengarkan perubahan pada koleksi jurnal
        const listenToJurnal = () => {
            const jurnalRef = getCollectionRef('jurnal');
            // Query: ambil semua data dan urutkan berdasarkan timestamp
            const q = query(jurnalRef, orderBy('timestamp', 'asc')); 
            
            // onSnapshot akan memanggil callback setiap kali data berubah
            onSnapshot(q, (snapshot) => {
                const transactions = [];
                let saldoBerjalan = 0;
                let totalMasuk = 0;
                let totalKeluar = 0;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const jumlah = parseFloat(data.jumlah || 0); // Pastikan jumlah adalah angka

                    let danaMasuk = 0;
                    let danaKeluar = 0;
                    
                    // Hitung saldo berjalan
                    if (data.jenis === 'MASUK') {
                        danaMasuk = jumlah;
                        saldoBerjalan += jumlah;
                        totalMasuk += jumlah;
                    } else if (data.jenis === 'KELUAR') {
                        danaKeluar = jumlah;
                        saldoBerjalan -= jumlah;
                        totalKeluar += jumlah;
                    }

                    transactions.push({
                        id: doc.id,
                        ...data,
                        jumlah: jumlah, // Simpan jumlah sebagai angka
                        danaMasuk: danaMasuk,
                        danaKeluar: danaKeluar,
                        saldoBerjalan: saldoBerjalan,
                        tanggalFormatted: new Date(data.tanggal).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' })
                    });
                });

                allTransactions = transactions; // Simpan data untuk PDF/laporan
                renderJurnalTable(transactions);
                updateTotals(totalMasuk, totalKeluar, saldoBerjalan);
                
            }, (error) => {
                console.error("Gagal mendengarkan data jurnal:", error);
                document.getElementById('jurnal-table-body').innerHTML = '<tr><td colspan="8" class="text-center py-4 text-red-500">Gagal memuat data jurnal.</td></tr>';
            });
        };

        // Fungsi untuk mencatat transaksi Dana Masuk (Jariyah)
        window.catatJariyah = async (event) => {
            event.preventDefault();
            
            const form = document.getElementById('form-jariyah');
            const namaDonatur = document.getElementById('nama-donatur').value.trim();
            const alamat = document.getElementById('alamat-donatur').value.trim();
            const jumlahJariyah = parseFloat(document.getElementById('jumlah-jariyah').value);
            const tanggal = document.getElementById('tanggal-jariyah').value;

            // Validasi
            if (!namaDonatur || !alamat || isNaN(jumlahJariyah) || jumlahJariyah <= 0 || !tanggal) {
                showToast('Semua field (Nama, Alamat, Jumlah, Tanggal) harus diisi dengan benar.', 'bg-red-500');
                return;
            }

            try {
                // Hitung persentase (sesuai alur: Perawatan Makam 15%, Ongkos Panitia 15%, Biaya Khaul 70%)
                const perawatanMakam = jumlahJariyah * 0.15;
                const ongkosPanitia = jumlahJariyah * 0.15;
                const biayaKhaul = jumlahJariyah * 0.70;

                const newJurnalEntry = {
                    jenis: 'MASUK',
                    tanggal: tanggal,
                    uraian: `Donasi dari ${namaDonatur} (Alamat: ${alamat})`,
                    kategori: 'Donasi', // Kategori LPJ untuk dana masuk
                    jumlah: jumlahJariyah,
                    namaDonatur: namaDonatur,
                    alamat: alamat,
                    rincianProsentase: {
                        perawatanMakam: perawatanMakam,
                        ongkosPanitia: ongkosPanitia,
                        biayaKhaul: biayaKhaul,
                    },
                    timestamp: serverTimestamp() // Waktu server
                };

                await addDoc(getCollectionRef('jurnal'), newJurnalEntry);
                form.reset();
                showToast('Dana Jariyah Berhasil Dicatat!', 'bg-green-500');

            } catch (e) {
                console.error("Error saat mencatat Jariyah:", e);
                showToast('Gagal mencatat dana. Cek konsol untuk detail.', 'bg-red-500');
            }
        };

        // Fungsi untuk mencatat transaksi Dana Keluar/Pengeluaran
        window.catatPengeluaran = async (event) => {
            event.preventDefault();

            if (!isAdmin) {
                showToast('Hanya Admin yang dapat mencatat pengeluaran.', 'bg-red-500');
                return;
            }
            
            const form = document.getElementById('form-pengeluaran');
            const uraian = document.getElementById('uraian-pengeluaran').value.trim();
            const kategori = document.getElementById('kategori-pengeluaran').value;
            const jumlah = parseFloat(document.getElementById('jumlah-pengeluaran').value);
            const tanggal = document.getElementById('tanggal-pengeluaran').value;

            // Validasi
            if (!uraian || !kategori || isNaN(jumlah) || jumlah <= 0 || !tanggal) {
                showToast('Semua field harus diisi dengan benar.', 'bg-red-500');
                return;
            }
            
            try {
                const newJurnalEntry = {
                    jenis: 'KELUAR',
                    tanggal: tanggal,
                    uraian: uraian,
                    kategori: kategori,
                    jumlah: jumlah,
                    timestamp: serverTimestamp()
                };

                await addDoc(getCollectionRef('jurnal'), newJurnalEntry);
                form.reset();
                showToast('Pengeluaran Berhasil Dicatat!', 'bg-green-500');

            } catch (e) {
                console.error("Error saat mencatat Pengeluaran:", e);
                showToast('Gagal mencatat pengeluaran. Cek konsol untuk detail.', 'bg-red-500');
            }
        };

        // Fungsi untuk menghapus transaksi
        window.deleteTransaction = async (id) => {
            if (!isAdmin) {
                showToast('Hanya Admin yang dapat menghapus transaksi.', 'bg-red-500');
                return;
            }

            // Tampilkan modal konfirmasi kustom
            showConfirmationModal('Konfirmasi Hapus', 'Apakah Anda yakin ingin menghapus transaksi ini? Tindakan ini tidak dapat dibatalkan.', async () => {
                try {
                    const docRef = doc(getCollectionRef('jurnal'), id);
                    await deleteDoc(docRef);
                    showToast('Transaksi berhasil dihapus!', 'bg-green-500');
                } catch (e) {
                    console.error("Error saat menghapus transaksi:", e);
                    showToast('Gagal menghapus transaksi. Cek konsol.', 'bg-red-500');
                }
            });
        };
        
        // --- Render UI ---

        const renderJurnalTable = (transactions) => {
            const tableBody = document.getElementById('jurnal-table-body');
            tableBody.innerHTML = ''; // Kosongkan tabel
            
            if (transactions.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-gray-500">Belum ada data transaksi yang tercatat.</td></tr>';
                return;
            }

            transactions.forEach((t, index) => {
                const row = tableBody.insertRow();
                
                // Tentukan warna baris
                const rowClass = t.jenis === 'MASUK' ? 'hover:bg-green-50' : 'hover:bg-red-50';
                row.className = rowClass;

                // 1. No.
                const cellNo = row.insertCell();
                cellNo.textContent = index + 1;
                cellNo.className = 'py-2 px-3 text-center border-r';

                // 2. Tanggal
                const cellTanggal = row.insertCell();
                cellTanggal.textContent = t.tanggalFormatted;
                cellTanggal.className = 'py-2 px-3 text-center border-r';
                
                // 3. Uraian
                const cellUraian = row.insertCell();
                cellUraian.innerHTML = `<span class="font-medium">${t.uraian}</span>`;
                
                if (t.jenis === 'MASUK') {
                    // Tambahkan rincian donatur dan persentase untuk dana masuk (Hanya terlihat admin)
                    if (isAdmin && t.namaDonatur) {
                        const rincianHtml = `
                            <p class="text-xs text-gray-500 mt-1">
                                Donatur: ${t.namaDonatur} (Alamat: ${t.alamat})<br>
                                Makam (15%): ${formatRupiah(t.rincianProsentase?.perawatanMakam || 0)} | 
                                Panitia (15%): ${formatRupiah(t.rincianProsentase?.ongkosPanitia || 0)} | 
                                Khaul (70%): ${formatRupiah(t.rincianProsentase?.biayaKhaul || 0)}
                            </p>
                        `;
                        cellUraian.innerHTML += rincianHtml;
                    }
                }
                cellUraian.className = 'py-2 px-3 border-r';

                // 4. Kategori LPJ (Hanya terlihat admin)
                const cellKategori = row.insertCell();
                cellKategori.textContent = t.kategori || '-';
                cellKategori.className = 'py-2 px-3 border-r ' + (isAdmin ? 'table-cell' : 'hidden md:table-cell');


                // 5. Dana Masuk
                const cellMasuk = row.insertCell();
                cellMasuk.textContent = t.jenis === 'MASUK' ? formatRupiah(t.jumlah) : '-';
                cellMasuk.className = 'py-2 px-3 text-right text-green-700 font-semibold border-r';

                // 6. Dana Keluar
                const cellKeluar = row.insertCell();
                cellKeluar.textContent = t.jenis === 'KELUAR' ? formatRupiah(t.jumlah) : '-';
                cellKeluar.className = 'py-2 px-3 text-right text-red-700 font-semibold border-r';

                // 7. Saldo Berjalan
                const cellSaldo = row.insertCell();
                cellSaldo.textContent = formatRupiah(t.saldoBerjalan);
                cellSaldo.className = 'py-2 px-3 text-right font-bold border-r';
                
                // 8. Aksi (Hanya terlihat admin)
                const cellAksi = row.insertCell();
                cellAksi.className = 'py-2 px-3 text-center ' + (isAdmin ? 'table-cell' : 'hidden');
                cellAksi.innerHTML = `
                    <button onclick="window.deleteTransaction('${t.id}')" class="text-red-600 hover:text-red-800 transition duration-150 p-1 rounded-full hover:bg-red-100" title="Hapus Transaksi">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd"></path></svg>
                    </button>
                `;
            });
        };

        const updateTotals = (totalMasuk, totalKeluar, saldoAkhir) => {
            document.getElementById('total-dana-masuk-jurnal').textContent = formatRupiah(totalMasuk);
            document.getElementById('total-dana-keluar-jurnal').textContent = formatRupiah(totalKeluar);
            document.getElementById('saldo-akhir').textContent = formatRupiah(saldoAkhir);
        };
        
        // --- Fungsi Utility UI ---
        
        const showToast = (message, bgColor) => {
            const toast = document.getElementById('toast-message');
            toast.textContent = message;
            toast.className = `fixed bottom-5 left-1/2 transform -translate-x-1/2 p-3 rounded-lg shadow-xl text-white font-semibold transition-opacity duration-300 ${bgColor}`;
            toast.classList.remove('opacity-0', 'hidden');
            toast.classList.add('opacity-100');
            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0');
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        };

        // --- Modal Kustom (Pengganti alert/confirm) ---

        const showConfirmationModal = (title, message, onConfirm) => {
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;

            const confirmBtn = document.getElementById('modal-confirm-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            const closeModal = () => {
                modal.classList.add('hidden');
                confirmBtn.removeEventListener('click', handleConfirm);
            };

            const handleConfirm = () => {
                onConfirm();
                closeModal();
            };

            confirmBtn.addEventListener('click', handleConfirm);
            cancelBtn.addEventListener('click', closeModal);

            modal.classList.remove('hidden');
        };

        // --- Fungsi Download PDF ---
        
        // Mengganti fungsi ini dengan kode dari user
        window.generatePDF = (type) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4'); // Potrait, mm, A4
            
            // Menggunakan `allTransactions` yang sudah global
            const transactionsToReport = allTransactions; 

            // Cek jika tidak ada data
            if (transactionsToReport.length === 0) {
                 showToast('Tidak ada data transaksi untuk dibuatkan laporan.', 'bg-yellow-500');
                 return;
            }

            const currentDate = new Date().toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' });
            const title = type === 'detail' ? 'LAPORAN KAS JURNAL KHAUL DETAIL' : 'LAPORAN KAS JURNAL KHAUL RINGKASAN';
            
            // Header
            doc.setFontSize(16);
            doc.text(title, 14, 20);
            doc.setFontSize(10);
            doc.text(`Dicetak pada: ${currentDate}`, 14, 26);
            doc.text(`Total Saldo Akhir: ${document.getElementById('saldo-akhir').textContent}`, 14, 32);

            if (type === 'detail') {
                // Laporan Detail
                const rows = transactionsToReport.map((t, index) => {
                    const rowData = [
                        (index + 1).toString(), // No
                        t.tanggalFormatted, // Tanggal
                        t.uraian, // Uraian
                        t.kategori || '-', // Kategori LPJ (hanya untuk admin)
                        t.jenis === 'MASUK' ? formatRupiah(t.jumlah) : '-', // Dana Masuk
                        t.jenis === 'KELUAR' ? formatRupiah(t.jumlah) : '-', // Dana Keluar
                        formatRupiah(t.saldoBerjalan) // Saldo Berjalan
                    ];
                    return rowData;
                });
                

                doc.autoTable({
                    head: [['No', 'Tanggal', 'Uraian', 'Kategori', 'Masuk', 'Keluar', 'Saldo Berjalan']],
                    body: rows,
                    startY: 40,
                    theme: 'striped',
                    headStyles: { fillColor: [30, 130, 76] }, // Hijau tua
                    columnStyles: {
                        0: { cellWidth: 10 },
                        4: { halign: 'right' }, // Rata kanan untuk Dana Masuk
                        5: { halign: 'right' }, // Rata kanan untuk Dana Keluar
                        6: { halign: 'right', fontStyle: 'bold' } // Rata kanan & bold untuk Saldo Berjalan
                    },
                    styles: { fontSize: 8 },
                });
                doc.save(`Laporan_Detail_Kas_Khaul_${currentDate}.pdf`);

            } else if (type === 'ringkasan') {
                // Laporan Ringkasan (Total per Kategori)
                const summary = transactionsToReport.reduce((acc, t) => {
                    if (!acc[t.kategori]) {
                        acc[t.kategori] = { masuk: 0, keluar: 0 };
                    }
                    if (t.jenis === 'MASUK') {
                        acc[t.kategori].masuk += t.jumlah;
                    } else if (t.jenis === 'KELUAR') {
                        acc[t.kategori].keluar += t.jumlah;
                    }
                    return acc;
                }, {});

                const summaryRows = Object.keys(summary).map(kategori => {
                    const data = summary[kategori];
                    return [
                        kategori,
                        formatRupiah(data.masuk),
                        formatRupiah(data.keluar),
                        formatRupiah(data.masuk - data.keluar)
                    ];
                });

                // Tambahkan baris total
                const totalRow = [
                    'TOTAL KESELURUHAN',
                    document.getElementById('total-dana-masuk-jurnal').textContent,
                    document.getElementById('total-dana-keluar-jurnal').textContent,
                    document.getElementById('saldo-akhir').textContent
                ];

                doc.autoTable({
                    head: [['Kategori', 'Total Dana Masuk', 'Total Dana Keluar', 'Saldo Kategori']],
                    body: summaryRows,
                    foot: [totalRow],
                    startY: 40,
                    theme: 'grid',
                    headStyles: { fillColor: [243, 156, 18] }, // Orange
                    footStyles: { fillColor: [46, 204, 113], fontStyle: 'bold' }, // Hijau muda
                    columnStyles: {
                        1: { halign: 'right' }, // Rata kanan untuk Total Masuk
                        2: { halign: 'right' }, // Rata kanan untuk Total Keluar
                        3: { halign: 'right' }  // Rata kanan untuk Saldo Kategori
                    },
                    styles: { fontSize: 9 },
                });
                doc.save(`Laporan_Ringkasan_Kas_Khaul_${currentDate}.pdf`);
            }
        };

        // --- Setup Event Listeners ---
        const setupEventListeners = () => {
            document.getElementById('form-jariyah').addEventListener('submit', window.catatJariyah);
            document.getElementById('form-pengeluaran').addEventListener('submit', window.catatPengeluaran);
            document.getElementById('btn-logout').addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    showToast('Berhasil keluar!', 'bg-blue-500');
                    // Tampilkan kembali tombol login modal
                    document.getElementById('login-modal').classList.remove('hidden');
                } catch (error) {
                    console.error("Error saat logout:", error);
                    showToast('Gagal keluar.', 'bg-red-500');
                }
            });

            // Login Admin Logic
            document.getElementById('admin-login-btn').addEventListener('click', () => {
                const passwordInput = document.getElementById('admin-password');
                const password = passwordInput.value;
                const modal = document.getElementById('login-modal');
                
                // Cek Password Sederhana (Ganti dengan sistem autentikasi yang lebih aman jika digunakan di luar Canvas)
                if (password === 'admin.khaul.2024') {
                    // Karena kita tidak bisa mendapatkan token kustom admin dari luar,
                    // kita hanya akan memuat ulang dengan asumsi Canvas akan memberikan token admin.
                    // Untuk tujuan DEMO di lingkungan Canvas, kita anggap login berhasil.
                    showToast('Admin Login Berhasil. Memuat ulang dengan status Admin...', 'bg-indigo-500');
                    passwordInput.value = '';
                    modal.classList.add('hidden');
                    // Di lingkungan non-Canvas, ini akan memicu signInWithCustomToken admin.
                    // Di sini, kita andalkan `__initial_auth_token` yang disediakan Canvas.
                    // Karena kita tidak bisa memicu auth token baru, kita hanya sembunyikan modal.
                } else {
                    showToast('Password Admin Salah!', 'bg-red-600');
                }
            });
        };
        
        // Panggil inisialisasi saat window load
        window.onload = () => {
            initializeFirebase();
            setupEventListeners();
        };
        
        // Export fungsi ke scope global agar bisa dipanggil dari tombol HTML
        window.catatJariyah = window.catatJariyah;
        window.catatPengeluaran = window.catatPengeluaran;
        window.deleteTransaction = window.deleteTransaction;

    </script>

    <!-- Kodingan CSS dengan Tailwind -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .container-app {
            max-width: 1200px;
        }
        .input-field {
            @apply w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-150;
        }
        .header-title {
            @apply text-3xl font-bold text-center text-gray-800 mb-6;
        }
        .section-title {
            @apply text-xl font-semibold text-gray-700 mb-4 border-b pb-2;
        }
        .btn-primary {
            @apply bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 shadow-md;
        }
        .btn-secondary {
            @apply bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-md;
        }
        .btn-danger {
            @apply bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-md;
        }
        /* Style untuk tabel agar lebih rapi */
        th, td {
            white-space: nowrap; /* Mencegah wrap teks di sel */
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="container-app mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-2xl border border-gray-100">
        
        <!-- Header Aplikasi -->
        <header class="mb-8">
            <h1 class="header-title text-green-700">
                <svg class="w-8 h-8 inline-block mr-2 -mt-1 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                Pembukuan Dana Khaul
            </h1>
            <div class="text-center text-sm text-gray-500 mt-2">
                Status: <span id="user-status" class="font-medium text-gray-700">Memuat...</span>
                <button id="btn-logout" class="ml-4 text-red-500 hover:text-red-700 font-semibold transition duration-150">Logout</button>
            </div>
        </header>

        <!-- Saldo Akhir -->
        <div class="mb-8 bg-green-50 p-6 rounded-xl shadow-inner border border-green-200">
            <p class="text-lg font-medium text-gray-700 mb-2">SALDO KAS KHAUL SAAT INI:</p>
            <p id="saldo-akhir" class="text-4xl font-extrabold text-green-800">Rp 0</p>
        </div>

        <!-- Formulir Pencatatan -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10">

            <!-- Form Dana Masuk (Jariyah) -->
            <div class="bg-blue-50 p-6 rounded-xl shadow-lg border border-blue-200">
                <h2 class="section-title text-blue-700">1. Catat Dana Masuk (Jariyah)</h2>
                <form id="form-jariyah">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="tanggal-jariyah">Tanggal:</label>
                        <input type="date" id="tanggal-jariyah" class="input-field" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="nama-donatur">Nama Donatur:</label>
                        <input type="text" id="nama-donatur" class="input-field" placeholder="Masukkan Nama Donatur" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="alamat-donatur">Alamat Donatur:</label>
                        <input type="text" id="alamat-donatur" class="input-field" placeholder="Masukkan Alamat Donatur" required>
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="jumlah-jariyah">Jumlah Jariyah (Rp):</label>
                        <input type="number" id="jumlah-jariyah" class="input-field" placeholder="Contoh: 150000" min="1" required>
                    </div>
                    <button type="submit" class="btn-primary w-full flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Catat Jariyah
                    </button>
                </form>
            </div>

            <!-- Form Dana Keluar (Pengeluaran) - Hanya untuk Admin -->
            <div class="bg-red-50 p-6 rounded-xl shadow-lg border border-red-200 hidden" data-admin-only>
                <h2 class="section-title text-red-700">2. Catat Dana Keluar (Pengeluaran)</h2>
                <form id="form-pengeluaran">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="tanggal-pengeluaran">Tanggal:</label>
                        <input type="date" id="tanggal-pengeluaran" class="input-field" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="uraian-pengeluaran">Uraian Pengeluaran:</label>
                        <input type="text" id="uraian-pengeluaran" class="input-field" placeholder="Contoh: Pembayaran Konsumsi Panitia" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="kategori-pengeluaran">Kategori LPJ:</label>
                        <select id="kategori-pengeluaran" class="input-field" required>
                            <option value="" disabled selected>Pilih Kategori LPJ</option>
                            <!-- Kategori Dana Keluar sesuai alur: -->
                            <option value="Ongkos Kiai">Ongkos Kiai</option>
                            <option value="Bayar Kataman">Bayar Kataman</option>
                            <option value="Bayar Konsumsi">Bayar Konsumsi</option>
                            <option value="Bayar Persewaan">Bayar Persewaan</option>
                            <option value="Bayar Pekerja">Bayar Pekerja</option>
                            <option value="Perawatan Makam">Perawatan Makam (15%)</option>
                            <option value="Ongkos Panitia">Ongkos Panitia (15%)</option>
                            <option value="Biaya Khaul">Biaya Khaul (70%)</option>
                            <option value="Lain-lain">Lain-lain</option>
                        </select>
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="jumlah-pengeluaran">Jumlah Keluar (Rp):</label>
                        <input type="number" id="jumlah-pengeluaran" class="input-field" placeholder="Contoh: 500000" min="1" required>
                    </div>
                    <button type="submit" class="btn-danger w-full flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Catat Pengeluaran
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Tombol Download PDF & Reset Data -->
        <div class="mb-8 p-6 bg-gray-50 rounded-xl shadow-inner border border-gray-200 flex flex-wrap gap-4 items-center justify-center">
             <span class="font-bold text-gray-700 mr-4">Unduh Laporan (PDF):</span>
            <button onclick="window.generatePDF('detail')" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-lg">
                <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                Detail
            </button>
            <button onclick="window.generatePDF('ringkasan')" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-lg">
                <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m-9 10h10a2 2 0 002-2V5a2 2 0 00-2-2H9a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                Ringkasan LPJ
            </button>
            <button onclick="window.showConfirmationModal('Reset Data', 'ANDA YAKIN INGIN MENGHAPUS SEMUA DATA TRANSAKSI? Tindakan ini tidak dapat dibatalkan dan hanya bisa dilakukan oleh Admin.', () => console.log('Admin konfirmasi reset, implementasi reset data di sini'))" class="btn-danger ml-auto hidden" data-admin-only>
                <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                Reset Data (Admin)
            </button>
        </div>

        <!-- Tabel Jurnal Transaksi -->
        <h2 class="section-title text-gray-800">3. Jurnal Transaksi Kas Khaul</h2>
        <div class="overflow-x-auto bg-white rounded-xl shadow-inner border border-gray-100">
            <table class="min-w-full divide-y divide-gray-300">
                <thead class="bg-gray-200 text-gray-700 text-xs uppercase tracking-wider">
                    <tr>
                        <th class="py-3 px-3 border-r w-10">No</th>
                        <th class="py-3 px-3 border-r">Tanggal</th>
                        <th class="py-3 px-3 border-r w-48">Uraian</th>
                        <!-- Kategori LPJ hanya tampil untuk admin -->
                        <th class="py-3 px-3 border-r w-24 hidden md:table-cell" data-admin-only>Kategori LPJ</th> 
                        <th class="py-3 px-3 border-r text-right w-24">Dana Masuk</th>
                        <th class="py-3 px-3 border-r text-right w-24">Dana Keluar</th>
                        <th class="py-3 px-3 border-r text-right w-24">Saldo Berjalan</th>
                        <!-- Kolom Aksi hanya tampil untuk admin -->
                        <th class="py-3 px-3 w-16 hidden" data-admin-only>Aksi</th>
                    </tr>
                </thead>
                <tbody id="jurnal-table-body" class="divide-y divide-gray-200 text-gray-700">
                    <tr><td colspan="8" class="text-center py-4 text-gray-500">Memuat data...</td></tr>
                </tbody>
                <tfoot>
                    <tr class="bg-blue-100 font-bold text-gray-800">
                        <!-- Kolom gabungan untuk total (4 kolom + 1 kolom kategori jika bukan admin = 5) -->
                        <td colspan="4" class="py-3 px-3 text-right">TOTAL AKUMULASI JURNAL:</td>
                        <td id="total-dana-masuk-jurnal" class="py-3 px-3 text-right text-green-700 border-l border-r">Rp 0</td>
                        <td id="total-dana-keluar-jurnal" class="py-3 px-3 text-right text-red-700 border-r">Rp 0</td>
                        <td id="saldo-akhir-footer" class="py-3 px-3 text-right text-blue-700 font-extrabold border-r">Rp 0</td>
                        <td class="py-3 px-3 hidden" data-admin-only></td> <!-- Kolom kosong Aksi -->
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast-message" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 p-3 rounded-lg shadow-xl text-white font-semibold transition-opacity duration-300 opacity-0 hidden" style="z-index: 1000;">
        Pesan
    </div>

    <!-- Custom Confirmation Modal (Menggantikan window.confirm) -->
    <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden" style="z-index: 2000;">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6">
            <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-4">Konfirmasi</h3>
            <p id="modal-message" class="text-gray-600 mb-6">Apakah Anda yakin ingin melanjutkan?</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-150">Batal</button>
                <button id="modal-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150">Ya, Hapus</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Login Admin -->
    <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4" style="z-index: 3000;">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Login Admin</h3>
            <p class="text-sm text-gray-500 mb-4 text-center">Akses Admin diperlukan untuk mencatat Pengeluaran, melihat Kategori LPJ, dan Hapus/Reset data.</p>
            <div class="mb-6">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="admin-password">Password Admin:</label>
                <input type="password" id="admin-password" class="input-field" placeholder="Masukkan password admin">
            </div>
            <button id="admin-login-btn" class="btn-secondary w-full">
                Login Sebagai Admin
            </button>
        </div>
    </div>

</body>
</html>
